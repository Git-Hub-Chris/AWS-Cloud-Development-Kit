"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const dynamodb = require("aws-cdk-lib/aws-dynamodb");
const lambda = require("aws-cdk-lib/aws-lambda");
const logs = require("aws-cdk-lib/aws-logs");
const cdk = require("aws-cdk-lib/core");
const integ_tests_alpha_1 = require("@aws-cdk/integ-tests-alpha");
const appsync = require("aws-cdk-lib/aws-appsync");
const app = new cdk.App();
const stack = new cdk.Stack(app, 'AppSyncJsResolverTestStack');
const logConfig = {
    retention: logs.RetentionDays.ONE_WEEK,
};
const api = new appsync.GraphqlApi(stack, 'JsResolverApi', {
    name: 'JsResolverApi',
    schema: appsync.SchemaFile.fromAsset(path.join(__dirname, 'appsync.js-resolver.graphql')),
    logConfig,
});
const db = new dynamodb.Table(stack, 'DynamoTable', {
    partitionKey: {
        name: 'id',
        type: dynamodb.AttributeType.STRING,
    },
    removalPolicy: cdk.RemovalPolicy.DESTROY,
});
const dataSource = api.addDynamoDbDataSource('DynamoDataSource', db);
const addTestFunc = dataSource.createFunction('AddTestFunction', {
    name: 'addTestFunc',
    runtime: appsync.FunctionRuntime.JS_1_0_0,
    code: appsync.Code.fromAsset(path.join(__dirname, 'integ-assets', 'appsync-js-resolver'), {
        bundling: {
            image: lambda.Runtime.NODEJS_18_X.bundlingImage,
            command: ['cp', '-a', '/asset-input/.', '/asset-output/'],
            outputType: cdk.BundlingOutput.FILE,
        },
    }),
});
new appsync.Resolver(stack, 'AddTestResolver', {
    api,
    typeName: 'Mutation',
    fieldName: 'addTest',
    code: appsync.Code.fromAsset(path.join(__dirname, 'integ-assets', 'appsync-js-pipeline'), {
        bundling: {
            image: lambda.Runtime.NODEJS_18_X.bundlingImage,
            command: ['cp', '-a', '/asset-input/.', '/asset-output/'],
            outputType: cdk.BundlingOutput.FILE,
        },
    }),
    runtime: appsync.FunctionRuntime.JS_1_0_0,
    pipelineConfig: [addTestFunc],
});
const integ = new integ_tests_alpha_1.IntegTest(app, 'JsResolverIntegTest', { testCases: [stack] });
/**
 * Handler that calls our api with an `addTest` Mutation
 */
const invoke = new lambda.Function(stack, 'InvokeApi', {
    code: lambda.Code.fromAsset(path.join(__dirname, 'integ-assets/js-resolver-assertion')),
    handler: 'index.handler',
    runtime: lambda.Runtime.NODEJS_18_X,
});
const addTestInvoke = integ.assertions.invokeFunction({
    functionName: invoke.functionName,
    payload: JSON.stringify({
        hostname: api.graphqlUrl,
        apiKey: api.apiKey,
    }),
});
/**
 * Assert result returned on API has a generated ID and the passed name.
 */
addTestInvoke.assertAtPath('Payload.data.addTest.name', integ_tests_alpha_1.ExpectedResult.stringLikeRegexp('123'));
addTestInvoke.assertAtPath('Payload.data.addTest.id', integ_tests_alpha_1.ExpectedResult.stringLikeRegexp('.+'));
/**
 * Generated ID of the item added in the previous handler
 */
const addTestResultId = addTestInvoke.getAttString('Payload.data.addTest.id');
/**
 * Try to find the item added in the DynamoDB data source.
 */
const getItemCall = integ.assertions.awsApiCall('DynamoDB', 'getItem', {
    TableName: db.tableName,
    Key: {
        id: {
            S: addTestResultId,
        },
    },
});
getItemCall.expect(integ_tests_alpha_1.ExpectedResult.objectLike({
    Item: {
        name: {
            S: '123',
        },
        id: {
            S: addTestResultId,
        },
    },
}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW50ZWcuanMtcmVzb2x2ZXItYnVuZGxlZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImludGVnLmpzLXJlc29sdmVyLWJ1bmRsZWQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw2QkFBNkI7QUFDN0IscURBQXFEO0FBQ3JELGlEQUFpRDtBQUNqRCw2Q0FBNkM7QUFDN0Msd0NBQXdDO0FBQ3hDLGtFQUF1RTtBQUN2RSxtREFBbUQ7QUFFbkQsTUFBTSxHQUFHLEdBQUcsSUFBSSxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUM7QUFDMUIsTUFBTSxLQUFLLEdBQUcsSUFBSSxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSw0QkFBNEIsQ0FBQyxDQUFDO0FBRS9ELE1BQU0sU0FBUyxHQUFzQjtJQUNuQyxTQUFTLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRO0NBQ3ZDLENBQUM7QUFFRixNQUFNLEdBQUcsR0FBRyxJQUFJLE9BQU8sQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLGVBQWUsRUFBRTtJQUN6RCxJQUFJLEVBQUUsZUFBZTtJQUNyQixNQUFNLEVBQUUsT0FBTyxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsNkJBQTZCLENBQUMsQ0FBQztJQUN6RixTQUFTO0NBQ1YsQ0FBQyxDQUFDO0FBRUgsTUFBTSxFQUFFLEdBQUcsSUFBSSxRQUFRLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxhQUFhLEVBQUU7SUFDbEQsWUFBWSxFQUFFO1FBQ1osSUFBSSxFQUFFLElBQUk7UUFDVixJQUFJLEVBQUUsUUFBUSxDQUFDLGFBQWEsQ0FBQyxNQUFNO0tBQ3BDO0lBQ0QsYUFBYSxFQUFFLEdBQUcsQ0FBQyxhQUFhLENBQUMsT0FBTztDQUN6QyxDQUFDLENBQUM7QUFFSCxNQUFNLFVBQVUsR0FBRyxHQUFHLENBQUMscUJBQXFCLENBQUMsa0JBQWtCLEVBQUUsRUFBRSxDQUFDLENBQUM7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QUFFLEVBQUUsQ0FBQyxTQUFTO0lBQ3ZCLEdBQUcsRUFBRTtRQUNILEVBQUUsRUFBRTtZQUNGLENBQUMsRUFBRSxlQUFlO1NBQ25CO0tBQ0Y7Q0FDRixDQUFDLENBQUM7QUFFSCxXQUFXLENBQUMsTUFBTSxDQUFDLGtDQUFjLENBQUMsVUFBVSxDQUFDO0lBQzNDLElBQUksRUFBRTtRQUNKLElBQUksRUFBRTtZQUNKLENBQUMsRUFBRSxLQUFLO1NBQ1Q7UUFDRCxFQUFFLEVBQUU7WUFDRixDQUFDLEVBQUUsZUFBZTtTQUNuQjtLQUNGO0NBQ0YsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0ICogYXMgZHluYW1vZGIgZnJvbSAnYXdzLWNkay1saWIvYXdzLWR5bmFtb2RiJztcbmltcG9ydCAqIGFzIGxhbWJkYSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtbGFtYmRhJztcbmltcG9ydCAqIGFzIGxvZ3MgZnJvbSAnYXdzLWNkay1saWIvYXdzLWxvZ3MnO1xuaW1wb3J0ICogYXMgY2RrIGZyb20gJ2F3cy1jZGstbGliL2NvcmUnO1xuaW1wb3J0IHsgSW50ZWdUZXN0LCBFeHBlY3RlZFJlc3VsdCB9IGZyb20gJ0Bhd3MtY2RrL2ludGVnLXRlc3RzLWFscGhhJztcbmltcG9ydCAqIGFzIGFwcHN5bmMgZnJvbSAnYXdzLWNkay1saWIvYXdzLWFwcHN5bmMnO1xuXG5jb25zdCBhcHAgPSBuZXcgY2RrLkFwcCgpO1xuY29uc3Qgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKGFwcCwgJ0FwcFN5bmNKc1Jlc29sdmVyVGVzdFN0YWNrJyk7XG5cbmNvbnN0IGxvZ0NvbmZpZzogYXBwc3luYy5Mb2dDb25maWcgPSB7XG4gIHJldGVudGlvbjogbG9ncy5SZXRlbnRpb25EYXlzLk9ORV9XRUVLLFxufTtcblxuY29uc3QgYXBpID0gbmV3IGFwcHN5bmMuR3JhcGhxbEFwaShzdGFjaywgJ0pzUmVzb2x2ZXJBcGknLCB7XG4gIG5hbWU6ICdKc1Jlc29sdmVyQXBpJyxcbiAgc2NoZW1hOiBhcHBzeW5jLlNjaGVtYUZpbGUuZnJvbUFzc2V0KHBhdGguam9pbihfX2Rpcm5hbWUsICdhcHBzeW5jLmpzLXJlc29sdmVyLmdyYXBocWwnKSksXG4gIGxvZ0NvbmZpZyxcbn0pO1xuXG5jb25zdCBkYiA9IG5ldyBkeW5hbW9kYi5UYWJsZShzdGFjaywgJ0R5bmFtb1RhYmxlJywge1xuICBwYXJ0aXRpb25LZXk6IHtcbiAgICBuYW1lOiAnaWQnLFxuICAgIHR5cGU6IGR5bmFtb2RiLkF0dHJpYnV0ZVR5cGUuU1RSSU5HLFxuICB9LFxuICByZW1vdmFsUG9saWN5OiBjZGsuUmVtb3ZhbFBvbGljeS5ERVNUUk9ZLFxufSk7XG5cbmNvbnN0IGRhdGFTb3VyY2UgPSBhcGkuYWRkRHluYW1vRGJEYXRhU291cmNlKCdEeW5hbW9EYXRhU291cmNlJywgZGIpO1xuXG5jb25zdCBhZGRUZXN0RnVuYyA9IGRhdGFTb3VyY2UuY3JlYXRlRnVuY3Rpb24oJ0FkZFRlc3RGdW5jdGlvbicsIHtcbiAgbmFtZTogJ2FkZFRlc3RGdW5jJyxcbiAgcnVudGltZTogYXBwc3luYy5GdW5jdGlvblJ1bnRpbWUuSlNfMV8wXzAsXG4gIGNvZGU6IGFwcHN5bmMuQ29kZS5mcm9tQXNzZXQocGF0aC5qb2luKFxuICAgIF9fZGlybmFtZSxcbiAgICAnaW50ZWctYXNzZXRzJyxcbiAgICAnYXBwc3luYy1qcy1yZXNvbHZlcicsXG4gICksIHtcbiAgICBidW5kbGluZzoge1xuICAgICAgaW1hZ2U6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xOF9YLmJ1bmRsaW5nSW1hZ2UsXG4gICAgICBjb21tYW5kOiBbJ2NwJywgJy1hJywgJy9hc3NldC1pbnB1dC8uJywgJy9hc3NldC1vdXRwdXQvJ10sXG4gICAgICBvdXRwdXRUeXBlOiBjZGsuQnVuZGxpbmdPdXRwdXQuRklMRSxcbiAgICB9LFxuICB9KSxcbn0pO1xuXG5uZXcgYXBwc3luYy5SZXNvbHZlcihzdGFjaywgJ0FkZFRlc3RSZXNvbHZlcicsIHtcbiAgYXBpLFxuICB0eXBlTmFtZTogJ011dGF0aW9uJyxcbiAgZmllbGROYW1lOiAnYWRkVGVzdCcsXG4gIGNvZGU6IGFwcHN5bmMuQ29kZS5mcm9tQXNzZXQocGF0aC5qb2luKFxuICAgIF9fZGlybmFtZSxcbiAgICAnaW50ZWctYXNzZXRzJyxcbiAgICAnYXBwc3luYy1qcy1waXBlbGluZScsXG4gICksIHtcbiAgICBidW5kbGluZzoge1xuICAgICAgaW1hZ2U6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xOF9YLmJ1bmRsaW5nSW1hZ2UsXG4gICAgICBjb21tYW5kOiBbJ2NwJywgJy1hJywgJy9hc3NldC1pbnB1dC8uJywgJy9hc3NldC1vdXRwdXQvJ10sXG4gICAgICBvdXRwdXRUeXBlOiBjZGsuQnVuZGxpbmdPdXRwdXQuRklMRSxcbiAgICB9LFxuICB9KSxcbiAgcnVudGltZTogYXBwc3luYy5GdW5jdGlvblJ1bnRpbWUuSlNfMV8wXzAsXG4gIHBpcGVsaW5lQ29uZmlnOiBbYWRkVGVzdEZ1bmNdLFxufSk7XG5cbmNvbnN0IGludGVnID0gbmV3IEludGVnVGVzdChhcHAsICdKc1Jlc29sdmVySW50ZWdUZXN0JywgeyB0ZXN0Q2FzZXM6IFtzdGFja10gfSk7XG5cbi8qKlxuICogSGFuZGxlciB0aGF0IGNhbGxzIG91ciBhcGkgd2l0aCBhbiBgYWRkVGVzdGAgTXV0YXRpb25cbiAqL1xuY29uc3QgaW52b2tlID0gbmV3IGxhbWJkYS5GdW5jdGlvbihzdGFjaywgJ0ludm9rZUFwaScsIHtcbiAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUFzc2V0KHBhdGguam9pbihfX2Rpcm5hbWUsICdpbnRlZy1hc3NldHMvanMtcmVzb2x2ZXItYXNzZXJ0aW9uJykpLFxuICBoYW5kbGVyOiAnaW5kZXguaGFuZGxlcicsXG4gIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xOF9YLFxufSk7XG5cbmNvbnN0IGFkZFRlc3RJbnZva2UgPSBpbnRlZy5hc3NlcnRpb25zLmludm9rZUZ1bmN0aW9uKHtcbiAgZnVuY3Rpb25OYW1lOiBpbnZva2UuZnVuY3Rpb25OYW1lLFxuICBwYXlsb2FkOiBKU09OLnN0cmluZ2lmeSh7XG4gICAgaG9zdG5hbWU6IGFwaS5ncmFwaHFsVXJsLFxuICAgIGFwaUtleTogYXBpLmFwaUtleSxcbiAgfSksXG59KTtcblxuLyoqXG4gKiBBc3NlcnQgcmVzdWx0IHJldHVybmVkIG9uIEFQSSBoYXMgYSBnZW5lcmF0ZWQgSUQgYW5kIHRoZSBwYXNzZWQgbmFtZS5cbiAqL1xuYWRkVGVzdEludm9rZS5hc3NlcnRBdFBhdGgoXG4gICdQYXlsb2FkLmRhdGEuYWRkVGVzdC5uYW1lJyxcbiAgRXhwZWN0ZWRSZXN1bHQuc3RyaW5nTGlrZVJlZ2V4cCgnMTIzJyksXG4pO1xuXG5hZGRUZXN0SW52b2tlLmFzc2VydEF0UGF0aChcbiAgJ1BheWxvYWQuZGF0YS5hZGRUZXN0LmlkJyxcbiAgRXhwZWN0ZWRSZXN1bHQuc3RyaW5nTGlrZVJlZ2V4cCgnLisnKSxcbik7XG5cbi8qKlxuICogR2VuZXJhdGVkIElEIG9mIHRoZSBpdGVtIGFkZGVkIGluIHRoZSBwcmV2aW91cyBoYW5kbGVyXG4gKi9cbmNvbnN0IGFkZFRlc3RSZXN1bHRJZCA9IGFkZFRlc3RJbnZva2UuZ2V0QXR0U3RyaW5nKCdQYXlsb2FkLmRhdGEuYWRkVGVzdC5pZCcpO1xuXG4vKipcbiAqIFRyeSB0byBmaW5kIHRoZSBpdGVtIGFkZGVkIGluIHRoZSBEeW5hbW9EQiBkYXRhIHNvdXJjZS5cbiAqL1xuY29uc3QgZ2V0SXRlbUNhbGwgPSBpbnRlZy5hc3NlcnRpb25zLmF3c0FwaUNhbGwoJ0R5bmFtb0RCJywgJ2dldEl0ZW0nLCB7XG4gIFRhYmxlTmFtZTogZGIudGFibGVOYW1lLFxuICBLZXk6IHtcbiAgICBpZDoge1xuICAgICAgUzogYWRkVGVzdFJlc3VsdElkLFxuICAgIH0sXG4gIH0sXG59KTtcblxuZ2V0SXRlbUNhbGwuZXhwZWN0KEV4cGVjdGVkUmVzdWx0Lm9iamVjdExpa2Uoe1xuICBJdGVtOiB7XG4gICAgbmFtZToge1xuICAgICAgUzogJzEyMycsXG4gICAgfSxcbiAgICBpZDoge1xuICAgICAgUzogYWRkVGVzdFJlc3VsdElkLFxuICAgIH0sXG4gIH0sXG59KSk7XG4iXX0=