"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const dynamodb = require("aws-cdk-lib/aws-dynamodb");
const lambda = require("aws-cdk-lib/aws-lambda");
const logs = require("aws-cdk-lib/aws-logs");
const cdk = require("aws-cdk-lib");
const integ_tests_alpha_1 = require("@aws-cdk/integ-tests-alpha");
const appsync = require("aws-cdk-lib/aws-appsync");
const app = new cdk.App();
const stack = new cdk.Stack(app, 'AppSyncJsResolverTestStack');
const logConfig = {
    retention: logs.RetentionDays.ONE_WEEK,
};
const api = new appsync.GraphqlApi(stack, 'JsResolverApi', {
    name: 'JsResolverApi',
    schema: appsync.SchemaFile.fromAsset(path.join(__dirname, 'appsync.js-resolver.graphql')),
    logConfig,
});
const db = new dynamodb.Table(stack, 'DynamoTable', {
    partitionKey: {
        name: 'id',
        type: dynamodb.AttributeType.STRING,
    },
    removalPolicy: cdk.RemovalPolicy.DESTROY,
});
const dataSource = api.addDynamoDbDataSource('DynamoDataSource', db);
const addTestFunc = dataSource.createFunction('AddTestFunction', {
    name: 'addTestFunc',
    runtime: appsync.FunctionRuntime.JS_1_0_0,
    code: appsync.Code.fromAsset(path.join(__dirname, 'integ-assets', 'appsync-js-resolver'), {
        bundling: {
            image: lambda.Runtime.NODEJS_18_X.bundlingImage,
            command: ['cp', '-a', '/asset-input/.', '/asset-output/'],
            outputType: cdk.BundlingOutput.FILE,
        },
    }),
});
new appsync.Resolver(stack, 'AddTestResolver', {
    api,
    typeName: 'Mutation',
    fieldName: 'addTest',
    code: appsync.Code.fromAsset(path.join(__dirname, 'integ-assets', 'appsync-js-pipeline'), {
        bundling: {
            image: lambda.Runtime.NODEJS_18_X.bundlingImage,
            command: ['cp', '-a', '/asset-input/.', '/asset-output/'],
            outputType: cdk.BundlingOutput.FILE,
        },
    }),
    runtime: appsync.FunctionRuntime.JS_1_0_0,
    pipelineConfig: [addTestFunc],
});
const integ = new integ_tests_alpha_1.IntegTest(app, 'JsResolverIntegTest', { testCases: [stack] });
/**
 * Handler that calls our api with an `addTest` Mutation
 */
const invoke = new lambda.Function(stack, 'InvokeApi', {
    code: lambda.Code.fromAsset(path.join(__dirname, 'integ-assets/js-resolver-assertion')),
    handler: 'index.handler',
    runtime: lambda.Runtime.NODEJS_18_X,
});
const addTestInvoke = integ.assertions.invokeFunction({
    functionName: invoke.functionName,
    payload: JSON.stringify({
        hostname: api.graphqlUrl,
        apiKey: api.apiKey,
    }),
});
/**
 * Assert result returned on API has a generated ID and the passed name.
 */
addTestInvoke.assertAtPath('Payload.data.addTest.name', integ_tests_alpha_1.ExpectedResult.stringLikeRegexp('123'));
addTestInvoke.assertAtPath('Payload.data.addTest.id', integ_tests_alpha_1.ExpectedResult.stringLikeRegexp('.+'));
/**
 * Generated ID of the item added in the previous handler
 */
const addTestResultId = addTestInvoke.getAttString('Payload.data.addTest.id');
/**
 * Try to find the item added in the DynamoDB data source.
 */
const getItemCall = integ.assertions.awsApiCall('DynamoDB', 'getItem', {
    TableName: db.tableName,
    Key: {
        id: {
            S: addTestResultId,
        },
    },
});
getItemCall.expect(integ_tests_alpha_1.ExpectedResult.objectLike({
    Item: {
        name: {
            S: '123',
        },
        id: {
            S: addTestResultId,
        },
    },
}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW50ZWcuanMtcmVzb2x2ZXItYnVuZGxlZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImludGVnLmpzLXJlc29sdmVyLWJ1bmRsZWQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw2QkFBNkI7QUFDN0IscURBQXFEO0FBQ3JELGlEQUFpRDtBQUNqRCw2Q0FBNkM7QUFDN0MsbUNBQW1DO0FBQ25DLGtFQUF1RTtBQUN2RSxtREFBbUQ7QUFFbkQsTUFBTSxHQUFHLEdBQUcsSUFBSSxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUM7QUFDMUIsTUFBTSxLQUFLLEdBQUcsSUFBSSxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSw0QkFBNEIsQ0FBQyxDQUFDO0FBRS9ELE1BQU0sU0FBUyxHQUFzQjtJQUNuQyxTQUFTLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRO0NBQ3ZDLENBQUM7QUFFRixNQUFNLEdBQUcsR0FBRyxJQUFJLE9BQU8sQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLGVBQWUsRUFBRTtJQUN6RCxJQUFJLEVBQUUsZUFBZTtJQUNyQixNQUFNLEVBQUUsT0FBTyxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsNkJBQTZCLENBQUMsQ0FBQztJQUN6RixTQUFTO0NBQ1YsQ0FBQyxDQUFDO0FBRUgsTUFBTSxFQUFFLEdBQUcsSUFBSSxRQUFRLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxhQUFhLEVBQUU7SUFDbEQsWUFBWSxFQUFFO1FBQ1osSUFBSSxFQUFFLElBQUk7UUFDVixJQUFJLEVBQUUsUUFBUSxDQUFDLGFBQWEsQ0FBQyxNQUFNO0tBQ3BDO0lBQ0QsYUFBYSxFQUFFLEdBQUcsQ0FBQyxhQUFhLENBQUMsT0FBTztDQUN6QyxDQUFDLENBQUM7QUFFSCxNQUFNLFVBQVUsR0FBRyxHQUFHLENBQUMscUJBQXFCLENBQUMsa0JBQWtCLEVBQUUsRUFBRSxDQUFDLENBQUM7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QUFFLEVBQUUsQ0FBQyxTQUFTO0lBQ3ZCLEdBQUcsRUFBRTtRQUNILEVBQUUsRUFBRTtZQUNGLENBQUMsRUFBRSxlQUFlO1NBQ25CO0tBQ0Y7Q0FDRixDQUFDLENBQUM7QUFFSCxXQUFXLENBQUMsTUFBTSxDQUFDLGtDQUFjLENBQUMsVUFBVSxDQUFDO0lBQzNDLElBQUksRUFBRTtRQUNKLElBQUksRUFBRTtZQUNKLENBQUMsRUFBRSxLQUFLO1NBQ1Q7UUFDRCxFQUFFLEVBQUU7WUFDRixDQUFDLEVBQUUsZUFBZTtTQUNuQjtLQUNGO0NBQ0YsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0ICogYXMgZHluYW1vZGIgZnJvbSAnYXdzLWNkay1saWIvYXdzLWR5bmFtb2RiJztcbmltcG9ydCAqIGFzIGxhbWJkYSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtbGFtYmRhJztcbmltcG9ydCAqIGFzIGxvZ3MgZnJvbSAnYXdzLWNkay1saWIvYXdzLWxvZ3MnO1xuaW1wb3J0ICogYXMgY2RrIGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCB7IEludGVnVGVzdCwgRXhwZWN0ZWRSZXN1bHQgfSBmcm9tICdAYXdzLWNkay9pbnRlZy10ZXN0cy1hbHBoYSc7XG5pbXBvcnQgKiBhcyBhcHBzeW5jIGZyb20gJ2F3cy1jZGstbGliL2F3cy1hcHBzeW5jJztcblxuY29uc3QgYXBwID0gbmV3IGNkay5BcHAoKTtcbmNvbnN0IHN0YWNrID0gbmV3IGNkay5TdGFjayhhcHAsICdBcHBTeW5jSnNSZXNvbHZlclRlc3RTdGFjaycpO1xuXG5jb25zdCBsb2dDb25maWc6IGFwcHN5bmMuTG9nQ29uZmlnID0ge1xuICByZXRlbnRpb246IGxvZ3MuUmV0ZW50aW9uRGF5cy5PTkVfV0VFSyxcbn07XG5cbmNvbnN0IGFwaSA9IG5ldyBhcHBzeW5jLkdyYXBocWxBcGkoc3RhY2ssICdKc1Jlc29sdmVyQXBpJywge1xuICBuYW1lOiAnSnNSZXNvbHZlckFwaScsXG4gIHNjaGVtYTogYXBwc3luYy5TY2hlbWFGaWxlLmZyb21Bc3NldChwYXRoLmpvaW4oX19kaXJuYW1lLCAnYXBwc3luYy5qcy1yZXNvbHZlci5ncmFwaHFsJykpLFxuICBsb2dDb25maWcsXG59KTtcblxuY29uc3QgZGIgPSBuZXcgZHluYW1vZGIuVGFibGUoc3RhY2ssICdEeW5hbW9UYWJsZScsIHtcbiAgcGFydGl0aW9uS2V5OiB7XG4gICAgbmFtZTogJ2lkJyxcbiAgICB0eXBlOiBkeW5hbW9kYi5BdHRyaWJ1dGVUeXBlLlNUUklORyxcbiAgfSxcbiAgcmVtb3ZhbFBvbGljeTogY2RrLlJlbW92YWxQb2xpY3kuREVTVFJPWSxcbn0pO1xuXG5jb25zdCBkYXRhU291cmNlID0gYXBpLmFkZER5bmFtb0RiRGF0YVNvdXJjZSgnRHluYW1vRGF0YVNvdXJjZScsIGRiKTtcblxuY29uc3QgYWRkVGVzdEZ1bmMgPSBkYXRhU291cmNlLmNyZWF0ZUZ1bmN0aW9uKCdBZGRUZXN0RnVuY3Rpb24nLCB7XG4gIG5hbWU6ICdhZGRUZXN0RnVuYycsXG4gIHJ1bnRpbWU6IGFwcHN5bmMuRnVuY3Rpb25SdW50aW1lLkpTXzFfMF8wLFxuICBjb2RlOiBhcHBzeW5jLkNvZGUuZnJvbUFzc2V0KHBhdGguam9pbihcbiAgICBfX2Rpcm5hbWUsXG4gICAgJ2ludGVnLWFzc2V0cycsXG4gICAgJ2FwcHN5bmMtanMtcmVzb2x2ZXInLFxuICApLCB7XG4gICAgYnVuZGxpbmc6IHtcbiAgICAgIGltYWdlOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMThfWC5idW5kbGluZ0ltYWdlLFxuICAgICAgY29tbWFuZDogWydjcCcsICctYScsICcvYXNzZXQtaW5wdXQvLicsICcvYXNzZXQtb3V0cHV0LyddLFxuICAgICAgb3V0cHV0VHlwZTogY2RrLkJ1bmRsaW5nT3V0cHV0LkZJTEUsXG4gICAgfSxcbiAgfSksXG59KTtcblxubmV3IGFwcHN5bmMuUmVzb2x2ZXIoc3RhY2ssICdBZGRUZXN0UmVzb2x2ZXInLCB7XG4gIGFwaSxcbiAgdHlwZU5hbWU6ICdNdXRhdGlvbicsXG4gIGZpZWxkTmFtZTogJ2FkZFRlc3QnLFxuICBjb2RlOiBhcHBzeW5jLkNvZGUuZnJvbUFzc2V0KHBhdGguam9pbihcbiAgICBfX2Rpcm5hbWUsXG4gICAgJ2ludGVnLWFzc2V0cycsXG4gICAgJ2FwcHN5bmMtanMtcGlwZWxpbmUnLFxuICApLCB7XG4gICAgYnVuZGxpbmc6IHtcbiAgICAgIGltYWdlOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMThfWC5idW5kbGluZ0ltYWdlLFxuICAgICAgY29tbWFuZDogWydjcCcsICctYScsICcvYXNzZXQtaW5wdXQvLicsICcvYXNzZXQtb3V0cHV0LyddLFxuICAgICAgb3V0cHV0VHlwZTogY2RrLkJ1bmRsaW5nT3V0cHV0LkZJTEUsXG4gICAgfSxcbiAgfSksXG4gIHJ1bnRpbWU6IGFwcHN5bmMuRnVuY3Rpb25SdW50aW1lLkpTXzFfMF8wLFxuICBwaXBlbGluZUNvbmZpZzogW2FkZFRlc3RGdW5jXSxcbn0pO1xuXG5jb25zdCBpbnRlZyA9IG5ldyBJbnRlZ1Rlc3QoYXBwLCAnSnNSZXNvbHZlckludGVnVGVzdCcsIHsgdGVzdENhc2VzOiBbc3RhY2tdIH0pO1xuXG4vKipcbiAqIEhhbmRsZXIgdGhhdCBjYWxscyBvdXIgYXBpIHdpdGggYW4gYGFkZFRlc3RgIE11dGF0aW9uXG4gKi9cbmNvbnN0IGludm9rZSA9IG5ldyBsYW1iZGEuRnVuY3Rpb24oc3RhY2ssICdJbnZva2VBcGknLCB7XG4gIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21Bc3NldChwYXRoLmpvaW4oX19kaXJuYW1lLCAnaW50ZWctYXNzZXRzL2pzLXJlc29sdmVyLWFzc2VydGlvbicpKSxcbiAgaGFuZGxlcjogJ2luZGV4LmhhbmRsZXInLFxuICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMThfWCxcbn0pO1xuXG5jb25zdCBhZGRUZXN0SW52b2tlID0gaW50ZWcuYXNzZXJ0aW9ucy5pbnZva2VGdW5jdGlvbih7XG4gIGZ1bmN0aW9uTmFtZTogaW52b2tlLmZ1bmN0aW9uTmFtZSxcbiAgcGF5bG9hZDogSlNPTi5zdHJpbmdpZnkoe1xuICAgIGhvc3RuYW1lOiBhcGkuZ3JhcGhxbFVybCxcbiAgICBhcGlLZXk6IGFwaS5hcGlLZXksXG4gIH0pLFxufSk7XG5cbi8qKlxuICogQXNzZXJ0IHJlc3VsdCByZXR1cm5lZCBvbiBBUEkgaGFzIGEgZ2VuZXJhdGVkIElEIGFuZCB0aGUgcGFzc2VkIG5hbWUuXG4gKi9cbmFkZFRlc3RJbnZva2UuYXNzZXJ0QXRQYXRoKFxuICAnUGF5bG9hZC5kYXRhLmFkZFRlc3QubmFtZScsXG4gIEV4cGVjdGVkUmVzdWx0LnN0cmluZ0xpa2VSZWdleHAoJzEyMycpLFxuKTtcblxuYWRkVGVzdEludm9rZS5hc3NlcnRBdFBhdGgoXG4gICdQYXlsb2FkLmRhdGEuYWRkVGVzdC5pZCcsXG4gIEV4cGVjdGVkUmVzdWx0LnN0cmluZ0xpa2VSZWdleHAoJy4rJyksXG4pO1xuXG4vKipcbiAqIEdlbmVyYXRlZCBJRCBvZiB0aGUgaXRlbSBhZGRlZCBpbiB0aGUgcHJldmlvdXMgaGFuZGxlclxuICovXG5jb25zdCBhZGRUZXN0UmVzdWx0SWQgPSBhZGRUZXN0SW52b2tlLmdldEF0dFN0cmluZygnUGF5bG9hZC5kYXRhLmFkZFRlc3QuaWQnKTtcblxuLyoqXG4gKiBUcnkgdG8gZmluZCB0aGUgaXRlbSBhZGRlZCBpbiB0aGUgRHluYW1vREIgZGF0YSBzb3VyY2UuXG4gKi9cbmNvbnN0IGdldEl0ZW1DYWxsID0gaW50ZWcuYXNzZXJ0aW9ucy5hd3NBcGlDYWxsKCdEeW5hbW9EQicsICdnZXRJdGVtJywge1xuICBUYWJsZU5hbWU6IGRiLnRhYmxlTmFtZSxcbiAgS2V5OiB7XG4gICAgaWQ6IHtcbiAgICAgIFM6IGFkZFRlc3RSZXN1bHRJZCxcbiAgICB9LFxuICB9LFxufSk7XG5cbmdldEl0ZW1DYWxsLmV4cGVjdChFeHBlY3RlZFJlc3VsdC5vYmplY3RMaWtlKHtcbiAgSXRlbToge1xuICAgIG5hbWU6IHtcbiAgICAgIFM6ICcxMjMnLFxuICAgIH0sXG4gICAgaWQ6IHtcbiAgICAgIFM6IGFkZFRlc3RSZXN1bHRJZCxcbiAgICB9LFxuICB9LFxufSkpO1xuIl19