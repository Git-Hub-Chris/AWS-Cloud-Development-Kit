"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assertions_1 = require("@aws-cdk/assertions");
const aws_iam_1 = require("@aws-cdk/aws-iam");
const core_1 = require("@aws-cdk/core");
const constructs_1 = require("constructs");
const alias_1 = require("../lib/alias");
const key_1 = require("../lib/key");
test('default alias', () => {
    const app = new core_1.App();
    const stack = new core_1.Stack(app, 'Test');
    const key = new key_1.Key(stack, 'Key');
    new alias_1.Alias(stack, 'Alias', { targetKey: key, aliasName: 'alias/foo' });
    assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::KMS::Alias', {
        AliasName: 'alias/foo',
        TargetKeyId: { 'Fn::GetAtt': ['Key961B73FD', 'Arn'] },
    });
});
test('add "alias/" prefix if not given.', () => {
    const app = new core_1.App();
    const stack = new core_1.Stack(app, 'Test');
    const key = new key_1.Key(stack, 'Key', {
        enableKeyRotation: true,
        enabled: false,
    });
    new alias_1.Alias(stack, 'Alias', {
        aliasName: 'foo',
        targetKey: key,
    });
    assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::KMS::Alias', {
        AliasName: 'alias/foo',
        TargetKeyId: { 'Fn::GetAtt': ['Key961B73FD', 'Arn'] },
    });
});
test('can create alias directly while creating the key', () => {
    const app = new core_1.App();
    const stack = new core_1.Stack(app, 'Test');
    new key_1.Key(stack, 'Key', {
        enableKeyRotation: true,
        enabled: false,
        alias: 'foo',
    });
    assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::KMS::Alias', {
        AliasName: 'alias/foo',
        TargetKeyId: { 'Fn::GetAtt': ['Key961B73FD', 'Arn'] },
    });
});
test('fails if alias is "alias/" (and nothing more)', () => {
    const app = new core_1.App();
    const stack = new core_1.Stack(app, 'Test');
    const key = new key_1.Key(stack, 'MyKey', {
        enableKeyRotation: true,
        enabled: false,
    });
    expect(() => new alias_1.Alias(stack, 'Alias', {
        aliasName: 'alias/',
        targetKey: key,
    })).toThrow(/Alias must include a value after/);
});
test('fails if alias contains illegal characters', () => {
    const app = new core_1.App();
    const stack = new core_1.Stack(app, 'Test');
    const key = new key_1.Key(stack, 'MyKey', {
        enableKeyRotation: true,
        enabled: false,
    });
    expect(() => new alias_1.Alias(stack, 'Alias', {
        aliasName: 'alias/@Nope',
        targetKey: key,
    })).toThrow('a-zA-Z0-9:/_-');
});
test('fails if alias starts with "alias/aws/"', () => {
    const app = new core_1.App();
    const stack = new core_1.Stack(app, 'Test');
    const key = new key_1.Key(stack, 'MyKey', {
        enableKeyRotation: true,
        enabled: false,
    });
    expect(() => new alias_1.Alias(stack, 'Alias1', {
        aliasName: 'alias/aws/',
        targetKey: key,
    })).toThrow(/Alias cannot start with alias\/aws\/: alias\/aws\//);
    expect(() => new alias_1.Alias(stack, 'Alias2', {
        aliasName: 'alias/aws/Awesome',
        targetKey: key,
    })).toThrow(/Alias cannot start with alias\/aws\/: alias\/aws\/Awesome/);
    expect(() => new alias_1.Alias(stack, 'Alias3', {
        aliasName: 'alias/AWS/awesome',
        targetKey: key,
    })).toThrow(/Alias cannot start with alias\/aws\/: alias\/AWS\/awesome/);
});
test('can be used wherever a key is expected', () => {
    const stack = new core_1.Stack();
    const myKey = new key_1.Key(stack, 'MyKey', {
        enableKeyRotation: true,
        enabled: false,
    });
    const myAlias = new alias_1.Alias(stack, 'MyAlias', {
        targetKey: myKey,
        aliasName: 'alias/myAlias',
    });
    /* eslint-disable @aws-cdk/no-core-construct */
    class MyConstruct extends constructs_1.Construct {
        constructor(scope, id, key) {
            super(scope, id);
            new core_1.CfnOutput(stack, 'OutId', {
                value: key.keyId,
            });
            new core_1.CfnOutput(stack, 'OutArn', {
                value: key.keyArn,
            });
        }
    }
    new MyConstruct(stack, 'MyConstruct', myAlias);
    /* eslint-enable @aws-cdk/no-core-construct */
    assertions_1.Template.fromStack(stack).hasOutput('OutId', {
        Value: 'alias/myAlias',
    });
    assertions_1.Template.fromStack(stack).hasOutput('OutArn', {
        Value: {
            'Fn::Join': ['', [
                    'arn:',
                    { Ref: 'AWS::Partition' },
                    ':kms:',
                    { Ref: 'AWS::Region' },
                    ':',
                    { Ref: 'AWS::AccountId' },
                    ':alias/myAlias',
                ]],
        },
    });
});
test('imported alias by name - can be used where a key is expected', () => {
    const stack = new core_1.Stack();
    const myAlias = alias_1.Alias.fromAliasName(stack, 'MyAlias', 'alias/myAlias');
    /* eslint-disable @aws-cdk/no-core-construct */
    class MyConstruct extends constructs_1.Construct {
        constructor(scope, id, key) {
            super(scope, id);
            new core_1.CfnOutput(stack, 'OutId', {
                value: key.keyId,
            });
            new core_1.CfnOutput(stack, 'OutArn', {
                value: key.keyArn,
            });
        }
    }
    new MyConstruct(stack, 'MyConstruct', myAlias);
    /* eslint-enable @aws-cdk/no-core-construct */
    assertions_1.Template.fromStack(stack).hasOutput('OutId', {
        Value: 'alias/myAlias',
    });
    assertions_1.Template.fromStack(stack).hasOutput('OutArn', {
        Value: {
            'Fn::Join': ['', [
                    'arn:',
                    { Ref: 'AWS::Partition' },
                    ':kms:',
                    { Ref: 'AWS::Region' },
                    ':',
                    { Ref: 'AWS::AccountId' },
                    ':alias/myAlias',
                ]],
        },
    });
});
test('imported alias by name - will throw an error when accessing the key', () => {
    const stack = new core_1.Stack();
    const myAlias = alias_1.Alias.fromAliasName(stack, 'MyAlias', 'alias/myAlias');
    expect(() => myAlias.aliasTargetKey).toThrow('Cannot access aliasTargetKey on an Alias imported by Alias.fromAliasName().');
});
test('fails if alias policy is invalid', () => {
    const app = new core_1.App();
    const stack = new core_1.Stack(app, 'my-stack');
    const key = new key_1.Key(stack, 'MyKey');
    const alias = new alias_1.Alias(stack, 'Alias', { targetKey: key, aliasName: 'alias/foo' });
    alias.addToResourcePolicy(new aws_iam_1.PolicyStatement({
        resources: ['*'],
        principals: [new aws_iam_1.ArnPrincipal('arn')],
    }));
    expect(() => app.synth()).toThrow(/A PolicyStatement must specify at least one \'action\' or \'notAction\'/);
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWxpYXMudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImFsaWFzLnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxvREFBK0M7QUFDL0MsOENBQWlFO0FBQ2pFLHdDQUFzRDtBQUN0RCwyQ0FBdUM7QUFDdkMsd0NBQXFDO0FBQ3JDLG9DQUF1QztBQUV2QyxJQUFJLENBQUMsZUFBZSxFQUFFLEdBQUcsRUFBRTtJQUN6QixNQUFNLEdBQUcsR0FBRyxJQUFJLFVBQUcsRUFBRSxDQUFDO0lBQ3RCLE1BQU0sS0FBSyxHQUFHLElBQUksWUFBSyxDQUFDLEdBQUcsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUNyQyxNQUFNLEdBQUcsR0FBRyxJQUFJLFNBQUcsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFFbEMsSUFBSSxhQUFLLENBQUMsS0FBSyxFQUFFLE9BQU8sRUFBRSxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLFdBQVcsRUFBRSxDQUFDLENBQUM7SUFFdEUscUJBQVEsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMscUJBQXFCLENBQUMsaUJBQWlCLEVBQUU7UUFDakUsU0FBUyxFQUFFLFdBQVc7UUFDdEIsV0FBVyxFQUFFLEVBQUUsWUFBWSxFQUFFLENBQUMsYUFBYSxFQUFFLEtBQUssQ0FBQyxFQUFFO0tBQ3RELENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDO0FBRUgsSUFBSSxDQUFDLG1DQUFtQyxFQUFFLEdBQUcsRUFBRTtJQUM3QyxNQUFNLEdBQUcsR0FBRyxJQUFJLFVBQUcsRUFBRSxDQUFDO0lBQ3RCLE1BQU0sS0FBSyxHQUFHLElBQUksWUFBSyxDQUFDLEdBQUcsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUVyQyxNQUFNLEdBQUcsR0FBRyxJQUFJLFNBQUcsQ0FBQyxLQUFLLEVBQUUsS0FBSyxFQUFFO1FBQ2hDLGlCQUFpQixFQUFFLElBQUk7UUFDdkIsT0FBTyxFQUFFLEtBQUs7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QyxDQUFDO0lBRXZFLE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDLENBQUMsT0FBTyxDQUFDLDZFQUE2RSxDQUFDLENBQUM7QUFDOUgsQ0FBQyxDQUFDLENBQUM7QUFFSCxJQUFJLENBQUMsa0NBQWtDLEVBQUUsR0FBRyxFQUFFO0lBQzVDLE1BQU0sR0FBRyxHQUFHLElBQUksVUFBRyxFQUFFLENBQUM7SUFDdEIsTUFBTSxLQUFLLEdBQUcsSUFBSSxZQUFLLENBQUMsR0FBRyxFQUFFLFVBQVUsQ0FBQyxDQUFDO0lBQ3pDLE1BQU0sR0FBRyxHQUFHLElBQUksU0FBRyxDQUFDLEtBQUssRUFBRSxPQUFPLENBQUMsQ0FBQztJQUNwQyxNQUFNLEtBQUssR0FBRyxJQUFJLGFBQUssQ0FBQyxLQUFLLEVBQUUsT0FBTyxFQUFFLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsV0FBVyxFQUFFLENBQUMsQ0FBQztJQUVwRixLQUFLLENBQUMsbUJBQW1CLENBQUMsSUFBSSx5QkFBZSxDQUFDO1FBQzVDLFNBQVMsRUFBRSxDQUFDLEdBQUcsQ0FBQztRQUNoQixVQUFVLEVBQUUsQ0FBQyxJQUFJLHNCQUFZLENBQUMsS0FBSyxDQUFDLENBQUM7S0FDdEMsQ0FBQyxDQUFDLENBQUM7SUFFSixNQUFNLENBQUMsR0FBRyxFQUFFLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLHlFQUF5RSxDQUFDLENBQUM7QUFDL0csQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUZW1wbGF0ZSB9IGZyb20gJ0Bhd3MtY2RrL2Fzc2VydGlvbnMnO1xuaW1wb3J0IHsgQXJuUHJpbmNpcGFsLCBQb2xpY3lTdGF0ZW1lbnQgfSBmcm9tICdAYXdzLWNkay9hd3MtaWFtJztcbmltcG9ydCB7IEFwcCwgQ2ZuT3V0cHV0LCBTdGFjayB9IGZyb20gJ0Bhd3MtY2RrL2NvcmUnO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5pbXBvcnQgeyBBbGlhcyB9IGZyb20gJy4uL2xpYi9hbGlhcyc7XG5pbXBvcnQgeyBJS2V5LCBLZXkgfSBmcm9tICcuLi9saWIva2V5JztcblxudGVzdCgnZGVmYXVsdCBhbGlhcycsICgpID0+IHtcbiAgY29uc3QgYXBwID0gbmV3IEFwcCgpO1xuICBjb25zdCBzdGFjayA9IG5ldyBTdGFjayhhcHAsICdUZXN0Jyk7XG4gIGNvbnN0IGtleSA9IG5ldyBLZXkoc3RhY2ssICdLZXknKTtcblxuICBuZXcgQWxpYXMoc3RhY2ssICdBbGlhcycsIHsgdGFyZ2V0S2V5OiBrZXksIGFsaWFzTmFtZTogJ2FsaWFzL2ZvbycgfSk7XG5cbiAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6S01TOjpBbGlhcycsIHtcbiAgICBBbGlhc05hbWU6ICdhbGlhcy9mb28nLFxuICAgIFRhcmdldEtleUlkOiB7ICdGbjo6R2V0QXR0JzogWydLZXk5NjFCNzNGRCcsICdBcm4nXSB9LFxuICB9KTtcbn0pO1xuXG50ZXN0KCdhZGQgXCJhbGlhcy9cIiBwcmVmaXggaWYgbm90IGdpdmVuLicsICgpID0+IHtcbiAgY29uc3QgYXBwID0gbmV3IEFwcCgpO1xuICBjb25zdCBzdGFjayA9IG5ldyBTdGFjayhhcHAsICdUZXN0Jyk7XG5cbiAgY29uc3Qga2V5ID0gbmV3IEtleShzdGFjaywgJ0tleScsIHtcbiAgICBlbmFibGVLZXlSb3RhdGlvbjogdHJ1ZSxcbiAgICBlbmFibGVkOiBmYWxzZSxcbiAgfSk7XG5cbiAgbmV3IEFsaWFzKHN0YWNrLCAnQWxpYXMnLCB7XG4gICAgYWxpYXNOYW1lOiAnZm9vJyxcbiAgICB0YXJnZXRLZXk6IGtleSxcbiAgfSk7XG5cbiAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6S01TOjpBbGlhcycsIHtcbiAgICBBbGlhc05hbWU6ICdhbGlhcy9mb28nLFxuICAgIFRhcmdldEtleUlkOiB7ICdGbjo6R2V0QXR0JzogWydLZXk5NjFCNzNGRCcsICdBcm4nXSB9LFxuICB9KTtcbn0pO1xuXG50ZXN0KCdjYW4gY3JlYXRlIGFsaWFzIGRpcmVjdGx5IHdoaWxlIGNyZWF0aW5nIHRoZSBrZXknLCAoKSA9PiB7XG4gIGNvbnN0IGFwcCA9IG5ldyBBcHAoKTtcbiAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soYXBwLCAnVGVzdCcpO1xuXG4gIG5ldyBLZXkoc3RhY2ssICdLZXknLCB7XG4gICAgZW5hYmxlS2V5Um90YXRpb246IHRydWUsXG4gICAgZW5hYmxlZDogZmFsc2UsXG4gICAgYWxpYXM6ICdmb28nLFxuICB9KTtcblxuICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpLTVM6OkFsaWFzJywge1xuICAgIEFsaWFzTmFtZTogJ2FsaWFzL2ZvbycsXG4gICAgVGFyZ2V0S2V5SWQ6IHsgJ0ZuOjpHZXRBdHQnOiBbJ0tleTk2MUI3M0ZEJywgJ0FybiddIH0sXG4gIH0pO1xufSk7XG5cbnRlc3QoJ2ZhaWxzIGlmIGFsaWFzIGlzIFwiYWxpYXMvXCIgKGFuZCBub3RoaW5nIG1vcmUpJywgKCkgPT4ge1xuICBjb25zdCBhcHAgPSBuZXcgQXBwKCk7XG4gIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKGFwcCwgJ1Rlc3QnKTtcblxuICBjb25zdCBrZXkgPSBuZXcgS2V5KHN0YWNrLCAnTXlLZXknLCB7XG4gICAgZW5hYmxlS2V5Um90YXRpb246IHRydWUsXG4gICAgZW5hYmxlZDogZmFsc2UsXG4gIH0pO1xuXG4gIGV4cGVjdCgoKSA9PiBuZXcgQWxpYXMoc3RhY2ssICdBbGlhcycsIHtcbiAgICBhbGlhc05hbWU6ICdhbGlhcy8nLFxuICAgIHRhcmdldEtleToga2V5LFxuICB9KSkudG9UaHJvdygvQWxpYXMgbXVzdCBpbmNsdWRlIGEgdmFsdWUgYWZ0ZXIvKTtcbn0pO1xuXG50ZXN0KCdmYWlscyBpZiBhbGlhcyBjb250YWlucyBpbGxlZ2FsIGNoYXJhY3RlcnMnLCAoKSA9PiB7XG4gIGNvbnN0IGFwcCA9IG5ldyBBcHAoKTtcbiAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soYXBwLCAnVGVzdCcpO1xuXG4gIGNvbnN0IGtleSA9IG5ldyBLZXkoc3RhY2ssICdNeUtleScsIHtcbiAgICBlbmFibGVLZXlSb3RhdGlvbjogdHJ1ZSxcbiAgICBlbmFibGVkOiBmYWxzZSxcbiAgfSk7XG5cbiAgZXhwZWN0KCgpID0+IG5ldyBBbGlhcyhzdGFjaywgJ0FsaWFzJywge1xuICAgIGFsaWFzTmFtZTogJ2FsaWFzL0BOb3BlJyxcbiAgICB0YXJnZXRLZXk6IGtleSxcbiAgfSkpLnRvVGhyb3coJ2EtekEtWjAtOTovXy0nKTtcbn0pO1xuXG50ZXN0KCdmYWlscyBpZiBhbGlhcyBzdGFydHMgd2l0aCBcImFsaWFzL2F3cy9cIicsICgpID0+IHtcbiAgY29uc3QgYXBwID0gbmV3IEFwcCgpO1xuICBjb25zdCBzdGFjayA9IG5ldyBTdGFjayhhcHAsICdUZXN0Jyk7XG5cbiAgY29uc3Qga2V5ID0gbmV3IEtleShzdGFjaywgJ015S2V5Jywge1xuICAgIGVuYWJsZUtleVJvdGF0aW9uOiB0cnVlLFxuICAgIGVuYWJsZWQ6IGZhbHNlLFxuICB9KTtcblxuICBleHBlY3QoKCkgPT4gbmV3IEFsaWFzKHN0YWNrLCAnQWxpYXMxJywge1xuICAgIGFsaWFzTmFtZTogJ2FsaWFzL2F3cy8nLFxuICAgIHRhcmdldEtleToga2V5LFxuICB9KSkudG9UaHJvdygvQWxpYXMgY2Fubm90IHN0YXJ0IHdpdGggYWxpYXNcXC9hd3NcXC86IGFsaWFzXFwvYXdzXFwvLyk7XG5cbiAgZXhwZWN0KCgpID0+IG5ldyBBbGlhcyhzdGFjaywgJ0FsaWFzMicsIHtcbiAgICBhbGlhc05hbWU6ICdhbGlhcy9hd3MvQXdlc29tZScsXG4gICAgdGFyZ2V0S2V5OiBrZXksXG4gIH0pKS50b1Rocm93KC9BbGlhcyBjYW5ub3Qgc3RhcnQgd2l0aCBhbGlhc1xcL2F3c1xcLzogYWxpYXNcXC9hd3NcXC9Bd2Vzb21lLyk7XG5cbiAgZXhwZWN0KCgpID0+IG5ldyBBbGlhcyhzdGFjaywgJ0FsaWFzMycsIHtcbiAgICBhbGlhc05hbWU6ICdhbGlhcy9BV1MvYXdlc29tZScsXG4gICAgdGFyZ2V0S2V5OiBrZXksXG4gIH0pKS50b1Rocm93KC9BbGlhcyBjYW5ub3Qgc3RhcnQgd2l0aCBhbGlhc1xcL2F3c1xcLzogYWxpYXNcXC9BV1NcXC9hd2Vzb21lLyk7XG59KTtcblxudGVzdCgnY2FuIGJlIHVzZWQgd2hlcmV2ZXIgYSBrZXkgaXMgZXhwZWN0ZWQnLCAoKSA9PiB7XG4gIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKCk7XG5cbiAgY29uc3QgbXlLZXkgPSBuZXcgS2V5KHN0YWNrLCAnTXlLZXknLCB7XG4gICAgZW5hYmxlS2V5Um90YXRpb246IHRydWUsXG4gICAgZW5hYmxlZDogZmFsc2UsXG4gIH0pO1xuICBjb25zdCBteUFsaWFzID0gbmV3IEFsaWFzKHN0YWNrLCAnTXlBbGlhcycsIHtcbiAgICB0YXJnZXRLZXk6IG15S2V5LFxuICAgIGFsaWFzTmFtZTogJ2FsaWFzL215QWxpYXMnLFxuICB9KTtcblxuICAvKiBlc2xpbnQtZGlzYWJsZSBAYXdzLWNkay9uby1jb3JlLWNvbnN0cnVjdCAqL1xuICBjbGFzcyBNeUNvbnN0cnVjdCBleHRlbmRzIENvbnN0cnVjdCB7XG4gICAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywga2V5OiBJS2V5KSB7XG4gICAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgICBuZXcgQ2ZuT3V0cHV0KHN0YWNrLCAnT3V0SWQnLCB7XG4gICAgICAgIHZhbHVlOiBrZXkua2V5SWQsXG4gICAgICB9KTtcbiAgICAgIG5ldyBDZm5PdXRwdXQoc3RhY2ssICdPdXRBcm4nLCB7XG4gICAgICAgIHZhbHVlOiBrZXkua2V5QXJuLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG4gIG5ldyBNeUNvbnN0cnVjdChzdGFjaywgJ015Q29uc3RydWN0JywgbXlBbGlhcyk7XG4gIC8qIGVzbGludC1lbmFibGUgQGF3cy1jZGsvbm8tY29yZS1jb25zdHJ1Y3QgKi9cblxuICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc091dHB1dCgnT3V0SWQnLCB7XG4gICAgVmFsdWU6ICdhbGlhcy9teUFsaWFzJyxcbiAgfSk7XG4gIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzT3V0cHV0KCdPdXRBcm4nLCB7XG4gICAgVmFsdWU6IHtcbiAgICAgICdGbjo6Sm9pbic6IFsnJywgW1xuICAgICAgICAnYXJuOicsXG4gICAgICAgIHsgUmVmOiAnQVdTOjpQYXJ0aXRpb24nIH0sXG4gICAgICAgICc6a21zOicsXG4gICAgICAgIHsgUmVmOiAnQVdTOjpSZWdpb24nIH0sXG4gICAgICAgICc6JyxcbiAgICAgICAgeyBSZWY6ICdBV1M6OkFjY291bnRJZCcgfSxcbiAgICAgICAgJzphbGlhcy9teUFsaWFzJyxcbiAgICAgIF1dLFxuICAgIH0sXG4gIH0pO1xufSk7XG5cbnRlc3QoJ2ltcG9ydGVkIGFsaWFzIGJ5IG5hbWUgLSBjYW4gYmUgdXNlZCB3aGVyZSBhIGtleSBpcyBleHBlY3RlZCcsICgpID0+IHtcbiAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soKTtcblxuICBjb25zdCBteUFsaWFzID0gQWxpYXMuZnJvbUFsaWFzTmFtZShzdGFjaywgJ015QWxpYXMnLCAnYWxpYXMvbXlBbGlhcycpO1xuXG4gIC8qIGVzbGludC1kaXNhYmxlIEBhd3MtY2RrL25vLWNvcmUtY29uc3RydWN0ICovXG4gIGNsYXNzIE15Q29uc3RydWN0IGV4dGVuZHMgQ29uc3RydWN0IHtcbiAgICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBrZXk6IElLZXkpIHtcbiAgICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICAgIG5ldyBDZm5PdXRwdXQoc3RhY2ssICdPdXRJZCcsIHtcbiAgICAgICAgdmFsdWU6IGtleS5rZXlJZCxcbiAgICAgIH0pO1xuICAgICAgbmV3IENmbk91dHB1dChzdGFjaywgJ091dEFybicsIHtcbiAgICAgICAgdmFsdWU6IGtleS5rZXlBcm4sXG4gICAgICB9KTtcbiAgICB9XG4gIH1cbiAgbmV3IE15Q29uc3RydWN0KHN0YWNrLCAnTXlDb25zdHJ1Y3QnLCBteUFsaWFzKTtcbiAgLyogZXNsaW50LWVuYWJsZSBAYXdzLWNkay9uby1jb3JlLWNvbnN0cnVjdCAqL1xuXG4gIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzT3V0cHV0KCdPdXRJZCcsIHtcbiAgICBWYWx1ZTogJ2FsaWFzL215QWxpYXMnLFxuICB9KTtcbiAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNPdXRwdXQoJ091dEFybicsIHtcbiAgICBWYWx1ZToge1xuICAgICAgJ0ZuOjpKb2luJzogWycnLCBbXG4gICAgICAgICdhcm46JyxcbiAgICAgICAgeyBSZWY6ICdBV1M6OlBhcnRpdGlvbicgfSxcbiAgICAgICAgJzprbXM6JyxcbiAgICAgICAgeyBSZWY6ICdBV1M6OlJlZ2lvbicgfSxcbiAgICAgICAgJzonLFxuICAgICAgICB7IFJlZjogJ0FXUzo6QWNjb3VudElkJyB9LFxuICAgICAgICAnOmFsaWFzL215QWxpYXMnLFxuICAgICAgXV0sXG4gICAgfSxcbiAgfSk7XG59KTtcblxudGVzdCgnaW1wb3J0ZWQgYWxpYXMgYnkgbmFtZSAtIHdpbGwgdGhyb3cgYW4gZXJyb3Igd2hlbiBhY2Nlc3NpbmcgdGhlIGtleScsICgpID0+IHtcbiAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soKTtcblxuICBjb25zdCBteUFsaWFzID0gQWxpYXMuZnJvbUFsaWFzTmFtZShzdGFjaywgJ015QWxpYXMnLCAnYWxpYXMvbXlBbGlhcycpO1xuXG4gIGV4cGVjdCgoKSA9PiBteUFsaWFzLmFsaWFzVGFyZ2V0S2V5KS50b1Rocm93KCdDYW5ub3QgYWNjZXNzIGFsaWFzVGFyZ2V0S2V5IG9uIGFuIEFsaWFzIGltcG9ydGVkIGJ5IEFsaWFzLmZyb21BbGlhc05hbWUoKS4nKTtcbn0pO1xuXG50ZXN0KCdmYWlscyBpZiBhbGlhcyBwb2xpY3kgaXMgaW52YWxpZCcsICgpID0+IHtcbiAgY29uc3QgYXBwID0gbmV3IEFwcCgpO1xuICBjb25zdCBzdGFjayA9IG5ldyBTdGFjayhhcHAsICdteS1zdGFjaycpO1xuICBjb25zdCBrZXkgPSBuZXcgS2V5KHN0YWNrLCAnTXlLZXknKTtcbiAgY29uc3QgYWxpYXMgPSBuZXcgQWxpYXMoc3RhY2ssICdBbGlhcycsIHsgdGFyZ2V0S2V5OiBrZXksIGFsaWFzTmFtZTogJ2FsaWFzL2ZvbycgfSk7XG5cbiAgYWxpYXMuYWRkVG9SZXNvdXJjZVBvbGljeShuZXcgUG9saWN5U3RhdGVtZW50KHtcbiAgICByZXNvdXJjZXM6IFsnKiddLFxuICAgIHByaW5jaXBhbHM6IFtuZXcgQXJuUHJpbmNpcGFsKCdhcm4nKV0sXG4gIH0pKTtcblxuICBleHBlY3QoKCkgPT4gYXBwLnN5bnRoKCkpLnRvVGhyb3coL0EgUG9saWN5U3RhdGVtZW50IG11c3Qgc3BlY2lmeSBhdCBsZWFzdCBvbmUgXFwnYWN0aW9uXFwnIG9yIFxcJ25vdEFjdGlvblxcJy8pO1xufSk7XG4iXX0=