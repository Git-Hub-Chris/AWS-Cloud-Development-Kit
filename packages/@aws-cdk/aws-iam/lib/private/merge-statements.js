"use strict";
// IAM Statement merging
//
// See docs/policy-merging.als for a formal model of the logic
// implemented here.
Object.defineProperty(exports, "__esModule", { value: true });
exports.mergeStatements = void 0;
const comparable_principal_1 = require("./comparable-principal");
const policy_statement_1 = require("../policy-statement");
const util_1 = require("../util");
/*
 * Don't produce any merged statements larger than this.
 *
 * They will become impossible to divide across managed policies if we do,
 * and this is the maximum size for User policies.
 */
const MAX_MERGE_SIZE = 2000;
/**
 * Merge as many statements as possible to shrink the total policy doc, modifying the input array in place
 *
 * We compare and merge all pairs of statements (O(N^2) complexity), opportunistically
 * merging them. This is not guaranteed to produce the optimal output, but it's probably
 * Good Enough(tm). If it merges anything, it's at least going to produce a smaller output
 * than the input.
 */
function mergeStatements(statements, options) {
    const sizeOptions = policy_statement_1.deriveEstimateSizeOptions(options.scope);
    const compStatements = statements.map(makeComparable);
    const mergeFn = options?.mergeIfCombinable ?? true ? mergeIfCombinable : mergeIfEqual;
    // Keep trying until nothing changes anymore
    while (onePass()) { /* again */ }
    const mergedStatements = new Array();
    const originsMap = new Map();
    for (const comp of compStatements) {
        const statement = renderComparable(comp);
        mergedStatements.push(statement);
        originsMap.set(statement, comp.originals);
    }
    return { mergedStatements, originsMap };
    // Do one optimization pass, return 'true' if we merged anything
    function onePass() {
        let ret = false;
        for (let i = 0; i < compStatements.length; i++) {
            let j = i + 1;
            while (j < compStatements.length) {
                const merged = mergeFn(compStatements[i], compStatements[j], !!options.limitSize, sizeOptions);
                if (merged) {
                    compStatements[i] = merged;
                    compStatements.splice(j, 1);
                    ret = true;
                }
                else {
                    j++;
                }
            }
        }
        return ret;
    }
}
exports.mergeStatements = mergeStatements;
/**
 * Given two statements, return their merging (if possible)
 *
 * We can merge two statements if:
 *
 * - Their effects are the same
 * - They don't have Sids (not really a hard requirement, but just a simplification and an escape hatch)
 * - Their Conditions are the same
 * - Their NotAction, NotResource and NotPrincipal sets are the same (empty sets is fine).
 * - From their Action, Resource and Principal sets, 2 are subsets of each other
 *   (empty sets are fine).
 */
function mergeIfCombinable(a, b, limitSize, options) {
    // Effects must be the same
    if (a.statement.effect !== b.statement.effect) {
        return;
    }
    // We don't merge Sids (for now)
    if (a.statement.sid || b.statement.sid) {
        return;
    }
    if (a.conditionString !== b.conditionString) {
        return;
    }
    if (!setEqual(a.statement.notActions, b.statement.notActions) ||
        !setEqual(a.statement.notResources, b.statement.notResources) ||
        !setEqualPrincipals(a.statement.notPrincipals, b.statement.notPrincipals)) {
        return;
    }
    // We can merge these statements if 2 out of the 3 sets of Action, Resource, Principal
    // are the same.
    const setsEqual = (setEqual(a.statement.actions, b.statement.actions) ? 1 : 0) +
        (setEqual(a.statement.resources, b.statement.resources) ? 1 : 0) +
        (setEqualPrincipals(a.statement.principals, b.statement.principals) ? 1 : 0);
    if (setsEqual < 2 || unmergeablePrincipals(a, b)) {
        return;
    }
    const combined = a.statement.copy({
        actions: setMerge(a.statement.actions, b.statement.actions),
        resources: setMerge(a.statement.resources, b.statement.resources),
        principals: setMergePrincipals(a.statement.principals, b.statement.principals),
    });
    if (limitSize && combined._estimateSize(options) > MAX_MERGE_SIZE) {
        return undefined;
    }
    return {
        originals: [...a.originals, ...b.originals],
        statement: combined,
        conditionString: a.conditionString,
    };
}
/**
 * We merge two statements only if they are exactly the same
 */
function mergeIfEqual(a, b) {
    if (a.statement.effect !== b.statement.effect) {
        return;
    }
    if (a.statement.sid !== b.statement.sid) {
        return;
    }
    if (a.conditionString !== b.conditionString) {
        return;
    }
    if (!setEqual(a.statement.notActions, b.statement.notActions) ||
        !setEqual(a.statement.notResources, b.statement.notResources) ||
        !setEqualPrincipals(a.statement.notPrincipals, b.statement.notPrincipals)) {
        return;
    }
    if (!setEqual(a.statement.actions, b.statement.actions) ||
        !setEqual(a.statement.resources, b.statement.resources) ||
        !setEqualPrincipals(a.statement.principals, b.statement.principals)) {
        return;
    }
    return {
        originals: [...a.originals, ...b.originals],
        statement: a.statement,
        conditionString: a.conditionString,
    };
}
/**
 * Calculate and return cached string set representation of the statement elements
 *
 * This is to be able to do comparisons on these sets quickly.
 */
function makeComparable(s) {
    return {
        originals: [s],
        statement: s,
        conditionString: JSON.stringify(s.conditions),
    };
}
/**
 * Return 'true' if the two principals are unmergeable
 *
 * This only happens if one of them is a literal, untyped principal (typically,
 * `Principal: '*'`) and the other one is typed.
 *
 * `Principal: '*'` behaves subtly different than `Principal: { AWS: '*' }` and must
 * therefore be preserved.
 */
function unmergeablePrincipals(a, b) {
    const aHasLiteral = a.statement.principals.some(v => util_1.LITERAL_STRING_KEY in v.policyFragment.principalJson);
    const bHasLiteral = b.statement.principals.some(v => util_1.LITERAL_STRING_KEY in v.policyFragment.principalJson);
    return aHasLiteral !== bHasLiteral;
}
/**
 * Turn a ComparableStatement back into a Statement
 */
function renderComparable(s) {
    return s.statement;
}
/**
 * Whether the given sets are equal
 */
function setEqual(a, b) {
    const bSet = new Set(b);
    return a.length === b.length && a.every(k => bSet.has(k));
}
/**
 * Merge two value sets
 */
function setMerge(x, y) {
    return Array.from(new Set([...x, ...y])).sort();
}
function setEqualPrincipals(xs, ys) {
    const xPrincipals = comparable_principal_1.partitionPrincipals(xs);
    const yPrincipals = comparable_principal_1.partitionPrincipals(ys);
    const nonComp = setEqual(xPrincipals.nonComparable, yPrincipals.nonComparable);
    const comp = setEqual(Object.keys(xPrincipals.comparable), Object.keys(yPrincipals.comparable));
    return nonComp && comp;
}
function setMergePrincipals(xs, ys) {
    const xPrincipals = comparable_principal_1.partitionPrincipals(xs);
    const yPrincipals = comparable_principal_1.partitionPrincipals(ys);
    const comparable = { ...xPrincipals.comparable, ...yPrincipals.comparable };
    return [...Object.values(comparable), ...xPrincipals.nonComparable, ...yPrincipals.nonComparable];
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVyZ2Utc3RhdGVtZW50cy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm1lcmdlLXN0YXRlbWVudHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLHdCQUF3QjtBQUN4QixFQUFFO0FBQ0YsOERBQThEO0FBQzlELG9CQUFvQjs7O0FBR3BCLGlFQUE2RDtBQUM3RCwwREFBc0c7QUFFdEcsa0NBQTZDO0FBRzdDOzs7OztHQUtHO0FBQ0gsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDO0FBNEI1Qjs7Ozs7OztHQU9HO0FBQ0gsU0FBZ0IsZUFBZSxDQUFDLFVBQTZCLEVBQUUsT0FBOEI7SUFDM0YsTUFBTSxXQUFXLEdBQUcsNENBQXlCLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQzdELE1BQU0sY0FBYyxHQUFHLFVBQVUsQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLENBQUM7SUFDdEQsTUFBTSxPQUFPLEdBQUcsT0FBTyxFQUFFLGlCQUFpQixJQUFJLElBQUksQ0FBQyxDQUFDLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQztJQUV0Riw0Q0FBNEM7SUFDNUMsT0FBTyxPQUFPLEVBQUUsRUFBRSxFQUFFLFdBQVcsRUFBRTtJQUVqQyxNQUFNLGdCQUFnQixHQUFHLElBQUksS0FBSyxFQUFtQixDQUFDO0lBQ3RELE1BQU0sVUFBVSxHQUFHLElBQUksR0FBRyxFQUFzQyxDQUFDO0lBQ2pFLEtBQUssTUFBTSxJQUFJLElBQUksY0FBYyxFQUFFO1FBQ2pDLE1BQU0sU0FBUyxHQUFHLGdCQUFnQixDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3pDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUNqQyxVQUFVLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7S0FDM0M7SUFFRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsVUFBVSxFQUFFLENBQUM7SUFFeEMsZ0VB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O0lBQy9FLE1BQU0sSUFBSSxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO0lBRWhHLE9BQU8sT0FBTyxJQUFJLElBQUksQ0FBQztBQUN6QixDQUFDO0FBRUQsU0FBUyxrQkFBa0IsQ0FBQyxFQUFnQixFQUFFLEVBQWdCO0lBQzVELE1BQU0sV0FBVyxHQUFHLDBDQUFtQixDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQzVDLE1BQU0sV0FBVyxHQUFHLDBDQUFtQixDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBRTVDLE1BQU0sVUFBVSxHQUFHLEVBQUUsR0FBRyxXQUFXLENBQUMsVUFBVSxFQUFFLEdBQUcsV0FBVyxDQUFDLFVBQVUsRUFBRSxDQUFDO0lBQzVFLE9BQU8sQ0FBQyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLEVBQUUsR0FBRyxXQUFXLENBQUMsYUFBYSxFQUFFLEdBQUcsV0FBVyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0FBQ3BHLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBJQU0gU3RhdGVtZW50IG1lcmdpbmdcbi8vXG4vLyBTZWUgZG9jcy9wb2xpY3ktbWVyZ2luZy5hbHMgZm9yIGEgZm9ybWFsIG1vZGVsIG9mIHRoZSBsb2dpY1xuLy8gaW1wbGVtZW50ZWQgaGVyZS5cblxuaW1wb3J0IHsgSUNvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHsgcGFydGl0aW9uUHJpbmNpcGFscyB9IGZyb20gJy4vY29tcGFyYWJsZS1wcmluY2lwYWwnO1xuaW1wb3J0IHsgUG9saWN5U3RhdGVtZW50LCBFc3RpbWF0ZVNpemVPcHRpb25zLCBkZXJpdmVFc3RpbWF0ZVNpemVPcHRpb25zIH0gZnJvbSAnLi4vcG9saWN5LXN0YXRlbWVudCc7XG5pbXBvcnQgeyBJUHJpbmNpcGFsIH0gZnJvbSAnLi4vcHJpbmNpcGFscyc7XG5pbXBvcnQgeyBMSVRFUkFMX1NUUklOR19LRVkgfSBmcm9tICcuLi91dGlsJztcblxuXG4vKlxuICogRG9uJ3QgcHJvZHVjZSBhbnkgbWVyZ2VkIHN0YXRlbWVudHMgbGFyZ2VyIHRoYW4gdGhpcy5cbiAqXG4gKiBUaGV5IHdpbGwgYmVjb21lIGltcG9zc2libGUgdG8gZGl2aWRlIGFjcm9zcyBtYW5hZ2VkIHBvbGljaWVzIGlmIHdlIGRvLFxuICogYW5kIHRoaXMgaXMgdGhlIG1heGltdW0gc2l6ZSBmb3IgVXNlciBwb2xpY2llcy5cbiAqL1xuY29uc3QgTUFYX01FUkdFX1NJWkUgPSAyMDAwO1xuXG4vKipcbiAqIE9wdGlvbnMgZm9yIHRoZSBtZXJnZVN0YXRlbWVudCBjb21tYW5kXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgTWVyZ2VTdGF0ZW1lbnRPcHRpb25zIHtcbiAgLyoqXG4gICAqIFNjb3BlIHRvIGRlcml2ZSBjb25maWd1cmF0aW9uIGZsYWdzIGZyb21cbiAgICovXG4gIHJlYWRvbmx5IHNjb3BlOiBJQ29uc3RydWN0O1xuXG4gIC8qKlxuICAgKiBEbyBub3QgbWVyZ2Ugc3RhdGVtZW50cyBpZiB0aGUgcmVzdWx0IHdvdWxkIGJlIGJpZ2dlciB0aGFuIE1BWF9NRVJHRV9TSVpFXG4gICAqXG4gICAqIEBkZWZhdWx0IGZhbHNlXG4gICAqL1xuICByZWFkb25seSBsaW1pdFNpemU/OiBib29sZWFuO1xuXG4gIC8qKlxuICAgKiBNZXJnZSBzdGF0ZW1lbnRzIGlmIHRoZXkgY2FuIGJlIGNvbWJpbmVkIHRvIHByb2R1Y2UgdGhlIHNhbWUgZWZmZWN0cy5cbiAgICpcbiAgICogSWYgZmFsc2UsIHN0YXRlbWVudHMgYXJlIG9ubHkgbWVyZ2VkIGlmIHRoZXkgYXJlIGV4YWN0bHkgZXF1YWwuXG4gICAqXG4gICAqIEBkZWZhdWx0IHRydWVcbiAgICovXG4gIHJlYWRvbmx5IG1lcmdlSWZDb21iaW5hYmxlPzogYm9vbGVhbjtcbn1cblxuLyoqXG4gKiBNZXJnZSBhcyBtYW55IHN0YXRlbWVudHMgYXMgcG9zc2libGUgdG8gc2hyaW5rIHRoZSB0b3RhbCBwb2xpY3kgZG9jLCBtb2RpZnlpbmcgdGhlIGlucHV0IGFycmF5IGluIHBsYWNlXG4gKlxuICogV2UgY29tcGFyZSBhbmQgbWVyZ2UgYWxsIHBhaXJzIG9mIHN0YXRlbWVudHMgKE8oTl4yKSBjb21wbGV4aXR5KSwgb3Bwb3J0dW5pc3RpY2FsbHlcbiAqIG1lcmdpbmcgdGhlbS4gVGhpcyBpcyBub3QgZ3VhcmFudGVlZCB0byBwcm9kdWNlIHRoZSBvcHRpbWFsIG91dHB1dCwgYnV0IGl0J3MgcHJvYmFibHlcbiAqIEdvb2QgRW5vdWdoKHRtKS4gSWYgaXQgbWVyZ2VzIGFueXRoaW5nLCBpdCdzIGF0IGxlYXN0IGdvaW5nIHRvIHByb2R1Y2UgYSBzbWFsbGVyIG91dHB1dFxuICogdGhhbiB0aGUgaW5wdXQuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBtZXJnZVN0YXRlbWVudHMoc3RhdGVtZW50czogUG9saWN5U3RhdGVtZW50W10sIG9wdGlvbnM6IE1lcmdlU3RhdGVtZW50T3B0aW9ucyk6IE1lcmdlU3RhdGVtZW50UmVzdWx0IHtcbiAgY29uc3Qgc2l6ZU9wdGlvbnMgPSBkZXJpdmVFc3RpbWF0ZVNpemVPcHRpb25zKG9wdGlvbnMuc2NvcGUpO1xuICBjb25zdCBjb21wU3RhdGVtZW50cyA9IHN0YXRlbWVudHMubWFwKG1ha2VDb21wYXJhYmxlKTtcbiAgY29uc3QgbWVyZ2VGbiA9IG9wdGlvbnM/Lm1lcmdlSWZDb21iaW5hYmxlID8/IHRydWUgPyBtZXJnZUlmQ29tYmluYWJsZSA6IG1lcmdlSWZFcXVhbDtcblxuICAvLyBLZWVwIHRyeWluZyB1bnRpbCBub3RoaW5nIGNoYW5nZXMgYW55bW9yZVxuICB3aGlsZSAob25lUGFzcygpKSB7IC8qIGFnYWluICovIH1cblxuICBjb25zdCBtZXJnZWRTdGF0ZW1lbnRzID0gbmV3IEFycmF5PFBvbGljeVN0YXRlbWVudD4oKTtcbiAgY29uc3Qgb3JpZ2luc01hcCA9IG5ldyBNYXA8UG9saWN5U3RhdGVtZW50LCBQb2xpY3lTdGF0ZW1lbnRbXT4oKTtcbiAgZm9yIChjb25zdCBjb21wIG9mIGNvbXBTdGF0ZW1lbnRzKSB7XG4gICAgY29uc3Qgc3RhdGVtZW50ID0gcmVuZGVyQ29tcGFyYWJsZShjb21wKTtcbiAgICBtZXJnZWRTdGF0ZW1lbnRzLnB1c2goc3RhdGVtZW50KTtcbiAgICBvcmlnaW5zTWFwLnNldChzdGF0ZW1lbnQsIGNvbXAub3JpZ2luYWxzKTtcbiAgfVxuXG4gIHJldHVybiB7IG1lcmdlZFN0YXRlbWVudHMsIG9yaWdpbnNNYXAgfTtcblxuICAvLyBEbyBvbmUgb3B0aW1pemF0aW9uIHBhc3MsIHJldHVybiAndHJ1ZScgaWYgd2UgbWVyZ2VkIGFueXRoaW5nXG4gIGZ1bmN0aW9uIG9uZVBhc3MoKSB7XG4gICAgbGV0IHJldCA9IGZhbHNlO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb21wU3RhdGVtZW50cy5sZW5ndGg7IGkrKykge1xuICAgICAgbGV0IGogPSBpICsgMTtcbiAgICAgIHdoaWxlIChqIDwgY29tcFN0YXRlbWVudHMubGVuZ3RoKSB7XG4gICAgICAgIGNvbnN0IG1lcmdlZCA9IG1lcmdlRm4oY29tcFN0YXRlbWVudHNbaV0sIGNvbXBTdGF0ZW1lbnRzW2pdLCAhIW9wdGlvbnMubGltaXRTaXplLCBzaXplT3B0aW9ucyk7XG5cbiAgICAgICAgaWYgKG1lcmdlZCkge1xuICAgICAgICAgIGNvbXBTdGF0ZW1lbnRzW2ldID0gbWVyZ2VkO1xuICAgICAgICAgIGNvbXBTdGF0ZW1lbnRzLnNwbGljZShqLCAxKTtcbiAgICAgICAgICByZXQgPSB0cnVlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGorKztcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiByZXQ7XG4gIH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBNZXJnZVN0YXRlbWVudFJlc3VsdCB7XG4gIC8qKlxuICAgKiBUaGUgbGlzdCBvZiBtYXhpbWFsbHkgbWVyZ2VkIHN0YXRlbWVudHNcbiAgICovXG4gIHJlYWRvbmx5IG1lcmdlZFN0YXRlbWVudHM6IFBvbGljeVN0YXRlbWVudFtdO1xuXG4gIC8qKlxuICAgKiBNYXBwaW5nIG9mIG9sZCB0byBuZXcgc3RhdGVtZW50c1xuICAgKi9cbiAgcmVhZG9ubHkgb3JpZ2luc01hcDogTWFwPFBvbGljeVN0YXRlbWVudCwgUG9saWN5U3RhdGVtZW50W10+O1xufVxuXG4vKipcbiAqIEdpdmVuIHR3byBzdGF0ZW1lbnRzLCByZXR1cm4gdGhlaXIgbWVyZ2luZyAoaWYgcG9zc2libGUpXG4gKlxuICogV2UgY2FuIG1lcmdlIHR3byBzdGF0ZW1lbnRzIGlmOlxuICpcbiAqIC0gVGhlaXIgZWZmZWN0cyBhcmUgdGhlIHNhbWVcbiAqIC0gVGhleSBkb24ndCBoYXZlIFNpZHMgKG5vdCByZWFsbHkgYSBoYXJkIHJlcXVpcmVtZW50LCBidXQganVzdCBhIHNpbXBsaWZpY2F0aW9uIGFuZCBhbiBlc2NhcGUgaGF0Y2gpXG4gKiAtIFRoZWlyIENvbmRpdGlvbnMgYXJlIHRoZSBzYW1lXG4gKiAtIFRoZWlyIE5vdEFjdGlvbiwgTm90UmVzb3VyY2UgYW5kIE5vdFByaW5jaXBhbCBzZXRzIGFyZSB0aGUgc2FtZSAoZW1wdHkgc2V0cyBpcyBmaW5lKS5cbiAqIC0gRnJvbSB0aGVpciBBY3Rpb24sIFJlc291cmNlIGFuZCBQcmluY2lwYWwgc2V0cywgMiBhcmUgc3Vic2V0cyBvZiBlYWNoIG90aGVyXG4gKiAgIChlbXB0eSBzZXRzIGFyZSBmaW5lKS5cbiAqL1xuZnVuY3Rpb24gbWVyZ2VJZkNvbWJpbmFibGUoXG4gIGE6IENvbXBhcmFibGVTdGF0ZW1lbnQsXG4gIGI6IENvbXBhcmFibGVTdGF0ZW1lbnQsXG4gIGxpbWl0U2l6ZTogYm9vbGVhbixcbiAgb3B0aW9uczogRXN0aW1hdGVTaXplT3B0aW9ucyxcbik6IENvbXBhcmFibGVTdGF0ZW1lbnQgfCB1bmRlZmluZWQge1xuICAvLyBFZmZlY3RzIG11c3QgYmUgdGhlIHNhbWVcbiAgaWYgKGEuc3RhdGVtZW50LmVmZmVjdCAhPT0gYi5zdGF0ZW1lbnQuZWZmZWN0KSB7IHJldHVybjsgfVxuICAvLyBXZSBkb24ndCBtZXJnZSBTaWRzIChmb3Igbm93KVxuICBpZiAoYS5zdGF0ZW1lbnQuc2lkIHx8IGIuc3RhdGVtZW50LnNpZCkgeyByZXR1cm47IH1cblxuICBpZiAoYS5jb25kaXRpb25TdHJpbmcgIT09IGIuY29uZGl0aW9uU3RyaW5nKSB7IHJldHVybjsgfVxuICBpZiAoXG4gICAgIXNldEVxdWFsKGEuc3RhdGVtZW50Lm5vdEFjdGlvbnMsIGIuc3RhdGVtZW50Lm5vdEFjdGlvbnMpIHx8XG4gICAgIXNldEVxdWFsKGEuc3RhdGVtZW50Lm5vdFJlc291cmNlcywgYi5zdGF0ZW1lbnQubm90UmVzb3VyY2VzKSB8fFxuICAgICFzZXRFcXVhbFByaW5jaXBhbHMoYS5zdGF0ZW1lbnQubm90UHJpbmNpcGFscywgYi5zdGF0ZW1lbnQubm90UHJpbmNpcGFscylcbiAgKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgLy8gV2UgY2FuIG1lcmdlIHRoZXNlIHN0YXRlbWVudHMgaWYgMiBvdXQgb2YgdGhlIDMgc2V0cyBvZiBBY3Rpb24sIFJlc291cmNlLCBQcmluY2lwYWxcbiAgLy8gYXJlIHRoZSBzYW1lLlxuICBjb25zdCBzZXRzRXF1YWwgPSAoc2V0RXF1YWwoYS5zdGF0ZW1lbnQuYWN0aW9ucywgYi5zdGF0ZW1lbnQuYWN0aW9ucykgPyAxIDogMCkgK1xuICAgIChzZXRFcXVhbChhLnN0YXRlbWVudC5yZXNvdXJjZXMsIGIuc3RhdGVtZW50LnJlc291cmNlcykgPyAxIDogMCkgK1xuICAgIChzZXRFcXVhbFByaW5jaXBhbHMoYS5zdGF0ZW1lbnQucHJpbmNpcGFscywgYi5zdGF0ZW1lbnQucHJpbmNpcGFscykgPyAxIDogMCk7XG5cbiAgaWYgKHNldHNFcXVhbCA8IDIgfHwgdW5tZXJnZWFibGVQcmluY2lwYWxzKGEsIGIpKSB7IHJldHVybjsgfVxuXG4gIGNvbnN0IGNvbWJpbmVkID0gYS5zdGF0ZW1lbnQuY29weSh7XG4gICAgYWN0aW9uczogc2V0TWVyZ2UoYS5zdGF0ZW1lbnQuYWN0aW9ucywgYi5zdGF0ZW1lbnQuYWN0aW9ucyksXG4gICAgcmVzb3VyY2VzOiBzZXRNZXJnZShhLnN0YXRlbWVudC5yZXNvdXJjZXMsIGIuc3RhdGVtZW50LnJlc291cmNlcyksXG4gICAgcHJpbmNpcGFsczogc2V0TWVyZ2VQcmluY2lwYWxzKGEuc3RhdGVtZW50LnByaW5jaXBhbHMsIGIuc3RhdGVtZW50LnByaW5jaXBhbHMpLFxuICB9KTtcblxuICBpZiAobGltaXRTaXplICYmIGNvbWJpbmVkLl9lc3RpbWF0ZVNpemUob3B0aW9ucykgPiBNQVhfTUVSR0VfU0laRSkgeyByZXR1cm4gdW5kZWZpbmVkOyB9XG5cbiAgcmV0dXJuIHtcbiAgICBvcmlnaW5hbHM6IFsuLi5hLm9yaWdpbmFscywgLi4uYi5vcmlnaW5hbHNdLFxuICAgIHN0YXRlbWVudDogY29tYmluZWQsXG4gICAgY29uZGl0aW9uU3RyaW5nOiBhLmNvbmRpdGlvblN0cmluZyxcbiAgfTtcbn1cblxuLyoqXG4gKiBXZSBtZXJnZSB0d28gc3RhdGVtZW50cyBvbmx5IGlmIHRoZXkgYXJlIGV4YWN0bHkgdGhlIHNhbWVcbiAqL1xuZnVuY3Rpb24gbWVyZ2VJZkVxdWFsKGE6IENvbXBhcmFibGVTdGF0ZW1lbnQsIGI6IENvbXBhcmFibGVTdGF0ZW1lbnQpOiBDb21wYXJhYmxlU3RhdGVtZW50IHwgdW5kZWZpbmVkIHtcbiAgaWYgKGEuc3RhdGVtZW50LmVmZmVjdCAhPT0gYi5zdGF0ZW1lbnQuZWZmZWN0KSB7IHJldHVybjsgfVxuICBpZiAoYS5zdGF0ZW1lbnQuc2lkICE9PSBiLnN0YXRlbWVudC5zaWQpIHsgcmV0dXJuOyB9XG4gIGlmIChhLmNvbmRpdGlvblN0cmluZyAhPT0gYi5jb25kaXRpb25TdHJpbmcpIHsgcmV0dXJuOyB9XG4gIGlmIChcbiAgICAhc2V0RXF1YWwoYS5zdGF0ZW1lbnQubm90QWN0aW9ucywgYi5zdGF0ZW1lbnQubm90QWN0aW9ucykgfHxcbiAgICAhc2V0RXF1YWwoYS5zdGF0ZW1lbnQubm90UmVzb3VyY2VzLCBiLnN0YXRlbWVudC5ub3RSZXNvdXJjZXMpIHx8XG4gICAgIXNldEVxdWFsUHJpbmNpcGFscyhhLnN0YXRlbWVudC5ub3RQcmluY2lwYWxzLCBiLnN0YXRlbWVudC5ub3RQcmluY2lwYWxzKVxuICApIHtcbiAgICByZXR1cm47XG4gIH1cbiAgaWYgKFxuICAgICFzZXRFcXVhbChhLnN0YXRlbWVudC5hY3Rpb25zLCBiLnN0YXRlbWVudC5hY3Rpb25zKSB8fFxuICAgICFzZXRFcXVhbChhLnN0YXRlbWVudC5yZXNvdXJjZXMsIGIuc3RhdGVtZW50LnJlc291cmNlcykgfHxcbiAgICAhc2V0RXF1YWxQcmluY2lwYWxzKGEuc3RhdGVtZW50LnByaW5jaXBhbHMsIGIuc3RhdGVtZW50LnByaW5jaXBhbHMpXG4gICkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgb3JpZ2luYWxzOiBbLi4uYS5vcmlnaW5hbHMsIC4uLmIub3JpZ2luYWxzXSxcbiAgICBzdGF0ZW1lbnQ6IGEuc3RhdGVtZW50LFxuICAgIGNvbmRpdGlvblN0cmluZzogYS5jb25kaXRpb25TdHJpbmcsXG4gIH07XG59XG5cbi8qKlxuICogQ2FsY3VsYXRlIGFuZCByZXR1cm4gY2FjaGVkIHN0cmluZyBzZXQgcmVwcmVzZW50YXRpb24gb2YgdGhlIHN0YXRlbWVudCBlbGVtZW50c1xuICpcbiAqIFRoaXMgaXMgdG8gYmUgYWJsZSB0byBkbyBjb21wYXJpc29ucyBvbiB0aGVzZSBzZXRzIHF1aWNrbHkuXG4gKi9cbmZ1bmN0aW9uIG1ha2VDb21wYXJhYmxlKHM6IFBvbGljeVN0YXRlbWVudCk6IENvbXBhcmFibGVTdGF0ZW1lbnQge1xuICByZXR1cm4ge1xuICAgIG9yaWdpbmFsczogW3NdLFxuICAgIHN0YXRlbWVudDogcyxcbiAgICBjb25kaXRpb25TdHJpbmc6IEpTT04uc3RyaW5naWZ5KHMuY29uZGl0aW9ucyksXG4gIH07XG59XG5cbi8qKlxuICogUmV0dXJuICd0cnVlJyBpZiB0aGUgdHdvIHByaW5jaXBhbHMgYXJlIHVubWVyZ2VhYmxlXG4gKlxuICogVGhpcyBvbmx5IGhhcHBlbnMgaWYgb25lIG9mIHRoZW0gaXMgYSBsaXRlcmFsLCB1bnR5cGVkIHByaW5jaXBhbCAodHlwaWNhbGx5LFxuICogYFByaW5jaXBhbDogJyonYCkgYW5kIHRoZSBvdGhlciBvbmUgaXMgdHlwZWQuXG4gKlxuICogYFByaW5jaXBhbDogJyonYCBiZWhhdmVzIHN1YnRseSBkaWZmZXJlbnQgdGhhbiBgUHJpbmNpcGFsOiB7IEFXUzogJyonIH1gIGFuZCBtdXN0XG4gKiB0aGVyZWZvcmUgYmUgcHJlc2VydmVkLlxuICovXG5mdW5jdGlvbiB1bm1lcmdlYWJsZVByaW5jaXBhbHMoYTogQ29tcGFyYWJsZVN0YXRlbWVudCwgYjogQ29tcGFyYWJsZVN0YXRlbWVudCkge1xuICBjb25zdCBhSGFzTGl0ZXJhbCA9IGEuc3RhdGVtZW50LnByaW5jaXBhbHMuc29tZSh2ID0+IExJVEVSQUxfU1RSSU5HX0tFWSBpbiB2LnBvbGljeUZyYWdtZW50LnByaW5jaXBhbEpzb24pO1xuICBjb25zdCBiSGFzTGl0ZXJhbCA9IGIuc3RhdGVtZW50LnByaW5jaXBhbHMuc29tZSh2ID0+IExJVEVSQUxfU1RSSU5HX0tFWSBpbiB2LnBvbGljeUZyYWdtZW50LnByaW5jaXBhbEpzb24pO1xuICByZXR1cm4gYUhhc0xpdGVyYWwgIT09IGJIYXNMaXRlcmFsO1xufVxuXG4vKipcbiAqIFR1cm4gYSBDb21wYXJhYmxlU3RhdGVtZW50IGJhY2sgaW50byBhIFN0YXRlbWVudFxuICovXG5mdW5jdGlvbiByZW5kZXJDb21wYXJhYmxlKHM6IENvbXBhcmFibGVTdGF0ZW1lbnQpOiBQb2xpY3lTdGF0ZW1lbnQge1xuICByZXR1cm4gcy5zdGF0ZW1lbnQ7XG59XG5cbi8qKlxuICogQW4gYW5hbHl6ZWQgdmVyc2lvbiBvZiBhIHN0YXRlbWVudCB0aGF0IG1ha2VzIGl0IGVhc2llciB0byBkbyBjb21wYXJpc29ucyBhbmQgbWVyZ2luZyBvblxuICovXG5pbnRlcmZhY2UgQ29tcGFyYWJsZVN0YXRlbWVudCB7XG4gIHJlYWRvbmx5IHN0YXRlbWVudDogUG9saWN5U3RhdGVtZW50O1xuICByZWFkb25seSBvcmlnaW5hbHM6IFBvbGljeVN0YXRlbWVudFtdO1xuICByZWFkb25seSBjb25kaXRpb25TdHJpbmc6IHN0cmluZztcbn1cblxuLyoqXG4gKiBXaGV0aGVyIHRoZSBnaXZlbiBzZXRzIGFyZSBlcXVhbFxuICovXG5mdW5jdGlvbiBzZXRFcXVhbDxBPihhOiBBW10sIGI6IEFbXSkge1xuICBjb25zdCBiU2V0ID0gbmV3IFNldChiKTtcbiAgcmV0dXJuIGEubGVuZ3RoID09PSBiLmxlbmd0aCAmJiBhLmV2ZXJ5KGsgPT4gYlNldC5oYXMoaykpO1xufVxuXG4vKipcbiAqIE1lcmdlIHR3byB2YWx1ZSBzZXRzXG4gKi9cbmZ1bmN0aW9uIHNldE1lcmdlPEE+KHg6IEFbXSwgeTogQVtdKTogQVtdIHtcbiAgcmV0dXJuIEFycmF5LmZyb20obmV3IFNldChbLi4ueCwgLi4ueV0pKS5zb3J0KCk7XG59XG5cbmZ1bmN0aW9uIHNldEVxdWFsUHJpbmNpcGFscyh4czogSVByaW5jaXBhbFtdLCB5czogSVByaW5jaXBhbFtdKTogYm9vbGVhbiB7XG4gIGNvbnN0IHhQcmluY2lwYWxzID0gcGFydGl0aW9uUHJpbmNpcGFscyh4cyk7XG4gIGNvbnN0IHlQcmluY2lwYWxzID0gcGFydGl0aW9uUHJpbmNpcGFscyh5cyk7XG5cbiAgY29uc3Qgbm9uQ29tcCA9IHNldEVxdWFsKHhQcmluY2lwYWxzLm5vbkNvbXBhcmFibGUsIHlQcmluY2lwYWxzLm5vbkNvbXBhcmFibGUpO1xuICBjb25zdCBjb21wID0gc2V0RXF1YWwoT2JqZWN0LmtleXMoeFByaW5jaXBhbHMuY29tcGFyYWJsZSksIE9iamVjdC5rZXlzKHlQcmluY2lwYWxzLmNvbXBhcmFibGUpKTtcblxuICByZXR1cm4gbm9uQ29tcCAmJiBjb21wO1xufVxuXG5mdW5jdGlvbiBzZXRNZXJnZVByaW5jaXBhbHMoeHM6IElQcmluY2lwYWxbXSwgeXM6IElQcmluY2lwYWxbXSk6IElQcmluY2lwYWxbXSB7XG4gIGNvbnN0IHhQcmluY2lwYWxzID0gcGFydGl0aW9uUHJpbmNpcGFscyh4cyk7XG4gIGNvbnN0IHlQcmluY2lwYWxzID0gcGFydGl0aW9uUHJpbmNpcGFscyh5cyk7XG5cbiAgY29uc3QgY29tcGFyYWJsZSA9IHsgLi4ueFByaW5jaXBhbHMuY29tcGFyYWJsZSwgLi4ueVByaW5jaXBhbHMuY29tcGFyYWJsZSB9O1xuICByZXR1cm4gWy4uLk9iamVjdC52YWx1ZXMoY29tcGFyYWJsZSksIC4uLnhQcmluY2lwYWxzLm5vbkNvbXBhcmFibGUsIC4uLnlQcmluY2lwYWxzLm5vbkNvbXBhcmFibGVdO1xufVxuIl19