import { UnknownPrincipal, Grant, IGrantable } from '@aws-cdk/aws-iam';
import { IKey } from '@aws-cdk/aws-kms';
import { Arn, ArnFormat, Fn, IResource, Resource, Stack, Token } from '@aws-cdk/core';
import { Construct } from 'constructs';
import { CfnDatabase } from './timestream.generated';

/**
 * Timestream Database interface
 */
export interface IDatabase extends IResource {
  /**
   * database ARN
   *
   * @attribute
   */
  readonly databaseArn: string

  /**
   * Database Name
   *
   * @attribute
   */
  readonly databaseName: string

  /**
    * Grant Permissions to read & write on database & on all tables
    * @param identity
    */
  grantRead(identity: IGrantable): Grant

  /**
    * Grant Permissions to read & write on database & on all tables
    * @param identity
    */
  grantReadWrite(identity: IGrantable): Grant


}

/**
 * Database Properties
 */
export interface DatabaseProps {
  /**
   * database name
   *
   * @default Autogenerated
   */
  readonly databaseName?: string

  /**
   * KMS Key
   *
   * @default If no key is specified, CloudFormation uses one of the account's AWS managed AWS KMS keys
   */
  readonly kmsKey?: IKey
}


abstract class DatabaseBase extends Resource implements IDatabase {
  public abstract readonly databaseArn: string;
  public abstract readonly databaseName: string;

  grantReadWrite(grantee: IGrantable) {
    return Grant.addToPrincipal({
      grantee,
      actions: ['timestream:Select', 'timestream:ListMeasures', 'timestream:DescribeTable', 'timestream:WriteRecords', 'timestream:ListTables', 'timestream:DescribeDatabase', 'timestream:CreateTable', 'timestream:DeleteTable', 'timestream:UpdateTable'],
      resourceArns: [this.databaseArn, Arn.format({
        service: 'timestream',
        resource: 'database',
        resourceName: this.databaseName+'/table/*',
        region: Fn.ref('AWS::Region'),
        account: Fn.ref('AWS::AccountId'),
        partition: Fn.ref('AWS::Partition'),
      })],
    });
  }

  grantRead(grantee: IGrantable) {
    return Grant.addToPrincipal({
      grantee,
      actions: ['timestream:Select', 'timestream:ListMeasures', 'timestream:DescribeTable', 'timestream:WriteRecords', 'timestream:ListTables', 'timestream:DescribeDatabase'],
      resourceArns: [this.databaseArn, Arn.format({
        service: 'timestream',
        resource: 'database',
        resourceName: this.databaseName+'/table/*',
        region: Fn.ref('AWS::Region'),
        account: Fn.ref('AWS::AccountId'),
        partition: Fn.ref('AWS::Partition'),
      })],
    });
  }

}

/**
 * Database Class
 */
export class Database extends DatabaseBase {

  /**
   * Import database via ARN
   *
   * @param scope CDK scope (stack or app)
   * @param id The id in the CDK stack
   * @param databaseArn the database ARN
   * @returns Database contruct
   */
  public static fromDatabaseArn(scope: Construct, id: string, databaseArn: string): IDatabase {
    const stack = Stack.of(scope);
    const splitArn = stack.splitArn(databaseArn, ArnFormat.SLASH_RESOURCE_NAME);

    class Import extends DatabaseBase {
      public readonly databaseArn = databaseArn;
      public readonly databaseName = splitArn.resourceName || ''
      public readonly grantPrincipal = new UnknownPrincipal({ resource: this });
    }
    return new Import(scope, id, {
      environmentFromArn: databaseArn,
    });
  }

  /**
   * The name of the Timestream database.
   *
   * @attribute
   */
  public readonly databaseName: string

  /**
   * The ARN of the database
   *
   * @attribute
   */
  public readonly databaseArn: string;

  constructor(scope: Construct, id: string, props?: DatabaseProps) {
    super(scope, id, {
      physicalName: props?.databaseName,
    });

    if (props?.databaseName !== undefined) {
      this.validateDatabaseName(props.databaseName);
    }

    const resource = new CfnDatabase(this, 'Resource', {
      databaseName: this.physicalName,
      kmsKeyId: props?.kmsKey?.keyId,
    });

    this.databaseArn = this.getResourceArnAttribute(resource.attrArn, {
      service: 'timestream',
      resource: this.physicalName,
    });
    this.databaseName = this.getResourceNameAttribute(resource.ref);
  }


  private validateDatabaseName(databaseName: string) {
    if (!Token.isUnresolved(databaseName)) {
      // Interestingly the CFN Docs state bytes, the underlying Timestream API does not
      // https://docs.aws.amazon.com/timestream/latest/developerguide/API_CreateDatabase.html
      if (databaseName.length < 3 || databaseName.length > 256) {
        throw new Error(`Database name must have between 3 and 256 characters or omitted. Received: ${databaseName}`);
      }
    }
  }
}