"use strict";
/**
 * This file asserts that it is possible to write a custom stacksynthesizer that will synthesize
 * ONE thing to the asset manifest, while returning another thing (including tokens) to the
 * CloudFormation template -- without reaching into the library internals
 */
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const assertions_1 = require("@aws-cdk/assertions");
const core_1 = require("@aws-cdk/core");
const lib_1 = require("../lib");
test('use custom synthesizer', () => {
    // GIVEN
    const app = new core_1.App();
    const stack = new core_1.Stack(app, 'Stack', {
        synthesizer: new CustomSynthesizer(),
    });
    // WHEN
    const asset = new lib_1.Asset(stack, 'MyAsset', {
        path: path.join(__dirname, 'file-asset.txt'),
    });
    new core_1.CfnResource(stack, 'TestResource', {
        type: 'CDK::TestResource',
        properties: {
            Bucket: asset.s3BucketName,
            ObjectKey: asset.s3ObjectKey,
            S3Url: asset.s3ObjectUrl,
            HttpUrl: asset.httpUrl,
        },
    });
    // THEN
    const assembly = app.synth();
    const stackArtifact = assembly.getStackArtifact(stack.artifactId);
    const assetArtifact = stackArtifact.dependencies[0];
    const stackTemplate = assertions_1.Template.fromJSON(stackArtifact.template);
    stackTemplate.hasResourceProperties('CDK::TestResource', {
        Bucket: { 'Fn::Sub': '${BucketName}' },
        ObjectKey: '78add9eaf468dfa2191da44a7da92a21baba4c686cf6053d772556768ef21197.txt',
        S3Url: { 'Fn::Sub': 's3://${BucketName}/78add9eaf468dfa2191da44a7da92a21baba4c686cf6053d772556768ef21197.txt' },
        HttpUrl: { 'Fn::Sub': 'https://s3.${AWS::Region}.${AWS::URLSuffix}/${BucketName}/78add9eaf468dfa2191da44a7da92a21baba4c686cf6053d772556768ef21197.txt' },
    });
    expect(assetArtifact.contents).toEqual(expect.objectContaining({
        files: expect.objectContaining({
            '78add9eaf468dfa2191da44a7da92a21baba4c686cf6053d772556768ef21197': {
                destinations: {
                    'current_account-current_region': {
                        bucketName: 'write-bucket',
                        objectKey: '78add9eaf468dfa2191da44a7da92a21baba4c686cf6053d772556768ef21197.txt',
                    },
                },
                source: {
                    packaging: 'file',
                    path: 'asset.78add9eaf468dfa2191da44a7da92a21baba4c686cf6053d772556768ef21197.txt',
                },
            },
        }),
    }));
});
class CustomSynthesizer extends core_1.StackSynthesizer {
    constructor() {
        super(...arguments);
        this.manifest = new core_1.AssetManifestBuilder();
    }
    bind(stack) {
        super.bind(stack);
        this.parameter = new core_1.CfnParameter(stack, 'BucketName');
    }
    addFileAsset(asset) {
        const dest = this.manifest.defaultAddFileAsset(this.boundStack, asset, {
            bucketName: 'write-bucket',
        });
        return this.cloudFormationLocationFromFileAsset({
            ...dest,
            bucketName: ['${', this.parameter.logicalId, '}'].join(''),
        });
    }
    addDockerImageAsset(asset) {
        void (asset);
        throw new Error('Docker images are not supported here');
    }
    synthesize(session) {
        const templateAsset = this.addFileAsset(this.synthesizeTemplate(session));
        const assetManifestId = this.manifest.emitManifest(this.boundStack, session);
        this.emitArtifact(session, {
            stackTemplateAssetObjectUrl: templateAsset.s3ObjectUrlWithPlaceholders,
            additionalDependencies: [assetManifestId],
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3VzdG9tLXN5bnRoZXNpcy50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY3VzdG9tLXN5bnRoZXNpcy50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7OztHQUlHOztBQUVILDZCQUE2QjtBQUM3QixvREFBK0M7QUFDL0Msd0NBQXVOO0FBRXZOLGdDQUErQjtBQUUvQixJQUFJLENBQUMsd0JBQXdCLEVBQUUsR0FBRyxFQUFFO0lBQ2xDLFFBQVE7SUFDUixNQUFNLEdBQUcsR0FBRyxJQUFJLFVBQUcsRUFBRSxDQUFDO0lBQ3RCLE1BQU0sS0FBSyxHQUFHLElBQUksWUFBSyxDQUFDLEdBQUcsRUFBRSxPQUFPLEVBQUU7UUFDcEMsV0FBVyxFQUFFLElBQUksaUJBQWlCLEVBQUU7S0FDckMsQ0FBQyxDQUFDO0lBRUgsT0FBTztJQUNQLE1BQU0sS0FBSyxHQUFHLElBQUksV0FBSyxDQUFDLEtBQUssRUFBRSxTQUFTLEVBQUU7UUFDeEMsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLGdCQUFnQixDQUFDO0tBQzdDLENBQUMsQ0FBQztJQUNILElBQUksa0JBQVcsQ0FBQyxLQUFLLEVBQUUsY0FBYyxFQUFFO1FBQ3JDLElBQUksRUFBRSxtQkFBbUI7UUFDekIsVUFBVSxFQUFFO1lBQ1YsTUFBTSxFQUFFLEtBQUssQ0FBQyxZQUFZO1lBQzFCLFNBQVMsRUFBRSxLQUFLLENBQUMsV0FBVztZQUM1QixLQUFLLEVBQUUsS0FBSyxDQUFDLFdBQVc7WUFDeEIsT0FBTyxFQUFFLEtBQUssQ0FBQyxPQUFPO1NBQ3ZCO0tBQ0YsQ0FBQyxDQUFDO0lBRUgsT0FBTztJQUNQLE1BQU0sUUFBUSxHQUFHLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUM3QixNQUFNLGFBQWEsR0FBRyxRQUFRLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ2xFLE1BQU0sYUFBYSxHQUFHLGFBQWEsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUEwQixDQUFDO0lBRTdFLE1BQU0sYUFBYSxHQUFHLHFCQUFRLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNoRSxhQUFhLENBQUMscUJBQXFCLENBQUMsbUJBQW1CLEVBQUU7UUFDdkQsTUFBTSxFQUFFLEVBQUUsU0FBUyxFQUFFLGVBQWUsRUFBRTtRQUN0QyxTQUFTLEVBQUUsc0VBQXNFO1FBQ2pGLEtBQUssRUFBRSxFQUFFLFNBQVMsRUFBRSx5RkFBeUYsRUFBRTtRQUMvRyxPQUFPLEVBQUUsRUFBRSxTQUFTLEVBQUUsZ0lBQWdJLEVBQUU7S0FDekosQ0FBQyxDQUFDO0lBRUgsTUFBTSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLGdCQUFnQixDQUFDO1FBQzdELEtBQUssRUFBRSxNQUFNLENBQUMsZ0JBQWdCLENBQUM7WUFDN0Isa0VBQWtFLEVBQUU7Z0JBQ2xFLFlBQVksRUFBRTtvQkFDWixnQ0FBZ0MsRUFBRTt3QkFDaEMsVUFBVSxFQUFFLGNBQWM7d0JBQzFCLFNBQVMsRUFBRSxzRUFBc0U7cUJBQ2xGO2lCQUNGO2dCQUNELE1BQU0sRUFBRTtvQkFDTixTQUFTLEVBQUUsTUFBTTtvQkFDakIsSUFBSSxFQUFFLDRFQUE0RTtpQkFDbkY7YUFDRjtTQUNGLENBQUM7S0FDSCxDQUFDLENBQUMsQ0FBQztBQUNOLENBQUMsQ0FBQyxDQUFDO0FBRUgsTUFBTSxpQkFBa0IsU0FBUSx1QkFBZ0I7SUFBaEQ7O1FBQ21CLGFBQVEsR0FBRyxJQUFJLDJCQUFvQixFQUFFLENBQUM7SUFpQ3pELENBQUM7SUE5QkMsSUFBSSxDQUFDLEtBQVk7UUFDZixLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRWxCLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxtQkFBWSxDQUFDLEtBQUssRUFBRSxZQUFZLENBQUMsQ0FBQztLQUN4RDtJQUVELFlBQVksQ0FBQyxLQUFzQjtRQUNqQyxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsS0FBSyxFQUFFO1lBQ3JFLFVBQVUsRUFBRSxjQUFjO1NBQzNCLENBQUMsQ0FBQztRQUNILE9BQU8sSUFBSSxDQUFDLG1DQUFtQyxDQUFDO1lBQzlDLEdBQUcsSUFBSTtZQUNQLFVBQVUsRUFBRSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsU0FBVSxDQUFDLFNBQVMsRUFBRSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO1NBQzVELENBQUMsQ0FBQztLQUNKO0lBRUQsbUJBQW1CLENBQUMsS0FBNkI7UUFDL0MsS0FBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ1osTUFBTSxJQUFJLEtBQUssQ0FBQyxzQ0FBc0MsQ0FBQyxDQUFDO0tBQ3pEO0lBRUQsVUFBVSxDQUFDLE9BQTBCO1FBQ25DLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFDMUUsTUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUU3RSxJQUFJLENBQUMsWUFBWSxDQUFDLE9BQU8sRUFBRTtZQUN6QiwyQkFBMkIsRUFBRSxhQUFhLENBQUMsMkJBQTJCO1lBQ3RFLHNCQUFzQixFQUFFLENBQUMsZUFBZSxDQUFDO1NBQzFDLENBQUMsQ0FBQztLQUNKO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFRoaXMgZmlsZSBhc3NlcnRzIHRoYXQgaXQgaXMgcG9zc2libGUgdG8gd3JpdGUgYSBjdXN0b20gc3RhY2tzeW50aGVzaXplciB0aGF0IHdpbGwgc3ludGhlc2l6ZVxuICogT05FIHRoaW5nIHRvIHRoZSBhc3NldCBtYW5pZmVzdCwgd2hpbGUgcmV0dXJuaW5nIGFub3RoZXIgdGhpbmcgKGluY2x1ZGluZyB0b2tlbnMpIHRvIHRoZVxuICogQ2xvdWRGb3JtYXRpb24gdGVtcGxhdGUgLS0gd2l0aG91dCByZWFjaGluZyBpbnRvIHRoZSBsaWJyYXJ5IGludGVybmFsc1xuICovXG5cbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBUZW1wbGF0ZSB9IGZyb20gJ0Bhd3MtY2RrL2Fzc2VydGlvbnMnO1xuaW1wb3J0IHsgU3RhY2tTeW50aGVzaXplciwgRmlsZUFzc2V0U291cmNlLCBGaWxlQXNzZXRMb2NhdGlvbiwgRG9ja2VySW1hZ2VBc3NldFNvdXJjZSwgRG9ja2VySW1hZ2VBc3NldExvY2F0aW9uLCBJU3ludGhlc2lzU2Vzc2lvbiwgQXBwLCBTdGFjaywgQXNzZXRNYW5pZmVzdEJ1aWxkZXIsIENmblBhcmFtZXRlciwgQ2ZuUmVzb3VyY2UgfSBmcm9tICdAYXdzLWNkay9jb3JlJztcbmltcG9ydCB7IEFzc2V0TWFuaWZlc3RBcnRpZmFjdCB9IGZyb20gJ0Bhd3MtY2RrL2N4LWFwaSc7XG5pbXBvcnQgeyBBc3NldCB9IGZyb20gJy4uL2xpYic7XG5cbnRlc3QoJ3VzZSBjdXN0b20gc3ludGhlc2l6ZXInLCAoKSA9PiB7XG4gIC8vIEdJVkVOXG4gIGNvbnN0IGFwcCA9IG5ldyBBcHAoKTtcbiAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soYXBwLCAnU3RhY2snLCB7XG4gICAgc3ludGhlc2l6ZXI6IG5ldyBDdXN0b21TeW50aGVzaXplcigpLFxuICB9KTtcblxuICAvLyBXSEVOXG4gIGNvbnN0IGFzc2V0ID0gbmV3IEFzc2V0KHN0YWNrLCAnTXlBc3NldCcsIHtcbiAgICBwYXRoOiBwYXRoLmpvaW4oX19kaXJuYW1lLCAnZmlsZS1hc3NldC50eHQnKSxcbiAgfSk7XG4gIG5ldyBDZm5SZXNvdXJjZShzdGFjaywgJ1Rlc3RSZXNvdXJjZScsIHtcbiAgICB0eXBlOiAnQ0RLOjpUZXN0UmVzb3VyY2UnLFxuICAgIHByb3BlcnRpZXM6IHtcbiAgICAgIEJ1Y2tldDogYXNzZXQuczNCdWNrZXROYW1lLFxuICAgICAgT2JqZWN0S2V5OiBhc3NldC5zM09iamVjdEtleSxcbiAgICAgIFMzVXJsOiBhc3NldC5zM09iamVjdFVybCxcbiAgICAgIEh0dHBVcmw6IGFzc2V0Lmh0dHBVcmwsXG4gICAgfSxcbiAgfSk7XG5cbiAgLy8gVEhFTlxuICBjb25zdCBhc3NlbWJseSA9IGFwcC5zeW50aCgpO1xuICBjb25zdCBzdGFja0FydGlmYWN0ID0gYXNzZW1ibHkuZ2V0U3RhY2tBcnRpZmFjdChzdGFjay5hcnRpZmFjdElkKTtcbiAgY29uc3QgYXNzZXRBcnRpZmFjdCA9IHN0YWNrQXJ0aWZhY3QuZGVwZW5kZW5jaWVzWzBdIGFzIEFzc2V0TWFuaWZlc3RBcnRpZmFjdDtcblxuICBjb25zdCBzdGFja1RlbXBsYXRlID0gVGVtcGxhdGUuZnJvbUpTT04oc3RhY2tBcnRpZmFjdC50ZW1wbGF0ZSk7XG4gIHN0YWNrVGVtcGxhdGUuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdDREs6OlRlc3RSZXNvdXJjZScsIHtcbiAgICBCdWNrZXQ6IHsgJ0ZuOjpTdWInOiAnJHtCdWNrZXROYW1lfScgfSxcbiAgICBPYmplY3RLZXk6ICc3OGFkZDllYWY0NjhkZmEyMTkxZGE0NGE3ZGE5MmEyMWJhYmE0YzY4NmNmNjA1M2Q3NzI1NTY3NjhlZjIxMTk3LnR4dCcsXG4gICAgUzNVcmw6IHsgJ0ZuOjpTdWInOiAnczM6Ly8ke0J1Y2tldE5hbWV9Lzc4YWRkOWVhZjQ2OGRmYTIxOTFkYTQ0YTdkYTkyYTIxYmFiYTRjNjg2Y2Y2MDUzZDc3MjU1Njc2OGVmMjExOTcudHh0JyB9LFxuICAgIEh0dHBVcmw6IHsgJ0ZuOjpTdWInOiAnaHR0cHM6Ly9zMy4ke0FXUzo6UmVnaW9ufS4ke0FXUzo6VVJMU3VmZml4fS8ke0J1Y2tldE5hbWV9Lzc4YWRkOWVhZjQ2OGRmYTIxOTFkYTQ0YTdkYTkyYTIxYmFiYTRjNjg2Y2Y2MDUzZDc3MjU1Njc2OGVmMjExOTcudHh0JyB9LFxuICB9KTtcblxuICBleHBlY3QoYXNzZXRBcnRpZmFjdC5jb250ZW50cykudG9FcXVhbChleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgZmlsZXM6IGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICc3OGFkZDllYWY0NjhkZmEyMTkxZGE0NGE3ZGE5MmEyMWJhYmE0YzY4NmNmNjA1M2Q3NzI1NTY3NjhlZjIxMTk3Jzoge1xuICAgICAgICBkZXN0aW5hdGlvbnM6IHtcbiAgICAgICAgICAnY3VycmVudF9hY2NvdW50LWN1cnJlbnRfcmVnaW9uJzoge1xuICAgICAgICAgICAgYnVja2V0TmFtZTogJ3dyaXRlLWJ1Y2tldCcsXG4gICAgICAgICAgICBvYmplY3RLZXk6ICc3OGFkZDllYWY0NjhkZmEyMTkxZGE0NGE3ZGE5MmEyMWJhYmE0YzY4NmNmNjA1M2Q3NzI1NTY3NjhlZjIxMTk3LnR4dCcsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgc291cmNlOiB7XG4gICAgICAgICAgcGFja2FnaW5nOiAnZmlsZScsXG4gICAgICAgICAgcGF0aDogJ2Fzc2V0Ljc4YWRkOWVhZjQ2OGRmYTIxOTFkYTQ0YTdkYTkyYTIxYmFiYTRjNjg2Y2Y2MDUzZDc3MjU1Njc2OGVmMjExOTcudHh0JyxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSksXG4gIH0pKTtcbn0pO1xuXG5jbGFzcyBDdXN0b21TeW50aGVzaXplciBleHRlbmRzIFN0YWNrU3ludGhlc2l6ZXIge1xuICBwcml2YXRlIHJlYWRvbmx5IG1hbmlmZXN0ID0gbmV3IEFzc2V0TWFuaWZlc3RCdWlsZGVyKCk7XG4gIHByaXZhdGUgcGFyYW1ldGVyPzogQ2ZuUGFyYW1ldGVyO1xuXG4gIGJpbmQoc3RhY2s6IFN0YWNrKSB7XG4gICAgc3VwZXIuYmluZChzdGFjayk7XG5cbiAgICB0aGlzLnBhcmFtZXRlciA9IG5ldyBDZm5QYXJhbWV0ZXIoc3RhY2ssICdCdWNrZXROYW1lJyk7XG4gIH1cblxuICBhZGRGaWxlQXNzZXQoYXNzZXQ6IEZpbGVBc3NldFNvdXJjZSk6IEZpbGVBc3NldExvY2F0aW9uIHtcbiAgICBjb25zdCBkZXN0ID0gdGhpcy5tYW5pZmVzdC5kZWZhdWx0QWRkRmlsZUFzc2V0KHRoaXMuYm91bmRTdGFjaywgYXNzZXQsIHtcbiAgICAgIGJ1Y2tldE5hbWU6ICd3cml0ZS1idWNrZXQnLFxuICAgIH0pO1xuICAgIHJldHVybiB0aGlzLmNsb3VkRm9ybWF0aW9uTG9jYXRpb25Gcm9tRmlsZUFzc2V0KHtcbiAgICAgIC4uLmRlc3QsXG4gICAgICBidWNrZXROYW1lOiBbJyR7JywgdGhpcy5wYXJhbWV0ZXIhLmxvZ2ljYWxJZCwgJ30nXS5qb2luKCcnKSxcbiAgICB9KTtcbiAgfVxuXG4gIGFkZERvY2tlckltYWdlQXNzZXQoYXNzZXQ6IERvY2tlckltYWdlQXNzZXRTb3VyY2UpOiBEb2NrZXJJbWFnZUFzc2V0TG9jYXRpb24ge1xuICAgIHZvaWQoYXNzZXQpO1xuICAgIHRocm93IG5ldyBFcnJvcignRG9ja2VyIGltYWdlcyBhcmUgbm90IHN1cHBvcnRlZCBoZXJlJyk7XG4gIH1cblxuICBzeW50aGVzaXplKHNlc3Npb246IElTeW50aGVzaXNTZXNzaW9uKTogdm9pZCB7XG4gICAgY29uc3QgdGVtcGxhdGVBc3NldCA9IHRoaXMuYWRkRmlsZUFzc2V0KHRoaXMuc3ludGhlc2l6ZVRlbXBsYXRlKHNlc3Npb24pKTtcbiAgICBjb25zdCBhc3NldE1hbmlmZXN0SWQgPSB0aGlzLm1hbmlmZXN0LmVtaXRNYW5pZmVzdCh0aGlzLmJvdW5kU3RhY2ssIHNlc3Npb24pO1xuXG4gICAgdGhpcy5lbWl0QXJ0aWZhY3Qoc2Vzc2lvbiwge1xuICAgICAgc3RhY2tUZW1wbGF0ZUFzc2V0T2JqZWN0VXJsOiB0ZW1wbGF0ZUFzc2V0LnMzT2JqZWN0VXJsV2l0aFBsYWNlaG9sZGVycyxcbiAgICAgIGFkZGl0aW9uYWxEZXBlbmRlbmNpZXM6IFthc3NldE1hbmlmZXN0SWRdLFxuICAgIH0pO1xuICB9XG59Il19