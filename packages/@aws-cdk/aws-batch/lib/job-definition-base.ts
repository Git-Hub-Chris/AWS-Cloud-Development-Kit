import { Duration, IResource, Resource } from '@aws-cdk/core';
import { Construct } from 'constructs';


export interface IJobDefinition extends IResource {
  /**
   * The name of this job definition
   *
   * @default - generated by CloudFormation
   */
  readonly name?: string;

  /**
   * The default parameters passed to the container
   * These parameters can be referenced in the `command` that
   * you give to the container
   *
   * @see: https://docs.aws.amazon.com/batch/latest/userguide/job_definition_parameters.html#parameters
   *
   * @default none
   */
  readonly parameters?: { [key:string]: any };

  /**
   * Whether to propogate tags from the JobDefinition
   * to the ECS task that Batch spawns
   *
   * @default false
   */
  readonly propogateTags?: boolean;

  /**
   * The number of times to retry a job.
   * The job is retried on failure the same number of attempts as the value.
   *
   * @default 1
   */
  readonly retryAttempts?: number;

  /**
   * Defines the retry behavior for this job
   *
   * @default - no `RetryStrategy`
   */
  readonly retryStrategies?: RetryStrategy[];

  /**
   * The priority of this Job. Only used in Fairshare Scheduling
   * to decide which job to run first when there are multiple jobs
   * with the same share identifier.
   *
   * @default none
   */
  readonly schedulingPriority?: number;

  /**
   * The timeout time for jobs that are submitted with this job definition.
   * After the amount of time you specify passes,
   * Batch terminates your jobs if they aren't finished.
   *
   * @default - no timeout
   */
  readonly timeout?: Duration;
}

export interface JobDefinitionProps {
  /**
   * The name of this job definition
   *
   * @default - generated by CloudFormation
   */
  readonly name?: string;

  /**
   * The default parameters passed to the container
   * These parameters can be referenced in the `command` that
   * you give to the container
   *
   * @see: https://docs.aws.amazon.com/batch/latest/userguide/job_definition_parameters.html#parameters
   *
   * @default none
   */
  readonly parameters?: { [key:string]: any };

  /**
   * Whether to propogate tags from the JobDefinition
   * to the ECS task that Batch spawns
   *
   * @default false
   */
  readonly propogateTags?: boolean;

  /**
   * The number of times to retry a job.
   * The job is retried on failure the same number of attempts as the value.
   *
   * @default 1
   */
  readonly retryAttempts?: number;

  /**
   * Defines the retry behavior for this job
   *
   * @default - no `RetryStrategy`
   */
  readonly retryStrategies?: RetryStrategy[];

  /**
   * The priority of this Job. Only used in Fairshare Scheduling
   * to decide which job to run first when there are multiple jobs
   * with the same share identifier.
   *
   * @default none
   */
  readonly schedulingPriority?: number;

  /**
   * The timeout time for jobs that are submitted with this job definition.
   * After the amount of time you specify passes,
   * Batch terminates your jobs if they aren't finished.
   *
   * @default - no timeout
   */
  readonly timeout?: Duration;
}

export class RetryStrategy {
  public static of(action: Action, on: Reason) {
    return new RetryStrategy(action, on);
  }

  public readonly action: Action;
  public readonly on: Reason;

  constructor(action: Action, on: Reason) {
    this.action = action;
    this.on = on;
  }
}

export enum Action {
  EXIT = 'EXIT',
  RETRY = 'RETRY',
}

export class Reason {
  static readonly NON_ZERO_EXIT_CODE = '*';
  static readonly SPOT_INSTANCE_RECLAIMED = 'Host EC2*'
  static readonly CANNOT_PULL_CONTAINER = 'CannotPullContainerError:*'

  //static custom(action?: Action, onExitCode?: string, onStatusReason?: string, onReason?: string) {}
}

export abstract class JobDefinitionBase extends Resource implements IJobDefinition {
  /**
   * The name of this job definition
   *
   * @default - generated by CloudFormation
   */
  readonly name?: string;

  /**
   * The default parameters passed to the container
   * These parameters can be referenced in the `command` that
   * you give to the container
   *
   * @see: https://docs.aws.amazon.com/batch/latest/userguide/job_definition_parameters.html#parameters
   *
   * @default none
   */
  readonly parameters?: { [key:string]: any };

  /**
   * Whether to propogate tags from the JobDefinition
   * to the ECS task that Batch spawns
   *
   * @default false
   */
  readonly propogateTags?: boolean;

  /**
   * The number of times to retry a job.
   * The job is retried on failure the same number of attempts as the value.
   *
   * @default 1
   */
  readonly retryAttempts?: number;

  /**
   * Defines the retry behavior for this job
   *
   * @default - no `RetryStrategy`
   */
  readonly retryStrategies?: RetryStrategy[];

  /**
   * The priority of this Job. Only used in Fairshare Scheduling
   * to decide which job to run first when there are multiple jobs
   * with the same share identifier.
   *
   * @default none
   */
  readonly schedulingPriority?: number;

  /**
   * The timeout time for jobs that are submitted with this job definition.
   * After the amount of time you specify passes,
   * Batch terminates your jobs if they aren't finished.
   *
   * @default - no timeout
   */
  readonly timeout?: Duration;

  constructor(scope: Construct, id: string, props: JobDefinitionProps) {
    super(scope, id);
    this.name = props.name;
    this.parameters = props.parameters;
    this.propogateTags = props.propogateTags;
    this.retryAttempts = props.retryAttempts;
    this.retryStrategies = props.retryStrategies;
    this.schedulingPriority = props.schedulingPriority;
    this.timeout = props.timeout;
  }
}
