"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const fs = require("fs");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const util_1 = require("./util");
const lib_1 = require("../lib");
const CLOUDFORMATION_EXECUTION_ROLE = 'cloudformation-execution-role';
const DEPLOY_ACTION_ROLE = 'deploy-action-role';
const LOOKUP_ROLE = 'lookup-role';
describe('Boostrap Roles', () => {
    test('default bootstrap role name is always under 64 characters', () => {
        // GIVEN
        const app = new aws_cdk_lib_1.App({
            defaultStackSynthesizer: lib_1.AppStagingSynthesizer.defaultResources({
                appId: 'super long app id that needs to be cut',
            }),
        });
        const stack = new aws_cdk_lib_1.Stack(app, 'Stack', {
            env: {
                account: '000000000000',
                region: 'us-east-1',
            },
        });
        new aws_cdk_lib_1.CfnResource(stack, 'Resource', {
            type: 'Some::Resource',
        });
        // WHEN
        const asm = app.synth();
        // THEN
        const manifestArtifact = asm.artifacts.filter(util_1.isAssetManifest)[0];
        expect(manifestArtifact).toBeDefined();
        const manifest = JSON.parse(fs.readFileSync(manifestArtifact.file, { encoding: 'utf-8' }));
        const firstFile = (manifest.files ? manifest.files[Object.keys(manifest.files)[0]] : undefined) ?? {};
        expect(firstFile.destinations['000000000000-us-east-1'].assumeRoleArn).toEqual('arn:${AWS::Partition}:iam::000000000000:role/cdk-super-long-app-id-th-file-role-us-east-1');
    });
    test('can supply existing arns for bootstrapped roles', () => {
        // GIVEN
        const app = new aws_cdk_lib_1.App({
            defaultStackSynthesizer: lib_1.AppStagingSynthesizer.defaultResources({
                appId: util_1.APP_ID,
                deploymentRoles: {
                    cloudFormationExecutionRole: lib_1.BootstrapRole.fromRoleArn(CLOUDFORMATION_EXECUTION_ROLE),
                    lookupRole: lib_1.BootstrapRole.fromRoleArn(LOOKUP_ROLE),
                    deploymentRole: lib_1.BootstrapRole.fromRoleArn(DEPLOY_ACTION_ROLE),
                },
            }),
        });
        const stack = new aws_cdk_lib_1.Stack(app, 'Stack', {
            env: {
                account: '000000000000',
                region: 'us-east-1',
            },
        });
        new aws_cdk_lib_1.CfnResource(stack, 'Resource', {
            type: 'Some::Resource',
        });
        // WHEN
        const asm = app.synth();
        // THEN
        const stackArtifact = asm.getStackArtifact('Stack');
        // Bootstrapped roles are as advertised
        expect(stackArtifact.cloudFormationExecutionRoleArn).toEqual(CLOUDFORMATION_EXECUTION_ROLE);
        expect(stackArtifact.lookupRole).toEqual({ arn: LOOKUP_ROLE });
        expect(stackArtifact.assumeRoleArn).toEqual(DEPLOY_ACTION_ROLE);
    });
    test('can supply existing arn for bucket staging role', () => {
        // GIVEN
        const app = new aws_cdk_lib_1.App({
            defaultStackSynthesizer: lib_1.AppStagingSynthesizer.defaultResources({
                appId: util_1.APP_ID,
                fileAssetPublishingRole: lib_1.BootstrapRole.fromRoleArn('arn:aws:iam::123456789012:role/S3Access'),
            }),
        });
        const stack = new aws_cdk_lib_1.Stack(app, 'Stack', {
            env: {
                account: '000000000000',
                region: 'us-east-1',
            },
        });
        new aws_cdk_lib_1.CfnResource(stack, 'Resource', {
            type: 'Some::Resource',
        });
        // WHEN
        const asm = app.synth();
        // THEN
        // Staging role is as advertised
        const manifestArtifact = asm.artifacts.filter(util_1.isAssetManifest)[0];
        expect(manifestArtifact).toBeDefined();
        const manifest = JSON.parse(fs.readFileSync(manifestArtifact.file, { encoding: 'utf-8' }));
        const firstFile = (manifest.files ? manifest.files[Object.keys(manifest.files)[0]] : undefined) ?? {};
        expect(firstFile.destinations['000000000000-us-east-1'].assumeRoleArn).toEqual('arn:aws:iam::123456789012:role/S3Access');
    });
    test('can provide existing arn for image staging role', () => {
        // GIVEN
        const app = new aws_cdk_lib_1.App({
            defaultStackSynthesizer: lib_1.AppStagingSynthesizer.defaultResources({
                appId: util_1.APP_ID,
                imageAssetPublishingRole: lib_1.BootstrapRole.fromRoleArn('arn:aws:iam::123456789012:role/ECRAccess'),
            }),
        });
        const stack = new aws_cdk_lib_1.Stack(app, 'Stack', {
            env: {
                account: '000000000000',
                region: 'us-east-1',
            },
        });
        stack.synthesizer.addDockerImageAsset({
            directoryName: '.',
            sourceHash: 'abcdef',
            assetName: 'myDockerAsset',
        });
        // WHEN
        const asm = app.synth();
        // THEN
        // Image role is as advertised
        const manifestArtifact = asm.artifacts.filter(util_1.isAssetManifest)[0];
        expect(manifestArtifact).toBeDefined();
        const manifest = JSON.parse(fs.readFileSync(manifestArtifact.file, { encoding: 'utf-8' }));
        const firstFile = (manifest.dockerImages ? manifest.dockerImages[Object.keys(manifest.dockerImages)[0]] : undefined) ?? {};
        expect(firstFile.destinations['000000000000-us-east-1'].assumeRoleArn).toEqual('arn:aws:iam::123456789012:role/ECRAccess');
    });
    test('bootstrap roles can be specified as current cli credentials instead', () => {
        // GIVEN
        const app = new aws_cdk_lib_1.App({
            defaultStackSynthesizer: lib_1.AppStagingSynthesizer.defaultResources({
                appId: util_1.APP_ID,
                deploymentRoles: {
                    cloudFormationExecutionRole: lib_1.BootstrapRole.cliCredentials(),
                    lookupRole: lib_1.BootstrapRole.cliCredentials(),
                    deploymentRole: lib_1.BootstrapRole.cliCredentials(),
                },
            }),
        });
        const stack = new aws_cdk_lib_1.Stack(app, 'Stack', {
            env: {
                account: '000000000000',
                region: 'us-east-1',
            },
        });
        new aws_cdk_lib_1.CfnResource(stack, 'Resource', {
            type: 'Some::Resource',
        });
        // WHEN
        const asm = app.synth();
        // THEN
        const stackArtifact = asm.getStackArtifact('Stack');
        // Bootstrapped roles are undefined, which means current credentials are used
        expect(stackArtifact.cloudFormationExecutionRoleArn).toBeUndefined();
        expect(stackArtifact.lookupRole).toBeUndefined();
        expect(stackArtifact.assumeRoleArn).toBeUndefined();
    });
    test('qualifier is resolved in the synthesizer', () => {
        const app = new aws_cdk_lib_1.App({
            defaultStackSynthesizer: lib_1.AppStagingSynthesizer.defaultResources({
                bootstrapQualifier: 'abcdef',
                appId: util_1.APP_ID,
            }),
        });
        new aws_cdk_lib_1.Stack(app, 'Stack', {
            env: {
                account: '000000000000',
                region: 'us-east-1',
            },
        });
        // WHEN
        const asm = app.synth();
        // THEN
        const stackArtifact = asm.getStackArtifact('Stack');
        // Bootstrapped role's asset manifest tokens are resolved, where possible
        expect(stackArtifact.cloudFormationExecutionRoleArn).toEqual('arn:${AWS::Partition}:iam::000000000000:role/cdk-abcdef-cfn-exec-role-000000000000-us-east-1');
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYm9vdHN0cmFwLXJvbGVzLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJib290c3RyYXAtcm9sZXMudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHlCQUF5QjtBQUN6Qiw2Q0FBc0Q7QUFFdEQsaUNBQWlEO0FBQ2pELGdDQUE4RDtBQUU5RCxNQUFNLDZCQUE2QixHQUFHLCtCQUErQixDQUFDO0FBQ3RFLE1BQU0sa0JBQWtCLEdBQUcsb0JBQW9CLENBQUM7QUFDaEQsTUFBTSxXQUFXLEdBQUcsYUFBYSxDQUFDO0FBRWxDLFFBQVEsQ0FBQyxnQkFBZ0IsRUFBRSxHQUFHLEVBQUU7SUFDOUIsSUFBSSxDQUFDLDJEQUEyRCxFQUFFLEdBQUcsRUFBRTtRQUNyRSxRQUFRO1FBQ1IsTUFBTSxHQUFHLEdBQUcsSUFBSSxpQkFBRyxDQUFDO1lBQ2xCLHVCQUF1QixFQUFFLDJCQUFxQixDQUFDLGdCQUFnQixDQUFDO2dCQUM5RCxLQUFLLEVBQUUsd0NBQXdDO2FBQ2hELENBQUM7U0FDSCxDQUFDLENBQUM7UUFDSCxNQUFNLEtBQUssR0FBRyxJQUFJLG1CQUFLLENBQUMsR0FBRyxFQUFFLE9BQU8sRUFBRTtZQUNwQyxHQUFHLEVBQUU7Z0JBQ0gsT0FBTyxFQUFFLGNBQWM7Z0JBQ3ZCLE1BQU0sRUFBRSxXQUFXO2FBQ3BCO1NBQ0YsQ0FBQyxDQUFDO1FBQ0gsSUFBSSx5QkFBVyxDQUFDLEtBQUssRUFBRSxVQUFVLEVBQUU7WUFDakMsSUFBSSxFQUFFLGdCQUFnQjtTQUN2QixDQUFDLENBQUM7UUFFSCxPQUFPO1FBQ1AsTUFBTSxHQUFHLEdBQUcsR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBRXhCLE9BQU87UUFDUCxNQUFNLGdCQUFnQixHQUFHLEdBQUcsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLHNCQUFlLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNsRSxNQUFNLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxXQUFXLEVBQUUs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QUM7Z0JBQzlELGtCQUFrQixFQUFFLFFBQVE7Z0JBQzVCLEtBQUssRUFBRSxhQUFNO2FBQ2QsQ0FBQztTQUNILENBQUMsQ0FBQztRQUNILElBQUksbUJBQUssQ0FBQyxHQUFHLEVBQUUsT0FBTyxFQUFFO1lBQ3RCLEdBQUcsRUFBRTtnQkFDSCxPQUFPLEVBQUUsY0FBYztnQkFDdkIsTUFBTSxFQUFFLFdBQVc7YUFDcEI7U0FDRixDQUFDLENBQUM7UUFFSCxPQUFPO1FBQ1AsTUFBTSxHQUFHLEdBQUcsR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBRXhCLE9BQU87UUFDUCxNQUFNLGFBQWEsR0FBRyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFcEQseUVBQXlFO1FBQ3pFLE1BQU0sQ0FBQyxhQUFhLENBQUMsOEJBQThCLENBQUMsQ0FBQyxPQUFPLENBQUMsOEZBQThGLENBQUMsQ0FBQztJQUMvSixDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHsgQXBwLCBTdGFjaywgQ2ZuUmVzb3VyY2UgfSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgKiBhcyBjeHNjaGVtYSBmcm9tICdhd3MtY2RrLWxpYi9jbG91ZC1hc3NlbWJseS1zY2hlbWEnO1xuaW1wb3J0IHsgQVBQX0lELCBpc0Fzc2V0TWFuaWZlc3QgfSBmcm9tICcuL3V0aWwnO1xuaW1wb3J0IHsgQXBwU3RhZ2luZ1N5bnRoZXNpemVyLCBCb290c3RyYXBSb2xlIH0gZnJvbSAnLi4vbGliJztcblxuY29uc3QgQ0xPVURGT1JNQVRJT05fRVhFQ1VUSU9OX1JPTEUgPSAnY2xvdWRmb3JtYXRpb24tZXhlY3V0aW9uLXJvbGUnO1xuY29uc3QgREVQTE9ZX0FDVElPTl9ST0xFID0gJ2RlcGxveS1hY3Rpb24tcm9sZSc7XG5jb25zdCBMT09LVVBfUk9MRSA9ICdsb29rdXAtcm9sZSc7XG5cbmRlc2NyaWJlKCdCb29zdHJhcCBSb2xlcycsICgpID0+IHtcbiAgdGVzdCgnZGVmYXVsdCBib290c3RyYXAgcm9sZSBuYW1lIGlzIGFsd2F5cyB1bmRlciA2NCBjaGFyYWN0ZXJzJywgKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3QgYXBwID0gbmV3IEFwcCh7XG4gICAgICBkZWZhdWx0U3RhY2tTeW50aGVzaXplcjogQXBwU3RhZ2luZ1N5bnRoZXNpemVyLmRlZmF1bHRSZXNvdXJjZXMoe1xuICAgICAgICBhcHBJZDogJ3N1cGVyIGxvbmcgYXBwIGlkIHRoYXQgbmVlZHMgdG8gYmUgY3V0JyxcbiAgICAgIH0pLFxuICAgIH0pO1xuICAgIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKGFwcCwgJ1N0YWNrJywge1xuICAgICAgZW52OiB7XG4gICAgICAgIGFjY291bnQ6ICcwMDAwMDAwMDAwMDAnLFxuICAgICAgICByZWdpb246ICd1cy1lYXN0LTEnLFxuICAgICAgfSxcbiAgICB9KTtcbiAgICBuZXcgQ2ZuUmVzb3VyY2Uoc3RhY2ssICdSZXNvdXJjZScsIHtcbiAgICAgIHR5cGU6ICdTb21lOjpSZXNvdXJjZScsXG4gICAgfSk7XG5cbiAgICAvLyBXSEVOXG4gICAgY29uc3QgYXNtID0gYXBwLnN5bnRoKCk7XG5cbiAgICAvLyBUSEVOXG4gICAgY29uc3QgbWFuaWZlc3RBcnRpZmFjdCA9IGFzbS5hcnRpZmFjdHMuZmlsdGVyKGlzQXNzZXRNYW5pZmVzdClbMF07XG4gICAgZXhwZWN0KG1hbmlmZXN0QXJ0aWZhY3QpLnRvQmVEZWZpbmVkKCk7XG4gICAgY29uc3QgbWFuaWZlc3Q6IGN4c2NoZW1hLkFzc2V0TWFuaWZlc3QgPSBKU09OLnBhcnNlKGZzLnJlYWRGaWxlU3luYyhtYW5pZmVzdEFydGlmYWN0LmZpbGUsIHsgZW5jb2Rpbmc6ICd1dGYtOCcgfSkpO1xuICAgIGNvbnN0IGZpcnN0RmlsZTogYW55ID0gKG1hbmlmZXN0LmZpbGVzID8gbWFuaWZlc3QuZmlsZXNbT2JqZWN0LmtleXMobWFuaWZlc3QuZmlsZXMpWzBdXSA6IHVuZGVmaW5lZCkgPz8ge307XG4gICAgZXhwZWN0KGZpcnN0RmlsZS5kZXN0aW5hdGlvbnNbJzAwMDAwMDAwMDAwMC11cy1lYXN0LTEnXS5hc3N1bWVSb2xlQXJuKS50b0VxdWFsKCdhcm46JHtBV1M6OlBhcnRpdGlvbn06aWFtOjowMDAwMDAwMDAwMDA6cm9sZS9jZGstc3VwZXItbG9uZy1hcHAtaWQtdGgtZmlsZS1yb2xlLXVzLWVhc3QtMScpO1xuICB9KTtcblxuICB0ZXN0KCdjYW4gc3VwcGx5IGV4aXN0aW5nIGFybnMgZm9yIGJvb3RzdHJhcHBlZCByb2xlcycsICgpID0+IHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IGFwcCA9IG5ldyBBcHAoe1xuICAgICAgZGVmYXVsdFN0YWNrU3ludGhlc2l6ZXI6IEFwcFN0YWdpbmdTeW50aGVzaXplci5kZWZhdWx0UmVzb3VyY2VzKHtcbiAgICAgICAgYXBwSWQ6IEFQUF9JRCxcbiAgICAgICAgZGVwbG95bWVudFJvbGVzOiB7XG4gICAgICAgICAgY2xvdWRGb3JtYXRpb25FeGVjdXRpb25Sb2xlOiBCb290c3RyYXBSb2xlLmZyb21Sb2xlQXJuKENMT1VERk9STUFUSU9OX0VYRUNVVElPTl9ST0xFKSxcbiAgICAgICAgICBsb29rdXBSb2xlOiBCb290c3RyYXBSb2xlLmZyb21Sb2xlQXJuKExPT0tVUF9ST0xFKSxcbiAgICAgICAgICBkZXBsb3ltZW50Um9sZTogQm9vdHN0cmFwUm9sZS5mcm9tUm9sZUFybihERVBMT1lfQUNUSU9OX1JPTEUpLFxuICAgICAgICB9LFxuICAgICAgfSksXG4gICAgfSk7XG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soYXBwLCAnU3RhY2snLCB7XG4gICAgICBlbnY6IHtcbiAgICAgICAgYWNjb3VudDogJzAwMDAwMDAwMDAwMCcsXG4gICAgICAgIHJlZ2lvbjogJ3VzLWVhc3QtMScsXG4gICAgICB9LFxuICAgIH0pO1xuICAgIG5ldyBDZm5SZXNvdXJjZShzdGFjaywgJ1Jlc291cmNlJywge1xuICAgICAgdHlwZTogJ1NvbWU6OlJlc291cmNlJyxcbiAgICB9KTtcblxuICAgIC8vIFdIRU5cbiAgICBjb25zdCBhc20gPSBhcHAuc3ludGgoKTtcblxuICAgIC8vIFRIRU5cbiAgICBjb25zdCBzdGFja0FydGlmYWN0ID0gYXNtLmdldFN0YWNrQXJ0aWZhY3QoJ1N0YWNrJyk7XG5cbiAgICAvLyBCb290c3RyYXBwZWQgcm9sZXMgYXJlIGFzIGFkdmVydGlzZWRcbiAgICBleHBlY3Qoc3RhY2tBcnRpZmFjdC5jbG91ZEZvcm1hdGlvbkV4ZWN1dGlvblJvbGVBcm4pLnRvRXF1YWwoQ0xPVURGT1JNQVRJT05fRVhFQ1VUSU9OX1JPTEUpO1xuICAgIGV4cGVjdChzdGFja0FydGlmYWN0Lmxvb2t1cFJvbGUpLnRvRXF1YWwoeyBhcm46IExPT0tVUF9ST0xFIH0pO1xuICAgIGV4cGVjdChzdGFja0FydGlmYWN0LmFzc3VtZVJvbGVBcm4pLnRvRXF1YWwoREVQTE9ZX0FDVElPTl9ST0xFKTtcbiAgfSk7XG5cbiAgdGVzdCgnY2FuIHN1cHBseSBleGlzdGluZyBhcm4gZm9yIGJ1Y2tldCBzdGFnaW5nIHJvbGUnLCAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBhcHAgPSBuZXcgQXBwKHtcbiAgICAgIGRlZmF1bHRTdGFja1N5bnRoZXNpemVyOiBBcHBTdGFnaW5nU3ludGhlc2l6ZXIuZGVmYXVsdFJlc291cmNlcyh7XG4gICAgICAgIGFwcElkOiBBUFBfSUQsXG4gICAgICAgIGZpbGVBc3NldFB1Ymxpc2hpbmdSb2xlOiBCb290c3RyYXBSb2xlLmZyb21Sb2xlQXJuKCdhcm46YXdzOmlhbTo6MTIzNDU2Nzg5MDEyOnJvbGUvUzNBY2Nlc3MnKSxcbiAgICAgIH0pLFxuICAgIH0pO1xuICAgIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKGFwcCwgJ1N0YWNrJywge1xuICAgICAgZW52OiB7XG4gICAgICAgIGFjY291bnQ6ICcwMDAwMDAwMDAwMDAnLFxuICAgICAgICByZWdpb246ICd1cy1lYXN0LTEnLFxuICAgICAgfSxcbiAgICB9KTtcbiAgICBuZXcgQ2ZuUmVzb3VyY2Uoc3RhY2ssICdSZXNvdXJjZScsIHtcbiAgICAgIHR5cGU6ICdTb21lOjpSZXNvdXJjZScsXG4gICAgfSk7XG5cbiAgICAvLyBXSEVOXG4gICAgY29uc3QgYXNtID0gYXBwLnN5bnRoKCk7XG5cbiAgICAvLyBUSEVOXG4gICAgLy8gU3RhZ2luZyByb2xlIGlzIGFzIGFkdmVydGlzZWRcbiAgICBjb25zdCBtYW5pZmVzdEFydGlmYWN0ID0gYXNtLmFydGlmYWN0cy5maWx0ZXIoaXNBc3NldE1hbmlmZXN0KVswXTtcbiAgICBleHBlY3QobWFuaWZlc3RBcnRpZmFjdCkudG9CZURlZmluZWQoKTtcbiAgICBjb25zdCBtYW5pZmVzdDogY3hzY2hlbWEuQXNzZXRNYW5pZmVzdCA9IEpTT04ucGFyc2UoZnMucmVhZEZpbGVTeW5jKG1hbmlmZXN0QXJ0aWZhY3QuZmlsZSwgeyBlbmNvZGluZzogJ3V0Zi04JyB9KSk7XG4gICAgY29uc3QgZmlyc3RGaWxlOiBhbnkgPSAobWFuaWZlc3QuZmlsZXMgPyBtYW5pZmVzdC5maWxlc1tPYmplY3Qua2V5cyhtYW5pZmVzdC5maWxlcylbMF1dIDogdW5kZWZpbmVkKSA/PyB7fTtcbiAgICBleHBlY3QoZmlyc3RGaWxlLmRlc3RpbmF0aW9uc1snMDAwMDAwMDAwMDAwLXVzLWVhc3QtMSddLmFzc3VtZVJvbGVBcm4pLnRvRXF1YWwoJ2Fybjphd3M6aWFtOjoxMjM0NTY3ODkwMTI6cm9sZS9TM0FjY2VzcycpO1xuICB9KTtcblxuICB0ZXN0KCdjYW4gcHJvdmlkZSBleGlzdGluZyBhcm4gZm9yIGltYWdlIHN0YWdpbmcgcm9sZScsICgpID0+IHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IGFwcCA9IG5ldyBBcHAoe1xuICAgICAgZGVmYXVsdFN0YWNrU3ludGhlc2l6ZXI6IEFwcFN0YWdpbmdTeW50aGVzaXplci5kZWZhdWx0UmVzb3VyY2VzKHtcbiAgICAgICAgYXBwSWQ6IEFQUF9JRCxcbiAgICAgICAgaW1hZ2VBc3NldFB1Ymxpc2hpbmdSb2xlOiBCb290c3RyYXBSb2xlLmZyb21Sb2xlQXJuKCdhcm46YXdzOmlhbTo6MTIzNDU2Nzg5MDEyOnJvbGUvRUNSQWNjZXNzJyksXG4gICAgICB9KSxcbiAgICB9KTtcbiAgICBjb25zdCBzdGFjayA9IG5ldyBTdGFjayhhcHAsICdTdGFjaycsIHtcbiAgICAgIGVudjoge1xuICAgICAgICBhY2NvdW50OiAnMDAwMDAwMDAwMDAwJyxcbiAgICAgICAgcmVnaW9uOiAndXMtZWFzdC0xJyxcbiAgICAgIH0sXG4gICAgfSk7XG4gICAgc3RhY2suc3ludGhlc2l6ZXIuYWRkRG9ja2VySW1hZ2VBc3NldCh7XG4gICAgICBkaXJlY3RvcnlOYW1lOiAnLicsXG4gICAgICBzb3VyY2VIYXNoOiAnYWJjZGVmJyxcbiAgICAgIGFzc2V0TmFtZTogJ215RG9ja2VyQXNzZXQnLFxuICAgIH0pO1xuXG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IGFzbSA9IGFwcC5zeW50aCgpO1xuXG4gICAgLy8gVEhFTlxuICAgIC8vIEltYWdlIHJvbGUgaXMgYXMgYWR2ZXJ0aXNlZFxuICAgIGNvbnN0IG1hbmlmZXN0QXJ0aWZhY3QgPSBhc20uYXJ0aWZhY3RzLmZpbHRlcihpc0Fzc2V0TWFuaWZlc3QpWzBdO1xuICAgIGV4cGVjdChtYW5pZmVzdEFydGlmYWN0KS50b0JlRGVmaW5lZCgpO1xuICAgIGNvbnN0IG1hbmlmZXN0OiBjeHNjaGVtYS5Bc3NldE1hbmlmZXN0ID0gSlNPTi5wYXJzZShmcy5yZWFkRmlsZVN5bmMobWFuaWZlc3RBcnRpZmFjdC5maWxlLCB7IGVuY29kaW5nOiAndXRmLTgnIH0pKTtcbiAgICBjb25zdCBmaXJzdEZpbGU6IGFueSA9IChtYW5pZmVzdC5kb2NrZXJJbWFnZXMgPyBtYW5pZmVzdC5kb2NrZXJJbWFnZXNbT2JqZWN0LmtleXMobWFuaWZlc3QuZG9ja2VySW1hZ2VzKVswXV0gOiB1bmRlZmluZWQpID8/IHt9O1xuICAgIGV4cGVjdChmaXJzdEZpbGUuZGVzdGluYXRpb25zWycwMDAwMDAwMDAwMDAtdXMtZWFzdC0xJ10uYXNzdW1lUm9sZUFybikudG9FcXVhbCgnYXJuOmF3czppYW06OjEyMzQ1Njc4OTAxMjpyb2xlL0VDUkFjY2VzcycpO1xuICB9KTtcblxuICB0ZXN0KCdib290c3RyYXAgcm9sZXMgY2FuIGJlIHNwZWNpZmllZCBhcyBjdXJyZW50IGNsaSBjcmVkZW50aWFscyBpbnN0ZWFkJywgKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3QgYXBwID0gbmV3IEFwcCh7XG4gICAgICBkZWZhdWx0U3RhY2tTeW50aGVzaXplcjogQXBwU3RhZ2luZ1N5bnRoZXNpemVyLmRlZmF1bHRSZXNvdXJjZXMoe1xuICAgICAgICBhcHBJZDogQVBQX0lELFxuICAgICAgICBkZXBsb3ltZW50Um9sZXM6IHtcbiAgICAgICAgICBjbG91ZEZvcm1hdGlvbkV4ZWN1dGlvblJvbGU6IEJvb3RzdHJhcFJvbGUuY2xpQ3JlZGVudGlhbHMoKSxcbiAgICAgICAgICBsb29rdXBSb2xlOiBCb290c3RyYXBSb2xlLmNsaUNyZWRlbnRpYWxzKCksXG4gICAgICAgICAgZGVwbG95bWVudFJvbGU6IEJvb3RzdHJhcFJvbGUuY2xpQ3JlZGVudGlhbHMoKSxcbiAgICAgICAgfSxcbiAgICAgIH0pLFxuICAgIH0pO1xuICAgIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKGFwcCwgJ1N0YWNrJywge1xuICAgICAgZW52OiB7XG4gICAgICAgIGFjY291bnQ6ICcwMDAwMDAwMDAwMDAnLFxuICAgICAgICByZWdpb246ICd1cy1lYXN0LTEnLFxuICAgICAgfSxcbiAgICB9KTtcbiAgICBuZXcgQ2ZuUmVzb3VyY2Uoc3RhY2ssICdSZXNvdXJjZScsIHtcbiAgICAgIHR5cGU6ICdTb21lOjpSZXNvdXJjZScsXG4gICAgfSk7XG5cbiAgICAvLyBXSEVOXG4gICAgY29uc3QgYXNtID0gYXBwLnN5bnRoKCk7XG5cbiAgICAvLyBUSEVOXG4gICAgY29uc3Qgc3RhY2tBcnRpZmFjdCA9IGFzbS5nZXRTdGFja0FydGlmYWN0KCdTdGFjaycpO1xuXG4gICAgLy8gQm9vdHN0cmFwcGVkIHJvbGVzIGFyZSB1bmRlZmluZWQsIHdoaWNoIG1lYW5zIGN1cnJlbnQgY3JlZGVudGlhbHMgYXJlIHVzZWRcbiAgICBleHBlY3Qoc3RhY2tBcnRpZmFjdC5jbG91ZEZvcm1hdGlvbkV4ZWN1dGlvblJvbGVBcm4pLnRvQmVVbmRlZmluZWQoKTtcbiAgICBleHBlY3Qoc3RhY2tBcnRpZmFjdC5sb29rdXBSb2xlKS50b0JlVW5kZWZpbmVkKCk7XG4gICAgZXhwZWN0KHN0YWNrQXJ0aWZhY3QuYXNzdW1lUm9sZUFybikudG9CZVVuZGVmaW5lZCgpO1xuICB9KTtcblxuICB0ZXN0KCdxdWFsaWZpZXIgaXMgcmVzb2x2ZWQgaW4gdGhlIHN5bnRoZXNpemVyJywgKCkgPT4ge1xuICAgIGNvbnN0IGFwcCA9IG5ldyBBcHAoe1xuICAgICAgZGVmYXVsdFN0YWNrU3ludGhlc2l6ZXI6IEFwcFN0YWdpbmdTeW50aGVzaXplci5kZWZhdWx0UmVzb3VyY2VzKHtcbiAgICAgICAgYm9vdHN0cmFwUXVhbGlmaWVyOiAnYWJjZGVmJyxcbiAgICAgICAgYXBwSWQ6IEFQUF9JRCxcbiAgICAgIH0pLFxuICAgIH0pO1xuICAgIG5ldyBTdGFjayhhcHAsICdTdGFjaycsIHtcbiAgICAgIGVudjoge1xuICAgICAgICBhY2NvdW50OiAnMDAwMDAwMDAwMDAwJyxcbiAgICAgICAgcmVnaW9uOiAndXMtZWFzdC0xJyxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICAvLyBXSEVOXG4gICAgY29uc3QgYXNtID0gYXBwLnN5bnRoKCk7XG5cbiAgICAvLyBUSEVOXG4gICAgY29uc3Qgc3RhY2tBcnRpZmFjdCA9IGFzbS5nZXRTdGFja0FydGlmYWN0KCdTdGFjaycpO1xuXG4gICAgLy8gQm9vdHN0cmFwcGVkIHJvbGUncyBhc3NldCBtYW5pZmVzdCB0b2tlbnMgYXJlIHJlc29sdmVkLCB3aGVyZSBwb3NzaWJsZVxuICAgIGV4cGVjdChzdGFja0FydGlmYWN0LmNsb3VkRm9ybWF0aW9uRXhlY3V0aW9uUm9sZUFybikudG9FcXVhbCgnYXJuOiR7QVdTOjpQYXJ0aXRpb259OmlhbTo6MDAwMDAwMDAwMDAwOnJvbGUvY2RrLWFiY2RlZi1jZm4tZXhlYy1yb2xlLTAwMDAwMDAwMDAwMC11cy1lYXN0LTEnKTtcbiAgfSk7XG59KTtcbiJdfQ==