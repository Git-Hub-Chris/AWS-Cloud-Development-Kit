import { Construct, Resource } from '@aws-cdk/core';

import { CfnRoute } from '../apigatewayv2.generated';
import { IAuthorizer } from '../common/authorizer';
import { IIntegration } from '../common/integration';
import { IRoute } from '../common/route';
import { IWebSocketApi } from './api';
import { IWebSocketModel } from './model';
import { WebSocketRouteResponse, WebSocketRouteResponseOptions } from './route-response';

/**
 * Available authorization providers for ApiGateway V2 APIs
 */
export enum WebSocketAuthorizationType {
  /**
   * Use AWS IAM permissions (Web Socket APIs).
   */
  IAM = 'AWS_IAM',
  /**
   * Use a custom authorizer (Web Socket APIs).
   */
  CUSTOM = 'CUSTOM',
  /**
   * Use an AWS Cognito user pool (Web Socket APIs).
   */
  COGNITO = 'COGNITO_USER_POOLS'
}

/**
 * Defines a set of common route keys known to the system
 */
export enum WebSocketKnownRouteKey {
  /**
   * Default route, when no other pattern matches
   */
  DEFAULT = '$default',
  /**
   * This route is a reserved route, used when a client establishes a connection to the WebSocket API
   */
  CONNECT = '$connect',
  /**
   * This route is a reserved route, used when a client disconnects from the WebSocket API
   */
  DISCONNECT = '$disconnect'
}

/**
 * Known expressions for selecting a route in an API
 */
export enum WebSocketKnownRouteSelectionExpression {
  /**
   * Selects the route key from the request context
   */
  CONTEXT_ROUTE_KEY = '${context.routeKey}',
}

/**
 * Defines the properties required for defining an Api Gateway V2 Route.
 *
 * This interface is used by the helper methods in `Api`
 */
export interface WebSocketRouteOptions {
  /**
   * The authorization scopes supported by this route.
   *
   * @default - no authorization scope
   */
  readonly authorizationScopes?: string[];

  /**
   * The Authorizer resource to be associated with this route.
   *
   * The authorizer identifier is generated by API Gateway when you created the authorizer.
   *
   * @default - no authorizer
   */
  readonly authorizer?: IAuthorizer;

  /**
   * The operation name for the route.
   *
   * @default - no operation name
   */
  readonly operationName?: string;

  /**
   * Specifies whether an API key is required for the route.
   *
   * @default false
   */
  readonly apiKeyRequired?: boolean;

  /**
   * The authorization type for the route.
   *
   * @default 'NONE'
   */
  readonly authorizationType?: WebSocketAuthorizationType;

  /**
   * The model selection expression for the route.
   *
   * @default - no selection key
   */
  readonly modelSelectionExpression?: string;

  /**
   * The request models for the route.
   *
   * @default - no models (for example passthrough)
   */
  readonly requestModels?: { [key: string]: IWebSocketModel };

  /**
   * The request parameters for the route.
   *
   * @default - no parameters
   */
  readonly requestParameters?: { [key: string]: boolean };

  /**
   * The route response selection expression for the route.
   *
   * @default - no selection expression
   */
  readonly routeResponseSelectionExpression?: string;
}

/**
 * Defines the properties required for defining an Api Gateway V2 Route.
 */
export interface WebSocketRouteProps extends WebSocketRouteOptions {
  /**
   * The route key for the route.
   */
  readonly key: string;

  /**
   * Defines the api for this route.
   */
  readonly api: IWebSocketApi;

  /**
   * Defines the integration for this route.
   */
  readonly integration: IIntegration;
}

/**
 * An route for an API in Amazon API Gateway v2.
 *
 * Use `addResponse` to configure routes.
 *
 * @resource AWS::ApiGatewayV2::Route
 */
export class WebSocketRoute extends Resource implements IRoute {
  /**
   * Creates a new imported API Deployment
   *
   * @param scope scope of this imported resource
   * @param id identifier of the resource
   * @param routeId identifier of the CloudFormation route resource
   */
  public static fromRouteId(scope: Construct, id: string, routeId: string): IRoute {
    class Import extends Resource implements IRoute {
      public readonly routeId = routeId;
    }

    return new Import(scope, id);
  }

  /**
   * The ID of this API Gateway Route.
   */
  public readonly routeId: string;

  /**
   * The key of this API Gateway Route.
   */
  public readonly key: string;

  protected api: IWebSocketApi;
  protected resource: CfnRoute;

  constructor(scope: Construct, id: string, props: WebSocketRouteProps) {
    super(scope, id);
    this.api = props.api;
    this.key = props.key;

    const authorizerId: string | undefined = props.authorizer?.authorizerId;
    let requestModels: { [key: string]: string } | undefined;

    if (props.requestModels !== undefined) {
      requestModels = Object.assign({}, ...Object.entries(props.requestModels).map((e) => {
        return ({ [e[0]]: (typeof(e[1]) === 'string' ? e[1] : e[1].modelName) });
      }));
    }

    this.resource = new CfnRoute(this, 'Resource', {
      apiId: this.api.webSocketApiId,
      routeKey: props.key,
      target: `integrations/${props.integration.integrationId}`,
      requestModels,
      authorizerId,
      apiKeyRequired: props.apiKeyRequired,
      authorizationScopes: props.authorizationScopes,
      authorizationType: props.authorizationType,
      modelSelectionExpression: props.modelSelectionExpression,
      operationName: props.operationName,
      requestParameters: props.requestParameters,
      routeResponseSelectionExpression: props.routeResponseSelectionExpression,
    });
    this.routeId = this.resource.ref;
  }

  /**
   * Creates a new response for this route.
   *
   * @param key the key (predefined or not) that will select this response
   * @param props the properties for this response
   */
  public addResponse(key: string, props?: WebSocketRouteResponseOptions): WebSocketRouteResponse {
    return new WebSocketRouteResponse(this, `Response.${key}`, {
      ...props,
      route: this,
      api: this.api,
      key,
    });
  }
}