{
  "Resources": {
    "User00B015A1": {
      "Type": "AWS::IAM::User"
    },
    "UserDefaultPolicy1F97781E": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "execute-api:Invoke",
              "Effect": "Allow",
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:aws:execute-api:",
                    {
                      "Ref": "AWS::Region"
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId"
                    },
                    ":",
                    {
                      "Ref": "HttpApiF5A9A8A7"
                    },
                    "/*/*/foo"
                  ]
                ]
              }
            },
            {
              "Action": "execute-api:Invoke",
              "Effect": "Allow",
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:aws:execute-api:",
                    {
                      "Ref": "AWS::Region"
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId"
                    },
                    ":",
                    {
                      "Ref": "HttpApiF5A9A8A7"
                    },
                    "/*/*/books/*"
                  ]
                ]
              }
            }
          ],
          "Version": "2012-10-17"
        },
        "PolicyName": "UserDefaultPolicy1F97781E",
        "Users": [
          {
            "Ref": "User00B015A1"
          }
        ]
      }
    },
    "UserAccess": {
      "Type": "AWS::IAM::AccessKey",
      "Properties": {
        "UserName": {
          "Ref": "User00B015A1"
        }
      }
    },
    "HttpApiF5A9A8A7": {
      "Type": "AWS::ApiGatewayV2::Api",
      "Properties": {
        "Name": "HttpApi",
        "ProtocolType": "HTTP"
      }
    },
    "HttpApiDefaultStage3EEB07D6": {
      "Type": "AWS::ApiGatewayV2::Stage",
      "Properties": {
        "ApiId": {
          "Ref": "HttpApiF5A9A8A7"
        },
        "StageName": "$default",
        "AutoDeploy": true
      }
    },
    "FooRouteHttpIntegrationa1c61b1feee2fb313274d3d2ee8b6d4bF59A130B": {
      "Type": "AWS::ApiGatewayV2::Integration",
      "Properties": {
        "ApiId": {
          "Ref": "HttpApiF5A9A8A7"
        },
        "IntegrationType": "HTTP_PROXY",
        "IntegrationMethod": "GET",
        "IntegrationUri": "https://www.example.com/",
        "PayloadFormatVersion": "1.0"
      }
    },
    "FooRoute507F6BE5": {
      "Type": "AWS::ApiGatewayV2::Route",
      "Properties": {
        "ApiId": {
          "Ref": "HttpApiF5A9A8A7"
        },
        "RouteKey": "ANY /foo",
        "AuthorizationType": "AWS_IAM",
        "Target": {
          "Fn::Join": [
            "",
            [
              "integrations/",
              {
                "Ref": "FooRouteHttpIntegrationa1c61b1feee2fb313274d3d2ee8b6d4bF59A130B"
              }
            ]
          ]
        }
      }
    },
    "BooksRoute0E0D7E1E": {
      "Type": "AWS::ApiGatewayV2::Route",
      "Properties": {
        "ApiId": {
          "Ref": "HttpApiF5A9A8A7"
        },
        "RouteKey": "ANY /books/{book}",
        "AuthorizationType": "AWS_IAM",
        "Target": {
          "Fn::Join": [
            "",
            [
              "integrations/",
              {
                "Ref": "FooRouteHttpIntegrationa1c61b1feee2fb313274d3d2ee8b6d4bF59A130B"
              }
            ]
          ]
        }
      }
    }
  },
  "Outputs": {
    "TestScript": {
      "Value": {
        "Fn::Join": [
          "",
          [
            "\necho Expect 403: $(docker run --rm curlimages/curl -s -o/dev/null -w\"%{http_code}\" \"https://",
            {
              "Ref": "HttpApiF5A9A8A7"
            },
            ".execute-api.",
            {
              "Ref": "AWS::Region"
            },
            ".",
            {
              "Ref": "AWS::URLSuffix"
            },
            "/foo\")\necho Expect 200: $(docker run --rm curlimages/curl -s -o/dev/null -w\"%{http_code}\" \"https://",
            {
              "Ref": "HttpApiF5A9A8A7"
            },
            ".execute-api.",
            {
              "Ref": "AWS::Region"
            },
            ".",
            {
              "Ref": "AWS::URLSuffix"
            },
            "/foo\" --user \"",
            {
              "Ref": "UserAccess"
            },
            ":",
            {
              "Fn::GetAtt": [
                "UserAccess",
                "SecretAccessKey"
              ]
            },
            "\" --aws-sigv4 \"aws:amz:",
            {
              "Ref": "AWS::Region"
            },
            ":execute-api\")\necho Expect 403: $(docker run --rm curlimages/curl -s -o/dev/null -w\"%{http_code}\" \"https://",
            {
              "Ref": "HttpApiF5A9A8A7"
            },
            ".execute-api.",
            {
              "Ref": "AWS::Region"
            },
            ".",
            {
              "Ref": "AWS::URLSuffix"
            },
            "/books/something\")\necho Expect 200: $(docker run --rm curlimages/curl -s -o/dev/null -w\"%{http_code}\" \"https://",
            {
              "Ref": "HttpApiF5A9A8A7"
            },
            ".execute-api.",
            {
              "Ref": "AWS::Region"
            },
            ".",
            {
              "Ref": "AWS::URLSuffix"
            },
            "/books/something\" --user \"",
            {
              "Ref": "UserAccess"
            },
            ":",
            {
              "Fn::GetAtt": [
                "UserAccess",
                "SecretAccessKey"
              ]
            },
            "\" --aws-sigv4 \"aws:amz:",
            {
              "Ref": "AWS::Region"
            },
            ":execute-api\")"
          ]
        ]
      }
    }
  }
}