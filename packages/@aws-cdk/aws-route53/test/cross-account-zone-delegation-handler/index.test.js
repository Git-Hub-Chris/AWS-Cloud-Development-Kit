"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const cross_account_zone_delegation_handler_1 = require("../../lib/cross-account-zone-delegation-handler");
const mockStsClient = {
    assumeRole: jest.fn().mockReturnThis(),
    promise: jest.fn(),
};
const mockRoute53Client = {
    changeResourceRecordSets: jest.fn().mockReturnThis(),
    listHostedZonesByName: jest.fn().mockReturnThis(),
    promise: jest.fn(),
};
jest.mock('aws-sdk', () => {
    return {
        ...jest.requireActual('aws-sdk'),
        STS: jest.fn(() => mockStsClient),
        Route53: jest.fn(() => mockRoute53Client),
    };
});
beforeEach(() => {
    mockStsClient.assumeRole.mockReturnThis();
    mockRoute53Client.changeResourceRecordSets.mockReturnThis();
    mockRoute53Client.listHostedZonesByName.mockReturnThis();
});
afterEach(() => {
    jest.clearAllMocks();
});
test('throws error if both ParentZoneId and ParentZoneName are not provided', async () => {
    // WHEN
    const event = getCfnEvent({}, {
        ParentZoneId: undefined,
        ParentZoneName: undefined,
    });
    // THEN
    await expect(invokeHandler(event)).rejects.toThrow(/One of ParentZoneId or ParentZoneName must be specified/);
});
test('throws error if getting credentials fails', async () => {
    // GIVEN
    mockStsClient.promise.mockResolvedValueOnce({ Credentials: undefined });
    // WHEN
    const event = getCfnEvent();
    // THEN
    await expect(invokeHandler(event)).rejects.toThrow(/Error getting assume role credentials/);
    expect(mockStsClient.assumeRole).toHaveBeenCalledTimes(1);
    expect(mockStsClient.assumeRole).toHaveBeenCalledWith({
        RoleArn: 'roleArn',
        RoleSessionName: expect.any(String),
    });
});
test('calls create resource record set with Upsert for Create event', async () => {
    // GIVEN
    mockStsClient.promise.mockResolvedValueOnce({ Credentials: { AccessKeyId: 'K', SecretAccessKey: 'S', SessionToken: 'T' } });
    mockRoute53Client.promise.mockResolvedValueOnce({});
    // WHEN
    const event = getCfnEvent();
    await invokeHandler(event);
    // THEN
    expect(mockRoute53Client.changeResourceRecordSets).toHaveBeenCalledTimes(1);
    expect(mockRoute53Client.changeResourceRecordSets).toHaveBeenCalledWith({
        HostedZoneId: '1',
        ChangeBatch: {
            Changes: [{
                    Action: 'UPSERT',
                    ResourceRecordSet: {
                        Name: 'recordName',
                        Type: 'NS',
                        TTL: 172800,
                        ResourceRecords: [{ Value: 'one' }, { Value: 'two' }],
                    },
                }],
        },
    });
});
test('calls create resource record set with DELETE for Delete event', async () => {
    // GIVEN
    mockStsClient.promise.mockResolvedValueOnce({ Credentials: { AccessKeyId: 'K', SecretAccessKey: 'S', SessionToken: 'T' } });
    mockRoute53Client.promise.mockResolvedValueOnce({});
    // WHEN
    const event = getCfnEvent({ RequestType: 'Delete' });
    await invokeHandler(event);
    // THEN
    expect(mockRoute53Client.changeResourceRecordSets).toHaveBeenCalledTimes(1);
    expect(mockRoute53Client.changeResourceRecordSets).toHaveBeenCalledWith({
        HostedZoneId: '1',
        ChangeBatch: {
            Changes: [{
                    Action: 'DELETE',
                    ResourceRecordSet: {
                        Name: 'recordName',
                        Type: 'NS',
                        TTL: 172800,
                        ResourceRecords: [{ Value: 'one' }, { Value: 'two' }],
                    },
                }],
        },
    });
});
test('calls listHostedZonesByName to get zoneId if ParentZoneId is not provided', async () => {
    // GIVEN
    const parentZoneName = 'some.zone';
    const parentZoneId = 'zone-id';
    mockStsClient.promise.mockResolvedValueOnce({ Credentials: { AccessKeyId: 'K', SecretAccessKey: 'S', SessionToken: 'T' } });
    mockRoute53Client.promise.mockResolvedValueOnce({ HostedZones: [{ Name: `${parentZoneName}.`, Id: parentZoneId }] });
    mockRoute53Client.promise.mockResolvedValueOnce({});
    // WHEN
    const event = getCfnEvent({}, {
        ParentZoneId: undefined,
        ParentZoneName: parentZoneName,
    });
    await invokeHandler(event);
    // THEN
    expect(mockRoute53Client.listHostedZonesByName).toHaveBeenCalledTimes(1);
    expect(mockRoute53Client.listHostedZonesByName).toHaveBeenCalledWith({ DNSName: parentZoneName });
    expect(mockRoute53Client.changeResourceRecordSets).toHaveBeenCalledTimes(1);
    expect(mockRoute53Client.changeResourceRecordSets).toHaveBeenCalledWith({
        HostedZoneId: parentZoneId,
        ChangeBatch: {
            Changes: [{
                    Action: 'UPSERT',
                    ResourceRecordSet: {
                        Name: 'recordName',
                        Type: 'NS',
                        TTL: 172800,
                        ResourceRecords: [{ Value: 'one' }, { Value: 'two' }],
                    },
                }],
        },
    });
});
test('throws if more than one HostedZones are returnd for the provided ParentHostedZone', async () => {
    // GIVEN
    const parentZoneName = 'some.zone';
    const parentZoneId = 'zone-id';
    mockStsClient.promise.mockResolvedValueOnce({ Credentials: { AccessKeyId: 'K', SecretAccessKey: 'S', SessionToken: 'T' } });
    mockRoute53Client.promise.mockResolvedValueOnce({
        HostedZones: [
            { Name: `${parentZoneName}.`, Id: parentZoneId },
            { Name: `${parentZoneName}.`, Id: parentZoneId },
        ],
    });
    // WHEN
    const event = getCfnEvent({}, {
        ParentZoneId: undefined,
        ParentZoneName: parentZoneName,
    });
    // THEN
    await expect(invokeHandler(event)).rejects.toThrow(/Expected one hosted zone to match the given name but found 2/);
    expect(mockRoute53Client.listHostedZonesByName).toHaveBeenCalledTimes(1);
    expect(mockRoute53Client.listHostedZonesByName).toHaveBeenCalledWith({ DNSName: parentZoneName });
});
function getCfnEvent(event, resourceProps) {
    return {
        RequestType: 'Create',
        ResourceProperties: {
            ServiceToken: 'Foo',
            AssumeRoleArn: 'roleArn',
            ParentZoneId: '1',
            DelegatedZoneName: 'recordName',
            DelegatedZoneNameServers: ['one', 'two'],
            TTL: 172800,
            ...resourceProps,
        },
        ...event,
    };
}
// helper function to get around TypeScript expecting a complete event object,
// even though our tests only need some of the fields
async function invokeHandler(event) {
    return cross_account_zone_delegation_handler_1.handler(event);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXgudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImluZGV4LnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwyR0FBMEU7QUFFMUUsTUFBTSxhQUFhLEdBQUc7SUFDcEIsVUFBVSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxjQUFjLEVBQUU7SUFDdEMsT0FBTyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7Q0FDbkIsQ0FBQztBQUNGLE1BQU0saUJBQWlCLEdBQUc7SUFDeEIsd0JBQXdCLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGNBQWMsRUFBRTtJQUNwRCxxQkFBcUIsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsY0FBYyxFQUFFO0lBQ2pELE9BQU8sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO0NBQ25CLENBQUM7QUFFRixJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxHQUFHLEVBQUU7SUFDeEIsT0FBTztRQUNMLEdBQUksSUFBSSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQVM7UUFDekMsR0FBRyxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsYUFBYSxDQUFDO1FBQ2pDLE9BQU8sRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLGlCQUFpQixDQUFDO0tBQzFDLENBQUM7QUFDSixDQUFDLENBQUMsQ0FBQztBQUVILFVBQVUsQ0FBQyxHQUFHLEVBQUU7SUFDZCxhQUFhLENBQUMsVUFBVSxDQUFDLGNBQWMsRUFBRSxDQUFDO0lBQzFDLGlCQUFpQixDQUFDLHdCQUF3QixDQUFDLGNBQWMsRUFBRSxDQUFDO0lBQzVELGlCQUFpQixDQUFDLHFCQUFxQixDQUFDLGNBQWMsRUFBRSxDQUFDO0FBQzNELENBQUMsQ0FBQyxDQUFDO0FBRUgsU0FBUyxDQUFDLEdBQUcsRUFBRTtJQUNiLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztBQUN2QixD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O1lBQ2pCLGlCQUFpQixFQUFFLFlBQVk7WUFDL0Isd0JBQXdCLEVBQUUsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDO1lBQ3hDLEdBQUcsRUFBRSxNQUFNO1lBQ1gsR0FBRyxhQUFhO1NBQ2pCO1FBQ0QsR0FBRyxLQUFLO0tBQ1QsQ0FBQztBQUNKLENBQUM7QUFFRCw4RUFBOEU7QUFDOUUscURBQXFEO0FBQ3JELEtBQUssVUFBVSxhQUFhLENBQUMsS0FBMkQ7SUFDdEYsT0FBTywrQ0FBTyxDQUFDLEtBQW9ELENBQUMsQ0FBQztBQUN2RSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaGFuZGxlciB9IGZyb20gJy4uLy4uL2xpYi9jcm9zcy1hY2NvdW50LXpvbmUtZGVsZWdhdGlvbi1oYW5kbGVyJztcblxuY29uc3QgbW9ja1N0c0NsaWVudCA9IHtcbiAgYXNzdW1lUm9sZTogamVzdC5mbigpLm1vY2tSZXR1cm5UaGlzKCksXG4gIHByb21pc2U6IGplc3QuZm4oKSxcbn07XG5jb25zdCBtb2NrUm91dGU1M0NsaWVudCA9IHtcbiAgY2hhbmdlUmVzb3VyY2VSZWNvcmRTZXRzOiBqZXN0LmZuKCkubW9ja1JldHVyblRoaXMoKSxcbiAgbGlzdEhvc3RlZFpvbmVzQnlOYW1lOiBqZXN0LmZuKCkubW9ja1JldHVyblRoaXMoKSxcbiAgcHJvbWlzZTogamVzdC5mbigpLFxufTtcblxuamVzdC5tb2NrKCdhd3Mtc2RrJywgKCkgPT4ge1xuICByZXR1cm4ge1xuICAgIC4uLihqZXN0LnJlcXVpcmVBY3R1YWwoJ2F3cy1zZGsnKSBhcyBhbnkpLFxuICAgIFNUUzogamVzdC5mbigoKSA9PiBtb2NrU3RzQ2xpZW50KSxcbiAgICBSb3V0ZTUzOiBqZXN0LmZuKCgpID0+IG1vY2tSb3V0ZTUzQ2xpZW50KSxcbiAgfTtcbn0pO1xuXG5iZWZvcmVFYWNoKCgpID0+IHtcbiAgbW9ja1N0c0NsaWVudC5hc3N1bWVSb2xlLm1vY2tSZXR1cm5UaGlzKCk7XG4gIG1vY2tSb3V0ZTUzQ2xpZW50LmNoYW5nZVJlc291cmNlUmVjb3JkU2V0cy5tb2NrUmV0dXJuVGhpcygpO1xuICBtb2NrUm91dGU1M0NsaWVudC5saXN0SG9zdGVkWm9uZXNCeU5hbWUubW9ja1JldHVyblRoaXMoKTtcbn0pO1xuXG5hZnRlckVhY2goKCkgPT4ge1xuICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcbn0pO1xuXG50ZXN0KCd0aHJvd3MgZXJyb3IgaWYgYm90aCBQYXJlbnRab25lSWQgYW5kIFBhcmVudFpvbmVOYW1lIGFyZSBub3QgcHJvdmlkZWQnLCBhc3luYyAoKSA9PiB7XG4gIC8vIFdIRU5cbiAgY29uc3QgZXZlbnQgPSBnZXRDZm5FdmVudCh7fSwge1xuICAgIFBhcmVudFpvbmVJZDogdW5kZWZpbmVkLFxuICAgIFBhcmVudFpvbmVOYW1lOiB1bmRlZmluZWQsXG4gIH0pO1xuXG4gIC8vIFRIRU5cbiAgYXdhaXQgZXhwZWN0KGludm9rZUhhbmRsZXIoZXZlbnQpKS5yZWplY3RzLnRvVGhyb3coL09uZSBvZiBQYXJlbnRab25lSWQgb3IgUGFyZW50Wm9uZU5hbWUgbXVzdCBiZSBzcGVjaWZpZWQvKTtcbn0pO1xuXG50ZXN0KCd0aHJvd3MgZXJyb3IgaWYgZ2V0dGluZyBjcmVkZW50aWFscyBmYWlscycsIGFzeW5jICgpID0+IHtcbiAgLy8gR0lWRU5cbiAgbW9ja1N0c0NsaWVudC5wcm9taXNlLm1vY2tSZXNvbHZlZFZhbHVlT25jZSh7IENyZWRlbnRpYWxzOiB1bmRlZmluZWQgfSk7XG5cbiAgLy8gV0hFTlxuICBjb25zdCBldmVudD0gZ2V0Q2ZuRXZlbnQoKTtcblxuICAvLyBUSEVOXG4gIGF3YWl0IGV4cGVjdChpbnZva2VIYW5kbGVyKGV2ZW50KSkucmVqZWN0cy50b1Rocm93KC9FcnJvciBnZXR0aW5nIGFzc3VtZSByb2xlIGNyZWRlbnRpYWxzLyk7XG5cbiAgZXhwZWN0KG1vY2tTdHNDbGllbnQuYXNzdW1lUm9sZSkudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICBleHBlY3QobW9ja1N0c0NsaWVudC5hc3N1bWVSb2xlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7XG4gICAgUm9sZUFybjogJ3JvbGVBcm4nLFxuICAgIFJvbGVTZXNzaW9uTmFtZTogZXhwZWN0LmFueShTdHJpbmcpLFxuICB9KTtcbn0pO1xuXG50ZXN0KCdjYWxscyBjcmVhdGUgcmVzb3VyY2UgcmVjb3JkIHNldCB3aXRoIFVwc2VydCBmb3IgQ3JlYXRlIGV2ZW50JywgYXN5bmMgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBtb2NrU3RzQ2xpZW50LnByb21pc2UubW9ja1Jlc29sdmVkVmFsdWVPbmNlKHsgQ3JlZGVudGlhbHM6IHsgQWNjZXNzS2V5SWQ6ICdLJywgU2VjcmV0QWNjZXNzS2V5OiAnUycsIFNlc3Npb25Ub2tlbjogJ1QnIH0gfSk7XG4gIG1vY2tSb3V0ZTUzQ2xpZW50LnByb21pc2UubW9ja1Jlc29sdmVkVmFsdWVPbmNlKHt9KTtcblxuICAvLyBXSEVOXG4gIGNvbnN0IGV2ZW50PSBnZXRDZm5FdmVudCgpO1xuICBhd2FpdCBpbnZva2VIYW5kbGVyKGV2ZW50KTtcblxuICAvLyBUSEVOXG4gIGV4cGVjdChtb2NrUm91dGU1M0NsaWVudC5jaGFuZ2VSZXNvdXJjZVJlY29yZFNldHMpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgZXhwZWN0KG1vY2tSb3V0ZTUzQ2xpZW50LmNoYW5nZVJlc291cmNlUmVjb3JkU2V0cykudG9IYXZlQmVlbkNhbGxlZFdpdGgoe1xuICAgIEhvc3RlZFpvbmVJZDogJzEnLFxuICAgIENoYW5nZUJhdGNoOiB7XG4gICAgICBDaGFuZ2VzOiBbe1xuICAgICAgICBBY3Rpb246ICdVUFNFUlQnLFxuICAgICAgICBSZXNvdXJjZVJlY29yZFNldDoge1xuICAgICAgICAgIE5hbWU6ICdyZWNvcmROYW1lJyxcbiAgICAgICAgICBUeXBlOiAnTlMnLFxuICAgICAgICAgIFRUTDogMTcyODAwLFxuICAgICAgICAgIFJlc291cmNlUmVjb3JkczogW3sgVmFsdWU6ICdvbmUnIH0sIHsgVmFsdWU6ICd0d28nIH1dLFxuICAgICAgICB9LFxuICAgICAgfV0sXG4gICAgfSxcbiAgfSk7XG59KTtcblxudGVzdCgnY2FsbHMgY3JlYXRlIHJlc291cmNlIHJlY29yZCBzZXQgd2l0aCBERUxFVEUgZm9yIERlbGV0ZSBldmVudCcsIGFzeW5jICgpID0+IHtcbiAgLy8gR0lWRU5cbiAgbW9ja1N0c0NsaWVudC5wcm9taXNlLm1vY2tSZXNvbHZlZFZhbHVlT25jZSh7IENyZWRlbnRpYWxzOiB7IEFjY2Vzc0tleUlkOiAnSycsIFNlY3JldEFjY2Vzc0tleTogJ1MnLCBTZXNzaW9uVG9rZW46ICdUJyB9IH0pO1xuICBtb2NrUm91dGU1M0NsaWVudC5wcm9taXNlLm1vY2tSZXNvbHZlZFZhbHVlT25jZSh7fSk7XG5cbiAgLy8gV0hFTlxuICBjb25zdCBldmVudD0gZ2V0Q2ZuRXZlbnQoeyBSZXF1ZXN0VHlwZTogJ0RlbGV0ZScgfSk7XG4gIGF3YWl0IGludm9rZUhhbmRsZXIoZXZlbnQpO1xuXG4gIC8vIFRIRU5cbiAgZXhwZWN0KG1vY2tSb3V0ZTUzQ2xpZW50LmNoYW5nZVJlc291cmNlUmVjb3JkU2V0cykudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICBleHBlY3QobW9ja1JvdXRlNTNDbGllbnQuY2hhbmdlUmVzb3VyY2VSZWNvcmRTZXRzKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7XG4gICAgSG9zdGVkWm9uZUlkOiAnMScsXG4gICAgQ2hhbmdlQmF0Y2g6IHtcbiAgICAgIENoYW5nZXM6IFt7XG4gICAgICAgIEFjdGlvbjogJ0RFTEVURScsXG4gICAgICAgIFJlc291cmNlUmVjb3JkU2V0OiB7XG4gICAgICAgICAgTmFtZTogJ3JlY29yZE5hbWUnLFxuICAgICAgICAgIFR5cGU6ICdOUycsXG4gICAgICAgICAgVFRMOiAxNzI4MDAsXG4gICAgICAgICAgUmVzb3VyY2VSZWNvcmRzOiBbeyBWYWx1ZTogJ29uZScgfSwgeyBWYWx1ZTogJ3R3bycgfV0sXG4gICAgICAgIH0sXG4gICAgICB9XSxcbiAgICB9LFxuICB9KTtcbn0pO1xuXG50ZXN0KCdjYWxscyBsaXN0SG9zdGVkWm9uZXNCeU5hbWUgdG8gZ2V0IHpvbmVJZCBpZiBQYXJlbnRab25lSWQgaXMgbm90IHByb3ZpZGVkJywgYXN5bmMgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBjb25zdCBwYXJlbnRab25lTmFtZSA9ICdzb21lLnpvbmUnO1xuICBjb25zdCBwYXJlbnRab25lSWQgPSAnem9uZS1pZCc7XG5cbiAgbW9ja1N0c0NsaWVudC5wcm9taXNlLm1vY2tSZXNvbHZlZFZhbHVlT25jZSh7IENyZWRlbnRpYWxzOiB7IEFjY2Vzc0tleUlkOiAnSycsIFNlY3JldEFjY2Vzc0tleTogJ1MnLCBTZXNzaW9uVG9rZW46ICdUJyB9IH0pO1xuICBtb2NrUm91dGU1M0NsaWVudC5wcm9taXNlLm1vY2tSZXNvbHZlZFZhbHVlT25jZSh7IEhvc3RlZFpvbmVzOiBbeyBOYW1lOiBgJHtwYXJlbnRab25lTmFtZX0uYCwgSWQ6IHBhcmVudFpvbmVJZCB9XSB9KTtcbiAgbW9ja1JvdXRlNTNDbGllbnQucHJvbWlzZS5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2Uoe30pO1xuXG4gIC8vIFdIRU5cbiAgY29uc3QgZXZlbnQgPSBnZXRDZm5FdmVudCh7fSwge1xuICAgIFBhcmVudFpvbmVJZDogdW5kZWZpbmVkLFxuICAgIFBhcmVudFpvbmVOYW1lOiBwYXJlbnRab25lTmFtZSxcbiAgfSk7XG4gIGF3YWl0IGludm9rZUhhbmRsZXIoZXZlbnQpO1xuXG4gIC8vIFRIRU5cbiAgZXhwZWN0KG1vY2tSb3V0ZTUzQ2xpZW50Lmxpc3RIb3N0ZWRab25lc0J5TmFtZSkudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICBleHBlY3QobW9ja1JvdXRlNTNDbGllbnQubGlzdEhvc3RlZFpvbmVzQnlOYW1lKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7IEROU05hbWU6IHBhcmVudFpvbmVOYW1lIH0pO1xuXG4gIGV4cGVjdChtb2NrUm91dGU1M0NsaWVudC5jaGFuZ2VSZXNvdXJjZVJlY29yZFNldHMpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgZXhwZWN0KG1vY2tSb3V0ZTUzQ2xpZW50LmNoYW5nZVJlc291cmNlUmVjb3JkU2V0cykudG9IYXZlQmVlbkNhbGxlZFdpdGgoe1xuICAgIEhvc3RlZFpvbmVJZDogcGFyZW50Wm9uZUlkLFxuICAgIENoYW5nZUJhdGNoOiB7XG4gICAgICBDaGFuZ2VzOiBbe1xuICAgICAgICBBY3Rpb246ICdVUFNFUlQnLFxuICAgICAgICBSZXNvdXJjZVJlY29yZFNldDoge1xuICAgICAgICAgIE5hbWU6ICdyZWNvcmROYW1lJyxcbiAgICAgICAgICBUeXBlOiAnTlMnLFxuICAgICAgICAgIFRUTDogMTcyODAwLFxuICAgICAgICAgIFJlc291cmNlUmVjb3JkczogW3sgVmFsdWU6ICdvbmUnIH0sIHsgVmFsdWU6ICd0d28nIH1dLFxuICAgICAgICB9LFxuICAgICAgfV0sXG4gICAgfSxcbiAgfSk7XG59KTtcblxudGVzdCgndGhyb3dzIGlmIG1vcmUgdGhhbiBvbmUgSG9zdGVkWm9uZXMgYXJlIHJldHVybmQgZm9yIHRoZSBwcm92aWRlZCBQYXJlbnRIb3N0ZWRab25lJywgYXN5bmMgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBjb25zdCBwYXJlbnRab25lTmFtZSA9ICdzb21lLnpvbmUnO1xuICBjb25zdCBwYXJlbnRab25lSWQgPSAnem9uZS1pZCc7XG5cbiAgbW9ja1N0c0NsaWVudC5wcm9taXNlLm1vY2tSZXNvbHZlZFZhbHVlT25jZSh7IENyZWRlbnRpYWxzOiB7IEFjY2Vzc0tleUlkOiAnSycsIFNlY3JldEFjY2Vzc0tleTogJ1MnLCBTZXNzaW9uVG9rZW46ICdUJyB9IH0pO1xuICBtb2NrUm91dGU1M0NsaWVudC5wcm9taXNlLm1vY2tSZXNvbHZlZFZhbHVlT25jZSh7XG4gICAgSG9zdGVkWm9uZXM6IFtcbiAgICAgIHsgTmFtZTogYCR7cGFyZW50Wm9uZU5hbWV9LmAsIElkOiBwYXJlbnRab25lSWQgfSxcbiAgICAgIHsgTmFtZTogYCR7cGFyZW50Wm9uZU5hbWV9LmAsIElkOiBwYXJlbnRab25lSWQgfSxcbiAgICBdLFxuICB9KTtcblxuICAvLyBXSEVOXG4gIGNvbnN0IGV2ZW50ID0gZ2V0Q2ZuRXZlbnQoe30sIHtcbiAgICBQYXJlbnRab25lSWQ6IHVuZGVmaW5lZCxcbiAgICBQYXJlbnRab25lTmFtZTogcGFyZW50Wm9uZU5hbWUsXG4gIH0pO1xuXG4gIC8vIFRIRU5cbiAgYXdhaXQgZXhwZWN0KGludm9rZUhhbmRsZXIoZXZlbnQpKS5yZWplY3RzLnRvVGhyb3coL0V4cGVjdGVkIG9uZSBob3N0ZWQgem9uZSB0byBtYXRjaCB0aGUgZ2l2ZW4gbmFtZSBidXQgZm91bmQgMi8pO1xuICBleHBlY3QobW9ja1JvdXRlNTNDbGllbnQubGlzdEhvc3RlZFpvbmVzQnlOYW1lKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSk7XG4gIGV4cGVjdChtb2NrUm91dGU1M0NsaWVudC5saXN0SG9zdGVkWm9uZXNCeU5hbWUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHsgRE5TTmFtZTogcGFyZW50Wm9uZU5hbWUgfSk7XG59KTtcblxuZnVuY3Rpb24gZ2V0Q2ZuRXZlbnQoXG4gIGV2ZW50PzogUGFydGlhbDxBV1NMYW1iZGEuQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZUV2ZW50PixcbiAgcmVzb3VyY2VQcm9wcz86IGFueSxcbik6IFBhcnRpYWw8QVdTTGFtYmRhLkNsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VFdmVudD4ge1xuICByZXR1cm4ge1xuICAgIFJlcXVlc3RUeXBlOiAnQ3JlYXRlJyxcbiAgICBSZXNvdXJjZVByb3BlcnRpZXM6IHtcbiAgICAgIFNlcnZpY2VUb2tlbjogJ0ZvbycsXG4gICAgICBBc3N1bWVSb2xlQXJuOiAncm9sZUFybicsXG4gICAgICBQYXJlbnRab25lSWQ6ICcxJyxcbiAgICAgIERlbGVnYXRlZFpvbmVOYW1lOiAncmVjb3JkTmFtZScsXG4gICAgICBEZWxlZ2F0ZWRab25lTmFtZVNlcnZlcnM6IFsnb25lJywgJ3R3byddLFxuICAgICAgVFRMOiAxNzI4MDAsXG4gICAgICAuLi5yZXNvdXJjZVByb3BzLFxuICAgIH0sXG4gICAgLi4uZXZlbnQsXG4gIH07XG59XG5cbi8vIGhlbHBlciBmdW5jdGlvbiB0byBnZXQgYXJvdW5kIFR5cGVTY3JpcHQgZXhwZWN0aW5nIGEgY29tcGxldGUgZXZlbnQgb2JqZWN0LFxuLy8gZXZlbiB0aG91Z2ggb3VyIHRlc3RzIG9ubHkgbmVlZCBzb21lIG9mIHRoZSBmaWVsZHNcbmFzeW5jIGZ1bmN0aW9uIGludm9rZUhhbmRsZXIoZXZlbnQ6IFBhcnRpYWw8QVdTTGFtYmRhLkNsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VFdmVudD4pIHtcbiAgcmV0dXJuIGhhbmRsZXIoZXZlbnQgYXMgQVdTTGFtYmRhLkNsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VFdmVudCk7XG59XG4iXX0=