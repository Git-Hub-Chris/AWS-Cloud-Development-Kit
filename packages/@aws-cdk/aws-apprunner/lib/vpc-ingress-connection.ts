import * as ec2 from '@aws-cdk/aws-ec2';
import * as cdk from '@aws-cdk/core';
import { Construct } from 'constructs';
import { CfnVpcIngressConnection } from './apprunner.generated';
import { Service } from './service';

/**
 * Properties of the AppRunner VPC Interface Endpoint connection
 */
export interface VpcInterfaceEndpointProps {

  /**
   * The service to connect.
   */
  readonly service: Service,

  /**
   * The VPC for the VPC Connector.
   */
  readonly vpc: ec2.IVpc;

  /**
   * The VPC for the VPC Connector.
   */
  readonly vpcInterfaceEndpoint: ec2.IInterfaceVpcEndpoint;

  /**
    * The name for the VPC Ingress Connection.
    *
    * @default - a name generated by CloudFormation
    */
  readonly vpcIngressConnectionName?: string;
}

/**
 * Represents the App Runner VPC Connector.
 */
export interface IVpcIngressConnection extends cdk.IResource {
  /**
   * The Amazon Resource Name (ARN) of the VPC Ingress Connection.
   * @attribute
   */
  readonly vpcIngressConnectionArn: string;

  /**
    * The domain name associated with the VPC Ingress Connection resource.
    * @attribute
    */
  readonly domainName: string;

  /**
    * The current status of the VPC Ingress Connection.
    * @attribute
    */
  readonly status: string;

  /**
    * The name of the VPC Ingress Connection.
    * @attribute
    */
  readonly vpcIngressConnectionName: string;
}

/**
 * The App Runner VPC Ingress Connection
 *
 * @resource AWS::AppRunner::VpcIngressConnection
 */
export class VpcIngressConnection extends cdk.Resource implements IVpcIngressConnection {
  /**
   * The Amazon Resource Name (ARN) of the VPC Ingress Connection.
   * @attribute
   */
  readonly vpcIngressConnectionArn: string;

  /**
   * The domain name associated with the VPC Ingress Connection resource.
   * @attribute
   */
  readonly domainName: string;

  /**
   * The current status of the VPC Ingress Connection.
   * @attribute
   */
  readonly status: string;

  /**
   * The name of the VPC Ingress Connection.
   * @attribute
   */
  readonly vpcIngressConnectionName: string;

  public constructor(scope: Construct, id: string, props: VpcInterfaceEndpointProps) {
    super(scope, id, {
      physicalName: props.vpcIngressConnectionName,
    });

    const resource = new CfnVpcIngressConnection(this, 'Resource', {
      ingressVpcConfiguration: {
        vpcEndpointId: props.vpcInterfaceEndpoint.vpcEndpointId,
        vpcId: props.vpc.vpcId,
      },
      serviceArn: props.service.serviceArn,
      vpcIngressConnectionName: this.physicalName,
    });

    this.vpcIngressConnectionArn = resource.attrVpcIngressConnectionArn;
    this.domainName = resource.attrDomainName,
    this.status = resource.attrStatus,
    this.vpcIngressConnectionName = resource.ref;
  }
}