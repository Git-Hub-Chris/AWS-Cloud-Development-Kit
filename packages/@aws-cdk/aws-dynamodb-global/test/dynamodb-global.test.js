"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assertions_1 = require("@aws-cdk/assertions");
const aws_dynamodb_1 = require("@aws-cdk/aws-dynamodb");
const cdk_build_tools_1 = require("@aws-cdk/cdk-build-tools");
const core_1 = require("@aws-cdk/core");
const lib_1 = require("../lib");
/* eslint-disable quote-props */
// CDK parameters
const CONSTRUCT_NAME = 'aws-cdk-dynamodb-global';
// DynamoDB table parameters
const TABLE_NAME = 'GlobalTable';
const TABLE_PARTITION_KEY = { name: 'hashKey', type: aws_dynamodb_1.AttributeType.STRING };
const STACK_PROPS = {
    partitionKey: TABLE_PARTITION_KEY,
    tableName: TABLE_NAME,
    regions: ['us-east-1', 'us-east-2', 'us-west-2'],
};
cdk_build_tools_1.describeDeprecated('Default Global DynamoDB stack', () => {
    test('global dynamo', () => {
        const stack = new core_1.Stack();
        new lib_1.GlobalTable(stack, CONSTRUCT_NAME, STACK_PROPS);
        const topStack = stack.node.findChild(CONSTRUCT_NAME);
        for (const reg of STACK_PROPS.regions) {
            const tableStack = topStack.node.findChild(CONSTRUCT_NAME + '-' + reg);
            assertions_1.Template.fromStack(tableStack).hasResourceProperties('AWS::DynamoDB::Table', {
                'KeySchema': [
                    {
                        'AttributeName': 'hashKey',
                        'KeyType': 'HASH',
                    },
                ],
                'AttributeDefinitions': [
                    {
                        'AttributeName': 'hashKey',
                        'AttributeType': 'S',
                    },
                ],
                'StreamSpecification': {
                    'StreamViewType': 'NEW_AND_OLD_IMAGES',
                },
                'TableName': 'GlobalTable',
            });
        }
        const customResourceStack = stack.node.findChild(CONSTRUCT_NAME + '-CustomResource');
        assertions_1.Template.fromStack(customResourceStack).hasResourceProperties('AWS::Lambda::Function', {
            Description: 'Lambda to make DynamoDB a global table',
            Handler: 'index.handler',
            Timeout: 300,
        });
        assertions_1.Template.fromStack(customResourceStack).hasResourceProperties('AWS::CloudFormation::CustomResource', {
            Regions: STACK_PROPS.regions,
            ResourceType: 'Custom::DynamoGlobalTableCoordinator',
            TableName: TABLE_NAME,
        });
    });
});
cdk_build_tools_1.testDeprecated('GlobalTable generated stacks inherit their account from the parent stack', () => {
    const app = new core_1.App({ context: { '@aws-cdk/core:stackRelativeExports': true } });
    const stack = new core_1.Stack(app, 'GlobalTableStack', { env: { account: '123456789012', region: 'us-east-1' } });
    const globalTable = new lib_1.GlobalTable(stack, CONSTRUCT_NAME, {
        tableName: TABLE_NAME,
        partitionKey: TABLE_PARTITION_KEY,
        regions: ['us-east-1', 'us-west-2'],
        stream: aws_dynamodb_1.StreamViewType.NEW_AND_OLD_IMAGES,
    });
    new core_1.CfnOutput(stack, 'DynamoDbOutput', {
        // this works, because both `stack` and `regionTables[0]` stack are in the same account & region
        value: globalTable.regionalTables[0].tableStreamArn,
    });
    assertions_1.Template.fromStack(stack).templateMatches({
        'Outputs': {
            'DynamoDbOutput': {
                'Value': {
                    'Fn::ImportValue': 'GlobalTableStackawscdkdynamodbglobalawscdkdynamodbglobaluseast19C1C8A14:ExportsOutputFnGetAttawscdkdynamodbglobalGlobalTableuseast1FC03DD69StreamArn9CE585ED',
                },
            },
        },
    });
});
cdk_build_tools_1.describeDeprecated('Enforce StreamSpecification', () => {
    test('global dynamo should only allow NEW_AND_OLD_IMAGES', () => {
        const stack = new core_1.Stack();
        expect(() => {
            new lib_1.GlobalTable(stack, CONSTRUCT_NAME, {
                tableName: TABLE_NAME,
                stream: aws_dynamodb_1.StreamViewType.KEYS_ONLY,
                partitionKey: TABLE_PARTITION_KEY,
                regions: ['us-east-1', 'us-east-2', 'us-west-2'],
            });
        }).toThrow(/dynamoProps.stream MUST be set to dynamodb.StreamViewType.NEW_AND_OLD_IMAGES/);
    });
});
cdk_build_tools_1.describeDeprecated('Check getting tables', () => {
    test('global dynamo should only allow NEW_AND_OLD_IMAGES', () => {
        const stack = new core_1.Stack();
        const regTables = new lib_1.GlobalTable(stack, CONSTRUCT_NAME, {
            tableName: TABLE_NAME,
            partitionKey: TABLE_PARTITION_KEY,
            regions: ['us-east-1', 'us-east-2', 'us-west-2'],
        });
        expect(regTables.regionalTables.length).toEqual(3);
        for (const table of regTables.regionalTables) {
            expect(table).toBeInstanceOf(aws_dynamodb_1.Table);
        }
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1vZGItZ2xvYmFsLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJkeW5hbW9kYi1nbG9iYWwudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLG9EQUErQztBQUMvQyx3REFBd0Y7QUFDeEYsOERBQThFO0FBQzlFLHdDQUFzRDtBQUN0RCxnQ0FBdUQ7QUFFdkQsZ0NBQWdDO0FBRWhDLGlCQUFpQjtBQUNqQixNQUFNLGNBQWMsR0FBRyx5QkFBeUIsQ0FBQztBQUVqRCw0QkFBNEI7QUFDNUIsTUFBTSxVQUFVLEdBQUcsYUFBYSxDQUFDO0FBQ2pDLE1BQU0sbUJBQW1CLEdBQWMsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSw0QkFBYSxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBRXZGLE1BQU0sV0FBVyxHQUFxQjtJQUNwQyxZQUFZLEVBQUUsbUJBQW1CO0lBQ2pDLFNBQVMsRUFBRSxVQUFVO0lBQ3JCLE9BQU8sRUFBRSxDQUFDLFdBQVcsRUFBRSxXQUFXLEVBQUUsV0FBVyxDQUFDO0NBQ2pELENBQUM7QUFFRixvQ0FBa0IsQ0FBQywrQkFBK0IsRUFBRSxHQUFHLEVBQUU7SUFDdkQsSUFBSSxDQUFDLGVBQWUsRUFBRSxHQUFHLEVBQUU7UUFDekIsTUFBTSxLQUFLLEdBQUcsSUFBSSxZQUFLLEVBQUUsQ0FBQztRQUMxQixJQUFJLGlCQUFXLENBQUMsS0FBSyxFQUFFLGNBQWMsRUFBRSxXQUFXLENBQUMsQ0FBQztRQUNwRCxNQUFNLFFBQVEsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQVUsQ0FBQztRQUMvRCxLQUFNLE1BQU0sR0FBRyxJQUFJLFdBQVcsQ0FBQyxPQUFPLEVBQUc7WUFDdkMsTUFBTSxVQUFVLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxHQUFHLEdBQUcsR0FBRyxHQUFHLENBQVUsQ0FBQztZQUNoRixxQkFBUSxDQUFDLFNBQVMsQ0FB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akQsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLDhFQUE4RSxDQUFDLENBQUM7SUFDN0YsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQztBQUVILG9DQUFrQixDQUFDLHNCQUFzQixFQUFFLEdBQUcsRUFBRTtJQUM5QyxJQUFJLENBQUMsb0RBQW9ELEVBQUUsR0FBRyxFQUFFO1FBQzlELE1BQU0sS0FBSyxHQUFHLElBQUksWUFBSyxFQUFFLENBQUM7UUFDMUIsTUFBTSxTQUFTLEdBQUcsSUFBSSxpQkFBVyxDQUFDLEtBQUssRUFBRSxjQUFjLEVBQUU7WUFDdkQsU0FBUyxFQUFFLFVBQVU7WUFDckIsWUFBWSxFQUFFLG1CQUFtQjtZQUNqQyxPQUFPLEVBQUUsQ0FBQyxXQUFXLEVBQUUsV0FBVyxFQUFFLFdBQVcsQ0FBQztTQUNqRCxDQUFDLENBQUM7UUFDSCxNQUFNLENBQUMsU0FBUyxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbkQsS0FBSyxNQUFNLEtBQUssSUFBSSxTQUFTLENBQUMsY0FBYyxFQUFFO1lBQzVDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxjQUFjLENBQUMsb0JBQUssQ0FBQyxDQUFDO1NBQ3JDO0lBQ0gsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRlbXBsYXRlIH0gZnJvbSAnQGF3cy1jZGsvYXNzZXJ0aW9ucyc7XG5pbXBvcnQgeyBBdHRyaWJ1dGUsIEF0dHJpYnV0ZVR5cGUsIFN0cmVhbVZpZXdUeXBlLCBUYWJsZSB9IGZyb20gJ0Bhd3MtY2RrL2F3cy1keW5hbW9kYic7XG5pbXBvcnQgeyBkZXNjcmliZURlcHJlY2F0ZWQsIHRlc3REZXByZWNhdGVkIH0gZnJvbSAnQGF3cy1jZGsvY2RrLWJ1aWxkLXRvb2xzJztcbmltcG9ydCB7IEFwcCwgQ2ZuT3V0cHV0LCBTdGFjayB9IGZyb20gJ0Bhd3MtY2RrL2NvcmUnO1xuaW1wb3J0IHsgR2xvYmFsVGFibGUsIEdsb2JhbFRhYmxlUHJvcHMgfSBmcm9tICcuLi9saWInO1xuXG4vKiBlc2xpbnQtZGlzYWJsZSBxdW90ZS1wcm9wcyAqL1xuXG4vLyBDREsgcGFyYW1ldGVyc1xuY29uc3QgQ09OU1RSVUNUX05BTUUgPSAnYXdzLWNkay1keW5hbW9kYi1nbG9iYWwnO1xuXG4vLyBEeW5hbW9EQiB0YWJsZSBwYXJhbWV0ZXJzXG5jb25zdCBUQUJMRV9OQU1FID0gJ0dsb2JhbFRhYmxlJztcbmNvbnN0IFRBQkxFX1BBUlRJVElPTl9LRVk6IEF0dHJpYnV0ZSA9IHsgbmFtZTogJ2hhc2hLZXknLCB0eXBlOiBBdHRyaWJ1dGVUeXBlLlNUUklORyB9O1xuXG5jb25zdCBTVEFDS19QUk9QUzogR2xvYmFsVGFibGVQcm9wcyA9IHtcbiAgcGFydGl0aW9uS2V5OiBUQUJMRV9QQVJUSVRJT05fS0VZLFxuICB0YWJsZU5hbWU6IFRBQkxFX05BTUUsXG4gIHJlZ2lvbnM6IFsndXMtZWFzdC0xJywgJ3VzLWVhc3QtMicsICd1cy13ZXN0LTInXSxcbn07XG5cbmRlc2NyaWJlRGVwcmVjYXRlZCgnRGVmYXVsdCBHbG9iYWwgRHluYW1vREIgc3RhY2snLCAoKSA9PiB7XG4gIHRlc3QoJ2dsb2JhbCBkeW5hbW8nLCAoKSA9PiB7XG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soKTtcbiAgICBuZXcgR2xvYmFsVGFibGUoc3RhY2ssIENPTlNUUlVDVF9OQU1FLCBTVEFDS19QUk9QUyk7XG4gICAgY29uc3QgdG9wU3RhY2sgPSBzdGFjay5ub2RlLmZpbmRDaGlsZChDT05TVFJVQ1RfTkFNRSkgYXMgU3RhY2s7XG4gICAgZm9yICggY29uc3QgcmVnIG9mIFNUQUNLX1BST1BTLnJlZ2lvbnMgKSB7XG4gICAgICBjb25zdCB0YWJsZVN0YWNrID0gdG9wU3RhY2subm9kZS5maW5kQ2hpbGQoQ09OU1RSVUNUX05BTUUgKyAnLScgKyByZWcpIGFzIFN0YWNrO1xuICAgICAgVGVtcGxhdGUuZnJvbVN0YWNrKHRhYmxlU3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpEeW5hbW9EQjo6VGFibGUnLCB7XG4gICAgICAgICdLZXlTY2hlbWEnOiBbXG4gICAgICAgICAge1xuICAgICAgICAgICAgJ0F0dHJpYnV0ZU5hbWUnOiAnaGFzaEtleScsXG4gICAgICAgICAgICAnS2V5VHlwZSc6ICdIQVNIJyxcbiAgICAgICAgICB9LFxuICAgICAgICBdLFxuICAgICAgICAnQXR0cmlidXRlRGVmaW5pdGlvbnMnOiBbXG4gICAgICAgICAge1xuICAgICAgICAgICAgJ0F0dHJpYnV0ZU5hbWUnOiAnaGFzaEtleScsXG4gICAgICAgICAgICAnQXR0cmlidXRlVHlwZSc6ICdTJyxcbiAgICAgICAgICB9LFxuICAgICAgICBdLFxuICAgICAgICAnU3RyZWFtU3BlY2lmaWNhdGlvbic6IHtcbiAgICAgICAgICAnU3RyZWFtVmlld1R5cGUnOiAnTkVXX0FORF9PTERfSU1BR0VTJyxcbiAgICAgICAgfSxcbiAgICAgICAgJ1RhYmxlTmFtZSc6ICdHbG9iYWxUYWJsZScsXG4gICAgICB9KTtcbiAgICB9XG4gICAgY29uc3QgY3VzdG9tUmVzb3VyY2VTdGFjayA9IHN0YWNrLm5vZGUuZmluZENoaWxkKENPTlNUUlVDVF9OQU1FICsgJy1DdXN0b21SZXNvdXJjZScpIGFzIFN0YWNrO1xuICAgIFRlbXBsYXRlLmZyb21TdGFjayhjdXN0b21SZXNvdXJjZVN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6TGFtYmRhOjpGdW5jdGlvbicsIHtcbiAgICAgIERlc2NyaXB0aW9uOiAnTGFtYmRhIHRvIG1ha2UgRHluYW1vREIgYSBnbG9iYWwgdGFibGUnLFxuICAgICAgSGFuZGxlcjogJ2luZGV4LmhhbmRsZXInLFxuICAgICAgVGltZW91dDogMzAwLFxuICAgIH0pO1xuICAgIFRlbXBsYXRlLmZyb21TdGFjayhjdXN0b21SZXNvdXJjZVN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6Q2xvdWRGb3JtYXRpb246OkN1c3RvbVJlc291cmNlJywge1xuICAgICAgUmVnaW9uczogU1RBQ0tfUFJPUFMucmVnaW9ucyxcbiAgICAgIFJlc291cmNlVHlwZTogJ0N1c3RvbTo6RHluYW1vR2xvYmFsVGFibGVDb29yZGluYXRvcicsXG4gICAgICBUYWJsZU5hbWU6IFRBQkxFX05BTUUsXG4gICAgfSk7XG4gIH0pO1xufSk7XG5cbnRlc3REZXByZWNhdGVkKCdHbG9iYWxUYWJsZSBnZW5lcmF0ZWQgc3RhY2tzIGluaGVyaXQgdGhlaXIgYWNjb3VudCBmcm9tIHRoZSBwYXJlbnQgc3RhY2snLCAoKSA9PiB7XG4gIGNvbnN0IGFwcCA9IG5ldyBBcHAoeyBjb250ZXh0OiB7ICdAYXdzLWNkay9jb3JlOnN0YWNrUmVsYXRpdmVFeHBvcnRzJzogdHJ1ZSB9IH0pO1xuICBjb25zdCBzdGFjayA9IG5ldyBTdGFjayhhcHAsICdHbG9iYWxUYWJsZVN0YWNrJywgeyBlbnY6IHsgYWNjb3VudDogJzEyMzQ1Njc4OTAxMicsIHJlZ2lvbjogJ3VzLWVhc3QtMScgfSB9KTtcblxuICBjb25zdCBnbG9iYWxUYWJsZSA9IG5ldyBHbG9iYWxUYWJsZShzdGFjaywgQ09OU1RSVUNUX05BTUUsIHtcbiAgICB0YWJsZU5hbWU6IFRBQkxFX05BTUUsXG4gICAgcGFydGl0aW9uS2V5OiBUQUJMRV9QQVJUSVRJT05fS0VZLFxuICAgIHJlZ2lvbnM6IFsndXMtZWFzdC0xJywgJ3VzLXdlc3QtMiddLFxuICAgIHN0cmVhbTogU3RyZWFtVmlld1R5cGUuTkVXX0FORF9PTERfSU1BR0VTLFxuICB9KTtcblxuICBuZXcgQ2ZuT3V0cHV0KHN0YWNrLCAnRHluYW1vRGJPdXRwdXQnLCB7XG4gICAgLy8gdGhpcyB3b3JrcywgYmVjYXVzZSBib3RoIGBzdGFja2AgYW5kIGByZWdpb25UYWJsZXNbMF1gIHN0YWNrIGFyZSBpbiB0aGUgc2FtZSBhY2NvdW50ICYgcmVnaW9uXG4gICAgdmFsdWU6IGdsb2JhbFRhYmxlLnJlZ2lvbmFsVGFibGVzWzBdLnRhYmxlU3RyZWFtQXJuISxcbiAgfSk7XG5cbiAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS50ZW1wbGF0ZU1hdGNoZXMoe1xuICAgICdPdXRwdXRzJzoge1xuICAgICAgJ0R5bmFtb0RiT3V0cHV0Jzoge1xuICAgICAgICAnVmFsdWUnOiB7XG4gICAgICAgICAgJ0ZuOjpJbXBvcnRWYWx1ZSc6ICdHbG9iYWxUYWJsZVN0YWNrYXdzY2RrZHluYW1vZGJnbG9iYWxhd3NjZGtkeW5hbW9kYmdsb2JhbHVzZWFzdDE5QzFDOEExNDpFeHBvcnRzT3V0cHV0Rm5HZXRBdHRhd3NjZGtkeW5hbW9kYmdsb2JhbEdsb2JhbFRhYmxldXNlYXN0MUZDMDNERDY5U3RyZWFtQXJuOUNFNTg1RUQnLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9LFxuICB9KTtcbn0pO1xuXG5kZXNjcmliZURlcHJlY2F0ZWQoJ0VuZm9yY2UgU3RyZWFtU3BlY2lmaWNhdGlvbicsICgpID0+IHtcbiAgdGVzdCgnZ2xvYmFsIGR5bmFtbyBzaG91bGQgb25seSBhbGxvdyBORVdfQU5EX09MRF9JTUFHRVMnLCAoKSA9PiB7XG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soKTtcblxuICAgIGV4cGVjdCgoKSA9PiB7XG4gICAgICBuZXcgR2xvYmFsVGFibGUoc3RhY2ssIENPTlNUUlVDVF9OQU1FLCB7XG4gICAgICAgIHRhYmxlTmFtZTogVEFCTEVfTkFNRSxcbiAgICAgICAgc3RyZWFtOiBTdHJlYW1WaWV3VHlwZS5LRVlTX09OTFksXG4gICAgICAgIHBhcnRpdGlvbktleTogVEFCTEVfUEFSVElUSU9OX0tFWSxcbiAgICAgICAgcmVnaW9uczogWyd1cy1lYXN0LTEnLCAndXMtZWFzdC0yJywgJ3VzLXdlc3QtMiddLFxuICAgICAgfSk7XG4gICAgfSkudG9UaHJvdygvZHluYW1vUHJvcHMuc3RyZWFtIE1VU1QgYmUgc2V0IHRvIGR5bmFtb2RiLlN0cmVhbVZpZXdUeXBlLk5FV19BTkRfT0xEX0lNQUdFUy8pO1xuICB9KTtcbn0pO1xuXG5kZXNjcmliZURlcHJlY2F0ZWQoJ0NoZWNrIGdldHRpbmcgdGFibGVzJywgKCkgPT4ge1xuICB0ZXN0KCdnbG9iYWwgZHluYW1vIHNob3VsZCBvbmx5IGFsbG93IE5FV19BTkRfT0xEX0lNQUdFUycsICgpID0+IHtcbiAgICBjb25zdCBzdGFjayA9IG5ldyBTdGFjaygpO1xuICAgIGNvbnN0IHJlZ1RhYmxlcyA9IG5ldyBHbG9iYWxUYWJsZShzdGFjaywgQ09OU1RSVUNUX05BTUUsIHtcbiAgICAgIHRhYmxlTmFtZTogVEFCTEVfTkFNRSxcbiAgICAgIHBhcnRpdGlvbktleTogVEFCTEVfUEFSVElUSU9OX0tFWSxcbiAgICAgIHJlZ2lvbnM6IFsndXMtZWFzdC0xJywgJ3VzLWVhc3QtMicsICd1cy13ZXN0LTInXSxcbiAgICB9KTtcbiAgICBleHBlY3QocmVnVGFibGVzLnJlZ2lvbmFsVGFibGVzLmxlbmd0aCkudG9FcXVhbCgzKTtcbiAgICBmb3IgKGNvbnN0IHRhYmxlIG9mIHJlZ1RhYmxlcy5yZWdpb25hbFRhYmxlcykge1xuICAgICAgZXhwZWN0KHRhYmxlKS50b0JlSW5zdGFuY2VPZihUYWJsZSk7XG4gICAgfVxuICB9KTtcbn0pO1xuIl19