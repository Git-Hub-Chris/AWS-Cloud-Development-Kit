"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const fs = require("fs");
const path = require("path");
const assertions_1 = require("aws-cdk-lib/assertions");
const s3 = require("aws-cdk-lib/aws-s3");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const cxapi = require("aws-cdk-lib/cx-api");
const synthetics = require("../lib");
const lib_1 = require("../lib");
describe(synthetics.Code.fromInline, () => {
    test('fromInline works', () => {
        // GIVEN
        const stack = new aws_cdk_lib_1.Stack(new aws_cdk_lib_1.App(), 'canaries');
        // WHEN
        const inline = synthetics.Code.fromInline(`
      exports.handler = async () => {
        console.log(\'hello world\');
      };`);
        // THEN
        expect(inline.bind(stack, 'index.handler', lib_1.RuntimeFamily.NODEJS).inlineCode).toEqual(`
      exports.handler = async () => {
        console.log(\'hello world\');
      };`);
    });
    test('fails if empty', () => {
        expect(() => synthetics.Code.fromInline(''))
            .toThrowError('Canary inline code cannot be empty');
    });
    test('fails if handler is not "index.handler"', () => {
        // GIVEN
        const stack = new aws_cdk_lib_1.Stack(new aws_cdk_lib_1.App(), 'canaries');
        // THEN
        expect(() => synthetics.Code.fromInline('code').bind(stack, 'canary.handler', lib_1.RuntimeFamily.NODEJS))
            .toThrowError('The handler for inline code must be "index.handler" (got "canary.handler")');
    });
});
describe(synthetics.Code.fromAsset, () => {
    test('fromAsset works for node runtimes', () => {
        // GIVEN
        const stack = new aws_cdk_lib_1.Stack(new aws_cdk_lib_1.App(), 'canaries');
        // WHEN
        const directoryAsset = synthetics.Code.fromAsset(path.join(__dirname, 'canaries'));
        new synthetics.Canary(stack, 'Canary', {
            test: synthetics.Test.custom({
                handler: 'canary.handler',
                code: directoryAsset,
            }),
            runtime: synthetics.Runtime.SYNTHETICS_NODEJS_PUPPETEER_3_8,
        });
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::Synthetics::Canary', {
            Code: {
                Handler: 'canary.handler',
                S3Bucket: stack.resolve(directoryAsset.bind(stack, 'canary.handler', synthetics.RuntimeFamily.NODEJS).s3Location?.bucketName),
                S3Key: stack.resolve(directoryAsset.bind(stack, 'canary.handler', synthetics.RuntimeFamily.NODEJS).s3Location?.objectKey),
            },
        });
    });
    test('fromAsset works for python runtimes', () => {
        // GIVEN
        const stack = new aws_cdk_lib_1.Stack(new aws_cdk_lib_1.App(), 'canaries');
        // WHEN
        const directoryAsset = synthetics.Code.fromAsset(path.join(__dirname, 'canaries'));
        new synthetics.Canary(stack, 'Canary', {
            test: synthetics.Test.custom({
                handler: 'canary.handler',
                code: directoryAsset,
            }),
            runtime: synthetics.Runtime.SYNTHETICS_PYTHON_SELENIUM_1_3,
        });
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::Synthetics::Canary', {
            Code: {
                Handler: 'canary.handler',
                S3Bucket: stack.resolve(directoryAsset.bind(stack, 'canary.handler', synthetics.RuntimeFamily.PYTHON).s3Location?.bucketName),
                S3Key: stack.resolve(directoryAsset.bind(stack, 'canary.handler', synthetics.RuntimeFamily.PYTHON).s3Location?.objectKey),
            },
        });
    });
    test('only one Asset object gets created even if multiple canaries use the same AssetCode', () => {
        // GIVEN
        const app = new aws_cdk_lib_1.App({
            context: {
                [cxapi.NEW_STYLE_STACK_SYNTHESIS_CONTEXT]: false,
            },
        });
        const stack = new aws_cdk_lib_1.Stack(app, 'canaries');
        // WHEN
        const directoryAsset = synthetics.Code.fromAsset(path.join(__dirname, 'canaries'));
        new synthetics.Canary(stack, 'Canary1', {
            test: synthetics.Test.custom({
                handler: 'canary.handler',
                code: directoryAsset,
            }),
            runtime: synthetics.Runtime.SYNTHETICS_NODEJS_PUPPETEER_3_8,
        });
        new synthetics.Canary(stack, 'Canary2', {
            test: synthetics.Test.custom({
                handler: 'canary.handler',
                code: directoryAsset,
            }),
            runtime: synthetics.Runtime.SYNTHETICS_NODEJS_PUPPETEER_3_8,
        });
        // THEN
        const assembly = app.synth();
        const synthesized = assembly.stacks[0];
        expect(synthesized.assets.length).toEqual(1);
    });
    test('works when stack is a part of a stage', () => {
        // GIVEN
        const app = new aws_cdk_lib_1.App();
        const stage1 = new aws_cdk_lib_1.Stage(app, 'Stage1');
        const stage2 = new aws_cdk_lib_1.Stage(stage1, 'Stage2');
        const stack = new aws_cdk_lib_1.Stack(stage2);
        // WHEN
        const directoryAsset = synthetics.Code.fromAsset(path.join(__dirname, 'canaries'));
        new synthetics.Canary(stack, 'Canary1', {
            test: synthetics.Test.custom({
                handler: 'canary.handler',
                code: directoryAsset,
            }),
            runtime: synthetics.Runtime.SYNTHETICS_NODEJS_PUPPETEER_3_8,
        });
    });
    test('fails if path does not exist', () => {
        const assetPath = path.join(__dirname, 'does-not-exist');
        expect(() => synthetics.Code.fromAsset(assetPath))
            .toThrowError(`${assetPath} is not a valid path`);
    });
    test('fails if non-zip asset is used', () => {
        // GIVEN
        const stack = new aws_cdk_lib_1.Stack(new aws_cdk_lib_1.App(), 'canaries');
        // THEN
        const assetPath = path.join(__dirname, 'canaries', 'nodejs', 'node_modules', 'canary.js');
        expect(() => synthetics.Code.fromAsset(assetPath).bind(stack, 'canary.handler', synthetics.RuntimeFamily.NODEJS))
            .toThrowError(`Asset must be a .zip file or a directory (${assetPath})`);
    });
    test('fails if node runtime and "nodejs/node_modules" folder structure not used', () => {
        // GIVEN
        const stack = new aws_cdk_lib_1.Stack(new aws_cdk_lib_1.App(), 'canaries');
        // THEN
        const assetPath = path.join(__dirname, 'canaries', 'nodejs', 'node_modules');
        expect(() => synthetics.Code.fromAsset(assetPath).bind(stack, 'canary.handler', synthetics.RuntimeFamily.NODEJS))
            .toThrowError(`The canary resource requires that the handler is present at "nodejs/node_modules/canary.js" but not found at ${assetPath} (https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch_Synthetics_Canaries_WritingCanary_Nodejs.html)`);
    });
    test('fails if python runtime and "python" folder structure not used', () => {
        // GIVEN
        const stack = new aws_cdk_lib_1.Stack(new aws_cdk_lib_1.App(), 'canaries');
        // THEN
        const assetPath = path.join(__dirname, 'canaries', 'python');
        expect(() => synthetics.Code.fromAsset(assetPath).bind(stack, 'canary.handler', synthetics.RuntimeFamily.PYTHON))
            .toThrowError(`The canary resource requires that the handler is present at "python/canary.py" but not found at ${assetPath} (https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch_Synthetics_Canaries_WritingCanary_Python.html)`);
    });
    test('fails if handler is specified incorrectly', () => {
        // GIVEN
        const stack = new aws_cdk_lib_1.Stack(new aws_cdk_lib_1.App(), 'canaries');
        // THEN
        const assetPath = path.join(__dirname, 'canaries', 'nodejs', 'node_modules');
        expect(() => synthetics.Code.fromAsset(assetPath).bind(stack, 'incorrect.handler', synthetics.RuntimeFamily.NODEJS))
            .toThrowError(`The canary resource requires that the handler is present at "nodejs/node_modules/incorrect.js" but not found at ${assetPath} (https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch_Synthetics_Canaries_WritingCanary_Nodejs.html)`);
    });
    test('passes if bundling is specified', () => {
        // GIVEN
        const stack = new aws_cdk_lib_1.Stack(new aws_cdk_lib_1.App(), 'canaries');
        // WHEN
        const assetPath = path.join(__dirname, 'canaries', 'nodejs', 'node_modules');
        const code = synthetics.Code.fromAsset(assetPath, {
            bundling: {
                image: aws_cdk_lib_1.DockerImage.fromRegistry('dummy'),
                local: {
                    tryBundle(outputDir) {
                        const stageDir = path.join(outputDir, 'nodejs', 'node_modules');
                        fs.mkdirSync(path.join(outputDir, 'nodejs'));
                        fs.mkdirSync(stageDir);
                        fs.copyFileSync(path.join(assetPath, 'canary.js'), path.join(stageDir, 'canary.js'));
                        return true;
                    },
                },
            },
        });
        // THEN
        expect(() => code.bind(stack, 'canary.handler', synthetics.RuntimeFamily.NODEJS))
            .not.toThrow();
    });
    test('fails if bundling is specified but folder structure is wrong', () => {
        // GIVEN
        const stack = new aws_cdk_lib_1.Stack(new aws_cdk_lib_1.App(), 'canaries');
        // WHEN
        const assetPath = path.join(__dirname, 'canaries', 'nodejs', 'node_modules');
        const code = synthetics.Code.fromAsset(assetPath, {
            bundling: {
                image: aws_cdk_lib_1.DockerImage.fromRegistry('dummy'),
                local: {
                    tryBundle(outputDir) {
                        fs.copyFileSync(path.join(assetPath, 'canary.js'), path.join(outputDir, 'canary.js'));
                        return true;
                    },
                },
            },
        });
        // THEN
        expect(() => code.bind(stack, 'canary.handler', synthetics.RuntimeFamily.NODEJS))
            .toThrowError(`The canary resource requires that the handler is present at "nodejs/node_modules/canary.js" but not found at ${assetPath} (https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch_Synthetics_Canaries_WritingCanary_Nodejs.html)`);
    });
});
describe(synthetics.Code.fromBucket, () => {
    test('fromBucket works', () => {
        // GIVEN
        const stack = new aws_cdk_lib_1.Stack(new aws_cdk_lib_1.App(), 'canaries');
        const bucket = new s3.Bucket(stack, 'CodeBucket');
        // WHEN
        const code = synthetics.Code.fromBucket(bucket, 'code.js');
        const codeConfig = code.bind(stack, 'code.handler', lib_1.RuntimeFamily.NODEJS);
        // THEN
        expect(codeConfig.s3Location?.bucketName).toEqual(bucket.bucketName);
        expect(codeConfig.s3Location?.objectKey).toEqual('code.js');
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29kZS50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY29kZS50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEseUJBQXlCO0FBQ3pCLDZCQUE2QjtBQUM3Qix1REFBa0Q7QUFDbEQseUNBQXlDO0FBQ3pDLDZDQUE2RDtBQUM3RCw0Q0FBNEM7QUFDNUMscUNBQXFDO0FBQ3JDLGdDQUF1QztBQUV2QyxRQUFRLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsR0FBRyxFQUFFO0lBQ3hDLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxHQUFHLEVBQUU7UUFDNUIsUUFBUTtRQUNSLE1BQU0sS0FBSyxHQUFHLElBQUksbUJBQUssQ0FBQyxJQUFJLGlCQUFHLEVBQUUsRUFBRSxVQUFVLENBQUMsQ0FBQztRQUUvQyxPQUFPO1FBQ1AsTUFBTSxNQUFNLEdBQUcsVUFBVSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUM7OztTQUdyQyxDQUFDLENBQUM7UUFFUCxPQUFPO1FBQ1AsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLGVBQWUsRUFBRSxtQkFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLE9BQU8sQ0FBQzs7O1NBR2hGLENBQUMsQ0FBQztJQUNULENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLGdCQUFnQixFQUFFLEdBQUcsRUFBRTtRQUMxQixNQUFNLENBQUMsR0FBRyxFQUFFLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDLENBQUM7YUFDekMsWUFBWSxDQUFDLG9DQUFvQyxDQUFDLENBQUM7SUFDeEQsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFJLENBQUMseUNBQXlDLEVBQUUsR0FBRyxFQUFFO1FBQ25ELFFBQVE7UUFDUixNQUFNLEtBQUssR0FBRyxJQUFJLG1CQUFLLENBQUMsSUFBSSxpQkFBRyxFQUFFLEVBQUUsVUFBVSxDQUFDLENB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QUM7QUFFSCxRQUFRLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsR0FBRyxFQUFFO0lBQ3hDLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxHQUFHLEVBQUU7UUFDNUIsUUFBUTtRQUNSLE1BQU0sS0FBSyxHQUFHLElBQUksbUJBQUssQ0FBQyxJQUFJLGlCQUFHLEVBQUUsRUFBRSxVQUFVLENBQUMsQ0FBQztRQUMvQyxNQUFNLE1BQU0sR0FBRyxJQUFJLEVBQUUsQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLFlBQVksQ0FBQyxDQUFDO1FBRWxELE9BQU87UUFDUCxNQUFNLElBQUksR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLEVBQUUsU0FBUyxDQUFDLENBQUM7UUFDM0QsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsY0FBYyxFQUFFLG1CQUFhLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFMUUsT0FBTztRQUNQLE1BQU0sQ0FBQyxVQUFVLENBQUMsVUFBVSxFQUFFLFVBQVUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDckUsTUFBTSxDQUFDLFVBQVUsQ0FBQyxVQUFVLEVBQUUsU0FBUyxDQUFDLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQzlELENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgVGVtcGxhdGUgfSBmcm9tICdhd3MtY2RrLWxpYi9hc3NlcnRpb25zJztcbmltcG9ydCAqIGFzIHMzIGZyb20gJ2F3cy1jZGstbGliL2F3cy1zMyc7XG5pbXBvcnQgeyBBcHAsIFN0YWdlLCBTdGFjaywgRG9ja2VySW1hZ2UgfSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgKiBhcyBjeGFwaSBmcm9tICdhd3MtY2RrLWxpYi9jeC1hcGknO1xuaW1wb3J0ICogYXMgc3ludGhldGljcyBmcm9tICcuLi9saWInO1xuaW1wb3J0IHsgUnVudGltZUZhbWlseSB9IGZyb20gJy4uL2xpYic7XG5cbmRlc2NyaWJlKHN5bnRoZXRpY3MuQ29kZS5mcm9tSW5saW5lLCAoKSA9PiB7XG4gIHRlc3QoJ2Zyb21JbmxpbmUgd29ya3MnLCAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBzdGFjayA9IG5ldyBTdGFjayhuZXcgQXBwKCksICdjYW5hcmllcycpO1xuXG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IGlubGluZSA9IHN5bnRoZXRpY3MuQ29kZS5mcm9tSW5saW5lKGBcbiAgICAgIGV4cG9ydHMuaGFuZGxlciA9IGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coXFwnaGVsbG8gd29ybGRcXCcpO1xuICAgICAgfTtgKTtcblxuICAgIC8vIFRIRU5cbiAgICBleHBlY3QoaW5saW5lLmJpbmQoc3RhY2ssICdpbmRleC5oYW5kbGVyJywgUnVudGltZUZhbWlseS5OT0RFSlMpLmlubGluZUNvZGUpLnRvRXF1YWwoYFxuICAgICAgZXhwb3J0cy5oYW5kbGVyID0gYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZyhcXCdoZWxsbyB3b3JsZFxcJyk7XG4gICAgICB9O2ApO1xuICB9KTtcblxuICB0ZXN0KCdmYWlscyBpZiBlbXB0eScsICgpID0+IHtcbiAgICBleHBlY3QoKCkgPT4gc3ludGhldGljcy5Db2RlLmZyb21JbmxpbmUoJycpKVxuICAgICAgLnRvVGhyb3dFcnJvcignQ2FuYXJ5IGlubGluZSBjb2RlIGNhbm5vdCBiZSBlbXB0eScpO1xuICB9KTtcblxuICB0ZXN0KCdmYWlscyBpZiBoYW5kbGVyIGlzIG5vdCBcImluZGV4LmhhbmRsZXJcIicsICgpID0+IHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKG5ldyBBcHAoKSwgJ2NhbmFyaWVzJyk7XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0KCgpID0+IHN5bnRoZXRpY3MuQ29kZS5mcm9tSW5saW5lKCdjb2RlJykuYmluZChzdGFjaywgJ2NhbmFyeS5oYW5kbGVyJywgUnVudGltZUZhbWlseS5OT0RFSlMpKVxuICAgICAgLnRvVGhyb3dFcnJvcignVGhlIGhhbmRsZXIgZm9yIGlubGluZSBjb2RlIG11c3QgYmUgXCJpbmRleC5oYW5kbGVyXCIgKGdvdCBcImNhbmFyeS5oYW5kbGVyXCIpJyk7XG4gIH0pO1xufSk7XG5cbmRlc2NyaWJlKHN5bnRoZXRpY3MuQ29kZS5mcm9tQXNzZXQsICgpID0+IHtcbiAgdGVzdCgnZnJvbUFzc2V0IHdvcmtzIGZvciBub2RlIHJ1bnRpbWVzJywgKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2sobmV3IEFwcCgpLCAnY2FuYXJpZXMnKTtcblxuICAgIC8vIFdIRU5cbiAgICBjb25zdCBkaXJlY3RvcnlBc3NldCA9IHN5bnRoZXRpY3MuQ29kZS5mcm9tQXNzZXQocGF0aC5qb2luKF9fZGlybmFtZSwgJ2NhbmFyaWVzJykpO1xuICAgIG5ldyBzeW50aGV0aWNzLkNhbmFyeShzdGFjaywgJ0NhbmFyeScsIHtcbiAgICAgIHRlc3Q6IHN5bnRoZXRpY3MuVGVzdC5jdXN0b20oe1xuICAgICAgICBoYW5kbGVyOiAnY2FuYXJ5LmhhbmRsZXInLFxuICAgICAgICBjb2RlOiBkaXJlY3RvcnlBc3NldCxcbiAgICAgIH0pLFxuICAgICAgcnVudGltZTogc3ludGhldGljcy5SdW50aW1lLlNZTlRIRVRJQ1NfTk9ERUpTX1BVUFBFVEVFUl8zXzgsXG4gICAgfSk7XG5cbiAgICAvLyBUSEVOXG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6U3ludGhldGljczo6Q2FuYXJ5Jywge1xuICAgICAgQ29kZToge1xuICAgICAgICBIYW5kbGVyOiAnY2FuYXJ5LmhhbmRsZXInLFxuICAgICAgICBTM0J1Y2tldDogc3RhY2sucmVzb2x2ZShkaXJlY3RvcnlBc3NldC5iaW5kKHN0YWNrLCAnY2FuYXJ5LmhhbmRsZXInLCBzeW50aGV0aWNzLlJ1bnRpbWVGYW1pbHkuTk9ERUpTKS5zM0xvY2F0aW9uPy5idWNrZXROYW1lKSxcbiAgICAgICAgUzNLZXk6IHN0YWNrLnJlc29sdmUoZGlyZWN0b3J5QXNzZXQuYmluZChzdGFjaywgJ2NhbmFyeS5oYW5kbGVyJywgc3ludGhldGljcy5SdW50aW1lRmFtaWx5Lk5PREVKUykuczNMb2NhdGlvbj8ub2JqZWN0S2V5KSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH0pO1xuXG4gIHRlc3QoJ2Zyb21Bc3NldCB3b3JrcyBmb3IgcHl0aG9uIHJ1bnRpbWVzJywgKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2sobmV3IEFwcCgpLCAnY2FuYXJpZXMnKTtcblxuICAgIC8vIFdIRU5cbiAgICBjb25zdCBkaXJlY3RvcnlBc3NldCA9IHN5bnRoZXRpY3MuQ29kZS5mcm9tQXNzZXQocGF0aC5qb2luKF9fZGlybmFtZSwgJ2NhbmFyaWVzJykpO1xuICAgIG5ldyBzeW50aGV0aWNzLkNhbmFyeShzdGFjaywgJ0NhbmFyeScsIHtcbiAgICAgIHRlc3Q6IHN5bnRoZXRpY3MuVGVzdC5jdXN0b20oe1xuICAgICAgICBoYW5kbGVyOiAnY2FuYXJ5LmhhbmRsZXInLFxuICAgICAgICBjb2RlOiBkaXJlY3RvcnlBc3NldCxcbiAgICAgIH0pLFxuICAgICAgcnVudGltZTogc3ludGhldGljcy5SdW50aW1lLlNZTlRIRVRJQ1NfUFlUSE9OX1NFTEVOSVVNXzFfMyxcbiAgICB9KTtcblxuICAgIC8vIFRIRU5cbiAgICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpTeW50aGV0aWNzOjpDYW5hcnknLCB7XG4gICAgICBDb2RlOiB7XG4gICAgICAgIEhhbmRsZXI6ICdjYW5hcnkuaGFuZGxlcicsXG4gICAgICAgIFMzQnVja2V0OiBzdGFjay5yZXNvbHZlKGRpcmVjdG9yeUFzc2V0LmJpbmQoc3RhY2ssICdjYW5hcnkuaGFuZGxlcicsIHN5bnRoZXRpY3MuUnVudGltZUZhbWlseS5QWVRIT04pLnMzTG9jYXRpb24/LmJ1Y2tldE5hbWUpLFxuICAgICAgICBTM0tleTogc3RhY2sucmVzb2x2ZShkaXJlY3RvcnlBc3NldC5iaW5kKHN0YWNrLCAnY2FuYXJ5LmhhbmRsZXInLCBzeW50aGV0aWNzLlJ1bnRpbWVGYW1pbHkuUFlUSE9OKS5zM0xvY2F0aW9uPy5vYmplY3RLZXkpLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnb25seSBvbmUgQXNzZXQgb2JqZWN0IGdldHMgY3JlYXRlZCBldmVuIGlmIG11bHRpcGxlIGNhbmFyaWVzIHVzZSB0aGUgc2FtZSBBc3NldENvZGUnLCAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBhcHAgPSBuZXcgQXBwKHtcbiAgICAgIGNvbnRleHQ6IHtcbiAgICAgICAgW2N4YXBpLk5FV19TVFlMRV9TVEFDS19TWU5USEVTSVNfQ09OVEVYVF06IGZhbHNlLFxuICAgICAgfSxcbiAgICB9KTtcbiAgICBjb25zdCBzdGFjayA9IG5ldyBTdGFjayhhcHAsICdjYW5hcmllcycpO1xuXG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IGRpcmVjdG9yeUFzc2V0ID0gc3ludGhldGljcy5Db2RlLmZyb21Bc3NldChwYXRoLmpvaW4oX19kaXJuYW1lLCAnY2FuYXJpZXMnKSk7XG4gICAgbmV3IHN5bnRoZXRpY3MuQ2FuYXJ5KHN0YWNrLCAnQ2FuYXJ5MScsIHtcbiAgICAgIHRlc3Q6IHN5bnRoZXRpY3MuVGVzdC5jdXN0b20oe1xuICAgICAgICBoYW5kbGVyOiAnY2FuYXJ5LmhhbmRsZXInLFxuICAgICAgICBjb2RlOiBkaXJlY3RvcnlBc3NldCxcbiAgICAgIH0pLFxuICAgICAgcnVudGltZTogc3ludGhldGljcy5SdW50aW1lLlNZTlRIRVRJQ1NfTk9ERUpTX1BVUFBFVEVFUl8zXzgsXG4gICAgfSk7XG5cbiAgICBuZXcgc3ludGhldGljcy5DYW5hcnkoc3RhY2ssICdDYW5hcnkyJywge1xuICAgICAgdGVzdDogc3ludGhldGljcy5UZXN0LmN1c3RvbSh7XG4gICAgICAgIGhhbmRsZXI6ICdjYW5hcnkuaGFuZGxlcicsXG4gICAgICAgIGNvZGU6IGRpcmVjdG9yeUFzc2V0LFxuICAgICAgfSksXG4gICAgICBydW50aW1lOiBzeW50aGV0aWNzLlJ1bnRpbWUuU1lOVEhFVElDU19OT0RFSlNfUFVQUEVURUVSXzNfOCxcbiAgICB9KTtcblxuICAgIC8vIFRIRU5cbiAgICBjb25zdCBhc3NlbWJseSA9IGFwcC5zeW50aCgpO1xuICAgIGNvbnN0IHN5bnRoZXNpemVkID0gYXNzZW1ibHkuc3RhY2tzWzBdO1xuXG4gICAgZXhwZWN0KHN5bnRoZXNpemVkLmFzc2V0cy5sZW5ndGgpLnRvRXF1YWwoMSk7XG4gIH0pO1xuXG4gIHRlc3QoJ3dvcmtzIHdoZW4gc3RhY2sgaXMgYSBwYXJ0IG9mIGEgc3RhZ2UnLCAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBhcHAgPSBuZXcgQXBwKCk7XG4gICAgY29uc3Qgc3RhZ2UxID0gbmV3IFN0YWdlKGFwcCwgJ1N0YWdlMScpO1xuICAgIGNvbnN0IHN0YWdlMiA9IG5ldyBTdGFnZShzdGFnZTEsICdTdGFnZTInKTtcbiAgICBjb25zdCBzdGFjayA9IG5ldyBTdGFjayhzdGFnZTIpO1xuXG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IGRpcmVjdG9yeUFzc2V0ID0gc3ludGhldGljcy5Db2RlLmZyb21Bc3NldChwYXRoLmpvaW4oX19kaXJuYW1lLCAnY2FuYXJpZXMnKSk7XG4gICAgbmV3IHN5bnRoZXRpY3MuQ2FuYXJ5KHN0YWNrLCAnQ2FuYXJ5MScsIHtcbiAgICAgIHRlc3Q6IHN5bnRoZXRpY3MuVGVzdC5jdXN0b20oe1xuICAgICAgICBoYW5kbGVyOiAnY2FuYXJ5LmhhbmRsZXInLFxuICAgICAgICBjb2RlOiBkaXJlY3RvcnlBc3NldCxcbiAgICAgIH0pLFxuICAgICAgcnVudGltZTogc3ludGhldGljcy5SdW50aW1lLlNZTlRIRVRJQ1NfTk9ERUpTX1BVUFBFVEVFUl8zXzgsXG4gICAgfSk7XG4gIH0pO1xuXG4gIHRlc3QoJ2ZhaWxzIGlmIHBhdGggZG9lcyBub3QgZXhpc3QnLCAoKSA9PiB7XG4gICAgY29uc3QgYXNzZXRQYXRoID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJ2RvZXMtbm90LWV4aXN0Jyk7XG4gICAgZXhwZWN0KCgpID0+IHN5bnRoZXRpY3MuQ29kZS5mcm9tQXNzZXQoYXNzZXRQYXRoKSlcbiAgICAgIC50b1Rocm93RXJyb3IoYCR7YXNzZXRQYXRofSBpcyBub3QgYSB2YWxpZCBwYXRoYCk7XG4gIH0pO1xuXG4gIHRlc3QoJ2ZhaWxzIGlmIG5vbi16aXAgYXNzZXQgaXMgdXNlZCcsICgpID0+IHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKG5ldyBBcHAoKSwgJ2NhbmFyaWVzJyk7XG5cbiAgICAvLyBUSEVOXG4gICAgY29uc3QgYXNzZXRQYXRoID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJ2NhbmFyaWVzJywgJ25vZGVqcycsICdub2RlX21vZHVsZXMnLCAnY2FuYXJ5LmpzJyk7XG4gICAgZXhwZWN0KCgpID0+IHN5bnRoZXRpY3MuQ29kZS5mcm9tQXNzZXQoYXNzZXRQYXRoKS5iaW5kKHN0YWNrLCAnY2FuYXJ5LmhhbmRsZXInLCBzeW50aGV0aWNzLlJ1bnRpbWVGYW1pbHkuTk9ERUpTKSlcbiAgICAgIC50b1Rocm93RXJyb3IoYEFzc2V0IG11c3QgYmUgYSAuemlwIGZpbGUgb3IgYSBkaXJlY3RvcnkgKCR7YXNzZXRQYXRofSlgKTtcbiAgfSk7XG5cbiAgdGVzdCgnZmFpbHMgaWYgbm9kZSBydW50aW1lIGFuZCBcIm5vZGVqcy9ub2RlX21vZHVsZXNcIiBmb2xkZXIgc3RydWN0dXJlIG5vdCB1c2VkJywgKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2sobmV3IEFwcCgpLCAnY2FuYXJpZXMnKTtcblxuICAgIC8vIFRIRU5cbiAgICBjb25zdCBhc3NldFBhdGggPSBwYXRoLmpvaW4oX19kaXJuYW1lLCAnY2FuYXJpZXMnLCAnbm9kZWpzJywgJ25vZGVfbW9kdWxlcycpO1xuICAgIGV4cGVjdCgoKSA9PiBzeW50aGV0aWNzLkNvZGUuZnJvbUFzc2V0KGFzc2V0UGF0aCkuYmluZChzdGFjaywgJ2NhbmFyeS5oYW5kbGVyJywgc3ludGhldGljcy5SdW50aW1lRmFtaWx5Lk5PREVKUykpXG4gICAgICAudG9UaHJvd0Vycm9yKGBUaGUgY2FuYXJ5IHJlc291cmNlIHJlcXVpcmVzIHRoYXQgdGhlIGhhbmRsZXIgaXMgcHJlc2VudCBhdCBcIm5vZGVqcy9ub2RlX21vZHVsZXMvY2FuYXJ5LmpzXCIgYnV0IG5vdCBmb3VuZCBhdCAke2Fzc2V0UGF0aH0gKGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9BbWF6b25DbG91ZFdhdGNoL2xhdGVzdC9tb25pdG9yaW5nL0Nsb3VkV2F0Y2hfU3ludGhldGljc19DYW5hcmllc19Xcml0aW5nQ2FuYXJ5X05vZGVqcy5odG1sKWApO1xuICB9KTtcblxuICB0ZXN0KCdmYWlscyBpZiBweXRob24gcnVudGltZSBhbmQgXCJweXRob25cIiBmb2xkZXIgc3RydWN0dXJlIG5vdCB1c2VkJywgKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2sobmV3IEFwcCgpLCAnY2FuYXJpZXMnKTtcblxuICAgIC8vIFRIRU5cbiAgICBjb25zdCBhc3NldFBhdGggPSBwYXRoLmpvaW4oX19kaXJuYW1lLCAnY2FuYXJpZXMnLCAncHl0aG9uJyk7XG4gICAgZXhwZWN0KCgpID0+IHN5bnRoZXRpY3MuQ29kZS5mcm9tQXNzZXQoYXNzZXRQYXRoKS5iaW5kKHN0YWNrLCAnY2FuYXJ5LmhhbmRsZXInLCBzeW50aGV0aWNzLlJ1bnRpbWVGYW1pbHkuUFlUSE9OKSlcbiAgICAgIC50b1Rocm93RXJyb3IoYFRoZSBjYW5hcnkgcmVzb3VyY2UgcmVxdWlyZXMgdGhhdCB0aGUgaGFuZGxlciBpcyBwcmVzZW50IGF0IFwicHl0aG9uL2NhbmFyeS5weVwiIGJ1dCBub3QgZm91bmQgYXQgJHthc3NldFBhdGh9IChodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vQW1hem9uQ2xvdWRXYXRjaC9sYXRlc3QvbW9uaXRvcmluZy9DbG91ZFdhdGNoX1N5bnRoZXRpY3NfQ2FuYXJpZXNfV3JpdGluZ0NhbmFyeV9QeXRob24uaHRtbClgKTtcbiAgfSk7XG5cbiAgdGVzdCgnZmFpbHMgaWYgaGFuZGxlciBpcyBzcGVjaWZpZWQgaW5jb3JyZWN0bHknLCAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBzdGFjayA9IG5ldyBTdGFjayhuZXcgQXBwKCksICdjYW5hcmllcycpO1xuXG4gICAgLy8gVEhFTlxuICAgIGNvbnN0IGFzc2V0UGF0aCA9IHBhdGguam9pbihfX2Rpcm5hbWUsICdjYW5hcmllcycsICdub2RlanMnLCAnbm9kZV9tb2R1bGVzJyk7XG4gICAgZXhwZWN0KCgpID0+IHN5bnRoZXRpY3MuQ29kZS5mcm9tQXNzZXQoYXNzZXRQYXRoKS5iaW5kKHN0YWNrLCAnaW5jb3JyZWN0LmhhbmRsZXInLCBzeW50aGV0aWNzLlJ1bnRpbWVGYW1pbHkuTk9ERUpTKSlcbiAgICAgIC50b1Rocm93RXJyb3IoYFRoZSBjYW5hcnkgcmVzb3VyY2UgcmVxdWlyZXMgdGhhdCB0aGUgaGFuZGxlciBpcyBwcmVzZW50IGF0IFwibm9kZWpzL25vZGVfbW9kdWxlcy9pbmNvcnJlY3QuanNcIiBidXQgbm90IGZvdW5kIGF0ICR7YXNzZXRQYXRofSAoaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL0FtYXpvbkNsb3VkV2F0Y2gvbGF0ZXN0L21vbml0b3JpbmcvQ2xvdWRXYXRjaF9TeW50aGV0aWNzX0NhbmFyaWVzX1dyaXRpbmdDYW5hcnlfTm9kZWpzLmh0bWwpYCk7XG4gIH0pO1xuXG4gIHRlc3QoJ3Bhc3NlcyBpZiBidW5kbGluZyBpcyBzcGVjaWZpZWQnLCAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBzdGFjayA9IG5ldyBTdGFjayhuZXcgQXBwKCksICdjYW5hcmllcycpO1xuXG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IGFzc2V0UGF0aCA9IHBhdGguam9pbihfX2Rpcm5hbWUsICdjYW5hcmllcycsICdub2RlanMnLCAnbm9kZV9tb2R1bGVzJyk7XG4gICAgY29uc3QgY29kZSA9IHN5bnRoZXRpY3MuQ29kZS5mcm9tQXNzZXQoYXNzZXRQYXRoLCB7XG4gICAgICBidW5kbGluZzoge1xuICAgICAgICBpbWFnZTogRG9ja2VySW1hZ2UuZnJvbVJlZ2lzdHJ5KCdkdW1teScpLFxuICAgICAgICBsb2NhbDoge1xuICAgICAgICAgIHRyeUJ1bmRsZShvdXRwdXREaXIpIHtcbiAgICAgICAgICAgIGNvbnN0IHN0YWdlRGlyID0gcGF0aC5qb2luKG91dHB1dERpciwgJ25vZGVqcycsICdub2RlX21vZHVsZXMnKTtcbiAgICAgICAgICAgIGZzLm1rZGlyU3luYyhwYXRoLmpvaW4ob3V0cHV0RGlyLCAnbm9kZWpzJykpO1xuICAgICAgICAgICAgZnMubWtkaXJTeW5jKHN0YWdlRGlyKTtcbiAgICAgICAgICAgIGZzLmNvcHlGaWxlU3luYyhwYXRoLmpvaW4oYXNzZXRQYXRoLCAnY2FuYXJ5LmpzJyksIHBhdGguam9pbihzdGFnZURpciwgJ2NhbmFyeS5qcycpKTtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIGV4cGVjdCgoKSA9PiBjb2RlLmJpbmQoc3RhY2ssICdjYW5hcnkuaGFuZGxlcicsIHN5bnRoZXRpY3MuUnVudGltZUZhbWlseS5OT0RFSlMpKVxuICAgICAgLm5vdC50b1Rocm93KCk7XG4gIH0pO1xuXG4gIHRlc3QoJ2ZhaWxzIGlmIGJ1bmRsaW5nIGlzIHNwZWNpZmllZCBidXQgZm9sZGVyIHN0cnVjdHVyZSBpcyB3cm9uZycsICgpID0+IHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKG5ldyBBcHAoKSwgJ2NhbmFyaWVzJyk7XG5cbiAgICAvLyBXSEVOXG4gICAgY29uc3QgYXNzZXRQYXRoID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJ2NhbmFyaWVzJywgJ25vZGVqcycsICdub2RlX21vZHVsZXMnKTtcbiAgICBjb25zdCBjb2RlID0gc3ludGhldGljcy5Db2RlLmZyb21Bc3NldChhc3NldFBhdGgsIHtcbiAgICAgIGJ1bmRsaW5nOiB7XG4gICAgICAgIGltYWdlOiBEb2NrZXJJbWFnZS5mcm9tUmVnaXN0cnkoJ2R1bW15JyksXG4gICAgICAgIGxvY2FsOiB7XG4gICAgICAgICAgdHJ5QnVuZGxlKG91dHB1dERpcikge1xuICAgICAgICAgICAgZnMuY29weUZpbGVTeW5jKHBhdGguam9pbihhc3NldFBhdGgsICdjYW5hcnkuanMnKSwgcGF0aC5qb2luKG91dHB1dERpciwgJ2NhbmFyeS5qcycpKTtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIGV4cGVjdCgoKSA9PiBjb2RlLmJpbmQoc3RhY2ssICdjYW5hcnkuaGFuZGxlcicsIHN5bnRoZXRpY3MuUnVudGltZUZhbWlseS5OT0RFSlMpKVxuICAgICAgLnRvVGhyb3dFcnJvcihgVGhlIGNhbmFyeSByZXNvdXJjZSByZXF1aXJlcyB0aGF0IHRoZSBoYW5kbGVyIGlzIHByZXNlbnQgYXQgXCJub2RlanMvbm9kZV9tb2R1bGVzL2NhbmFyeS5qc1wiIGJ1dCBub3QgZm91bmQgYXQgJHthc3NldFBhdGh9IChodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vQW1hem9uQ2xvdWRXYXRjaC9sYXRlc3QvbW9uaXRvcmluZy9DbG91ZFdhdGNoX1N5bnRoZXRpY3NfQ2FuYXJpZXNfV3JpdGluZ0NhbmFyeV9Ob2RlanMuaHRtbClgKTtcbiAgfSk7XG59KTtcblxuZGVzY3JpYmUoc3ludGhldGljcy5Db2RlLmZyb21CdWNrZXQsICgpID0+IHtcbiAgdGVzdCgnZnJvbUJ1Y2tldCB3b3JrcycsICgpID0+IHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKG5ldyBBcHAoKSwgJ2NhbmFyaWVzJyk7XG4gICAgY29uc3QgYnVja2V0ID0gbmV3IHMzLkJ1Y2tldChzdGFjaywgJ0NvZGVCdWNrZXQnKTtcblxuICAgIC8vIFdIRU5cbiAgICBjb25zdCBjb2RlID0gc3ludGhldGljcy5Db2RlLmZyb21CdWNrZXQoYnVja2V0LCAnY29kZS5qcycpO1xuICAgIGNvbnN0IGNvZGVDb25maWcgPSBjb2RlLmJpbmQoc3RhY2ssICdjb2RlLmhhbmRsZXInLCBSdW50aW1lRmFtaWx5Lk5PREVKUyk7XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0KGNvZGVDb25maWcuczNMb2NhdGlvbj8uYnVja2V0TmFtZSkudG9FcXVhbChidWNrZXQuYnVja2V0TmFtZSk7XG4gICAgZXhwZWN0KGNvZGVDb25maWcuczNMb2NhdGlvbj8ub2JqZWN0S2V5KS50b0VxdWFsKCdjb2RlLmpzJyk7XG4gIH0pO1xufSk7XG4iXX0=