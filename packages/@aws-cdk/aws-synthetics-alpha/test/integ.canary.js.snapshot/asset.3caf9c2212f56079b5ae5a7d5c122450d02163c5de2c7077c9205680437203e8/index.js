"use strict";var f=Object.create;var i=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var g=Object.getOwnPropertyNames;var A=Object.getPrototypeOf,w=Object.prototype.hasOwnProperty;var S=(o,e)=>{for(var t in e)i(o,t,{get:e[t],enumerable:!0})},l=(o,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of g(e))!w.call(o,n)&&n!==t&&i(o,n,{get:()=>e[n],enumerable:!(r=I(e,n))||r.enumerable});return o};var m=(o,e,t)=>(t=o!=null?f(A(o)):{},l(e||!o||!o.__esModule?i(t,"default",{value:o,enumerable:!0}):t,o)),P=o=>l(i({},"__esModule",{value:!0}),o);var W={};S(W,{autoDeleteHandler:()=>E,handler:()=>k});module.exports=P(W);var c=require("@aws-sdk/client-lambda"),d=require("@aws-sdk/client-synthetics");var y=m(require("https")),R=m(require("url")),a={sendHttpRequest:D,log:x,includeStackTraces:!0,userHandlerIndex:"./index"},p="AWSCDK::CustomResourceProviderFramework::CREATE_FAILED",b="AWSCDK::CustomResourceProviderFramework::MISSING_PHYSICAL_ID";function C(o){return async(e,t)=>{let r={...e,ResponseURL:"..."};if(a.log(JSON.stringify(r,void 0,2)),e.RequestType==="Delete"&&e.PhysicalResourceId===p){a.log("ignoring DELETE event caused by a failed CREATE event"),await u("SUCCESS",e);return}try{let n=await o(r,t),s=L(e,n);await u("SUCCESS",s)}catch(n){let s={...e,Reason:a.includeStackTraces?n.stack:n.message};s.PhysicalResourceId||(e.RequestType==="Create"?(a.log("CREATE failed, responding with a marker physical resource id so that the subsequent DELETE will be ignored"),s.PhysicalResourceId=p):a.log(`ERROR: Malformed event. "PhysicalResourceId" is required: ${JSON.stringify(e)}`)),await u("FAILED",s)}}}function L(o,e={}){let t=e.PhysicalResourceId??o.PhysicalResourceId??o.RequestId;if(o.RequestType==="Delete"&&t!==o.PhysicalResourceId)throw new Error(`DELETE: cannot change the physical resource ID from "${o.PhysicalResourceId}" to "${e.PhysicalResourceId}" during deletion`);return{...o,...e,PhysicalResourceId:t}}async function u(o,e){let t={Status:o,Reason:e.Reason??o,StackId:e.StackId,RequestId:e.RequestId,PhysicalResourceId:e.PhysicalResourceId||b,LogicalResourceId:e.LogicalResourceId,NoEcho:e.NoEcho,Data:e.Data};a.log("submit response to cloudformation",t);let r=JSON.stringify(t),n=R.parse(e.ResponseURL),s={hostname:n.hostname,path:n.path,method:"PUT",headers:{"content-type":"","content-length":Buffer.byteLength(r,"utf8")}};await F({attempts:5,sleep:1e3},a.sendHttpRequest)(s,r)}async function D(o,e){return new Promise((t,r)=>{try{let n=y.request(o,s=>t());n.on("error",r),n.write(e),n.end()}catch(n){r(n)}})}function x(o,...e){console.log(o,...e)}function F(o,e){return async(...t)=>{let r=o.attempts,n=o.sleep;for(;;)try{return await e(...t)}catch(s){if(r--<=0)throw s;await T(Math.floor(Math.random()*n)),n*=2}}}async function T(o){return new Promise(e=>setTimeout(e,o))}var h="aws-cdk:auto-delete-lambda",H=new c.LambdaClient({}),N=new d.SyntheticsClient({}),k=C(E);async function E(o){switch(o.RequestType){case"Create":break;case"Update":return _(o);case"Delete":return q(o.ResourceProperties?.CanaryName)}}async function _(o){let e=o,t=e.OldResourceProperties?.CanaryName,r=e.ResourceProperties?.CanaryName;return r&&t&&r!==t?{PhysicalResourceId:r}:{PhysicalResourceId:o.PhysicalResourceId}}async function q(o){if(console.log(`Deleting lambda function associated with ${o}`),!o)throw new Error("No CanaryName was provided.");try{let e=await N.send(new d.GetCanaryCommand({Name:o}));if(e.Canary===void 0)throw new Error(`No canary with ${o} found.`);if(e.Canary.Id===void 0||e.Canary.EngineArn===void 0)throw new Error(`${o} canary exists but recieved unexpected id ${e.Canary.Id} or function arn ${e.Canary.EngineArn}.`);if(!O(e.Canary.Tags)){console.log(`Canary does not have '${h}' tag, skipping deletion.`);return}let t=e.Canary.EngineArn.split(":");t.at(-1)?.includes(e.Canary.Id)||t.pop();let r=t.join(":");console.log(`Deleting lambda ${r}`),await H.send(new c.DeleteFunctionCommand({FunctionName:r}))}catch(e){if(e.name!=="ResourceNotFoundException")throw e}}function O(o){return o?Object.keys(o).some(e=>e===h&&o[e]==="true"):!1}0&&(module.exports={autoDeleteHandler,handler});
