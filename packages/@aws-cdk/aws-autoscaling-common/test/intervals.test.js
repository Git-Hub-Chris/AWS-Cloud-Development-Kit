"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const fc = require("fast-check");
const util_1 = require("./util");
const interval_utils_1 = require("../lib/interval-utils");
describe('intervals', () => {
    test('test bounds propagation', () => {
        const intervals = interval_utils_1.normalizeIntervals(realisticRelativeIntervals(), false);
        expect(intervals).toEqual([
            { lower: 0, upper: 10, change: -2 },
            { lower: 10, upper: 20, change: -1 },
            { lower: 20, upper: 80, change: undefined },
            { lower: 80, upper: 90, change: +1 },
            { lower: 90, upper: Infinity, change: +2 },
        ]);
    });
    test('test interval completion', () => {
        const lowerIncompleteIntervals = interval_utils_1.normalizeIntervals(incompleteLowerRelativeIntervals(), false);
        const upperIncompleteIntervals = interval_utils_1.normalizeIntervals(incompleteUpperRelativeIntervals(), false);
        expect(lowerIncompleteIntervals).toEqual([
            { lower: 0, upper: 65, change: undefined },
            { lower: 65, upper: 85, change: +2 },
            { lower: 85, upper: Infinity, change: +3 },
        ]);
        expect(upperIncompleteIntervals).toEqual([
            { lower: 0, upper: 65, change: +2 },
            { lower: 65, upper: 85, change: +3 },
            { lower: 85, upper: Infinity, change: undefined },
        ]);
    });
    test('bounds propagation fails if middle boundary missing', () => {
        expect(() => {
            interval_utils_1.normalizeIntervals([
                { lower: 0, change: -2 },
                { upper: 20, change: -1 },
            ], false);
        }).toThrow();
    });
    test('lower alarm index is lower than higher alarm index', () => {
        fc.assert(fc.property(util_1.arbitrary_complete_intervals(), (intervals) => {
            const alarms = interval_utils_1.findAlarmThresholds(intervals);
            return (alarms.lowerAlarmIntervalIndex === undefined
                || alarms.upperAlarmIntervalIndex === undefined
                || alarms.lowerAlarmIntervalIndex < alarms.upperAlarmIntervalIndex);
        }));
    });
    test('never pick undefined intervals for relative alarms', () => {
        fc.assert(fc.property(util_1.arbitrary_complete_intervals(), (intervals) => {
            const alarms = interval_utils_1.findAlarmThresholds(intervals);
            return (alarms.lowerAlarmIntervalIndex === undefined || intervals[alarms.lowerAlarmIntervalIndex].change !== undefined)
                && (alarms.upperAlarmIntervalIndex === undefined || intervals[alarms.upperAlarmIntervalIndex].change !== undefined);
        }));
    });
    test('pick intervals on either side of the undefined interval, if present', () => {
        fc.assert(fc.property(util_1.arbitrary_complete_intervals(), (intervals) => {
            // There must be an undefined interval and it must not be at the edges
            const i = intervals.findIndex(x => x.change === undefined);
            fc.pre(i > 0 && i < intervals.length - 1);
            const alarms = interval_utils_1.findAlarmThresholds(intervals);
            return (alarms.lowerAlarmIntervalIndex === i - 1 && alarms.upperAlarmIntervalIndex === i + 1);
        }));
    });
    test('no picking upper bound infinity for lower alarm', () => {
        fc.assert(fc.property(util_1.arbitrary_complete_intervals(), (intervals) => {
            const alarms = interval_utils_1.findAlarmThresholds(intervals);
            fc.pre(alarms.lowerAlarmIntervalIndex !== undefined);
            return intervals[alarms.lowerAlarmIntervalIndex].upper !== Infinity;
        }));
    });
    test('no picking lower bound 0 for upper alarm', () => {
        fc.assert(fc.property(util_1.arbitrary_complete_intervals(), (intervals) => {
            const alarms = interval_utils_1.findAlarmThresholds(intervals);
            fc.pre(alarms.upperAlarmIntervalIndex !== undefined);
            return intervals[alarms.upperAlarmIntervalIndex].lower !== 0;
        }));
    });
});
function realisticRelativeIntervals() {
    // Function so we don't have to worry about cloning
    return [
        { upper: 10, change: -2 },
        { upper: 20, change: -1 },
        { lower: 80, change: +1 },
        { lower: 90, change: +2 },
    ];
}
function incompleteLowerRelativeIntervals() {
    // Function so we don't have to worry about cloning
    // The first interval's lower is not zero nor undefined
    return [
        { lower: 65, change: +2 },
        { lower: 85, change: +3 },
    ];
}
function incompleteUpperRelativeIntervals() {
    // Function so we don't have to worry about cloning
    // The last interval's upper is not Infinity nor undefined
    return [
        { upper: 65, change: +2 },
        { upper: 85, change: +3 },
    ];
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW50ZXJ2YWxzLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbnRlcnZhbHMudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGlDQUFpQztBQUNqQyxpQ0FBc0Q7QUFFdEQsMERBQWdGO0FBRWhGLFFBQVEsQ0FBQyxXQUFXLEVBQUUsR0FBRyxFQUFFO0lBQ3pCLElBQUksQ0FBQyx5QkFBeUIsRUFBRSxHQUFHLEVBQUU7UUFDbkMsTUFBTSxTQUFTLEdBQUcsbUNBQWtCLENBQUMsMEJBQTBCLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUUxRSxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsT0FBTyxDQUFDO1lBQ3hCLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUMsRUFBRTtZQUNuQyxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDLEVBQUU7WUFDcEMsRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRTtZQUMzQyxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDLEVBQUU7WUFDcEMsRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQyxFQUFFO1NBQzNDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLDBCQUEwQixFQUFFLEdBQUcsRUFBRTtRQUNwQyxNQUFNLHdCQUF3QixHQUFHLG1DQUFrQixDQUNqRCxnQ0FBZ0MsRUFBRSxFQUNsQyxLQUFLLENBQUMsQ0FBQztRQUNULE1BQU0sd0JBQXdCLEdBQUcsbUNBQWtCLENBQ2pELGdDQUFnQyxFQUFFLEVBQ2xD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YXJiaXRyYXJ5X2NvbXBsZXRlX2ludGVydmFscyB9IGZyb20gJy4vdXRpbCc7XG5pbXBvcnQgKiBhcyBhcHBzY2FsaW5nIGZyb20gJy4uL2xpYic7XG5pbXBvcnQgeyBmaW5kQWxhcm1UaHJlc2hvbGRzLCBub3JtYWxpemVJbnRlcnZhbHMgfSBmcm9tICcuLi9saWIvaW50ZXJ2YWwtdXRpbHMnO1xuXG5kZXNjcmliZSgnaW50ZXJ2YWxzJywgKCkgPT4ge1xuICB0ZXN0KCd0ZXN0IGJvdW5kcyBwcm9wYWdhdGlvbicsICgpID0+IHtcbiAgICBjb25zdCBpbnRlcnZhbHMgPSBub3JtYWxpemVJbnRlcnZhbHMocmVhbGlzdGljUmVsYXRpdmVJbnRlcnZhbHMoKSwgZmFsc2UpO1xuXG4gICAgZXhwZWN0KGludGVydmFscykudG9FcXVhbChbXG4gICAgICB7IGxvd2VyOiAwLCB1cHBlcjogMTAsIGNoYW5nZTogLTIgfSxcbiAgICAgIHsgbG93ZXI6IDEwLCB1cHBlcjogMjAsIGNoYW5nZTogLTEgfSxcbiAgICAgIHsgbG93ZXI6IDIwLCB1cHBlcjogODAsIGNoYW5nZTogdW5kZWZpbmVkIH0sXG4gICAgICB7IGxvd2VyOiA4MCwgdXBwZXI6IDkwLCBjaGFuZ2U6ICsxIH0sXG4gICAgICB7IGxvd2VyOiA5MCwgdXBwZXI6IEluZmluaXR5LCBjaGFuZ2U6ICsyIH0sXG4gICAgXSk7XG4gIH0pO1xuXG4gIHRlc3QoJ3Rlc3QgaW50ZXJ2YWwgY29tcGxldGlvbicsICgpID0+IHtcbiAgICBjb25zdCBsb3dlckluY29tcGxldGVJbnRlcnZhbHMgPSBub3JtYWxpemVJbnRlcnZhbHMoXG4gICAgICBpbmNvbXBsZXRlTG93ZXJSZWxhdGl2ZUludGVydmFscygpLFxuICAgICAgZmFsc2UpO1xuICAgIGNvbnN0IHVwcGVySW5jb21wbGV0ZUludGVydmFscyA9IG5vcm1hbGl6ZUludGVydmFscyhcbiAgICAgIGluY29tcGxldGVVcHBlclJlbGF0aXZlSW50ZXJ2YWxzKCksXG4gICAgICBmYWxzZSk7XG5cbiAgICBleHBlY3QobG93ZXJJbmNvbXBsZXRlSW50ZXJ2YWxzKS50b0VxdWFsKFtcbiAgICAgIHsgbG93ZXI6IDAsIHVwcGVyOiA2NSwgY2hhbmdlOiB1bmRlZmluZWQgfSxcbiAgICAgIHsgbG93ZXI6IDY1LCB1cHBlcjogODUsIGNoYW5nZTogKzIgfSxcbiAgICAgIHsgbG93ZXI6IDg1LCB1cHBlcjogSW5maW5pdHksIGNoYW5nZTogKzMgfSxcbiAgICBdKTtcblxuICAgIGV4cGVjdCh1cHBlckluY29tcGxldGVJbnRlcnZhbHMpLnRvRXF1YWwoW1xuICAgICAgeyBsb3dlcjogMCwgdXBwZXI6IDY1LCBjaGFuZ2U6ICsyIH0sXG4gICAgICB7IGxvd2VyOiA2NSwgdXBwZXI6IDg1LCBjaGFuZ2U6ICszIH0sXG4gICAgICB7IGxvd2VyOiA4NSwgdXBwZXI6IEluZmluaXR5LCBjaGFuZ2U6IHVuZGVmaW5lZCB9LFxuICAgIF0pO1xuICB9KTtcblxuICB0ZXN0KCdib3VuZHMgcHJvcGFnYXRpb24gZmFpbHMgaWYgbWlkZGxlIGJvdW5kYXJ5IG1pc3NpbmcnLCAoKSA9PiB7XG4gICAgZXhwZWN0KCgpID0+IHtcbiAgICAgIG5vcm1hbGl6ZUludGVydmFscyhbXG4gICAgICAgIHsgbG93ZXI6IDAsIGNoYW5nZTogLTIgfSxcbiAgICAgICAgeyB1cHBlcjogMjAsIGNoYW5nZTogLTEgfSxcbiAgICAgIF0sIGZhbHNlKTtcbiAgICB9KS50b1Rocm93KCk7XG4gIH0pO1xuXG4gIHRlc3QoJ2xvd2VyIGFsYXJtIGluZGV4IGlzIGxvd2VyIHRoYW4gaGlnaGVyIGFsYXJtIGluZGV4JywgKCkgPT4ge1xuICAgIGZjLmFzc2VydChmYy5wcm9wZXJ0eShcbiAgICAgIGFyYml0cmFyeV9jb21wbGV0ZV9pbnRlcnZhbHMoKSxcbiAgICAgIChpbnRlcnZhbHMpID0+IHtcbiAgICAgICAgY29uc3QgYWxhcm1zID0gZmluZEFsYXJtVGhyZXNob2xkcyhpbnRlcnZhbHMpO1xuXG4gICAgICAgIHJldHVybiAoYWxhcm1zLmxvd2VyQWxhcm1JbnRlcnZhbEluZGV4ID09PSB1bmRlZmluZWRcbiAgICAgICAgICB8fCBhbGFybXMudXBwZXJBbGFybUludGVydmFsSW5kZXggPT09IHVuZGVmaW5lZFxuICAgICAgICAgIHx8IGFsYXJtcy5sb3dlckFsYXJtSW50ZXJ2YWxJbmRleCA8IGFsYXJtcy51cHBlckFsYXJtSW50ZXJ2YWxJbmRleCk7XG4gICAgICB9LFxuICAgICkpO1xuICB9KTtcblxuICB0ZXN0KCduZXZlciBwaWNrIHVuZGVmaW5lZCBpbnRlcnZhbHMgZm9yIHJlbGF0aXZlIGFsYXJtcycsICgpID0+IHtcbiAgICBmYy5hc3NlcnQoZmMucHJvcGVydHkoXG4gICAgICBhcmJpdHJhcnlfY29tcGxldGVfaW50ZXJ2YWxzKCksXG4gICAgICAoaW50ZXJ2YWxzKSA9PiB7XG4gICAgICAgIGNvbnN0IGFsYXJtcyA9IGZpbmRBbGFybVRocmVzaG9sZHMoaW50ZXJ2YWxzKTtcblxuICAgICAgICByZXR1cm4gKGFsYXJtcy5sb3dlckFsYXJtSW50ZXJ2YWxJbmRleCA9PT0gdW5kZWZpbmVkIHx8IGludGVydmFsc1thbGFybXMubG93ZXJBbGFybUludGVydmFsSW5kZXhdLmNoYW5nZSAhPT0gdW5kZWZpbmVkKVxuICAgICAgICAgICYmIChhbGFybXMudXBwZXJBbGFybUludGVydmFsSW5kZXggPT09IHVuZGVmaW5lZCB8fCBpbnRlcnZhbHNbYWxhcm1zLnVwcGVyQWxhcm1JbnRlcnZhbEluZGV4XS5jaGFuZ2UgIT09IHVuZGVmaW5lZCk7XG4gICAgICB9LFxuICAgICkpO1xuICB9KTtcblxuICB0ZXN0KCdwaWNrIGludGVydmFscyBvbiBlaXRoZXIgc2lkZSBvZiB0aGUgdW5kZWZpbmVkIGludGVydmFsLCBpZiBwcmVzZW50JywgKCkgPT4ge1xuICAgIGZjLmFzc2VydChmYy5wcm9wZXJ0eShcbiAgICAgIGFyYml0cmFyeV9jb21wbGV0ZV9pbnRlcnZhbHMoKSxcbiAgICAgIChpbnRlcnZhbHMpID0+IHtcbiAgICAgICAgLy8gVGhlcmUgbXVzdCBiZSBhbiB1bmRlZmluZWQgaW50ZXJ2YWwgYW5kIGl0IG11c3Qgbm90IGJlIGF0IHRoZSBlZGdlc1xuICAgICAgICBjb25zdCBpID0gaW50ZXJ2YWxzLmZpbmRJbmRleCh4ID0+IHguY2hhbmdlID09PSB1bmRlZmluZWQpO1xuICAgICAgICBmYy5wcmUoaSA+IDAgJiYgaSA8IGludGVydmFscy5sZW5ndGggLSAxKTtcblxuICAgICAgICBjb25zdCBhbGFybXMgPSBmaW5kQWxhcm1UaHJlc2hvbGRzKGludGVydmFscyk7XG4gICAgICAgIHJldHVybiAoYWxhcm1zLmxvd2VyQWxhcm1JbnRlcnZhbEluZGV4ID09PSBpIC0gMSAmJiBhbGFybXMudXBwZXJBbGFybUludGVydmFsSW5kZXggPT09IGkgKyAxKTtcbiAgICAgIH0sXG4gICAgKSk7XG4gIH0pO1xuXG4gIHRlc3QoJ25vIHBpY2tpbmcgdXBwZXIgYm91bmQgaW5maW5pdHkgZm9yIGxvd2VyIGFsYXJtJywgKCkgPT4ge1xuICAgIGZjLmFzc2VydChmYy5wcm9wZXJ0eShcbiAgICAgIGFyYml0cmFyeV9jb21wbGV0ZV9pbnRlcnZhbHMoKSxcbiAgICAgIChpbnRlcnZhbHMpID0+IHtcbiAgICAgICAgY29uc3QgYWxhcm1zID0gZmluZEFsYXJtVGhyZXNob2xkcyhpbnRlcnZhbHMpO1xuICAgICAgICBmYy5wcmUoYWxhcm1zLmxvd2VyQWxhcm1JbnRlcnZhbEluZGV4ICE9PSB1bmRlZmluZWQpO1xuXG4gICAgICAgIHJldHVybiBpbnRlcnZhbHNbYWxhcm1zLmxvd2VyQWxhcm1JbnRlcnZhbEluZGV4IV0udXBwZXIgIT09IEluZmluaXR5O1xuICAgICAgfSxcbiAgICApKTtcbiAgfSk7XG5cbiAgdGVzdCgnbm8gcGlja2luZyBsb3dlciBib3VuZCAwIGZvciB1cHBlciBhbGFybScsICgpID0+IHtcbiAgICBmYy5hc3NlcnQoZmMucHJvcGVydHkoXG4gICAgICBhcmJpdHJhcnlfY29tcGxldGVfaW50ZXJ2YWxzKCksXG4gICAgICAoaW50ZXJ2YWxzKSA9PiB7XG4gICAgICAgIGNvbnN0IGFsYXJtcyA9IGZpbmRBbGFybVRocmVzaG9sZHMoaW50ZXJ2YWxzKTtcbiAgICAgICAgZmMucHJlKGFsYXJtcy51cHBlckFsYXJtSW50ZXJ2YWxJbmRleCAhPT0gdW5kZWZpbmVkKTtcblxuICAgICAgICByZXR1cm4gaW50ZXJ2YWxzW2FsYXJtcy51cHBlckFsYXJtSW50ZXJ2YWxJbmRleCFdLmxvd2VyICE9PSAwO1xuICAgICAgfSxcbiAgICApKTtcbiAgfSk7XG59KTtcblxuZnVuY3Rpb24gcmVhbGlzdGljUmVsYXRpdmVJbnRlcnZhbHMoKTogYXBwc2NhbGluZy5TY2FsaW5nSW50ZXJ2YWxbXSB7XG4gIC8vIEZ1bmN0aW9uIHNvIHdlIGRvbid0IGhhdmUgdG8gd29ycnkgYWJvdXQgY2xvbmluZ1xuICByZXR1cm4gW1xuICAgIHsgdXBwZXI6IDEwLCBjaGFuZ2U6IC0yIH0sXG4gICAgeyB1cHBlcjogMjAsIGNoYW5nZTogLTEgfSxcbiAgICB7IGxvd2VyOiA4MCwgY2hhbmdlOiArMSB9LFxuICAgIHsgbG93ZXI6IDkwLCBjaGFuZ2U6ICsyIH0sXG4gIF07XG59XG5cbmZ1bmN0aW9uIGluY29tcGxldGVMb3dlclJlbGF0aXZlSW50ZXJ2YWxzKCk6IGFwcHNjYWxpbmcuU2NhbGluZ0ludGVydmFsW10ge1xuICAvLyBGdW5jdGlvbiBzbyB3ZSBkb24ndCBoYXZlIHRvIHdvcnJ5IGFib3V0IGNsb25pbmdcbiAgLy8gVGhlIGZpcnN0IGludGVydmFsJ3MgbG93ZXIgaXMgbm90IHplcm8gbm9yIHVuZGVmaW5lZFxuICByZXR1cm4gW1xuICAgIHsgbG93ZXI6IDY1LCBjaGFuZ2U6ICsyIH0sXG4gICAgeyBsb3dlcjogODUsIGNoYW5nZTogKzMgfSxcbiAgXTtcbn1cblxuZnVuY3Rpb24gaW5jb21wbGV0ZVVwcGVyUmVsYXRpdmVJbnRlcnZhbHMoKTogYXBwc2NhbGluZy5TY2FsaW5nSW50ZXJ2YWxbXSB7XG4gIC8vIEZ1bmN0aW9uIHNvIHdlIGRvbid0IGhhdmUgdG8gd29ycnkgYWJvdXQgY2xvbmluZ1xuICAvLyBUaGUgbGFzdCBpbnRlcnZhbCdzIHVwcGVyIGlzIG5vdCBJbmZpbml0eSBub3IgdW5kZWZpbmVkXG4gIHJldHVybiBbXG4gICAgeyB1cHBlcjogNjUsIGNoYW5nZTogKzIgfSxcbiAgICB7IHVwcGVyOiA4NSwgY2hhbmdlOiArMyB9LFxuICBdO1xufVxuIl19