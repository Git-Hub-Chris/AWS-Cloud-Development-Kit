"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Coercer = exports.coerceApiParameters = void 0;
const parameter_types_1 = require("./parameter-types");
/**
 * Given a minimal AWS SDKv3 call definition (service, action, parameters),
 * coerces nested parameter values into a Uint8Array if that's what the SDKv3 expects.
 */
function coerceApiParameters(v3service, action, parameters = {}) {
    const typeMachine = (0, parameter_types_1.typeCoercionStateMachine)();
    return new Coercer(typeMachine).coerceApiParameters(v3service, action, parameters);
}
exports.coerceApiParameters = coerceApiParameters;
/**
 * Make this a class in order to have multiple entry points for testing that can all share convenience functions
 */
class Coercer {
    constructor(typeMachine) {
        this.typeMachine = typeMachine;
    }
    coerceApiParameters(v3service, action, parameters = {}) {
        // Get the initial state corresponding to the current service+action, then recurse through the parameters
        const actionState = this.progress(action.toLowerCase(), this.progress(v3service.toLowerCase(), 0));
        return this.recurse(parameters, actionState);
    }
    testCoerce(value) {
        return this.recurse(value, 0);
    }
    recurse(value, state) {
        switch (state) {
            case undefined: return value;
            case 'b': return coerceValueToUint8Array(value);
            case 'n': return coerceValueToNumber(value);
            case 'd': return coerceValueToDate(value);
        }
        if (Array.isArray(value)) {
            const elState = this.progress('*', state);
            return elState !== undefined
                ? value.map((e) => this.recurse(e, elState))
                : value;
        }
        if (value && typeof value === 'object') {
            // Mutate the object in-place for efficiency
            const mapState = this.progress('*', state);
            for (const key of Object.keys(value)) {
                const fieldState = this.progress(key, state) ?? mapState;
                if (fieldState !== undefined) {
                    value[key] = this.recurse(value[key], fieldState);
                }
            }
            return value;
        }
        return value;
    }
    /**
     * From a given state, return the state we would end up in if we followed this field
     */
    progress(field, s) {
        if (s === undefined || typeof s !== 'number') {
            return undefined;
        }
        return this.typeMachine[s][field];
    }
}
exports.Coercer = Coercer;
function coerceValueToUint8Array(x) {
    if (x instanceof Uint8Array) {
        return x;
    }
    if (typeof x === 'string' || typeof x === 'number') {
        return new TextEncoder().encode(x.toString());
    }
    return x;
}
function coerceValueToNumber(x) {
    if (typeof x === 'number') {
        return x;
    }
    if (typeof x === 'string') {
        const n = Number(x);
        return isNaN(n) ? x : n;
    }
    return x;
}
function coerceValueToDate(x) {
    if (typeof x === 'string' || typeof x === 'number') {
        const date = new Date(x);
        // if x is not a valid date
        if (isNaN(date.getTime())) {
            return x;
        }
        return date;
    }
    return x;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29lcmNlLWFwaS1wYXJhbWV0ZXJzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY29lcmNlLWFwaS1wYXJhbWV0ZXJzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLHVEQUF1RjtBQU12Rjs7O0dBR0c7QUFDSCxTQUFnQixtQkFBbUIsQ0FBQyxTQUFpQixFQUFFLE1BQWMsRUFBRSxhQUE0QixFQUFFO0lBQ25HLE1BQU0sV0FBVyxHQUFHLElBQUEsMENBQXdCLEdBQUUsQ0FBQztJQUMvQyxPQUFPLElBQUksT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDLG1CQUFtQixDQUFDLFNBQVMsRUFBRSxNQUFNLEVBQUUsVUFBVSxDQUFDLENBQUM7QUFDckYsQ0FBQztBQUhELGtEQUdDO0FBRUQ7O0dBRUc7QUFDSCxNQUFhLE9BQU87SUFDbEIsWUFBNkIsV0FBcUM7UUFBckMsZ0JBQVcsR0FBWCxXQUFXLENBQTBCO0lBQUksQ0FBQztJQUVoRSxtQkFBbUIsQ0FBQyxTQUFpQixFQUFFLE1BQWMsRUFBRSxhQUE0QixFQUFFO1FBQzFGLHlHQUF5RztRQUN6RyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxXQUFXLEVBQUUsRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxXQUFXLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ25HLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsV0FBVyxDQUFRLENBQUM7SUFDdEQsQ0FBQztJQUVNLFVBQVUsQ0FBQyxLQUFjO1FBQzlCLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDaEMsQ0FBQztJQUVPLE9BQU8sQ0FBQyxLQUFjLEVBQUUsS0FBb0M7UUFDbEUsUUFBUSxLQUFLLEVBQUU7WUFDYixLQUFLLFNBQVMsQ0FBQyxDQUFDLE9BQU8sS0FBSyxDQUFDO1lBQzdCLEtBQUssR0FBRyxD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SSxLQUFLLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDLEVBQUU7WUFDekIsT0FBTyxDQUFDLENBQUM7U0FDVjtRQUNELE9BQU8sSUFBSSxDQUFDO0tBQ2I7SUFFRCxPQUFPLENBQUMsQ0FBQztBQUNYLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUeXBlQ29lcmNpb25TdGF0ZU1hY2hpbmUsIHR5cGVDb2VyY2lvblN0YXRlTWFjaGluZSB9IGZyb20gJy4vcGFyYW1ldGVyLXR5cGVzJztcblxudHlwZSBBcGlQYXJhbWV0ZXJzID0geyBbcGFyYW06IHN0cmluZ106IGFueSB9O1xuXG50eXBlIFN0YXRlT3JDb252ZXJzaW9uID0gVHlwZUNvZXJjaW9uU3RhdGVNYWNoaW5lW251bWJlcl1bc3RyaW5nXTtcblxuLyoqXG4gKiBHaXZlbiBhIG1pbmltYWwgQVdTIFNES3YzIGNhbGwgZGVmaW5pdGlvbiAoc2VydmljZSwgYWN0aW9uLCBwYXJhbWV0ZXJzKSxcbiAqIGNvZXJjZXMgbmVzdGVkIHBhcmFtZXRlciB2YWx1ZXMgaW50byBhIFVpbnQ4QXJyYXkgaWYgdGhhdCdzIHdoYXQgdGhlIFNES3YzIGV4cGVjdHMuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjb2VyY2VBcGlQYXJhbWV0ZXJzKHYzc2VydmljZTogc3RyaW5nLCBhY3Rpb246IHN0cmluZywgcGFyYW1ldGVyczogQXBpUGFyYW1ldGVycyA9IHt9KTogQXBpUGFyYW1ldGVycyB7XG4gIGNvbnN0IHR5cGVNYWNoaW5lID0gdHlwZUNvZXJjaW9uU3RhdGVNYWNoaW5lKCk7XG4gIHJldHVybiBuZXcgQ29lcmNlcih0eXBlTWFjaGluZSkuY29lcmNlQXBpUGFyYW1ldGVycyh2M3NlcnZpY2UsIGFjdGlvbiwgcGFyYW1ldGVycyk7XG59XG5cbi8qKlxuICogTWFrZSB0aGlzIGEgY2xhc3MgaW4gb3JkZXIgdG8gaGF2ZSBtdWx0aXBsZSBlbnRyeSBwb2ludHMgZm9yIHRlc3RpbmcgdGhhdCBjYW4gYWxsIHNoYXJlIGNvbnZlbmllbmNlIGZ1bmN0aW9uc1xuICovXG5leHBvcnQgY2xhc3MgQ29lcmNlciB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgdHlwZU1hY2hpbmU6IFR5cGVDb2VyY2lvblN0YXRlTWFjaGluZSkgeyB9XG5cbiAgcHVibGljIGNvZXJjZUFwaVBhcmFtZXRlcnModjNzZXJ2aWNlOiBzdHJpbmcsIGFjdGlvbjogc3RyaW5nLCBwYXJhbWV0ZXJzOiBBcGlQYXJhbWV0ZXJzID0ge30pOiBBcGlQYXJhbWV0ZXJzIHtcbiAgICAvLyBHZXQgdGhlIGluaXRpYWwgc3RhdGUgY29ycmVzcG9uZGluZyB0byB0aGUgY3VycmVudCBzZXJ2aWNlK2FjdGlvbiwgdGhlbiByZWN1cnNlIHRocm91Z2ggdGhlIHBhcmFtZXRlcnNcbiAgICBjb25zdCBhY3Rpb25TdGF0ZSA9IHRoaXMucHJvZ3Jlc3MoYWN0aW9uLnRvTG93ZXJDYXNlKCksIHRoaXMucHJvZ3Jlc3ModjNzZXJ2aWNlLnRvTG93ZXJDYXNlKCksIDApKTtcbiAgICByZXR1cm4gdGhpcy5yZWN1cnNlKHBhcmFtZXRlcnMsIGFjdGlvblN0YXRlKSBhcyBhbnk7XG4gIH1cblxuICBwdWJsaWMgdGVzdENvZXJjZSh2YWx1ZTogdW5rbm93bik6IGFueSB7XG4gICAgcmV0dXJuIHRoaXMucmVjdXJzZSh2YWx1ZSwgMCk7XG4gIH1cblxuICBwcml2YXRlIHJlY3Vyc2UodmFsdWU6IHVua25vd24sIHN0YXRlOiBTdGF0ZU9yQ29udmVyc2lvbiB8IHVuZGVmaW5lZCk6IGFueSB7XG4gICAgc3dpdGNoIChzdGF0ZSkge1xuICAgICAgY2FzZSB1bmRlZmluZWQ6IHJldHVybiB2YWx1ZTtcbiAgICAgIGNhc2UgJ2InOiByZXR1cm4gY29lcmNlVmFsdWVUb1VpbnQ4QXJyYXkodmFsdWUpO1xuICAgICAgY2FzZSAnbic6IHJldHVybiBjb2VyY2VWYWx1ZVRvTnVtYmVyKHZhbHVlKTtcbiAgICAgIGNhc2UgJ2QnOiByZXR1cm4gY29lcmNlVmFsdWVUb0RhdGUodmFsdWUpO1xuICAgIH1cblxuICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xuICAgICAgY29uc3QgZWxTdGF0ZSA9IHRoaXMucHJvZ3Jlc3MoJyonLCBzdGF0ZSk7XG4gICAgICByZXR1cm4gZWxTdGF0ZSAhPT0gdW5kZWZpbmVkXG4gICAgICAgID8gdmFsdWUubWFwKChlKSA9PiB0aGlzLnJlY3Vyc2UoZSwgZWxTdGF0ZSkpXG4gICAgICAgIDogdmFsdWU7XG4gICAgfVxuXG4gICAgaWYgKHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcpIHtcbiAgICAgIC8vIE11dGF0ZSB0aGUgb2JqZWN0IGluLXBsYWNlIGZvciBlZmZpY2llbmN5XG4gICAgICBjb25zdCBtYXBTdGF0ZSA9IHRoaXMucHJvZ3Jlc3MoJyonLCBzdGF0ZSk7XG4gICAgICBmb3IgKGNvbnN0IGtleSBvZiBPYmplY3Qua2V5cyh2YWx1ZSkpIHtcbiAgICAgICAgY29uc3QgZmllbGRTdGF0ZSA9IHRoaXMucHJvZ3Jlc3Moa2V5LCBzdGF0ZSkgPz8gbWFwU3RhdGU7XG4gICAgICAgIGlmIChmaWVsZFN0YXRlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAodmFsdWUgYXMgYW55KVtrZXldID0gdGhpcy5yZWN1cnNlKCh2YWx1ZSBhcyBhbnkpW2tleV0sIGZpZWxkU3RhdGUpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gdmFsdWU7XG4gICAgfVxuXG4gICAgcmV0dXJuIHZhbHVlO1xuICB9XG5cbiAgLyoqXG4gICAqIEZyb20gYSBnaXZlbiBzdGF0ZSwgcmV0dXJuIHRoZSBzdGF0ZSB3ZSB3b3VsZCBlbmQgdXAgaW4gaWYgd2UgZm9sbG93ZWQgdGhpcyBmaWVsZFxuICAgKi9cbiAgcHJpdmF0ZSBwcm9ncmVzcyhmaWVsZDogc3RyaW5nLCBzOiBTdGF0ZU9yQ29udmVyc2lvbiB8IHVuZGVmaW5lZCk6IFN0YXRlT3JDb252ZXJzaW9uIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAocyA9PT0gdW5kZWZpbmVkIHx8IHR5cGVvZiBzICE9PSAnbnVtYmVyJykge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMudHlwZU1hY2hpbmVbc11bZmllbGRdO1xuICB9XG59XG5cbmZ1bmN0aW9uIGNvZXJjZVZhbHVlVG9VaW50OEFycmF5KHg6IHVua25vd24pOiBVaW50OEFycmF5IHwgYW55IHtcbiAgaWYgKHggaW5zdGFuY2VvZiBVaW50OEFycmF5KSB7XG4gICAgcmV0dXJuIHg7XG4gIH1cblxuICBpZiAodHlwZW9mIHggPT09ICdzdHJpbmcnIHx8IHR5cGVvZiB4ID09PSAnbnVtYmVyJykge1xuICAgIHJldHVybiBuZXcgVGV4dEVuY29kZXIoKS5lbmNvZGUoeC50b1N0cmluZygpKTtcbiAgfVxuXG4gIHJldHVybiB4O1xufVxuXG5mdW5jdGlvbiBjb2VyY2VWYWx1ZVRvTnVtYmVyKHg6IHVua25vd24pOiBudW1iZXIgfCBhbnkge1xuICBpZiAodHlwZW9mIHggPT09ICdudW1iZXInKSB7XG4gICAgcmV0dXJuIHg7XG4gIH1cblxuICBpZiAodHlwZW9mIHggPT09ICdzdHJpbmcnKSB7XG4gICAgY29uc3QgbiA9IE51bWJlcih4KTtcbiAgICByZXR1cm4gaXNOYU4obikgPyB4IDogbjtcbiAgfVxuXG4gIHJldHVybiB4O1xufVxuXG5mdW5jdGlvbiBjb2VyY2VWYWx1ZVRvRGF0ZSh4OiB1bmtub3duKTogRGF0ZSB8IGFueSB7XG4gIGlmICh0eXBlb2YgeCA9PT0gJ3N0cmluZycgfHwgdHlwZW9mIHggPT09ICdudW1iZXInKSB7XG4gICAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKHgpO1xuICAgIC8vIGlmIHggaXMgbm90IGEgdmFsaWQgZGF0ZVxuICAgIGlmIChpc05hTihkYXRlLmdldFRpbWUoKSkpIHtcbiAgICAgIHJldHVybiB4O1xuICAgIH1cbiAgICByZXR1cm4gZGF0ZTtcbiAgfVxuXG4gIHJldHVybiB4O1xufVxuIl19