"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const cdk_build_tools_1 = require("@aws-cdk/cdk-build-tools");
const lib_1 = require("../lib");
describe('secret value', () => {
    cdk_build_tools_1.testDeprecated('plainText', () => {
        // GIVEN
        const stack = new lib_1.Stack();
        // WHEN
        const v = lib_1.SecretValue.plainText('this just resolves to a string');
        // THEN
        expect(stack.resolve(v)).toEqual('this just resolves to a string');
    });
    test('unsafePlainText', () => {
        // GIVEN
        const stack = new lib_1.Stack();
        // WHEN
        const v = lib_1.SecretValue.unsafePlainText('this just resolves to a string');
        // THEN
        expect(stack.resolve(v)).toEqual('this just resolves to a string');
    });
    test('isSecretValue returns true', () => {
        const v = lib_1.SecretValue.unsafePlainText('this just resolves to a string');
        // THEN
        expect(lib_1.SecretValue.isSecretValue(v)).toEqual(true);
    });
    test('secret resolution fails if feature flag is switched on, secret can be unwrapped', () => {
        const app = new lib_1.App({
            context: { '@aws-cdk/core:checkSecretUsage': true },
        });
        const stack = new lib_1.Stack(app, 'Stack');
        // WHEN
        const v = lib_1.SecretValue.unsafePlainText('s3cr3t');
        // THEN
        expect(() => stack.resolve(v)).toThrow(/Using a SecretValue here risks exposing your secret/);
        // THEN
        expect(stack.resolve(v.unsafeUnwrap())).toEqual('s3cr3t');
    });
    test('secretsManager', () => {
        // GIVEN
        const stack = new lib_1.Stack();
        // WHEN
        const v = lib_1.SecretValue.secretsManager('secret-id', {
            jsonField: 'json-key',
            versionStage: 'version-stage',
        });
        // THEN
        expect(stack.resolve(v)).toEqual('{{resolve:secretsmanager:secret-id:SecretString:json-key:version-stage:}}');
    });
    test('secretsManager with secret-id from token', () => {
        // GIVEN
        const stack = new lib_1.Stack();
        // WHEN
        const v = lib_1.SecretValue.secretsManager(lib_1.Token.asString({ Ref: 'secret-id' }), {
            jsonField: 'json-key',
            versionStage: 'version-stage',
        });
        // THEN
        expect(stack.resolve(v)).toEqual({
            'Fn::Join': [
                '',
                [
                    '{{resolve:secretsmanager:',
                    { Ref: 'secret-id' },
                    ':SecretString:json-key:version-stage:}}',
                ],
            ],
        });
    });
    test('secretsManager with defaults', () => {
        // GIVEN
        const stack = new lib_1.Stack();
        // WHEN
        const v = lib_1.SecretValue.secretsManager('secret-id');
        // THEN
        expect(stack.resolve(v)).toEqual('{{resolve:secretsmanager:secret-id:SecretString:::}}');
    });
    test('secretsManager with defaults, secret-id from token', () => {
        // GIVEN
        const stack = new lib_1.Stack();
        // WHEN
        const v = lib_1.SecretValue.secretsManager(lib_1.Token.asString({ Ref: 'secret-id' }));
        // THEN
        expect(stack.resolve(v)).toEqual({
            'Fn::Join': [
                '',
                [
                    '{{resolve:secretsmanager:',
                    { Ref: 'secret-id' },
                    ':SecretString:::}}',
                ],
            ],
        });
    });
    test('secretsManager with an empty ID', () => {
        expect(() => lib_1.SecretValue.secretsManager('')).toThrow(/secretId cannot be empty/);
    });
    test('secretsManager with versionStage and versionId', () => {
        expect(() => {
            lib_1.SecretValue.secretsManager('secret-id', {
                versionStage: 'version-stage',
                versionId: 'version-id',
            });
        }).toThrow(/were both provided but only one is allowed/);
    });
    test('secretsManager with a non-ARN ID that has colon', () => {
        expect(() => lib_1.SecretValue.secretsManager('not:an:arn')).toThrow(/is not an ARN but contains ":"/);
    });
    test('ssmSecure', () => {
        // GIVEN
        const stack = new lib_1.Stack();
        // WHEN
        const v = lib_1.SecretValue.ssmSecure('param-name', 'param-version');
        // THEN
        expect(stack.resolve(v)).toEqual('{{resolve:ssm-secure:param-name:param-version}}');
    });
    test('ssmSecure without version', () => {
        // GIVEN
        const stack = new lib_1.Stack();
        // WHEN
        const v = lib_1.SecretValue.ssmSecure('param-name');
        // THEN
        expect(stack.resolve(v)).toEqual('{{resolve:ssm-secure:param-name}}');
    });
    test('cfnDynamicReference', () => {
        // GIVEN
        const stack = new lib_1.Stack();
        // WHEN
        const v = lib_1.SecretValue.cfnDynamicReference(new lib_1.CfnDynamicReference(lib_1.CfnDynamicReferenceService.SSM, 'foo:bar'));
        // THEN
        expect(stack.resolve(v)).toEqual('{{resolve:ssm:foo:bar}}');
    });
    test('cfnParameter (with NoEcho)', () => {
        // GIVEN
        const stack = new lib_1.Stack();
        const p = new lib_1.CfnParameter(stack, 'MyParam', { type: 'String', noEcho: true });
        // WHEN
        const v = lib_1.SecretValue.cfnParameter(p);
        // THEN
        expect(stack.resolve(v)).toEqual({ Ref: 'MyParam' });
    });
    test('fails if cfnParameter does not have NoEcho', () => {
        // GIVEN
        const stack = new lib_1.Stack();
        const p = new lib_1.CfnParameter(stack, 'MyParam', { type: 'String' });
        // THEN
        expect(() => lib_1.SecretValue.cfnParameter(p)).toThrow(/CloudFormation parameter must be configured with "NoEcho"/);
    });
    test('resourceAttribute does not work on literal', () => {
        expect(() => lib_1.SecretValue.resourceAttribute('xyz')).toThrow(/must be used with/);
    });
    test('resourceAttribute does not work on plain ref', () => {
        const stack = new lib_1.Stack();
        const param = new lib_1.CfnParameter(stack, 'Param');
        expect(() => lib_1.SecretValue.resourceAttribute(param.valueAsString)).toThrow(/must be used with/);
    });
    test('resourceAttribute works on actual resource attribute', () => {
        const stack = new lib_1.Stack();
        const res = new lib_1.CfnResource(stack, 'Resource', {
            type: 'AWS::My::Resource',
        });
        expect(stack.resolve(lib_1.SecretValue.resourceAttribute(res.ref))).toEqual({ Ref: 'Resource' });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VjcmV0LXZhbHVlLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzZWNyZXQtdmFsdWUudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDhEQUEwRDtBQUMxRCxnQ0FBb0k7QUFFcEksUUFBUSxDQUFDLGNBQWMsRUFBRSxHQUFHLEVBQUU7SUFDNUIsZ0NBQWMsQ0FBQyxXQUFXLEVBQUUsR0FBRyxFQUFFO1FBQy9CLFFBQVE7UUFDUixNQUFNLEtBQUssR0FBRyxJQUFJLFdBQUssRUFBRSxDQUFDO1FBRTFCLE9BQU87UUFDUCxNQUFNLENBQUMsR0FBRyxpQkFBVyxDQUFDLFNBQVMsQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO1FBRWxFLE9BQU87UUFDUCxNQUFNLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO0lBQ3JFLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLGlCQUFpQixFQUFFLEdBQUcsRUFBRTtRQUMzQixRQUFRO1FBQ1IsTUFBTSxLQUFLLEdBQUcsSUFBSSxXQUFLLEVBQUUsQ0FBQztRQUUxQixPQUFPO1FBQ1AsTUFBTSxDQUFDLEdBQUcsaUJBQVcsQ0FBQyxlQUFlLENBQUMsZ0NBQWdDLENBQUMsQ0FBQztRQUV4RSxPQUFPO1FBQ1AsTUFBTSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsZ0NBQWdDLENBQUMsQ0FBQztJQUNyRSxDQUFDLENBQUMsQ0FBQztJQUVILElBQUksQ0FBQyw0QkFBNEIsRUFBRSxHQUFHLEVBQUU7UUFDdEMsTUFBTSxDQUFDLEdBQUcsaUJBQVcsQ0FBQyxlQUFlLENBQUMsZ0NBQWdDLENBQUMsQ0FBQztRQUV4RSxPQUFPO1FBQ1AsTUFBTSxDQUFDLGlCQUFXLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUks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LG1CQUFtQixDQUFDLENBQUM7SUFDaEcsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFJLENBQUMsc0RBQXNELEVBQUUsR0FBRyxFQUFFO1FBQ2hFLE1BQU0sS0FBSyxHQUFHLElBQUksV0FBSyxFQUFFLENBQUM7UUFDMUIsTUFBTSxHQUFHLEdBQUcsSUFBSSxpQkFBVyxDQUFDLEtBQUssRUFBRSxVQUFVLEVBQUU7WUFDN0MsSUFBSSxFQUFFLG1CQUFtQjtTQUMxQixDQUFDLENBQUM7UUFDSCxNQUFNLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxpQkFBVyxDQUFDLGlCQUFpQixDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLEVBQUUsR0FBRyxFQUFFLFVBQVUsRUFBRSxDQUFDLENBQUM7SUFDN0YsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHRlc3REZXByZWNhdGVkIH0gZnJvbSAnQGF3cy1jZGsvY2RrLWJ1aWxkLXRvb2xzJztcbmltcG9ydCB7IENmbkR5bmFtaWNSZWZlcmVuY2UsIENmbkR5bmFtaWNSZWZlcmVuY2VTZXJ2aWNlLCBDZm5QYXJhbWV0ZXIsIFNlY3JldFZhbHVlLCBTdGFjaywgVG9rZW4sIEFwcCwgQ2ZuUmVzb3VyY2UgfSBmcm9tICcuLi9saWInO1xuXG5kZXNjcmliZSgnc2VjcmV0IHZhbHVlJywgKCkgPT4ge1xuICB0ZXN0RGVwcmVjYXRlZCgncGxhaW5UZXh0JywgKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soKTtcblxuICAgIC8vIFdIRU5cbiAgICBjb25zdCB2ID0gU2VjcmV0VmFsdWUucGxhaW5UZXh0KCd0aGlzIGp1c3QgcmVzb2x2ZXMgdG8gYSBzdHJpbmcnKTtcblxuICAgIC8vIFRIRU5cbiAgICBleHBlY3Qoc3RhY2sucmVzb2x2ZSh2KSkudG9FcXVhbCgndGhpcyBqdXN0IHJlc29sdmVzIHRvIGEgc3RyaW5nJyk7XG4gIH0pO1xuXG4gIHRlc3QoJ3Vuc2FmZVBsYWluVGV4dCcsICgpID0+IHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKCk7XG5cbiAgICAvLyBXSEVOXG4gICAgY29uc3QgdiA9IFNlY3JldFZhbHVlLnVuc2FmZVBsYWluVGV4dCgndGhpcyBqdXN0IHJlc29sdmVzIHRvIGEgc3RyaW5nJyk7XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0KHN0YWNrLnJlc29sdmUodikpLnRvRXF1YWwoJ3RoaXMganVzdCByZXNvbHZlcyB0byBhIHN0cmluZycpO1xuICB9KTtcblxuICB0ZXN0KCdpc1NlY3JldFZhbHVlIHJldHVybnMgdHJ1ZScsICgpID0+IHtcbiAgICBjb25zdCB2ID0gU2VjcmV0VmFsdWUudW5zYWZlUGxhaW5UZXh0KCd0aGlzIGp1c3QgcmVzb2x2ZXMgdG8gYSBzdHJpbmcnKTtcblxuICAgIC8vIFRIRU5cbiAgICBleHBlY3QoU2VjcmV0VmFsdWUuaXNTZWNyZXRWYWx1ZSh2KSkudG9FcXVhbCh0cnVlKTtcbiAgfSk7XG5cbiAgdGVzdCgnc2VjcmV0IHJlc29sdXRpb24gZmFpbHMgaWYgZmVhdHVyZSBmbGFnIGlzIHN3aXRjaGVkIG9uLCBzZWNyZXQgY2FuIGJlIHVud3JhcHBlZCcsICgpID0+IHtcbiAgICBjb25zdCBhcHAgPSBuZXcgQXBwKHtcbiAgICAgIGNvbnRleHQ6IHsgJ0Bhd3MtY2RrL2NvcmU6Y2hlY2tTZWNyZXRVc2FnZSc6IHRydWUgfSxcbiAgICB9KTtcbiAgICBjb25zdCBzdGFjayA9IG5ldyBTdGFjayhhcHAsICdTdGFjaycpO1xuXG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IHYgPSBTZWNyZXRWYWx1ZS51bnNhZmVQbGFpblRleHQoJ3MzY3IzdCcpO1xuXG4gICAgLy8gVEhFTlxuICAgIGV4cGVjdCgoKSA9PiBzdGFjay5yZXNvbHZlKHYpKS50b1Rocm93KC9Vc2luZyBhIFNlY3JldFZhbHVlIGhlcmUgcmlza3MgZXhwb3NpbmcgeW91ciBzZWNyZXQvKTtcblxuICAgIC8vIFRIRU5cbiAgICBleHBlY3Qoc3RhY2sucmVzb2x2ZSh2LnVuc2FmZVVud3JhcCgpKSkudG9FcXVhbCgnczNjcjN0Jyk7XG4gIH0pO1xuXG4gIHRlc3QoJ3NlY3JldHNNYW5hZ2VyJywgKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soKTtcblxuICAgIC8vIFdIRU5cbiAgICBjb25zdCB2ID0gU2VjcmV0VmFsdWUuc2VjcmV0c01hbmFnZXIoJ3NlY3JldC1pZCcsIHtcbiAgICAgIGpzb25GaWVsZDogJ2pzb24ta2V5JyxcbiAgICAgIHZlcnNpb25TdGFnZTogJ3ZlcnNpb24tc3RhZ2UnLFxuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIGV4cGVjdChzdGFjay5yZXNvbHZlKHYpKS50b0VxdWFsKCd7e3Jlc29sdmU6c2VjcmV0c21hbmFnZXI6c2VjcmV0LWlkOlNlY3JldFN0cmluZzpqc29uLWtleTp2ZXJzaW9uLXN0YWdlOn19Jyk7XG4gIH0pO1xuXG4gIHRlc3QoJ3NlY3JldHNNYW5hZ2VyIHdpdGggc2VjcmV0LWlkIGZyb20gdG9rZW4nLCAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBzdGFjayA9IG5ldyBTdGFjaygpO1xuXG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IHYgPSBTZWNyZXRWYWx1ZS5zZWNyZXRzTWFuYWdlcihUb2tlbi5hc1N0cmluZyh7IFJlZjogJ3NlY3JldC1pZCcgfSksIHtcbiAgICAgIGpzb25GaWVsZDogJ2pzb24ta2V5JyxcbiAgICAgIHZlcnNpb25TdGFnZTogJ3ZlcnNpb24tc3RhZ2UnLFxuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIGV4cGVjdChzdGFjay5yZXNvbHZlKHYpKS50b0VxdWFsKHtcbiAgICAgICdGbjo6Sm9pbic6IFtcbiAgICAgICAgJycsXG4gICAgICAgIFtcbiAgICAgICAgICAne3tyZXNvbHZlOnNlY3JldHNtYW5hZ2VyOicsXG4gICAgICAgICAgeyBSZWY6ICdzZWNyZXQtaWQnIH0sXG4gICAgICAgICAgJzpTZWNyZXRTdHJpbmc6anNvbi1rZXk6dmVyc2lvbi1zdGFnZTp9fScsXG4gICAgICAgIF0sXG4gICAgICBdLFxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdzZWNyZXRzTWFuYWdlciB3aXRoIGRlZmF1bHRzJywgKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soKTtcblxuICAgIC8vIFdIRU5cbiAgICBjb25zdCB2ID0gU2VjcmV0VmFsdWUuc2VjcmV0c01hbmFnZXIoJ3NlY3JldC1pZCcpO1xuXG4gICAgLy8gVEhFTlxuICAgIGV4cGVjdChzdGFjay5yZXNvbHZlKHYpKS50b0VxdWFsKCd7e3Jlc29sdmU6c2VjcmV0c21hbmFnZXI6c2VjcmV0LWlkOlNlY3JldFN0cmluZzo6On19Jyk7XG4gIH0pO1xuXG4gIHRlc3QoJ3NlY3JldHNNYW5hZ2VyIHdpdGggZGVmYXVsdHMsIHNlY3JldC1pZCBmcm9tIHRva2VuJywgKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soKTtcblxuICAgIC8vIFdIRU5cbiAgICBjb25zdCB2ID0gU2VjcmV0VmFsdWUuc2VjcmV0c01hbmFnZXIoVG9rZW4uYXNTdHJpbmcoeyBSZWY6ICdzZWNyZXQtaWQnIH0pKTtcblxuICAgIC8vIFRIRU5cbiAgICBleHBlY3Qoc3RhY2sucmVzb2x2ZSh2KSkudG9FcXVhbCh7XG4gICAgICAnRm46OkpvaW4nOiBbXG4gICAgICAgICcnLFxuICAgICAgICBbXG4gICAgICAgICAgJ3t7cmVzb2x2ZTpzZWNyZXRzbWFuYWdlcjonLFxuICAgICAgICAgIHsgUmVmOiAnc2VjcmV0LWlkJyB9LFxuICAgICAgICAgICc6U2VjcmV0U3RyaW5nOjo6fX0nLFxuICAgICAgICBdLFxuICAgICAgXSxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnc2VjcmV0c01hbmFnZXIgd2l0aCBhbiBlbXB0eSBJRCcsICgpID0+IHtcbiAgICBleHBlY3QoKCkgPT4gU2VjcmV0VmFsdWUuc2VjcmV0c01hbmFnZXIoJycpKS50b1Rocm93KC9zZWNyZXRJZCBjYW5ub3QgYmUgZW1wdHkvKTtcbiAgfSk7XG5cbiAgdGVzdCgnc2VjcmV0c01hbmFnZXIgd2l0aCB2ZXJzaW9uU3RhZ2UgYW5kIHZlcnNpb25JZCcsICgpID0+IHtcbiAgICBleHBlY3QoKCkgPT4ge1xuICAgICAgU2VjcmV0VmFsdWUuc2VjcmV0c01hbmFnZXIoJ3NlY3JldC1pZCcsXG4gICAgICAgIHtcbiAgICAgICAgICB2ZXJzaW9uU3RhZ2U6ICd2ZXJzaW9uLXN0YWdlJyxcbiAgICAgICAgICB2ZXJzaW9uSWQ6ICd2ZXJzaW9uLWlkJyxcbiAgICAgICAgfSk7XG4gICAgfSkudG9UaHJvdygvd2VyZSBib3RoIHByb3ZpZGVkIGJ1dCBvbmx5IG9uZSBpcyBhbGxvd2VkLyk7XG4gIH0pO1xuXG4gIHRlc3QoJ3NlY3JldHNNYW5hZ2VyIHdpdGggYSBub24tQVJOIElEIHRoYXQgaGFzIGNvbG9uJywgKCkgPT4ge1xuICAgIGV4cGVjdCgoKSA9PiBTZWNyZXRWYWx1ZS5zZWNyZXRzTWFuYWdlcignbm90OmFuOmFybicpKS50b1Rocm93KC9pcyBub3QgYW4gQVJOIGJ1dCBjb250YWlucyBcIjpcIi8pO1xuICB9KTtcblxuICB0ZXN0KCdzc21TZWN1cmUnLCAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBzdGFjayA9IG5ldyBTdGFjaygpO1xuXG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IHYgPSBTZWNyZXRWYWx1ZS5zc21TZWN1cmUoJ3BhcmFtLW5hbWUnLCAncGFyYW0tdmVyc2lvbicpO1xuXG4gICAgLy8gVEhFTlxuICAgIGV4cGVjdChzdGFjay5yZXNvbHZlKHYpKS50b0VxdWFsKCd7e3Jlc29sdmU6c3NtLXNlY3VyZTpwYXJhbS1uYW1lOnBhcmFtLXZlcnNpb259fScpO1xuICB9KTtcblxuICB0ZXN0KCdzc21TZWN1cmUgd2l0aG91dCB2ZXJzaW9uJywgKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soKTtcblxuICAgIC8vIFdIRU5cbiAgICBjb25zdCB2ID0gU2VjcmV0VmFsdWUuc3NtU2VjdXJlKCdwYXJhbS1uYW1lJyk7XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0KHN0YWNrLnJlc29sdmUodikpLnRvRXF1YWwoJ3t7cmVzb2x2ZTpzc20tc2VjdXJlOnBhcmFtLW5hbWV9fScpO1xuICB9KTtcblxuICB0ZXN0KCdjZm5EeW5hbWljUmVmZXJlbmNlJywgKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soKTtcblxuICAgIC8vIFdIRU5cbiAgICBjb25zdCB2ID0gU2VjcmV0VmFsdWUuY2ZuRHluYW1pY1JlZmVyZW5jZShuZXcgQ2ZuRHluYW1pY1JlZmVyZW5jZShDZm5EeW5hbWljUmVmZXJlbmNlU2VydmljZS5TU00sICdmb286YmFyJykpO1xuXG4gICAgLy8gVEhFTlxuICAgIGV4cGVjdChzdGFjay5yZXNvbHZlKHYpKS50b0VxdWFsKCd7e3Jlc29sdmU6c3NtOmZvbzpiYXJ9fScpO1xuICB9KTtcblxuICB0ZXN0KCdjZm5QYXJhbWV0ZXIgKHdpdGggTm9FY2hvKScsICgpID0+IHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKCk7XG4gICAgY29uc3QgcCA9IG5ldyBDZm5QYXJhbWV0ZXIoc3RhY2ssICdNeVBhcmFtJywgeyB0eXBlOiAnU3RyaW5nJywgbm9FY2hvOiB0cnVlIH0pO1xuXG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IHYgPSBTZWNyZXRWYWx1ZS5jZm5QYXJhbWV0ZXIocCk7XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0KHN0YWNrLnJlc29sdmUodikpLnRvRXF1YWwoeyBSZWY6ICdNeVBhcmFtJyB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnZmFpbHMgaWYgY2ZuUGFyYW1ldGVyIGRvZXMgbm90IGhhdmUgTm9FY2hvJywgKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soKTtcbiAgICBjb25zdCBwID0gbmV3IENmblBhcmFtZXRlcihzdGFjaywgJ015UGFyYW0nLCB7IHR5cGU6ICdTdHJpbmcnIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIGV4cGVjdCgoKSA9PiBTZWNyZXRWYWx1ZS5jZm5QYXJhbWV0ZXIocCkpLnRvVGhyb3coL0Nsb3VkRm9ybWF0aW9uIHBhcmFtZXRlciBtdXN0IGJlIGNvbmZpZ3VyZWQgd2l0aCBcIk5vRWNob1wiLyk7XG4gIH0pO1xuXG4gIHRlc3QoJ3Jlc291cmNlQXR0cmlidXRlIGRvZXMgbm90IHdvcmsgb24gbGl0ZXJhbCcsICgpID0+IHtcbiAgICBleHBlY3QoKCkgPT4gU2VjcmV0VmFsdWUucmVzb3VyY2VBdHRyaWJ1dGUoJ3h5eicpKS50b1Rocm93KC9tdXN0IGJlIHVzZWQgd2l0aC8pO1xuICB9KTtcblxuICB0ZXN0KCdyZXNvdXJjZUF0dHJpYnV0ZSBkb2VzIG5vdCB3b3JrIG9uIHBsYWluIHJlZicsICgpID0+IHtcbiAgICBjb25zdCBzdGFjayA9IG5ldyBTdGFjaygpO1xuICAgIGNvbnN0IHBhcmFtID0gbmV3IENmblBhcmFtZXRlcihzdGFjaywgJ1BhcmFtJyk7XG4gICAgZXhwZWN0KCgpID0+IFNlY3JldFZhbHVlLnJlc291cmNlQXR0cmlidXRlKHBhcmFtLnZhbHVlQXNTdHJpbmcpKS50b1Rocm93KC9tdXN0IGJlIHVzZWQgd2l0aC8pO1xuICB9KTtcblxuICB0ZXN0KCdyZXNvdXJjZUF0dHJpYnV0ZSB3b3JrcyBvbiBhY3R1YWwgcmVzb3VyY2UgYXR0cmlidXRlJywgKCkgPT4ge1xuICAgIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKCk7XG4gICAgY29uc3QgcmVzID0gbmV3IENmblJlc291cmNlKHN0YWNrLCAnUmVzb3VyY2UnLCB7XG4gICAgICB0eXBlOiAnQVdTOjpNeTo6UmVzb3VyY2UnLFxuICAgIH0pO1xuICAgIGV4cGVjdChzdGFjay5yZXNvbHZlKFNlY3JldFZhbHVlLnJlc291cmNlQXR0cmlidXRlKHJlcy5yZWYpKSkudG9FcXVhbCh7IFJlZjogJ1Jlc291cmNlJyB9KTtcbiAgfSk7XG59KTtcbiJdfQ==