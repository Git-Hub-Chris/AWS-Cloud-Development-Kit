"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const cxschema = require("@aws-cdk/cloud-assembly-schema");
const cxapi = require("@aws-cdk/cx-api");
const util_1 = require("./util");
const lib_1 = require("../lib");
describe('assets', () => {
    let app;
    let stack;
    beforeEach(() => {
        app = new lib_1.App({ context: { [cxapi.NEW_STYLE_STACK_SYNTHESIS_CONTEXT]: false } });
        stack = new lib_1.Stack(app);
    });
    test('addFileAsset correctly sets metadata and creates S3 parameters', () => {
        // WHEN
        stack.synthesizer.addFileAsset({
            fileName: 'file-name',
            packaging: lib_1.FileAssetPackaging.ZIP_DIRECTORY,
            sourceHash: 'source-hash',
        });
        // THEN
        const assetMetadata = stack.node.metadata.find(({ type }) => type === cxschema.ArtifactMetadataEntryType.ASSET);
        expect(assetMetadata && assetMetadata.data).toBeDefined();
        if (assetMetadata && assetMetadata.data) {
            const data = assetMetadata.data;
            expect(data.path).toEqual('file-name');
            expect(data.id).toEqual('source-hash');
            expect(data.packaging).toEqual(lib_1.FileAssetPackaging.ZIP_DIRECTORY);
            expect(data.sourceHash).toEqual('source-hash');
        }
        expect(util_1.toCloudFormation(stack)).toEqual({
            Parameters: {
                AssetParameterssourcehashS3BucketE6E91E3E: {
                    Type: 'String',
                    Description: 'S3 bucket for asset "source-hash"',
                },
                AssetParameterssourcehashS3VersionKeyAC4157C3: {
                    Type: 'String',
                    Description: 'S3 key for asset version "source-hash"',
                },
                AssetParameterssourcehashArtifactHashADBAE418: {
                    Type: 'String',
                    Description: 'Artifact hash for asset "source-hash"',
                },
            },
        });
    });
    test('addFileAsset correctly sets object urls', () => {
        // WHEN
        const assetLocation = stack.synthesizer.addFileAsset({
            fileName: 'file-name',
            packaging: lib_1.FileAssetPackaging.ZIP_DIRECTORY,
            sourceHash: 'source-hash',
        });
        // THEN
        const expectedS3UrlPrefix = 's3://';
        const expectedHttpUrlPrefix = `https://s3.${stack.region}.${stack.urlSuffix}/`;
        expect(assetLocation.s3ObjectUrl.replace(expectedS3UrlPrefix, '')).toEqual(assetLocation.httpUrl.replace(expectedHttpUrlPrefix, ''));
    });
    test('addDockerImageAsset correctly sets metadata', () => {
        // WHEN
        stack.synthesizer.addDockerImageAsset({
            sourceHash: 'source-hash',
            directoryName: 'directory-name',
        });
        // THEN
        const assetMetadata = stack.node.metadata.find(({ type }) => type === cxschema.ArtifactMetadataEntryType.ASSET);
        expect(assetMetadata && assetMetadata.data).toBeDefined();
        if (assetMetadata && assetMetadata.data) {
            const data = assetMetadata.data;
            expect(data.packaging).toEqual('container-image');
            expect(data.path).toEqual('directory-name');
            expect(data.sourceHash).toEqual('source-hash');
            expect(data.imageTag).toEqual('source-hash');
        }
        expect(util_1.toCloudFormation(stack)).toEqual({});
    });
    test('addDockerImageAsset uses the default repository name', () => {
        // WHEN
        stack.synthesizer.addDockerImageAsset({
            sourceHash: 'source-hash',
            directoryName: 'directory-name',
        });
        // THEN
        const assetMetadata = stack.node.metadata.find(({ type }) => type === cxschema.ArtifactMetadataEntryType.ASSET);
        expect(assetMetadata && assetMetadata.data).toBeDefined();
        if (assetMetadata && assetMetadata.data) {
            const data = assetMetadata.data;
            expect(data.packaging).toEqual('container-image');
            expect(data.path).toEqual('directory-name');
            expect(data.sourceHash).toEqual('source-hash');
            expect(data.imageTag).toEqual('source-hash');
        }
        expect(util_1.toCloudFormation(stack)).toEqual({});
    });
    test('addDockerImageAsset supports overriding repository name through a context key as a workaround until we have API for that', () => {
        stack.node.setContext('assets-ecr-repository-name', 'my-custom-repo-name');
        // WHEN
        stack.synthesizer.addDockerImageAsset({
            sourceHash: 'source-hash',
            directoryName: 'directory-name',
        });
        // THEN
        const assetMetadata = stack.node.metadata.find(({ type }) => type === cxschema.ArtifactMetadataEntryType.ASSET);
        expect(assetMetadata && assetMetadata.data).toBeDefined();
        if (assetMetadata && assetMetadata.data) {
            const data = assetMetadata.data;
            expect(data.packaging).toEqual('container-image');
            expect(data.path).toEqual('directory-name');
            expect(data.sourceHash).toEqual('source-hash');
            expect(data.repositoryName).toEqual('my-custom-repo-name');
            expect(data.imageTag).toEqual('source-hash');
        }
        expect(util_1.toCloudFormation(stack)).toEqual({});
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXNzZXRzLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJhc3NldHMudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDJEQUEyRDtBQUMzRCx5Q0FBeUM7QUFDekMsaUNBQTBDO0FBQzFDLGdDQUF3RDtBQUV4RCxRQUFRLENBQUMsUUFBUSxFQUFFLEdBQUcsRUFBRTtJQUN0QixJQUFJLEdBQVEsQ0FBQztJQUNiLElBQUksS0FBWSxDQUFDO0lBRWpCLFVBQVUsQ0FBQyxHQUFHLEVBQUU7UUFDZCxHQUFHLEdBQUcsSUFBSSxTQUFHLENBQUMsRUFBRSxPQUFPLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxpQ0FBaUMsQ0FBQyxFQUFFLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUNqRixLQUFLLEdBQUcsSUFBSSxXQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDekIsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFJLENBQUMsZ0VBQWdFLEVBQUUsR0FBRyxFQUFFO1FBQzFFLE9BQU87UUFDUCxLQUFLLENBQUMsV0FBVyxDQUFDLFlBQVksQ0FBQztZQUM3QixRQUFRLEVBQUUsV0FBVztZQUNyQixTQUFTLEVBQUUsd0JBQWtCLENBQUMsYUFBYTtZQUMzQyxVQUFVLEVBQUUsYUFBYTtTQUMxQixDQUFDLENBQUM7UUFFSCxPQUFPO1FBQ1AsTUFBTSxhQUFhLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLENBQUMsSUFBSSxLQUFLLFFBQVEsQ0FBQyx5QkFBeUIsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUVoSCxNQUFNLENBQUMsYUFBYSxJQUFJLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUUxRCxJQUFJLGFBQWEsSUFBSSxhQUFhLENBQUMsSUFBSSxFQUFFO1lBQ3ZDLE1BQU0sSUFBSSxHQUFHLGFBQWEsQ0FBQyxJ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SyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsRUFBRyxDQUFDLENBQUM7SUFFL0MsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGN4c2NoZW1hIGZyb20gJ0Bhd3MtY2RrL2Nsb3VkLWFzc2VtYmx5LXNjaGVtYSc7XG5pbXBvcnQgKiBhcyBjeGFwaSBmcm9tICdAYXdzLWNkay9jeC1hcGknO1xuaW1wb3J0IHsgdG9DbG91ZEZvcm1hdGlvbiB9IGZyb20gJy4vdXRpbCc7XG5pbXBvcnQgeyBBcHAsIEZpbGVBc3NldFBhY2thZ2luZywgU3RhY2sgfSBmcm9tICcuLi9saWInO1xuXG5kZXNjcmliZSgnYXNzZXRzJywgKCkgPT4ge1xuICBsZXQgYXBwOiBBcHA7XG4gIGxldCBzdGFjazogU3RhY2s7XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgYXBwID0gbmV3IEFwcCh7IGNvbnRleHQ6IHsgW2N4YXBpLk5FV19TVFlMRV9TVEFDS19TWU5USEVTSVNfQ09OVEVYVF06IGZhbHNlIH0gfSk7XG4gICAgc3RhY2sgPSBuZXcgU3RhY2soYXBwKTtcbiAgfSk7XG5cbiAgdGVzdCgnYWRkRmlsZUFzc2V0IGNvcnJlY3RseSBzZXRzIG1ldGFkYXRhIGFuZCBjcmVhdGVzIFMzIHBhcmFtZXRlcnMnLCAoKSA9PiB7XG4gICAgLy8gV0hFTlxuICAgIHN0YWNrLnN5bnRoZXNpemVyLmFkZEZpbGVBc3NldCh7XG4gICAgICBmaWxlTmFtZTogJ2ZpbGUtbmFtZScsXG4gICAgICBwYWNrYWdpbmc6IEZpbGVBc3NldFBhY2thZ2luZy5aSVBfRElSRUNUT1JZLFxuICAgICAgc291cmNlSGFzaDogJ3NvdXJjZS1oYXNoJyxcbiAgICB9KTtcblxuICAgIC8vIFRIRU5cbiAgICBjb25zdCBhc3NldE1ldGFkYXRhID0gc3RhY2subm9kZS5tZXRhZGF0YS5maW5kKCh7IHR5cGUgfSkgPT4gdHlwZSA9PT0gY3hzY2hlbWEuQXJ0aWZhY3RNZXRhZGF0YUVudHJ5VHlwZS5BU1NFVCk7XG5cbiAgICBleHBlY3QoYXNzZXRNZXRhZGF0YSAmJiBhc3NldE1ldGFkYXRhLmRhdGEpLnRvQmVEZWZpbmVkKCk7XG5cbiAgICBpZiAoYXNzZXRNZXRhZGF0YSAmJiBhc3NldE1ldGFkYXRhLmRhdGEpIHtcbiAgICAgIGNvbnN0IGRhdGEgPSBhc3NldE1ldGFkYXRhLmRhdGEgYXMgY3hzY2hlbWEuQXNzZXRNZXRhZGF0YUVudHJ5O1xuICAgICAgZXhwZWN0KGRhdGEucGF0aCkudG9FcXVhbCgnZmlsZS1uYW1lJyk7XG4gICAgICBleHBlY3QoZGF0YS5pZCkudG9FcXVhbCgnc291cmNlLWhhc2gnKTtcbiAgICAgIGV4cGVjdChkYXRhLnBhY2thZ2luZykudG9FcXVhbChGaWxlQXNzZXRQYWNrYWdpbmcuWklQX0RJUkVDVE9SWSk7XG4gICAgICBleHBlY3QoZGF0YS5zb3VyY2VIYXNoKS50b0VxdWFsKCdzb3VyY2UtaGFzaCcpO1xuICAgIH1cblxuICAgIGV4cGVjdCh0b0Nsb3VkRm9ybWF0aW9uKHN0YWNrKSkudG9FcXVhbCh7XG4gICAgICBQYXJhbWV0ZXJzOiB7XG4gICAgICAgIEFzc2V0UGFyYW1ldGVyc3NvdXJjZWhhc2hTM0J1Y2tldEU2RTkxRTNFOiB7XG4gICAgICAgICAgVHlwZTogJ1N0cmluZycsXG4gICAgICAgICAgRGVzY3JpcHRpb246ICdTMyBidWNrZXQgZm9yIGFzc2V0IFwic291cmNlLWhhc2hcIicsXG4gICAgICAgIH0sXG4gICAgICAgIEFzc2V0UGFyYW1ldGVyc3NvdXJjZWhhc2hTM1ZlcnNpb25LZXlBQzQxNTdDMzoge1xuICAgICAgICAgIFR5cGU6ICdTdHJpbmcnLFxuICAgICAgICAgIERlc2NyaXB0aW9uOiAnUzMga2V5IGZvciBhc3NldCB2ZXJzaW9uIFwic291cmNlLWhhc2hcIicsXG4gICAgICAgIH0sXG4gICAgICAgIEFzc2V0UGFyYW1ldGVyc3NvdXJjZWhhc2hBcnRpZmFjdEhhc2hBREJBRTQxODoge1xuICAgICAgICAgIFR5cGU6ICdTdHJpbmcnLFxuICAgICAgICAgIERlc2NyaXB0aW9uOiAnQXJ0aWZhY3QgaGFzaCBmb3IgYXNzZXQgXCJzb3VyY2UtaGFzaFwiJyxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH0pO1xuXG4gIHRlc3QoJ2FkZEZpbGVBc3NldCBjb3JyZWN0bHkgc2V0cyBvYmplY3QgdXJscycsICgpID0+IHtcbiAgICAvLyBXSEVOXG4gICAgY29uc3QgYXNzZXRMb2NhdGlvbiA9IHN0YWNrLnN5bnRoZXNpemVyLmFkZEZpbGVBc3NldCh7XG4gICAgICBmaWxlTmFtZTogJ2ZpbGUtbmFtZScsXG4gICAgICBwYWNrYWdpbmc6IEZpbGVBc3NldFBhY2thZ2luZy5aSVBfRElSRUNUT1JZLFxuICAgICAgc291cmNlSGFzaDogJ3NvdXJjZS1oYXNoJyxcbiAgICB9KTtcblxuICAgIC8vIFRIRU5cbiAgICBjb25zdCBleHBlY3RlZFMzVXJsUHJlZml4ID0gJ3MzOi8vJztcbiAgICBjb25zdCBleHBlY3RlZEh0dHBVcmxQcmVmaXggPSBgaHR0cHM6Ly9zMy4ke3N0YWNrLnJlZ2lvbn0uJHtzdGFjay51cmxTdWZmaXh9L2A7XG5cbiAgICBleHBlY3QoXG4gICAgICBhc3NldExvY2F0aW9uLnMzT2JqZWN0VXJsLnJlcGxhY2UoZXhwZWN0ZWRTM1VybFByZWZpeCwgJycpKS50b0VxdWFsKFxuICAgICAgYXNzZXRMb2NhdGlvbi5odHRwVXJsLnJlcGxhY2UoZXhwZWN0ZWRIdHRwVXJsUHJlZml4LCAnJyksXG4gICAgKTtcbiAgfSk7XG5cbiAgdGVzdCgnYWRkRG9ja2VySW1hZ2VBc3NldCBjb3JyZWN0bHkgc2V0cyBtZXRhZGF0YScsICgpID0+IHtcbiAgICAvLyBXSEVOXG4gICAgc3RhY2suc3ludGhlc2l6ZXIuYWRkRG9ja2VySW1hZ2VBc3NldCh7XG4gICAgICBzb3VyY2VIYXNoOiAnc291cmNlLWhhc2gnLFxuICAgICAgZGlyZWN0b3J5TmFtZTogJ2RpcmVjdG9yeS1uYW1lJyxcbiAgICB9KTtcblxuICAgIC8vIFRIRU5cbiAgICBjb25zdCBhc3NldE1ldGFkYXRhID0gc3RhY2subm9kZS5tZXRhZGF0YS5maW5kKCh7IHR5cGUgfSkgPT4gdHlwZSA9PT0gY3hzY2hlbWEuQXJ0aWZhY3RNZXRhZGF0YUVudHJ5VHlwZS5BU1NFVCk7XG5cbiAgICBleHBlY3QoYXNzZXRNZXRhZGF0YSAmJiBhc3NldE1ldGFkYXRhLmRhdGEpLnRvQmVEZWZpbmVkKCk7XG5cbiAgICBpZiAoYXNzZXRNZXRhZGF0YSAmJiBhc3NldE1ldGFkYXRhLmRhdGEpIHtcbiAgICAgIGNvbnN0IGRhdGEgPSBhc3NldE1ldGFkYXRhLmRhdGEgYXMgY3hzY2hlbWEuQ29udGFpbmVySW1hZ2VBc3NldE1ldGFkYXRhRW50cnk7XG4gICAgICBleHBlY3QoZGF0YS5wYWNrYWdpbmcpLnRvRXF1YWwoJ2NvbnRhaW5lci1pbWFnZScpO1xuICAgICAgZXhwZWN0KGRhdGEucGF0aCkudG9FcXVhbCgnZGlyZWN0b3J5LW5hbWUnKTtcbiAgICAgIGV4cGVjdChkYXRhLnNvdXJjZUhhc2gpLnRvRXF1YWwoJ3NvdXJjZS1oYXNoJyk7XG4gICAgICBleHBlY3QoZGF0YS5pbWFnZVRhZykudG9FcXVhbCgnc291cmNlLWhhc2gnKTtcbiAgICB9XG5cbiAgICBleHBlY3QodG9DbG91ZEZvcm1hdGlvbihzdGFjaykpLnRvRXF1YWwoeyB9KTtcblxuICB9KTtcblxuICB0ZXN0KCdhZGREb2NrZXJJbWFnZUFzc2V0IHVzZXMgdGhlIGRlZmF1bHQgcmVwb3NpdG9yeSBuYW1lJywgKCkgPT4ge1xuICAgIC8vIFdIRU5cbiAgICBzdGFjay5zeW50aGVzaXplci5hZGREb2NrZXJJbWFnZUFzc2V0KHtcbiAgICAgIHNvdXJjZUhhc2g6ICdzb3VyY2UtaGFzaCcsXG4gICAgICBkaXJlY3RvcnlOYW1lOiAnZGlyZWN0b3J5LW5hbWUnLFxuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIGNvbnN0IGFzc2V0TWV0YWRhdGEgPSBzdGFjay5ub2RlLm1ldGFkYXRhLmZpbmQoKHsgdHlwZSB9KSA9PiB0eXBlID09PSBjeHNjaGVtYS5BcnRpZmFjdE1ldGFkYXRhRW50cnlUeXBlLkFTU0VUKTtcblxuICAgIGV4cGVjdChhc3NldE1ldGFkYXRhICYmIGFzc2V0TWV0YWRhdGEuZGF0YSkudG9CZURlZmluZWQoKTtcblxuICAgIGlmIChhc3NldE1ldGFkYXRhICYmIGFzc2V0TWV0YWRhdGEuZGF0YSkge1xuICAgICAgY29uc3QgZGF0YSA9IGFzc2V0TWV0YWRhdGEuZGF0YSBhcyBjeHNjaGVtYS5Db250YWluZXJJbWFnZUFzc2V0TWV0YWRhdGFFbnRyeTtcbiAgICAgIGV4cGVjdChkYXRhLnBhY2thZ2luZykudG9FcXVhbCgnY29udGFpbmVyLWltYWdlJyk7XG4gICAgICBleHBlY3QoZGF0YS5wYXRoKS50b0VxdWFsKCdkaXJlY3RvcnktbmFtZScpO1xuICAgICAgZXhwZWN0KGRhdGEuc291cmNlSGFzaCkudG9FcXVhbCgnc291cmNlLWhhc2gnKTtcbiAgICAgIGV4cGVjdChkYXRhLmltYWdlVGFnKS50b0VxdWFsKCdzb3VyY2UtaGFzaCcpO1xuICAgIH1cblxuICAgIGV4cGVjdCh0b0Nsb3VkRm9ybWF0aW9uKHN0YWNrKSkudG9FcXVhbCh7IH0pO1xuXG4gIH0pO1xuXG4gIHRlc3QoJ2FkZERvY2tlckltYWdlQXNzZXQgc3VwcG9ydHMgb3ZlcnJpZGluZyByZXBvc2l0b3J5IG5hbWUgdGhyb3VnaCBhIGNvbnRleHQga2V5IGFzIGEgd29ya2Fyb3VuZCB1bnRpbCB3ZSBoYXZlIEFQSSBmb3IgdGhhdCcsICgpID0+IHtcbiAgICBzdGFjay5ub2RlLnNldENvbnRleHQoJ2Fzc2V0cy1lY3ItcmVwb3NpdG9yeS1uYW1lJywgJ215LWN1c3RvbS1yZXBvLW5hbWUnKTtcblxuICAgIC8vIFdIRU5cbiAgICBzdGFjay5zeW50aGVzaXplci5hZGREb2NrZXJJbWFnZUFzc2V0KHtcbiAgICAgIHNvdXJjZUhhc2g6ICdzb3VyY2UtaGFzaCcsXG4gICAgICBkaXJlY3RvcnlOYW1lOiAnZGlyZWN0b3J5LW5hbWUnLFxuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIGNvbnN0IGFzc2V0TWV0YWRhdGEgPSBzdGFjay5ub2RlLm1ldGFkYXRhLmZpbmQoKHsgdHlwZSB9KSA9PiB0eXBlID09PSBjeHNjaGVtYS5BcnRpZmFjdE1ldGFkYXRhRW50cnlUeXBlLkFTU0VUKTtcblxuICAgIGV4cGVjdChhc3NldE1ldGFkYXRhICYmIGFzc2V0TWV0YWRhdGEuZGF0YSkudG9CZURlZmluZWQoKTtcblxuICAgIGlmIChhc3NldE1ldGFkYXRhICYmIGFzc2V0TWV0YWRhdGEuZGF0YSkge1xuICAgICAgY29uc3QgZGF0YSA9IGFzc2V0TWV0YWRhdGEuZGF0YSBhcyBjeHNjaGVtYS5Db250YWluZXJJbWFnZUFzc2V0TWV0YWRhdGFFbnRyeTtcbiAgICAgIGV4cGVjdChkYXRhLnBhY2thZ2luZykudG9FcXVhbCgnY29udGFpbmVyLWltYWdlJyk7XG4gICAgICBleHBlY3QoZGF0YS5wYXRoKS50b0VxdWFsKCdkaXJlY3RvcnktbmFtZScpO1xuICAgICAgZXhwZWN0KGRhdGEuc291cmNlSGFzaCkudG9FcXVhbCgnc291cmNlLWhhc2gnKTtcbiAgICAgIGV4cGVjdChkYXRhLnJlcG9zaXRvcnlOYW1lKS50b0VxdWFsKCdteS1jdXN0b20tcmVwby1uYW1lJyk7XG4gICAgICBleHBlY3QoZGF0YS5pbWFnZVRhZykudG9FcXVhbCgnc291cmNlLWhhc2gnKTtcbiAgICB9XG5cbiAgICBleHBlY3QodG9DbG91ZEZvcm1hdGlvbihzdGFjaykpLnRvRXF1YWwoeyB9KTtcblxuICB9KTtcbn0pO1xuIl19