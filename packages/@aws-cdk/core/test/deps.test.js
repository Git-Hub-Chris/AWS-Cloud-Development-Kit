"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const constructs_1 = require("constructs");
const core = require("../lib");
const lib_1 = require("../lib");
const deps_1 = require("../lib/deps");
describe('deps', () => {
    describe('dependency methods', () => {
        test('can explicitly add a dependency between resources', () => {
            const app = new core.App();
            const stack = new core.Stack(app, 'TestStack');
            const resource1 = new core.CfnResource(stack, 'Resource1', { type: 'Test::Resource::Fake1' });
            const resource2 = new core.CfnResource(stack, 'Resource2', { type: 'Test::Resource::Fake2' });
            deps_1.addDependency(resource1, resource2);
            expect(app.synth().getStackByName(stack.stackName).template.Resources).toEqual({
                Resource1: {
                    Type: 'Test::Resource::Fake1',
                    DependsOn: [
                        'Resource2',
                    ],
                },
                Resource2: {
                    Type: 'Test::Resource::Fake2',
                },
            });
        });
        test('can explicitly remove a dependency between resources', () => {
            const app = new core.App();
            const stack = new core.Stack(app, 'TestStack');
            const resource1 = new core.CfnResource(stack, 'Resource1', { type: 'Test::Resource::Fake1' });
            const resource2 = new core.CfnResource(stack, 'Resource2', { type: 'Test::Resource::Fake2' });
            deps_1.addDependency(resource1, resource2);
            deps_1.removeDependency(resource1, resource2);
            expect(app.synth().getStackByName(stack.stackName).template.Resources).toEqual({
                Resource1: {
                    Type: 'Test::Resource::Fake1',
                },
                Resource2: {
                    Type: 'Test::Resource::Fake2',
                },
            });
        });
        test('can explicitly add, obtain, and remove dependencies across stacks', () => {
            const app = new core.App();
            const stack1 = new core.Stack(app, 'TestStack1');
            // Use a really long construct id to identify issues between Names.uniqueId and Names.uniqueResourceName
            const reallyLongConstructId = 'A'.repeat(247);
            const stack2 = new core.Stack(app, reallyLongConstructId, { stackName: 'TestStack2' });
            // Sanity check since this test depends on the discrepancy
            expect(lib_1.Names.uniqueId(stack2)).not.toBe(lib_1.Names.uniqueResourceName(stack2, {}));
            const resource1 = new core.CfnResource(stack1, 'Resource1', { type: 'Test::Resource::Fake1' });
            const resource2 = new core.CfnResource(stack2, 'Resource2', { type: 'Test::Resource::Fake2' });
            const resource3 = new core.CfnResource(stack1, 'Resource3', { type: 'Test::Resource::Fake3' });
            deps_1.addDependency(resource1, resource2);
            // Adding the same resource dependency twice should be a no-op
            deps_1.addDependency(resource1, resource2);
            deps_1.addDependency(resource1, resource3);
            expect(stack1.dependencies.length).toEqual(1);
            expect(stack1.dependencies[0].node.id).toEqual(stack2.node.id);
            // obtainDependencies should assemble and flatten resource-to-resource dependencies even across stacks
            expect(deps_1.obtainDependencies(resource1).map(x => x.node.path)).toEqual([resource3.node.path, resource2.node.path]);
            deps_1.removeDependency(resource1, resource2);
            // For symmetry, removing a dependency that doesn't exist should be a no-op
            deps_1.removeDependency(resource1, resource2);
            expect(stack1.dependencies.length).toEqual(0);
        });
        test('do nothing if source is target', () => {
            const app = new core.App();
            const stack = new core.Stack(app, 'TestStack');
            const resource1 = new core.CfnResource(stack, 'Resource1', { type: 'Test::Resource::Fake1' });
            deps_1.addDependency(resource1, resource1);
            expect(app.synth().getStackByName(stack.stackName).template.Resources).toEqual({
                Resource1: {
                    Type: 'Test::Resource::Fake1',
                },
            });
        });
        test('handle source being common stack', () => {
            const app = new core.App();
            const stack1 = new core.Stack(app, 'TestStack1');
            const resource1 = new core.CfnResource(stack1, 'Resource1', { type: 'Test::Resource::Fake1' });
            // If source is the common stack, this should be a noop
            deps_1.addDependency(stack1, resource1);
            expect(stack1.dependencies.length).toEqual(0);
        });
        test('throws error if target is common stack', () => {
            const app = new core.App();
            const stack1 = new core.Stack(app, 'TestStack1');
            const resource1 = new core.CfnResource(stack1, 'Resource1', { type: 'Test::Resource::Fake1' });
            expect(() => {
                deps_1.addDependency(resource1, stack1);
            }).toThrow(/cannot depend on /);
        });
        test('can explicitly add, obtain, and remove dependencies across nested stacks', () => {
            const app = new core.App();
            const stack1 = new core.Stack(app, 'TestStack1');
            const construct1 = new constructs_1.Construct(stack1, 'CommonConstruct');
            // Use a really long construct id to identify issues between Names.uniqueId and Names.uniqueResourceName
            const nestedStack1 = new core.Stack(construct1, 'TestNestedStack1');
            const nestedStack2 = new core.Stack(construct1, 'TestNestedStack2');
            const resource1 = new core.CfnResource(nestedStack1, 'Resource1', { type: 'Test::Resource::Fake1' });
            const resource2 = new core.CfnResource(nestedStack2, 'Resource2', { type: 'Test::Resource::Fake2' });
            deps_1.addDependency(resource1, resource2);
            // Adding the same resource dependency twice should be a no-op
            deps_1.addDependency(resource1, resource2);
            expect(nestedStack1.dependencies.length).toEqual(1);
            expect(nestedStack1.dependencies[0].node.id).toEqual(nestedStack2.node.id);
            deps_1.removeDependency(resource1, resource2);
            // For symmetry, removing a dependency that doesn't exist should be a no-op
            deps_1.removeDependency(resource1, resource2);
            expect(stack1.dependencies.length).toEqual(0);
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVwcy50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZGVwcy50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsMkNBQXVDO0FBQ3ZDLCtCQUErQjtBQUMvQixnQ0FBK0I7QUFDL0Isc0NBQWtGO0FBRWxGLFFBQVEsQ0FBQyxNQUFNLEVBQUUsR0FBRyxFQUFFO0lBQ3BCLFFBQVEsQ0FBQyxvQkFBb0IsRUFBRSxHQUFHLEVBQUU7UUFDbEMsSUFBSSxDQUFDLG1EQUFtRCxFQUFFLEdBQUcsRUFBRTtZQUM3RCxNQUFNLEdBQUcsR0FBRyxJQUFJLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUMzQixNQUFNLEtBQUssR0FBRyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLFdBQVcsQ0FBQyxDQUFDO1lBQy9DLE1BQU0sU0FBUyxHQUFHLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLEVBQUUsV0FBVyxFQUFFLEVBQUUsSUFBSSxFQUFFLHVCQUF1QixFQUFFLENBQUMsQ0FBQztZQUM5RixNQUFNLFNBQVMsR0FBRyxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxFQUFFLFdBQVcsRUFBRSxFQUFFLElBQUksRUFBRSx1QkFBdUIsRUFBRSxDQUFDLENBQUM7WUFDOUYsb0JBQWEsQ0FBQyxTQUFTLEVBQUUsU0FBUyxDQUFDLENBQUM7WUFFcEMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQyxPQUFPLENBQUM7Z0JBQzdFLFNBQVMsRUFBRTtvQkFDVCxJQUFJLEVBQUUsdUJBQXVCO29CQUM3QixTQUFTLEVBQUU7d0JBQ1QsV0FBVztxQkFDWjtpQkFDRjtnQkFDRCxTQUFTLEVBQUU7b0JBQ1QsSUFBSSxFQUFFLHVCQUF1QjtpQkFDOUI7YUFDRixDQUFDLENBQUM7UUFDTCxDQUFDLENB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QUFTLENBQUMsQ0FBQztZQUN2QyxNQUFNLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDaEQsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5pbXBvcnQgKiBhcyBjb3JlIGZyb20gJy4uL2xpYic7XG5pbXBvcnQgeyBOYW1lcyB9IGZyb20gJy4uL2xpYic7XG5pbXBvcnQgeyBhZGREZXBlbmRlbmN5LCBvYnRhaW5EZXBlbmRlbmNpZXMsIHJlbW92ZURlcGVuZGVuY3kgfSBmcm9tICcuLi9saWIvZGVwcyc7XG5cbmRlc2NyaWJlKCdkZXBzJywgKCkgPT4ge1xuICBkZXNjcmliZSgnZGVwZW5kZW5jeSBtZXRob2RzJywgKCkgPT4ge1xuICAgIHRlc3QoJ2NhbiBleHBsaWNpdGx5IGFkZCBhIGRlcGVuZGVuY3kgYmV0d2VlbiByZXNvdXJjZXMnLCAoKSA9PiB7XG4gICAgICBjb25zdCBhcHAgPSBuZXcgY29yZS5BcHAoKTtcbiAgICAgIGNvbnN0IHN0YWNrID0gbmV3IGNvcmUuU3RhY2soYXBwLCAnVGVzdFN0YWNrJyk7XG4gICAgICBjb25zdCByZXNvdXJjZTEgPSBuZXcgY29yZS5DZm5SZXNvdXJjZShzdGFjaywgJ1Jlc291cmNlMScsIHsgdHlwZTogJ1Rlc3Q6OlJlc291cmNlOjpGYWtlMScgfSk7XG4gICAgICBjb25zdCByZXNvdXJjZTIgPSBuZXcgY29yZS5DZm5SZXNvdXJjZShzdGFjaywgJ1Jlc291cmNlMicsIHsgdHlwZTogJ1Rlc3Q6OlJlc291cmNlOjpGYWtlMicgfSk7XG4gICAgICBhZGREZXBlbmRlbmN5KHJlc291cmNlMSwgcmVzb3VyY2UyKTtcblxuICAgICAgZXhwZWN0KGFwcC5zeW50aCgpLmdldFN0YWNrQnlOYW1lKHN0YWNrLnN0YWNrTmFtZSkudGVtcGxhdGUuUmVzb3VyY2VzKS50b0VxdWFsKHtcbiAgICAgICAgUmVzb3VyY2UxOiB7XG4gICAgICAgICAgVHlwZTogJ1Rlc3Q6OlJlc291cmNlOjpGYWtlMScsXG4gICAgICAgICAgRGVwZW5kc09uOiBbXG4gICAgICAgICAgICAnUmVzb3VyY2UyJyxcbiAgICAgICAgICBdLFxuICAgICAgICB9LFxuICAgICAgICBSZXNvdXJjZTI6IHtcbiAgICAgICAgICBUeXBlOiAnVGVzdDo6UmVzb3VyY2U6OkZha2UyJyxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgdGVzdCgnY2FuIGV4cGxpY2l0bHkgcmVtb3ZlIGEgZGVwZW5kZW5jeSBiZXR3ZWVuIHJlc291cmNlcycsICgpID0+IHtcbiAgICAgIGNvbnN0IGFwcCA9IG5ldyBjb3JlLkFwcCgpO1xuICAgICAgY29uc3Qgc3RhY2sgPSBuZXcgY29yZS5TdGFjayhhcHAsICdUZXN0U3RhY2snKTtcbiAgICAgIGNvbnN0IHJlc291cmNlMSA9IG5ldyBjb3JlLkNmblJlc291cmNlKHN0YWNrLCAnUmVzb3VyY2UxJywgeyB0eXBlOiAnVGVzdDo6UmVzb3VyY2U6OkZha2UxJyB9KTtcbiAgICAgIGNvbnN0IHJlc291cmNlMiA9IG5ldyBjb3JlLkNmblJlc291cmNlKHN0YWNrLCAnUmVzb3VyY2UyJywgeyB0eXBlOiAnVGVzdDo6UmVzb3VyY2U6OkZha2UyJyB9KTtcbiAgICAgIGFkZERlcGVuZGVuY3kocmVzb3VyY2UxLCByZXNvdXJjZTIpO1xuICAgICAgcmVtb3ZlRGVwZW5kZW5jeShyZXNvdXJjZTEsIHJlc291cmNlMik7XG5cbiAgICAgIGV4cGVjdChhcHAuc3ludGgoKS5nZXRTdGFja0J5TmFtZShzdGFjay5zdGFja05hbWUpLnRlbXBsYXRlLlJlc291cmNlcykudG9FcXVhbCh7XG4gICAgICAgIFJlc291cmNlMToge1xuICAgICAgICAgIFR5cGU6ICdUZXN0OjpSZXNvdXJjZTo6RmFrZTEnLFxuICAgICAgICB9LFxuICAgICAgICBSZXNvdXJjZTI6IHtcbiAgICAgICAgICBUeXBlOiAnVGVzdDo6UmVzb3VyY2U6OkZha2UyJyxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgdGVzdCgnY2FuIGV4cGxpY2l0bHkgYWRkLCBvYnRhaW4sIGFuZCByZW1vdmUgZGVwZW5kZW5jaWVzIGFjcm9zcyBzdGFja3MnLCAoKSA9PiB7XG4gICAgICBjb25zdCBhcHAgPSBuZXcgY29yZS5BcHAoKTtcbiAgICAgIGNvbnN0IHN0YWNrMSA9IG5ldyBjb3JlLlN0YWNrKGFwcCwgJ1Rlc3RTdGFjazEnKTtcbiAgICAgIC8vIFVzZSBhIHJlYWxseSBsb25nIGNvbnN0cnVjdCBpZCB0byBpZGVudGlmeSBpc3N1ZXMgYmV0d2VlbiBOYW1lcy51bmlxdWVJZCBhbmQgTmFtZXMudW5pcXVlUmVzb3VyY2VOYW1lXG4gICAgICBjb25zdCByZWFsbHlMb25nQ29uc3RydWN0SWQgPSAnQScucmVwZWF0KDI0Nyk7XG4gICAgICBjb25zdCBzdGFjazIgPSBuZXcgY29yZS5TdGFjayhhcHAsIHJlYWxseUxvbmdDb25zdHJ1Y3RJZCwgeyBzdGFja05hbWU6ICdUZXN0U3RhY2syJyB9KTtcbiAgICAgIC8vIFNhbml0eSBjaGVjayBzaW5jZSB0aGlzIHRlc3QgZGVwZW5kcyBvbiB0aGUgZGlzY3JlcGFuY3lcbiAgICAgIGV4cGVjdChOYW1lcy51bmlxdWVJZChzdGFjazIpKS5ub3QudG9CZShOYW1lcy51bmlxdWVSZXNvdXJjZU5hbWUoc3RhY2syLCB7fSkpO1xuICAgICAgY29uc3QgcmVzb3VyY2UxID0gbmV3IGNvcmUuQ2ZuUmVzb3VyY2Uoc3RhY2sxLCAnUmVzb3VyY2UxJywgeyB0eXBlOiAnVGVzdDo6UmVzb3VyY2U6OkZha2UxJyB9KTtcbiAgICAgIGNvbnN0IHJlc291cmNlMiA9IG5ldyBjb3JlLkNmblJlc291cmNlKHN0YWNrMiwgJ1Jlc291cmNlMicsIHsgdHlwZTogJ1Rlc3Q6OlJlc291cmNlOjpGYWtlMicgfSk7XG4gICAgICBjb25zdCByZXNvdXJjZTMgPSBuZXcgY29yZS5DZm5SZXNvdXJjZShzdGFjazEsICdSZXNvdXJjZTMnLCB7IHR5cGU6ICdUZXN0OjpSZXNvdXJjZTo6RmFrZTMnIH0pO1xuXG4gICAgICBhZGREZXBlbmRlbmN5KHJlc291cmNlMSwgcmVzb3VyY2UyKTtcbiAgICAgIC8vIEFkZGluZyB0aGUgc2FtZSByZXNvdXJjZSBkZXBlbmRlbmN5IHR3aWNlIHNob3VsZCBiZSBhIG5vLW9wXG4gICAgICBhZGREZXBlbmRlbmN5KHJlc291cmNlMSwgcmVzb3VyY2UyKTtcbiAgICAgIGFkZERlcGVuZGVuY3kocmVzb3VyY2UxLCByZXNvdXJjZTMpO1xuICAgICAgZXhwZWN0KHN0YWNrMS5kZXBlbmRlbmNpZXMubGVuZ3RoKS50b0VxdWFsKDEpO1xuICAgICAgZXhwZWN0KHN0YWNrMS5kZXBlbmRlbmNpZXNbMF0ubm9kZS5pZCkudG9FcXVhbChzdGFjazIubm9kZS5pZCk7XG4gICAgICAvLyBvYnRhaW5EZXBlbmRlbmNpZXMgc2hvdWxkIGFzc2VtYmxlIGFuZCBmbGF0dGVuIHJlc291cmNlLXRvLXJlc291cmNlIGRlcGVuZGVuY2llcyBldmVuIGFjcm9zcyBzdGFja3NcbiAgICAgIGV4cGVjdChvYnRhaW5EZXBlbmRlbmNpZXMocmVzb3VyY2UxKS5tYXAoeCA9PiB4Lm5vZGUucGF0aCkpLnRvRXF1YWwoW3Jlc291cmNlMy5ub2RlLnBhdGgsIHJlc291cmNlMi5ub2RlLnBhdGhdKTtcblxuICAgICAgcmVtb3ZlRGVwZW5kZW5jeShyZXNvdXJjZTEsIHJlc291cmNlMik7XG4gICAgICAvLyBGb3Igc3ltbWV0cnksIHJlbW92aW5nIGEgZGVwZW5kZW5jeSB0aGF0IGRvZXNuJ3QgZXhpc3Qgc2hvdWxkIGJlIGEgbm8tb3BcbiAgICAgIHJlbW92ZURlcGVuZGVuY3kocmVzb3VyY2UxLCByZXNvdXJjZTIpO1xuICAgICAgZXhwZWN0KHN0YWNrMS5kZXBlbmRlbmNpZXMubGVuZ3RoKS50b0VxdWFsKDApO1xuICAgIH0pO1xuXG4gICAgdGVzdCgnZG8gbm90aGluZyBpZiBzb3VyY2UgaXMgdGFyZ2V0JywgKCkgPT4ge1xuICAgICAgY29uc3QgYXBwID0gbmV3IGNvcmUuQXBwKCk7XG4gICAgICBjb25zdCBzdGFjayA9IG5ldyBjb3JlLlN0YWNrKGFwcCwgJ1Rlc3RTdGFjaycpO1xuICAgICAgY29uc3QgcmVzb3VyY2UxID0gbmV3IGNvcmUuQ2ZuUmVzb3VyY2Uoc3RhY2ssICdSZXNvdXJjZTEnLCB7IHR5cGU6ICdUZXN0OjpSZXNvdXJjZTo6RmFrZTEnIH0pO1xuICAgICAgYWRkRGVwZW5kZW5jeShyZXNvdXJjZTEsIHJlc291cmNlMSk7XG5cbiAgICAgIGV4cGVjdChhcHAuc3ludGgoKS5nZXRTdGFja0J5TmFtZShzdGFjay5zdGFja05hbWUpLnRlbXBsYXRlLlJlc291cmNlcykudG9FcXVhbCh7XG4gICAgICAgIFJlc291cmNlMToge1xuICAgICAgICAgIFR5cGU6ICdUZXN0OjpSZXNvdXJjZTo6RmFrZTEnLFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdoYW5kbGUgc291cmNlIGJlaW5nIGNvbW1vbiBzdGFjaycsICgpID0+IHtcbiAgICAgIGNvbnN0IGFwcCA9IG5ldyBjb3JlLkFwcCgpO1xuICAgICAgY29uc3Qgc3RhY2sxID0gbmV3IGNvcmUuU3RhY2soYXBwLCAnVGVzdFN0YWNrMScpO1xuICAgICAgY29uc3QgcmVzb3VyY2UxID0gbmV3IGNvcmUuQ2ZuUmVzb3VyY2Uoc3RhY2sxLCAnUmVzb3VyY2UxJywgeyB0eXBlOiAnVGVzdDo6UmVzb3VyY2U6OkZha2UxJyB9KTtcblxuICAgICAgLy8gSWYgc291cmNlIGlzIHRoZSBjb21tb24gc3RhY2ssIHRoaXMgc2hvdWxkIGJlIGEgbm9vcFxuICAgICAgYWRkRGVwZW5kZW5jeShzdGFjazEsIHJlc291cmNlMSk7XG4gICAgICBleHBlY3Qoc3RhY2sxLmRlcGVuZGVuY2llcy5sZW5ndGgpLnRvRXF1YWwoMCk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCd0aHJvd3MgZXJyb3IgaWYgdGFyZ2V0IGlzIGNvbW1vbiBzdGFjaycsICgpID0+IHtcbiAgICAgIGNvbnN0IGFwcCA9IG5ldyBjb3JlLkFwcCgpO1xuICAgICAgY29uc3Qgc3RhY2sxID0gbmV3IGNvcmUuU3RhY2soYXBwLCAnVGVzdFN0YWNrMScpO1xuICAgICAgY29uc3QgcmVzb3VyY2UxID0gbmV3IGNvcmUuQ2ZuUmVzb3VyY2Uoc3RhY2sxLCAnUmVzb3VyY2UxJywgeyB0eXBlOiAnVGVzdDo6UmVzb3VyY2U6OkZha2UxJyB9KTtcblxuICAgICAgZXhwZWN0KCgpID0+IHtcbiAgICAgICAgYWRkRGVwZW5kZW5jeShyZXNvdXJjZTEsIHN0YWNrMSk7XG4gICAgICB9KS50b1Rocm93KC9jYW5ub3QgZGVwZW5kIG9uIC8pO1xuICAgIH0pO1xuXG4gICAgdGVzdCgnY2FuIGV4cGxpY2l0bHkgYWRkLCBvYnRhaW4sIGFuZCByZW1vdmUgZGVwZW5kZW5jaWVzIGFjcm9zcyBuZXN0ZWQgc3RhY2tzJywgKCkgPT4ge1xuICAgICAgY29uc3QgYXBwID0gbmV3IGNvcmUuQXBwKCk7XG4gICAgICBjb25zdCBzdGFjazEgPSBuZXcgY29yZS5TdGFjayhhcHAsICdUZXN0U3RhY2sxJyk7XG4gICAgICBjb25zdCBjb25zdHJ1Y3QxID0gbmV3IENvbnN0cnVjdChzdGFjazEsICdDb21tb25Db25zdHJ1Y3QnKTtcbiAgICAgIC8vIFVzZSBhIHJlYWxseSBsb25nIGNvbnN0cnVjdCBpZCB0byBpZGVudGlmeSBpc3N1ZXMgYmV0d2VlbiBOYW1lcy51bmlxdWVJZCBhbmQgTmFtZXMudW5pcXVlUmVzb3VyY2VOYW1lXG4gICAgICBjb25zdCBuZXN0ZWRTdGFjazEgPSBuZXcgY29yZS5TdGFjayhjb25zdHJ1Y3QxLCAnVGVzdE5lc3RlZFN0YWNrMScpO1xuICAgICAgY29uc3QgbmVzdGVkU3RhY2syID0gbmV3IGNvcmUuU3RhY2soY29uc3RydWN0MSwgJ1Rlc3ROZXN0ZWRTdGFjazInKTtcbiAgICAgIGNvbnN0IHJlc291cmNlMSA9IG5ldyBjb3JlLkNmblJlc291cmNlKG5lc3RlZFN0YWNrMSwgJ1Jlc291cmNlMScsIHsgdHlwZTogJ1Rlc3Q6OlJlc291cmNlOjpGYWtlMScgfSk7XG4gICAgICBjb25zdCByZXNvdXJjZTIgPSBuZXcgY29yZS5DZm5SZXNvdXJjZShuZXN0ZWRTdGFjazIsICdSZXNvdXJjZTInLCB7IHR5cGU6ICdUZXN0OjpSZXNvdXJjZTo6RmFrZTInIH0pO1xuXG4gICAgICBhZGREZXBlbmRlbmN5KHJlc291cmNlMSwgcmVzb3VyY2UyKTtcbiAgICAgIC8vIEFkZGluZyB0aGUgc2FtZSByZXNvdXJjZSBkZXBlbmRlbmN5IHR3aWNlIHNob3VsZCBiZSBhIG5vLW9wXG4gICAgICBhZGREZXBlbmRlbmN5KHJlc291cmNlMSwgcmVzb3VyY2UyKTtcbiAgICAgIGV4cGVjdChuZXN0ZWRTdGFjazEuZGVwZW5kZW5jaWVzLmxlbmd0aCkudG9FcXVhbCgxKTtcbiAgICAgIGV4cGVjdChuZXN0ZWRTdGFjazEuZGVwZW5kZW5jaWVzWzBdLm5vZGUuaWQpLnRvRXF1YWwobmVzdGVkU3RhY2syLm5vZGUuaWQpO1xuXG4gICAgICByZW1vdmVEZXBlbmRlbmN5KHJlc291cmNlMSwgcmVzb3VyY2UyKTtcbiAgICAgIC8vIEZvciBzeW1tZXRyeSwgcmVtb3ZpbmcgYSBkZXBlbmRlbmN5IHRoYXQgZG9lc24ndCBleGlzdCBzaG91bGQgYmUgYSBuby1vcFxuICAgICAgcmVtb3ZlRGVwZW5kZW5jeShyZXNvdXJjZTEsIHJlc291cmNlMik7XG4gICAgICBleHBlY3Qoc3RhY2sxLmRlcGVuZGVuY2llcy5sZW5ndGgpLnRvRXF1YWwoMCk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXX0=