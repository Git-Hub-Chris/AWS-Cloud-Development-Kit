"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const cxapi = require("@aws-cdk/cx-api");
const constructs_1 = require("constructs");
const util_1 = require("./util");
const lib_1 = require("../lib");
/**
 * These tests are executed once (for specific ID schemes)
 */
describe('logical id', () => {
    test('if the naming scheme uniquifies with a hash we can have the same concatenated identifier', () => {
        // GIVEN
        const stack = new lib_1.Stack(undefined, 'TestStack');
        const A = new constructs_1.Construct(stack, 'A');
        new lib_1.CfnResource(A, 'BC', { type: 'Resource' });
        // WHEN
        const AB = new constructs_1.Construct(stack, 'AB');
        new lib_1.CfnResource(AB, 'C', { type: 'Resource' });
        // THEN: no exception
    });
    test('special case: if the resource is top-level, a hash is not added', () => {
        // GIVEN
        const stack = new lib_1.Stack(undefined, 'TestStack');
        // WHEN
        const r = new lib_1.CfnResource(stack, 'MyAwesomeness', { type: 'Resource' });
        const r2 = new lib_1.CfnResource(stack, 'x'.repeat(255), { type: 'Resource' }); // max length
        const r3 = new lib_1.CfnResource(stack, '*y-'.repeat(255), { type: 'Resource' }); // non-alpha are filtered out (yes, I know it might conflict)
        // THEN
        expect(stack.resolve(r.logicalId)).toEqual('MyAwesomeness');
        expect(stack.resolve(r2.logicalId)).toEqual('x'.repeat(255));
        expect(stack.resolve(r3.logicalId)).toEqual('y'.repeat(255));
    });
    test('if resource is top-level and logical id is longer than allowed, it is trimmed with a hash', () => {
        // GIVEN
        const stack = new lib_1.Stack(undefined, 'TestStack');
        // WHEN
        const r = new lib_1.CfnResource(stack, 'x'.repeat(256), { type: 'Resource' });
        // THEN
        expect(stack.resolve(r.logicalId)).toEqual('x'.repeat(240) + 'C7A139A2');
    });
    test('Logical IDs can be renamed at the stack level', () => {
        // GIVEN
        const stack = new lib_1.Stack();
        // WHEN
        const parent = new constructs_1.Construct(stack, 'Parent');
        new lib_1.CfnResource(parent, 'ThingResource', { type: 'AWS::TAAS::Thing' });
        stack.renameLogicalId('ParentThingResource75D1D9CB', 'Renamed');
        // THEN
        const template = util_1.toCloudFormation(stack);
        expect('Renamed' in template.Resources).toEqual(true);
    });
    test('Renames for objects that don\'t exist fail', () => {
        // GIVEN
        const stack = new lib_1.Stack();
        new constructs_1.Construct(stack, 'Parent');
        // WHEN
        stack.renameLogicalId('DOESNOTEXIST', 'Renamed');
        // THEN
        expect(() => util_1.toCloudFormation(stack)).toThrow();
    });
    test('ID Renames that collide with existing IDs should fail', () => {
        // GIVEN
        const stack = new lib_1.Stack();
        stack.renameLogicalId('ParentThingResource1916E7808', 'ParentThingResource2F19948CB');
        // WHEN
        const parent = new constructs_1.Construct(stack, 'Parent');
        new lib_1.CfnResource(parent, 'ThingResource1', { type: 'AWS::TAAS::Thing' });
        new lib_1.CfnResource(parent, 'ThingResource2', { type: 'AWS::TAAS::Thing' });
        // THEN
        expect(() => util_1.toCloudFormation(stack)).toThrow(/Two objects have been assigned the same Logical ID/);
    });
    test('hashed naming scheme filters constructs named "Resource" from the human portion', () => {
        // GIVEN
        const stack = new lib_1.Stack();
        // WHEN
        const parent = new constructs_1.Construct(stack, 'Parent');
        const child1 = new constructs_1.Construct(parent, 'Child');
        const child2 = new constructs_1.Construct(child1, 'Resource');
        new lib_1.CfnResource(child2, 'HeyThere', { type: 'AWS::TAAS::Thing' });
        // THEN
        const template = util_1.toCloudFormation(stack);
        expect(template).toEqual({
            Resources: {
                ParentChildHeyThere35220347: {
                    Type: 'AWS::TAAS::Thing',
                },
            },
        });
    });
    test('can transparently wrap constructs using "Default" id', () => {
        // GIVEN
        const stack1 = new lib_1.Stack();
        const parent1 = new constructs_1.Construct(stack1, 'Parent');
        new lib_1.CfnResource(parent1, 'HeyThere', { type: 'AWS::TAAS::Thing' });
        const template1 = util_1.toCloudFormation(stack1);
        // AND
        const theId1 = Object.keys(template1.Resources)[0];
        expect('AWS::TAAS::Thing').toEqual(template1.Resources[theId1].Type);
        // WHEN
        const stack2 = new lib_1.Stack();
        const parent2 = new constructs_1.Construct(stack2, 'Parent');
        const invisibleWrapper = new constructs_1.Construct(parent2, 'Default');
        new lib_1.CfnResource(invisibleWrapper, 'HeyThere', { type: 'AWS::TAAS::Thing' });
        const template2 = util_1.toCloudFormation(stack1);
        const theId2 = Object.keys(template2.Resources)[0];
        expect('AWS::TAAS::Thing').toEqual(template2.Resources[theId2].Type);
        // THEN: same ID, same object
        expect(theId1).toEqual(theId2);
    });
    test('non-alphanumeric characters are removed from the human part of the logical ID', () => {
        const val1 = logicalForElementInPath(['Foo-bar', 'B00m', 'Hello_World', '&&Horray Horray.']);
        const val2 = logicalForElementInPath(['Foobar', 'B00m', 'HelloWorld', 'HorrayHorray']);
        // same human part, different hash
        expect(val1).toEqual('FoobarB00mHelloWorldHorrayHorray640E99FB');
        expect(val2).toEqual('FoobarB00mHelloWorldHorrayHorray744334FD');
    });
    test('non-alphanumeric characters are removed even if the ID has only one component', () => {
        const val1 = logicalForElementInPath(['Foo-bar']);
        // same human part, different hash
        expect(val1).toEqual('Foobar');
    });
    test('empty identifiers are not allowed', () => {
        // GIVEN
        const stack = new lib_1.Stack();
        // WHEN
        new lib_1.CfnResource(stack, '.', { type: 'R' });
        // THEN
        expect(() => util_1.toCloudFormation(stack)).toThrow(/Logical ID must adhere to the regular expression/);
    });
    test('too large identifiers are truncated yet still remain unique', () => {
        // GIVEN
        const stack = new lib_1.Stack();
        const A = new constructs_1.Construct(stack, generateString(100));
        const B = new constructs_1.Construct(A, generateString(100));
        // WHEN
        const firstPart = generateString(60);
        // The shared part has now exceeded the maximum length of CloudFormation identifiers
        // so the identity generator will have to something smart
        const C1 = new lib_1.CfnResource(B, firstPart + generateString(40), { type: 'Resource' });
        const C2 = new lib_1.CfnResource(B, firstPart + generateString(40), { type: 'Resource' });
        // THEN
        expect(C1.logicalId.length).toBeLessThanOrEqual(255);
        expect(C2.logicalId.length).toBeLessThanOrEqual(255);
        expect(C1).not.toEqual(C2);
    });
    test('Refs and dependencies will correctly reflect renames done at the stack level', () => {
        // GIVEN
        const stack = new lib_1.Stack();
        stack.renameLogicalId('OriginalName', 'NewName');
        // WHEN
        const c1 = new lib_1.CfnResource(stack, 'OriginalName', { type: 'R1' });
        const ref = c1.ref;
        const c2 = new lib_1.CfnResource(stack, 'Construct2', { type: 'R2', properties: { ReferenceToR1: ref } });
        c2.node.addDependency(c1);
        // THEN
        expect(util_1.toCloudFormation(stack)).toEqual({
            Resources: {
                NewName: { Type: 'R1' },
                Construct2: {
                    Type: 'R2',
                    Properties: { ReferenceToR1: { Ref: 'NewName' } },
                    DependsOn: ['NewName'],
                },
            },
        });
    });
    test('customize logical id allocation behavior by overriding `Stack.allocateLogicalId`', () => {
        class MyStack extends lib_1.Stack {
            allocateLogicalId(element) {
                if (element.node.id === 'A') {
                    return 'LogicalIdOfA';
                }
                if (element.node.id === 'B') {
                    return 'LogicalIdOfB';
                }
                throw new Error('Invalid element ID');
            }
        }
        const app = new lib_1.App({
            context: {
                [cxapi.NEW_STYLE_STACK_SYNTHESIS_CONTEXT]: false,
            },
        });
        const stack = new MyStack(app);
        new lib_1.CfnResource(stack, 'A', { type: 'Type::Of::A' });
        const group = new constructs_1.Construct(stack, 'Group');
        new lib_1.CfnResource(group, 'B', { type: 'Type::Of::B' });
        // renames can also be applied on custom logical IDs.
        stack.renameLogicalId('LogicalIdOfB', 'BoomBoomB');
        const c = new lib_1.CfnResource(stack, 'B', { type: 'Type::Of::C' });
        c.overrideLogicalId('TheC');
        expect(util_1.toCloudFormation(stack)).toEqual({
            Resources: {
                LogicalIdOfA: { Type: 'Type::Of::A' },
                BoomBoomB: { Type: 'Type::Of::B' },
                TheC: { Type: 'Type::Of::C' },
            },
        });
    });
    test('detects duplicate logical IDs in the same Stack caused by overrideLogicalId', () => {
        const stack = new lib_1.Stack();
        const resource1 = new lib_1.CfnResource(stack, 'A', { type: 'Type::Of::A' });
        const resource2 = new lib_1.CfnResource(stack, 'B', { type: 'Type::Of::B' });
        resource1.overrideLogicalId('C');
        resource2.overrideLogicalId('C');
        expect(() => {
            util_1.toCloudFormation(stack);
        }).toThrow(/section 'Resources' already contains 'C'/);
    });
});
function generateString(chars) {
    let s = '';
    for (let i = 0; i < chars; ++i) {
        s += randomAlpha();
    }
    return s;
    function randomAlpha() {
        return String.fromCharCode('a'.charCodeAt(0) + Math.floor(Math.random() * 26));
    }
}
function logicalForElementInPath(constructPath) {
    const stack = new lib_1.Stack();
    let scope = stack;
    for (const component of constructPath) {
        scope = new lib_1.CfnResource(scope, component, { type: 'Foo' });
    }
    return stack.resolve(scope.logicalId);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9naWNhbC1pZC50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibG9naWNhbC1pZC50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEseUNBQXlDO0FBQ3pDLDJDQUF1QztBQUN2QyxpQ0FBMEM7QUFDMUMsZ0NBQTZEO0FBRTdEOztHQUVHO0FBQ0gsUUFBUSxDQUFDLFlBQVksRUFBRSxHQUFHLEVBQUU7SUFDMUIsSUFBSSxDQUFDLDBGQUEwRixFQUFFLEdBQUcsRUFBRTtRQUNwRyxRQUFRO1FBQ1IsTUFBTSxLQUFLLEdBQUcsSUFBSSxXQUFLLENBQUMsU0FBUyxFQUFFLFdBQVcsQ0FBQyxDQUFDO1FBRWhELE1BQU0sQ0FBQyxHQUFHLElBQUksc0JBQVMsQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDcEMsSUFBSSxpQkFBVyxDQUFDLENBQUMsRUFBRSxJQUFJLEVBQUUsRUFBRSxJQUFJLEVBQUUsVUFBVSxFQUFFLENBQUMsQ0FBQztRQUUvQyxPQUFPO1FBQ1AsTUFBTSxFQUFFLEdBQUcsSUFBSSxzQkFBUyxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztRQUN0QyxJQUFJLGlCQUFXLENBQUMsRUFBRSxFQUFFLEdBQUcsRUFBRSxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsQ0FBQyxDQUFDO1FBRS9DLHFCQUFxQjtJQUN2QixDQUFDLENBQUMsQ0FBQztJQUVILElBQUksQ0FBQyxpRUFBaUUsRUFBRSxHQUFHLEVBQUU7UUFDM0UsUUFBUTtRQUNSLE1BQU0sS0FBSyxHQUFHLElBQUksV0FBSyxDQUFDLFNBQVMsRUFBRSxXQUFXLENBQUMsQ0FBQztRQUVoRCxPQUFPO1FBQ1AsTUFBTSxDQUFDLEdBQUcsSUFBSSxpQkFBVyxDQUFDLEtBQUssRUFBRSxlQUFlLEVBQUUsRUFBRSxJQUFJLEVBQUUsVUFBVSxFQUFFLENBQUMsQ0FBQztRQUN4RSxNQUFNLEVBQUUsR0FBRyxJQUFJLGlCQUFXLENBQUMsS0FBSyxFQUFF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QyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDakYsQ0FBQztBQUNILENBQUM7QUFFRCxTQUFTLHVCQUF1QixDQUFDLGFBQXVCO0lBQ3RELE1BQU0sS0FBSyxHQUFHLElBQUksV0FBSyxFQUFFLENBQUM7SUFDMUIsSUFBSSxLQUFLLEdBQWMsS0FBSyxDQUFDO0lBQzdCLEtBQUssTUFBTSxTQUFTLElBQUksYUFBYSxFQUFFO1FBQ3JDLEtBQUssR0FBRyxJQUFJLGlCQUFXLENBQUMsS0FBSyxFQUFFLFNBQVMsRUFBRSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO0tBQzVEO0lBRUQsT0FBTyxLQUFLLENBQUMsT0FBTyxDQUFFLEtBQXFCLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDekQsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGN4YXBpIGZyb20gJ0Bhd3MtY2RrL2N4LWFwaSc7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7IHRvQ2xvdWRGb3JtYXRpb24gfSBmcm9tICcuL3V0aWwnO1xuaW1wb3J0IHsgQXBwLCBDZm5FbGVtZW50LCBDZm5SZXNvdXJjZSwgU3RhY2sgfSBmcm9tICcuLi9saWInO1xuXG4vKipcbiAqIFRoZXNlIHRlc3RzIGFyZSBleGVjdXRlZCBvbmNlIChmb3Igc3BlY2lmaWMgSUQgc2NoZW1lcylcbiAqL1xuZGVzY3JpYmUoJ2xvZ2ljYWwgaWQnLCAoKSA9PiB7XG4gIHRlc3QoJ2lmIHRoZSBuYW1pbmcgc2NoZW1lIHVuaXF1aWZpZXMgd2l0aCBhIGhhc2ggd2UgY2FuIGhhdmUgdGhlIHNhbWUgY29uY2F0ZW5hdGVkIGlkZW50aWZpZXInLCAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBzdGFjayA9IG5ldyBTdGFjayh1bmRlZmluZWQsICdUZXN0U3RhY2snKTtcblxuICAgIGNvbnN0IEEgPSBuZXcgQ29uc3RydWN0KHN0YWNrLCAnQScpO1xuICAgIG5ldyBDZm5SZXNvdXJjZShBLCAnQkMnLCB7IHR5cGU6ICdSZXNvdXJjZScgfSk7XG5cbiAgICAvLyBXSEVOXG4gICAgY29uc3QgQUIgPSBuZXcgQ29uc3RydWN0KHN0YWNrLCAnQUInKTtcbiAgICBuZXcgQ2ZuUmVzb3VyY2UoQUIsICdDJywgeyB0eXBlOiAnUmVzb3VyY2UnIH0pO1xuXG4gICAgLy8gVEhFTjogbm8gZXhjZXB0aW9uXG4gIH0pO1xuXG4gIHRlc3QoJ3NwZWNpYWwgY2FzZTogaWYgdGhlIHJlc291cmNlIGlzIHRvcC1sZXZlbCwgYSBoYXNoIGlzIG5vdCBhZGRlZCcsICgpID0+IHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKHVuZGVmaW5lZCwgJ1Rlc3RTdGFjaycpO1xuXG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IHIgPSBuZXcgQ2ZuUmVzb3VyY2Uoc3RhY2ssICdNeUF3ZXNvbWVuZXNzJywgeyB0eXBlOiAnUmVzb3VyY2UnIH0pO1xuICAgIGNvbnN0IHIyID0gbmV3IENmblJlc291cmNlKHN0YWNrLCAneCcucmVwZWF0KDI1NSksIHsgdHlwZTogJ1Jlc291cmNlJyB9KTsgLy8gbWF4IGxlbmd0aFxuICAgIGNvbnN0IHIzID0gbmV3IENmblJlc291cmNlKHN0YWNrLCAnKnktJy5yZXBlYXQoMjU1KSwgeyB0eXBlOiAnUmVzb3VyY2UnIH0pOyAvLyBub24tYWxwaGEgYXJlIGZpbHRlcmVkIG91dCAoeWVzLCBJIGtub3cgaXQgbWlnaHQgY29uZmxpY3QpXG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0KHN0YWNrLnJlc29sdmUoci5sb2dpY2FsSWQpKS50b0VxdWFsKCdNeUF3ZXNvbWVuZXNzJyk7XG4gICAgZXhwZWN0KHN0YWNrLnJlc29sdmUocjIubG9naWNhbElkKSkudG9FcXVhbCgneCcucmVwZWF0KDI1NSkpO1xuICAgIGV4cGVjdChzdGFjay5yZXNvbHZlKHIzLmxvZ2ljYWxJZCkpLnRvRXF1YWwoJ3knLnJlcGVhdCgyNTUpKTtcbiAgfSk7XG5cbiAgdGVzdCgnaWYgcmVzb3VyY2UgaXMgdG9wLWxldmVsIGFuZCBsb2dpY2FsIGlkIGlzIGxvbmdlciB0aGFuIGFsbG93ZWQsIGl0IGlzIHRyaW1tZWQgd2l0aCBhIGhhc2gnLCAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBzdGFjayA9IG5ldyBTdGFjayh1bmRlZmluZWQsICdUZXN0U3RhY2snKTtcblxuICAgIC8vIFdIRU5cbiAgICBjb25zdCByID0gbmV3IENmblJlc291cmNlKHN0YWNrLCAneCcucmVwZWF0KDI1NiksIHsgdHlwZTogJ1Jlc291cmNlJyB9KTtcblxuICAgIC8vIFRIRU5cbiAgICBleHBlY3Qoc3RhY2sucmVzb2x2ZShyLmxvZ2ljYWxJZCkpLnRvRXF1YWwoJ3gnLnJlcGVhdCgyNDApICsgJ0M3QTEzOUEyJyk7XG4gIH0pO1xuXG4gIHRlc3QoJ0xvZ2ljYWwgSURzIGNhbiBiZSByZW5hbWVkIGF0IHRoZSBzdGFjayBsZXZlbCcsICgpID0+IHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKCk7XG5cbiAgICAvLyBXSEVOXG4gICAgY29uc3QgcGFyZW50ID0gbmV3IENvbnN0cnVjdChzdGFjaywgJ1BhcmVudCcpO1xuICAgIG5ldyBDZm5SZXNvdXJjZShwYXJlbnQsICdUaGluZ1Jlc291cmNlJywgeyB0eXBlOiAnQVdTOjpUQUFTOjpUaGluZycgfSk7XG4gICAgc3RhY2sucmVuYW1lTG9naWNhbElkKCdQYXJlbnRUaGluZ1Jlc291cmNlNzVEMUQ5Q0InLCAnUmVuYW1lZCcpO1xuXG4gICAgLy8gVEhFTlxuICAgIGNvbnN0IHRlbXBsYXRlID0gdG9DbG91ZEZvcm1hdGlvbihzdGFjayk7XG4gICAgZXhwZWN0KCdSZW5hbWVkJyBpbiB0ZW1wbGF0ZS5SZXNvdXJjZXMpLnRvRXF1YWwodHJ1ZSk7XG4gIH0pO1xuXG4gIHRlc3QoJ1JlbmFtZXMgZm9yIG9iamVjdHMgdGhhdCBkb25cXCd0IGV4aXN0IGZhaWwnLCAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBzdGFjayA9IG5ldyBTdGFjaygpO1xuICAgIG5ldyBDb25zdHJ1Y3Qoc3RhY2ssICdQYXJlbnQnKTtcblxuICAgIC8vIFdIRU5cbiAgICBzdGFjay5yZW5hbWVMb2dpY2FsSWQoJ0RPRVNOT1RFWElTVCcsICdSZW5hbWVkJyk7XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0KCgpID0+IHRvQ2xvdWRGb3JtYXRpb24oc3RhY2spKS50b1Rocm93KCk7XG4gIH0pO1xuXG4gIHRlc3QoJ0lEIFJlbmFtZXMgdGhhdCBjb2xsaWRlIHdpdGggZXhpc3RpbmcgSURzIHNob3VsZCBmYWlsJywgKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soKTtcbiAgICBzdGFjay5yZW5hbWVMb2dpY2FsSWQoJ1BhcmVudFRoaW5nUmVzb3VyY2UxOTE2RTc4MDgnLCAnUGFyZW50VGhpbmdSZXNvdXJjZTJGMTk5NDhDQicpO1xuXG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IHBhcmVudCA9IG5ldyBDb25zdHJ1Y3Qoc3RhY2ssICdQYXJlbnQnKTtcbiAgICBuZXcgQ2ZuUmVzb3VyY2UocGFyZW50LCAnVGhpbmdSZXNvdXJjZTEnLCB7IHR5cGU6ICdBV1M6OlRBQVM6OlRoaW5nJyB9KTtcbiAgICBuZXcgQ2ZuUmVzb3VyY2UocGFyZW50LCAnVGhpbmdSZXNvdXJjZTInLCB7IHR5cGU6ICdBV1M6OlRBQVM6OlRoaW5nJyB9KTtcblxuICAgIC8vIFRIRU5cbiAgICBleHBlY3QoKCkgPT4gdG9DbG91ZEZvcm1hdGlvbihzdGFjaykpLnRvVGhyb3coL1R3byBvYmplY3RzIGhhdmUgYmVlbiBhc3NpZ25lZCB0aGUgc2FtZSBMb2dpY2FsIElELyk7XG4gIH0pO1xuXG4gIHRlc3QoJ2hhc2hlZCBuYW1pbmcgc2NoZW1lIGZpbHRlcnMgY29uc3RydWN0cyBuYW1lZCBcIlJlc291cmNlXCIgZnJvbSB0aGUgaHVtYW4gcG9ydGlvbicsICgpID0+IHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKCk7XG5cbiAgICAvLyBXSEVOXG4gICAgY29uc3QgcGFyZW50ID0gbmV3IENvbnN0cnVjdChzdGFjaywgJ1BhcmVudCcpO1xuICAgIGNvbnN0IGNoaWxkMSA9IG5ldyBDb25zdHJ1Y3QocGFyZW50LCAnQ2hpbGQnKTtcbiAgICBjb25zdCBjaGlsZDIgPSBuZXcgQ29uc3RydWN0KGNoaWxkMSwgJ1Jlc291cmNlJyk7XG5cbiAgICBuZXcgQ2ZuUmVzb3VyY2UoY2hpbGQyLCAnSGV5VGhlcmUnLCB7IHR5cGU6ICdBV1M6OlRBQVM6OlRoaW5nJyB9KTtcblxuICAgIC8vIFRIRU5cbiAgICBjb25zdCB0ZW1wbGF0ZSA9IHRvQ2xvdWRGb3JtYXRpb24oc3RhY2spO1xuICAgIGV4cGVjdCh0ZW1wbGF0ZSkudG9FcXVhbCh7XG4gICAgICBSZXNvdXJjZXM6IHtcbiAgICAgICAgUGFyZW50Q2hpbGRIZXlUaGVyZTM1MjIwMzQ3OiB7XG4gICAgICAgICAgVHlwZTogJ0FXUzo6VEFBUzo6VGhpbmcnLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnY2FuIHRyYW5zcGFyZW50bHkgd3JhcCBjb25zdHJ1Y3RzIHVzaW5nIFwiRGVmYXVsdFwiIGlkJywgKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2sxID0gbmV3IFN0YWNrKCk7XG4gICAgY29uc3QgcGFyZW50MSA9IG5ldyBDb25zdHJ1Y3Qoc3RhY2sxLCAnUGFyZW50Jyk7XG4gICAgbmV3IENmblJlc291cmNlKHBhcmVudDEsICdIZXlUaGVyZScsIHsgdHlwZTogJ0FXUzo6VEFBUzo6VGhpbmcnIH0pO1xuICAgIGNvbnN0IHRlbXBsYXRlMSA9IHRvQ2xvdWRGb3JtYXRpb24oc3RhY2sxKTtcblxuICAgIC8vIEFORFxuICAgIGNvbnN0IHRoZUlkMSA9IE9iamVjdC5rZXlzKHRlbXBsYXRlMS5SZXNvdXJjZXMpWzBdO1xuICAgIGV4cGVjdCgnQVdTOjpUQUFTOjpUaGluZycpLnRvRXF1YWwodGVtcGxhdGUxLlJlc291cmNlc1t0aGVJZDFdLlR5cGUpO1xuXG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IHN0YWNrMiA9IG5ldyBTdGFjaygpO1xuICAgIGNvbnN0IHBhcmVudDIgPSBuZXcgQ29uc3RydWN0KHN0YWNrMiwgJ1BhcmVudCcpO1xuICAgIGNvbnN0IGludmlzaWJsZVdyYXBwZXIgPSBuZXcgQ29uc3RydWN0KHBhcmVudDIsICdEZWZhdWx0Jyk7XG4gICAgbmV3IENmblJlc291cmNlKGludmlzaWJsZVdyYXBwZXIsICdIZXlUaGVyZScsIHsgdHlwZTogJ0FXUzo6VEFBUzo6VGhpbmcnIH0pO1xuICAgIGNvbnN0IHRlbXBsYXRlMiA9IHRvQ2xvdWRGb3JtYXRpb24oc3RhY2sxKTtcblxuICAgIGNvbnN0IHRoZUlkMiA9IE9iamVjdC5rZXlzKHRlbXBsYXRlMi5SZXNvdXJjZXMpWzBdO1xuICAgIGV4cGVjdCgnQVdTOjpUQUFTOjpUaGluZycpLnRvRXF1YWwodGVtcGxhdGUyLlJlc291cmNlc1t0aGVJZDJdLlR5cGUpO1xuXG4gICAgLy8gVEhFTjogc2FtZSBJRCwgc2FtZSBvYmplY3RcbiAgICBleHBlY3QodGhlSWQxKS50b0VxdWFsKHRoZUlkMik7XG4gIH0pO1xuXG4gIHRlc3QoJ25vbi1hbHBoYW51bWVyaWMgY2hhcmFjdGVycyBhcmUgcmVtb3ZlZCBmcm9tIHRoZSBodW1hbiBwYXJ0IG9mIHRoZSBsb2dpY2FsIElEJywgKCkgPT4ge1xuICAgIGNvbnN0IHZhbDEgPSBsb2dpY2FsRm9yRWxlbWVudEluUGF0aChbJ0Zvby1iYXInLCAnQjAwbScsICdIZWxsb19Xb3JsZCcsICcmJkhvcnJheSBIb3JyYXkuJ10pO1xuICAgIGNvbnN0IHZhbDIgPSBsb2dpY2FsRm9yRWxlbWVudEluUGF0aChbJ0Zvb2JhcicsICdCMDBtJywgJ0hlbGxvV29ybGQnLCAnSG9ycmF5SG9ycmF5J10pO1xuXG4gICAgLy8gc2FtZSBodW1hbiBwYXJ0LCBkaWZmZXJlbnQgaGFzaFxuICAgIGV4cGVjdCh2YWwxKS50b0VxdWFsKCdGb29iYXJCMDBtSGVsbG9Xb3JsZEhvcnJheUhvcnJheTY0MEU5OUZCJyk7XG4gICAgZXhwZWN0KHZhbDIpLnRvRXF1YWwoJ0Zvb2JhckIwMG1IZWxsb1dvcmxkSG9ycmF5SG9ycmF5NzQ0MzM0RkQnKTtcbiAgfSk7XG5cbiAgdGVzdCgnbm9uLWFscGhhbnVtZXJpYyBjaGFyYWN0ZXJzIGFyZSByZW1vdmVkIGV2ZW4gaWYgdGhlIElEIGhhcyBvbmx5IG9uZSBjb21wb25lbnQnLCAoKSA9PiB7XG4gICAgY29uc3QgdmFsMSA9IGxvZ2ljYWxGb3JFbGVtZW50SW5QYXRoKFsnRm9vLWJhciddKTtcblxuICAgIC8vIHNhbWUgaHVtYW4gcGFydCwgZGlmZmVyZW50IGhhc2hcbiAgICBleHBlY3QodmFsMSkudG9FcXVhbCgnRm9vYmFyJyk7XG4gIH0pO1xuXG4gIHRlc3QoJ2VtcHR5IGlkZW50aWZpZXJzIGFyZSBub3QgYWxsb3dlZCcsICgpID0+IHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKCk7XG5cbiAgICAvLyBXSEVOXG4gICAgbmV3IENmblJlc291cmNlKHN0YWNrLCAnLicsIHsgdHlwZTogJ1InIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIGV4cGVjdCgoKSA9PiB0b0Nsb3VkRm9ybWF0aW9uKHN0YWNrKSkudG9UaHJvdygvTG9naWNhbCBJRCBtdXN0IGFkaGVyZSB0byB0aGUgcmVndWxhciBleHByZXNzaW9uLyk7XG4gIH0pO1xuXG4gIHRlc3QoJ3RvbyBsYXJnZSBpZGVudGlmaWVycyBhcmUgdHJ1bmNhdGVkIHlldCBzdGlsbCByZW1haW4gdW5pcXVlJywgKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soKTtcbiAgICBjb25zdCBBID0gbmV3IENvbnN0cnVjdChzdGFjaywgZ2VuZXJhdGVTdHJpbmcoMTAwKSk7XG4gICAgY29uc3QgQiA9IG5ldyBDb25zdHJ1Y3QoQSwgZ2VuZXJhdGVTdHJpbmcoMTAwKSk7XG5cbiAgICAvLyBXSEVOXG4gICAgY29uc3QgZmlyc3RQYXJ0ID0gZ2VuZXJhdGVTdHJpbmcoNjApO1xuICAgIC8vIFRoZSBzaGFyZWQgcGFydCBoYXMgbm93IGV4Y2VlZGVkIHRoZSBtYXhpbXVtIGxlbmd0aCBvZiBDbG91ZEZvcm1hdGlvbiBpZGVudGlmaWVyc1xuICAgIC8vIHNvIHRoZSBpZGVudGl0eSBnZW5lcmF0b3Igd2lsbCBoYXZlIHRvIHNvbWV0aGluZyBzbWFydFxuXG4gICAgY29uc3QgQzEgPSBuZXcgQ2ZuUmVzb3VyY2UoQiwgZmlyc3RQYXJ0ICsgZ2VuZXJhdGVTdHJpbmcoNDApLCB7IHR5cGU6ICdSZXNvdXJjZScgfSk7XG4gICAgY29uc3QgQzIgPSBuZXcgQ2ZuUmVzb3VyY2UoQiwgZmlyc3RQYXJ0ICsgZ2VuZXJhdGVTdHJpbmcoNDApLCB7IHR5cGU6ICdSZXNvdXJjZScgfSk7XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0KEMxLmxvZ2ljYWxJZC5sZW5ndGgpLnRvQmVMZXNzVGhhbk9yRXF1YWwoMjU1KTtcbiAgICBleHBlY3QoQzIubG9naWNhbElkLmxlbmd0aCkudG9CZUxlc3NUaGFuT3JFcXVhbCgyNTUpO1xuICAgIGV4cGVjdChDMSkubm90LnRvRXF1YWwoQzIpO1xuICB9KTtcblxuICB0ZXN0KCdSZWZzIGFuZCBkZXBlbmRlbmNpZXMgd2lsbCBjb3JyZWN0bHkgcmVmbGVjdCByZW5hbWVzIGRvbmUgYXQgdGhlIHN0YWNrIGxldmVsJywgKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soKTtcbiAgICBzdGFjay5yZW5hbWVMb2dpY2FsSWQoJ09yaWdpbmFsTmFtZScsICdOZXdOYW1lJyk7XG5cbiAgICAvLyBXSEVOXG4gICAgY29uc3QgYzEgPSBuZXcgQ2ZuUmVzb3VyY2Uoc3RhY2ssICdPcmlnaW5hbE5hbWUnLCB7IHR5cGU6ICdSMScgfSk7XG4gICAgY29uc3QgcmVmID0gYzEucmVmO1xuXG4gICAgY29uc3QgYzIgPSBuZXcgQ2ZuUmVzb3VyY2Uoc3RhY2ssICdDb25zdHJ1Y3QyJywgeyB0eXBlOiAnUjInLCBwcm9wZXJ0aWVzOiB7IFJlZmVyZW5jZVRvUjE6IHJlZiB9IH0pO1xuICAgIGMyLm5vZGUuYWRkRGVwZW5kZW5jeShjMSk7XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0KHRvQ2xvdWRGb3JtYXRpb24oc3RhY2spKS50b0VxdWFsKHtcbiAgICAgIFJlc291cmNlczoge1xuICAgICAgICBOZXdOYW1lOiB7IFR5cGU6ICdSMScgfSxcbiAgICAgICAgQ29uc3RydWN0Mjoge1xuICAgICAgICAgIFR5cGU6ICdSMicsXG4gICAgICAgICAgUHJvcGVydGllczogeyBSZWZlcmVuY2VUb1IxOiB7IFJlZjogJ05ld05hbWUnIH0gfSxcbiAgICAgICAgICBEZXBlbmRzT246IFsnTmV3TmFtZSddLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnY3VzdG9taXplIGxvZ2ljYWwgaWQgYWxsb2NhdGlvbiBiZWhhdmlvciBieSBvdmVycmlkaW5nIGBTdGFjay5hbGxvY2F0ZUxvZ2ljYWxJZGAnLCAoKSA9PiB7XG4gICAgY2xhc3MgTXlTdGFjayBleHRlbmRzIFN0YWNrIHtcbiAgICAgIHByb3RlY3RlZCBhbGxvY2F0ZUxvZ2ljYWxJZChlbGVtZW50OiBDZm5FbGVtZW50KTogc3RyaW5nIHtcbiAgICAgICAgaWYgKGVsZW1lbnQubm9kZS5pZCA9PT0gJ0EnKSB7IHJldHVybiAnTG9naWNhbElkT2ZBJzsgfVxuICAgICAgICBpZiAoZWxlbWVudC5ub2RlLmlkID09PSAnQicpIHsgcmV0dXJuICdMb2dpY2FsSWRPZkInOyB9XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBlbGVtZW50IElEJyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgYXBwID0gbmV3IEFwcCh7XG4gICAgICBjb250ZXh0OiB7XG4gICAgICAgIFtjeGFwaS5ORVdfU1RZTEVfU1RBQ0tfU1lOVEhFU0lTX0NPTlRFWFRdOiBmYWxzZSxcbiAgICAgIH0sXG4gICAgfSk7XG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgTXlTdGFjayhhcHApO1xuICAgIG5ldyBDZm5SZXNvdXJjZShzdGFjaywgJ0EnLCB7IHR5cGU6ICdUeXBlOjpPZjo6QScgfSk7XG4gICAgY29uc3QgZ3JvdXAgPSBuZXcgQ29uc3RydWN0KHN0YWNrLCAnR3JvdXAnKTtcbiAgICBuZXcgQ2ZuUmVzb3VyY2UoZ3JvdXAsICdCJywgeyB0eXBlOiAnVHlwZTo6T2Y6OkInIH0pO1xuXG4gICAgLy8gcmVuYW1lcyBjYW4gYWxzbyBiZSBhcHBsaWVkIG9uIGN1c3RvbSBsb2dpY2FsIElEcy5cbiAgICBzdGFjay5yZW5hbWVMb2dpY2FsSWQoJ0xvZ2ljYWxJZE9mQicsICdCb29tQm9vbUInKTtcblxuICAgIGNvbnN0IGMgPSBuZXcgQ2ZuUmVzb3VyY2Uoc3RhY2ssICdCJywgeyB0eXBlOiAnVHlwZTo6T2Y6OkMnIH0pO1xuICAgIGMub3ZlcnJpZGVMb2dpY2FsSWQoJ1RoZUMnKTtcblxuICAgIGV4cGVjdCh0b0Nsb3VkRm9ybWF0aW9uKHN0YWNrKSkudG9FcXVhbCh7XG4gICAgICBSZXNvdXJjZXM6IHtcbiAgICAgICAgTG9naWNhbElkT2ZBOiB7IFR5cGU6ICdUeXBlOjpPZjo6QScgfSxcbiAgICAgICAgQm9vbUJvb21COiB7IFR5cGU6ICdUeXBlOjpPZjo6QicgfSxcbiAgICAgICAgVGhlQzogeyBUeXBlOiAnVHlwZTo6T2Y6OkMnIH0sXG4gICAgICB9LFxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdkZXRlY3RzIGR1cGxpY2F0ZSBsb2dpY2FsIElEcyBpbiB0aGUgc2FtZSBTdGFjayBjYXVzZWQgYnkgb3ZlcnJpZGVMb2dpY2FsSWQnLCAoKSA9PiB7XG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soKTtcbiAgICBjb25zdCByZXNvdXJjZTEgPSBuZXcgQ2ZuUmVzb3VyY2Uoc3RhY2ssICdBJywgeyB0eXBlOiAnVHlwZTo6T2Y6OkEnIH0pO1xuICAgIGNvbnN0IHJlc291cmNlMiA9IG5ldyBDZm5SZXNvdXJjZShzdGFjaywgJ0InLCB7IHR5cGU6ICdUeXBlOjpPZjo6QicgfSk7XG5cbiAgICByZXNvdXJjZTEub3ZlcnJpZGVMb2dpY2FsSWQoJ0MnKTtcbiAgICByZXNvdXJjZTIub3ZlcnJpZGVMb2dpY2FsSWQoJ0MnKTtcblxuICAgIGV4cGVjdCgoKSA9PiB7XG4gICAgICB0b0Nsb3VkRm9ybWF0aW9uKHN0YWNrKTtcbiAgICB9KS50b1Rocm93KC9zZWN0aW9uICdSZXNvdXJjZXMnIGFscmVhZHkgY29udGFpbnMgJ0MnLyk7XG4gIH0pO1xufSk7XG5cbmZ1bmN0aW9uIGdlbmVyYXRlU3RyaW5nKGNoYXJzOiBudW1iZXIpIHtcbiAgbGV0IHMgPSAnJztcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGFyczsgKytpKSB7XG4gICAgcyArPSByYW5kb21BbHBoYSgpO1xuICB9XG4gIHJldHVybiBzO1xuXG4gIGZ1bmN0aW9uIHJhbmRvbUFscGhhKCkge1xuICAgIHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKCdhJy5jaGFyQ29kZUF0KDApICsgTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMjYpKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBsb2dpY2FsRm9yRWxlbWVudEluUGF0aChjb25zdHJ1Y3RQYXRoOiBzdHJpbmdbXSk6IHN0cmluZyB7XG4gIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKCk7XG4gIGxldCBzY29wZTogQ29uc3RydWN0ID0gc3RhY2s7XG4gIGZvciAoY29uc3QgY29tcG9uZW50IG9mIGNvbnN0cnVjdFBhdGgpIHtcbiAgICBzY29wZSA9IG5ldyBDZm5SZXNvdXJjZShzY29wZSwgY29tcG9uZW50LCB7IHR5cGU6ICdGb28nIH0pO1xuICB9XG5cbiAgcmV0dXJuIHN0YWNrLnJlc29sdmUoKHNjb3BlIGFzIENmblJlc291cmNlKS5sb2dpY2FsSWQpO1xufVxuIl19