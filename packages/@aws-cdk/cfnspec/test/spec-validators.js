"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.validateSpecification = void 0;
/* eslint-disable jest/no-export */
const schema = require("../lib/schema");
function validateSpecification(specification) {
    validateResourceTypes(specification);
    validatePropertyTypes(specification);
}
exports.validateSpecification = validateSpecification;
function validateResourceTypes(specification) {
    for (const typeName of Object.keys(specification.ResourceTypes)) {
        describe(typeName, () => {
            expect(typeName).toBeTruthy();
            const type = specification.ResourceTypes[typeName];
            expect(type.Documentation).not.toBeNull();
            if (type.ScrutinyType) {
                expect(schema.isResourceScrutinyType(type.ScrutinyType)).toBeTruthy();
            }
            if (type.Properties) {
                validateProperties(typeName, type.Properties, specification);
            }
            if (type.Attributes) {
                validateAttributes(typeName, type.Attributes, specification);
            }
        });
    }
}
function validatePropertyTypes(specification) {
    for (const typeName of Object.keys(specification.PropertyTypes)) {
        describe(`PropertyType ${typeName}`, () => {
            expect(typeName).toBeTruthy();
            const type = specification.PropertyTypes[typeName];
            if (schema.isRecordType(type)) {
                validateProperties(typeName, type.Properties, specification);
            }
            else {
                validateProperties(typeName, { '<this>': type }, specification);
            }
        });
    }
}
function validateProperties(typeName, properties, specification) {
    const expectedKeys = ['Documentation', 'Required', 'UpdateType', 'ScrutinyType'];
    for (const name of Object.keys(properties)) {
        test(`Property ${name}`, () => {
            const property = properties[name];
            expect(property.Documentation).not.toEqual('');
            expect(!property.UpdateType || schema.isUpdateType(property.UpdateType)).toBeTruthy();
            if (property.ScrutinyType !== undefined) {
                expect(schema.isPropertyScrutinyType(property.ScrutinyType)).toBeTruthy();
            }
            if (schema.isPrimitiveProperty(property)) {
                expect(schema.isPrimitiveType(property.PrimitiveType)).toBeTruthy();
                expectedKeys.push('PrimitiveType');
            }
            else if (schema.isPrimitiveListProperty(property)) {
                expectedKeys.push('Type', 'DuplicatesAllowed', 'PrimitiveItemType');
                expect(schema.isPrimitiveType(property.PrimitiveItemType)).toBeTruthy();
            }
            else if (schema.isPrimitiveMapProperty(property)) {
                expectedKeys.push('Type', 'DuplicatesAllowed', 'PrimitiveItemType', 'Type');
                expect(schema.isPrimitiveType(property.PrimitiveItemType)).toBeTruthy();
                expect(property.DuplicatesAllowed).toBeFalsy();
            }
            else if (schema.isComplexListProperty(property)) {
                expectedKeys.push('Type', 'DuplicatesAllowed', 'ItemType', 'Type');
                expect(property.ItemType).toBeTruthy();
                if (property.ItemType !== 'Tag') {
                    const fqn = `${typeName.split('.')[0]}.${property.ItemType}`;
                    const resolvedType = specification.PropertyTypes && specification.PropertyTypes[fqn];
                    expect(resolvedType).toBeTruthy();
                }
            }
            else if (schema.isMapOfStructsProperty(property)) {
                expectedKeys.push('Type', 'DuplicatesAllowed', 'ItemType', 'Type');
                expect(property.ItemType).toBeTruthy();
                const fqn = `${typeName.split('.')[0]}.${property.ItemType}`;
                const resolvedType = specification.PropertyTypes && specification.PropertyTypes[fqn];
                expect(resolvedType).toBeTruthy();
                expect(property.DuplicatesAllowed).toBeFalsy();
            }
            else if (schema.isMapOfListsOfPrimitivesProperty(property)) {
                expectedKeys.push('Type', 'DuplicatesAllowed', 'ItemType', 'PrimitiveItemItemType', 'Type');
                expect(schema.isPrimitiveType(property.PrimitiveItemItemType)).toBeTruthy();
                expect(property.DuplicatesAllowed).toBeFalsy();
            }
            else if (schema.isComplexProperty(property)) {
                expectedKeys.push('Type');
                expect(property.Type).toBeTruthy();
                const fqn = `${typeName.split('.')[0]}.${property.Type}`;
                expect(Object.keys(specification.PropertyTypes)).toContain(fqn);
            }
            else if (schema.isUnionProperty(property)) {
                expectedKeys.push('PrimitiveTypes', 'PrimitiveItemTypes', 'ItemTypes', 'Types', 'InclusivePrimitiveItemTypes', 'InclusiveItemTypes', 'InclusiveItemPattern');
                if (property.PrimitiveTypes) {
                    for (const type of property.PrimitiveTypes) {
                        expect(schema.isPrimitiveType(type)).toBeTruthy();
                    }
                }
                if (property.ItemTypes) {
                    for (const type of property.ItemTypes) {
                        const fqn = `${typeName.split('.')[0]}.${type}`;
                        const resolvedType = specification.PropertyTypes && specification.PropertyTypes[fqn];
                        expect(resolvedType).toBeTruthy();
                    }
                }
                if (property.Types) {
                    for (const type of property.Types) {
                        const fqn = `${typeName.split('.')[0]}.${type}`;
                        const resolvedType = specification.PropertyTypes && specification.PropertyTypes[fqn];
                        expect(resolvedType).toBeTruthy();
                    }
                }
            }
            else {
                // eslint-disable-next-line no-console
                console.error(`${typeName}.Properties.${name} does not declare a type. ` +
                    `Property definition is: ${JSON.stringify(property, undefined, 2)}`);
                expect(false).toBeTruthy();
            }
            expect(without(Object.keys(property), expectedKeys)).toEqual([]);
        });
    }
}
function validateAttributes(typeName, attributes, specification) {
    for (const name of Object.keys(attributes)) {
        test(`Attribute ${name}`, () => {
            const attribute = attributes[name];
            expect(('Type' in attribute)).not.toEqual(('PrimitiveType' in attribute));
            if (schema.isPrimitiveAttribute(attribute)) {
                expect(schema.isListAttribute(attribute)).toBeFalsy();
                expect(schema.isPrimitiveType(attribute.PrimitiveType)).toBeTruthy();
                expect(('PrimitiveItemType' in attribute)).toBeFalsy();
                expect(('ItemType' in attribute)).toBeFalsy();
            }
            else if (schema.isPrimitiveListAttribute(attribute)) {
                expect(schema.isComplexListAttribute(attribute)).toBeFalsy();
                expect(schema.isPrimitiveType(attribute.PrimitiveItemType)).toBeTruthy();
                expect(('ItemType' in attribute)).toBeFalsy();
            }
            else if (schema.isComplexListAttribute(attribute)) {
                expect(attribute.ItemType).toBeTruthy();
                if (attribute.ItemType !== 'Tag') {
                    const fqn = `${typeName.split('.')[0]}.${attribute.ItemType}`;
                    const resolvedType = specification.PropertyTypes && specification.PropertyTypes[fqn];
                    expect(resolvedType).toBeTruthy();
                }
                expect(('PrimitiveItemType' in attribute)).toBeFalsy();
            }
            else if (schema.isPrimitiveMapAttribute(attribute)) {
                expect(schema.isPrimitiveType(attribute.PrimitiveItemType)).toBeTruthy();
                expect(('ItemType' in attribute)).toBeFalsy();
            }
            else {
                throw new Error(`No valid attribute type in ${JSON.stringify(attribute)}`);
            }
        });
    }
}
/**
 * Remove elements from a set
 */
function without(xs, ...sets) {
    const ret = new Set(xs);
    for (const set of sets) {
        for (const element of set) {
            if (ret.has(element)) {
                ret.delete(element);
            }
        }
    }
    return Array.from(ret);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3BlYy12YWxpZGF0b3JzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic3BlYy12YWxpZGF0b3JzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLG1DQUFtQztBQUNuQyx3Q0FBd0M7QUFFeEMsU0FBZ0IscUJBQXFCLENBQUMsYUFBbUM7SUFDdkUscUJBQXFCLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDckMscUJBQXFCLENBQUMsYUFBYSxDQUFDLENBQUM7QUFDdkMsQ0FBQztBQUhELHNEQUdDO0FBRUQsU0FBUyxxQkFBcUIsQ0FBQyxhQUFtQztJQUNoRSxLQUFLLE1BQU0sUUFBUSxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLGFBQWEsQ0FBQyxFQUFFO1FBQy9ELFFBQVEsQ0FBQyxRQUFRLEVBQUUsR0FBRyxFQUFFO1lBQ3RCLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxVQUFVLEVBQUUsQ0FBQztZQUM5QixNQUFNLElBQUksR0FBRyxhQUFhLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ25ELE1BQU0sQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQzFDLElBQUksSUFBSSxDQUFDLFlBQVksRUFBRTtnQkFDckIsTUFBTSxDQUFDLE1BQU0sQ0FBQyxzQkFBc0IsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxVQUFVLEVBQUUsQ0FBQzthQUN2RTtZQUNELElBQUksSUFBSSxDQUFDLFVBQVUsRUFBRTtnQkFBRSxrQkFBa0IsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLFVBQVUsRUFBRSxhQUFhLENBQUMsQ0FBQzthQUFFO1lBQ3RGLElBQUksSUFBSSxDQUFDLFVBQVUsRUFBRTtnQkFBRSxrQkFBa0IsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLFVBQVUsRUFBRSxhQUFhLENBQUMsQ0FBQzthQUFFO1FBQ3hGLENBQUMsQ0FBQyxDQUFD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QUFDSCxDQUFDO0FBRUQ7O0dBRUc7QUFDSCxTQUFTLE9BQU8sQ0FBSSxFQUFPLEVBQUUsR0FBRyxJQUFXO0lBQ3pDLE1BQU0sR0FBRyxHQUFHLElBQUksR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBRXhCLEtBQUssTUFBTSxHQUFHLElBQUksSUFBSSxFQUFFO1FBQ3RCLEtBQUssTUFBTSxPQUFPLElBQUksR0FBRyxFQUFFO1lBQ3pCLElBQUksR0FBRyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsRUFBRTtnQkFDcEIsR0FBRyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQzthQUNyQjtTQUNGO0tBQ0Y7SUFFRCxPQUFPLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDekIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIGplc3Qvbm8tZXhwb3J0ICovXG5pbXBvcnQgKiBhcyBzY2hlbWEgZnJvbSAnLi4vbGliL3NjaGVtYSc7XG5cbmV4cG9ydCBmdW5jdGlvbiB2YWxpZGF0ZVNwZWNpZmljYXRpb24oc3BlY2lmaWNhdGlvbjogc2NoZW1hLlNwZWNpZmljYXRpb24pIHtcbiAgdmFsaWRhdGVSZXNvdXJjZVR5cGVzKHNwZWNpZmljYXRpb24pO1xuICB2YWxpZGF0ZVByb3BlcnR5VHlwZXMoc3BlY2lmaWNhdGlvbik7XG59XG5cbmZ1bmN0aW9uIHZhbGlkYXRlUmVzb3VyY2VUeXBlcyhzcGVjaWZpY2F0aW9uOiBzY2hlbWEuU3BlY2lmaWNhdGlvbikge1xuICBmb3IgKGNvbnN0IHR5cGVOYW1lIG9mIE9iamVjdC5rZXlzKHNwZWNpZmljYXRpb24uUmVzb3VyY2VUeXBlcykpIHtcbiAgICBkZXNjcmliZSh0eXBlTmFtZSwgKCkgPT4ge1xuICAgICAgZXhwZWN0KHR5cGVOYW1lKS50b0JlVHJ1dGh5KCk7XG4gICAgICBjb25zdCB0eXBlID0gc3BlY2lmaWNhdGlvbi5SZXNvdXJjZVR5cGVzW3R5cGVOYW1lXTtcbiAgICAgIGV4cGVjdCh0eXBlLkRvY3VtZW50YXRpb24pLm5vdC50b0JlTnVsbCgpO1xuICAgICAgaWYgKHR5cGUuU2NydXRpbnlUeXBlKSB7XG4gICAgICAgIGV4cGVjdChzY2hlbWEuaXNSZXNvdXJjZVNjcnV0aW55VHlwZSh0eXBlLlNjcnV0aW55VHlwZSkpLnRvQmVUcnV0aHkoKTtcbiAgICAgIH1cbiAgICAgIGlmICh0eXBlLlByb3BlcnRpZXMpIHsgdmFsaWRhdGVQcm9wZXJ0aWVzKHR5cGVOYW1lLCB0eXBlLlByb3BlcnRpZXMsIHNwZWNpZmljYXRpb24pOyB9XG4gICAgICBpZiAodHlwZS5BdHRyaWJ1dGVzKSB7IHZhbGlkYXRlQXR0cmlidXRlcyh0eXBlTmFtZSwgdHlwZS5BdHRyaWJ1dGVzLCBzcGVjaWZpY2F0aW9uKTsgfVxuICAgIH0pO1xuICB9XG59XG5cbmZ1bmN0aW9uIHZhbGlkYXRlUHJvcGVydHlUeXBlcyhzcGVjaWZpY2F0aW9uOiBzY2hlbWEuU3BlY2lmaWNhdGlvbikge1xuICBmb3IgKGNvbnN0IHR5cGVOYW1lIG9mIE9iamVjdC5rZXlzKHNwZWNpZmljYXRpb24uUHJvcGVydHlUeXBlcykpIHtcbiAgICBkZXNjcmliZShgUHJvcGVydHlUeXBlICR7dHlwZU5hbWV9YCwgKCkgPT4ge1xuICAgICAgZXhwZWN0KHR5cGVOYW1lKS50b0JlVHJ1dGh5KCk7XG4gICAgICBjb25zdCB0eXBlID0gc3BlY2lmaWNhdGlvbi5Qcm9wZXJ0eVR5cGVzW3R5cGVOYW1lXTtcbiAgICAgIGlmIChzY2hlbWEuaXNSZWNvcmRUeXBlKHR5cGUpKSB7XG4gICAgICAgIHZhbGlkYXRlUHJvcGVydGllcyh0eXBlTmFtZSwgdHlwZS5Qcm9wZXJ0aWVzLCBzcGVjaWZpY2F0aW9uKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHZhbGlkYXRlUHJvcGVydGllcyh0eXBlTmFtZSwgeyAnPHRoaXM+JzogdHlwZSB9LCBzcGVjaWZpY2F0aW9uKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxufVxuXG5mdW5jdGlvbiB2YWxpZGF0ZVByb3BlcnRpZXMoXG4gIHR5cGVOYW1lOiBzdHJpbmcsXG4gIHByb3BlcnRpZXM6IHsgW25hbWU6IHN0cmluZ106IHNjaGVtYS5Qcm9wZXJ0eSB9LFxuICBzcGVjaWZpY2F0aW9uOiBzY2hlbWEuU3BlY2lmaWNhdGlvbikge1xuICBjb25zdCBleHBlY3RlZEtleXMgPSBbJ0RvY3VtZW50YXRpb24nLCAnUmVxdWlyZWQnLCAnVXBkYXRlVHlwZScsICdTY3J1dGlueVR5cGUnXTtcbiAgZm9yIChjb25zdCBuYW1lIG9mIE9iamVjdC5rZXlzKHByb3BlcnRpZXMpKSB7XG5cbiAgICB0ZXN0KGBQcm9wZXJ0eSAke25hbWV9YCwgKCkgPT4ge1xuICAgICAgY29uc3QgcHJvcGVydHkgPSBwcm9wZXJ0aWVzW25hbWVdO1xuICAgICAgZXhwZWN0KHByb3BlcnR5LkRvY3VtZW50YXRpb24pLm5vdC50b0VxdWFsKCcnKTtcbiAgICAgIGV4cGVjdCghcHJvcGVydHkuVXBkYXRlVHlwZSB8fCBzY2hlbWEuaXNVcGRhdGVUeXBlKHByb3BlcnR5LlVwZGF0ZVR5cGUpKS50b0JlVHJ1dGh5KCk7XG4gICAgICBpZiAocHJvcGVydHkuU2NydXRpbnlUeXBlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgZXhwZWN0KHNjaGVtYS5pc1Byb3BlcnR5U2NydXRpbnlUeXBlKHByb3BlcnR5LlNjcnV0aW55VHlwZSkpLnRvQmVUcnV0aHkoKTtcbiAgICAgIH1cblxuICAgICAgaWYgKHNjaGVtYS5pc1ByaW1pdGl2ZVByb3BlcnR5KHByb3BlcnR5KSkge1xuICAgICAgICBleHBlY3Qoc2NoZW1hLmlzUHJpbWl0aXZlVHlwZShwcm9wZXJ0eS5QcmltaXRpdmVUeXBlKSkudG9CZVRydXRoeSgpO1xuICAgICAgICBleHBlY3RlZEtleXMucHVzaCgnUHJpbWl0aXZlVHlwZScpO1xuXG4gICAgICB9IGVsc2UgaWYgKHNjaGVtYS5pc1ByaW1pdGl2ZUxpc3RQcm9wZXJ0eShwcm9wZXJ0eSkpIHtcbiAgICAgICAgZXhwZWN0ZWRLZXlzLnB1c2goJ1R5cGUnLCAnRHVwbGljYXRlc0FsbG93ZWQnLCAnUHJpbWl0aXZlSXRlbVR5cGUnKTtcbiAgICAgICAgZXhwZWN0KHNjaGVtYS5pc1ByaW1pdGl2ZVR5cGUocHJvcGVydHkuUHJpbWl0aXZlSXRlbVR5cGUpKS50b0JlVHJ1dGh5KCk7XG5cbiAgICAgIH0gZWxzZSBpZiAoc2NoZW1hLmlzUHJpbWl0aXZlTWFwUHJvcGVydHkocHJvcGVydHkpKSB7XG4gICAgICAgIGV4cGVjdGVkS2V5cy5wdXNoKCdUeXBlJywgJ0R1cGxpY2F0ZXNBbGxvd2VkJywgJ1ByaW1pdGl2ZUl0ZW1UeXBlJywgJ1R5cGUnKTtcbiAgICAgICAgZXhwZWN0KHNjaGVtYS5pc1ByaW1pdGl2ZVR5cGUocHJvcGVydHkuUHJpbWl0aXZlSXRlbVR5cGUpKS50b0JlVHJ1dGh5KCk7XG4gICAgICAgIGV4cGVjdChwcm9wZXJ0eS5EdXBsaWNhdGVzQWxsb3dlZCkudG9CZUZhbHN5KCk7XG5cbiAgICAgIH0gZWxzZSBpZiAoc2NoZW1hLmlzQ29tcGxleExpc3RQcm9wZXJ0eShwcm9wZXJ0eSkpIHtcbiAgICAgICAgZXhwZWN0ZWRLZXlzLnB1c2goJ1R5cGUnLCAnRHVwbGljYXRlc0FsbG93ZWQnLCAnSXRlbVR5cGUnLCAnVHlwZScpO1xuICAgICAgICBleHBlY3QocHJvcGVydHkuSXRlbVR5cGUpLnRvQmVUcnV0aHkoKTtcbiAgICAgICAgaWYgKHByb3BlcnR5Lkl0ZW1UeXBlICE9PSAnVGFnJykge1xuICAgICAgICAgIGNvbnN0IGZxbiA9IGAke3R5cGVOYW1lLnNwbGl0KCcuJylbMF19LiR7cHJvcGVydHkuSXRlbVR5cGV9YDtcbiAgICAgICAgICBjb25zdCByZXNvbHZlZFR5cGUgPSBzcGVjaWZpY2F0aW9uLlByb3BlcnR5VHlwZXMgJiYgc3BlY2lmaWNhdGlvbi5Qcm9wZXJ0eVR5cGVzW2Zxbl07XG4gICAgICAgICAgZXhwZWN0KHJlc29sdmVkVHlwZSkudG9CZVRydXRoeSgpO1xuICAgICAgICB9XG5cbiAgICAgIH0gZWxzZSBpZiAoc2NoZW1hLmlzTWFwT2ZTdHJ1Y3RzUHJvcGVydHkocHJvcGVydHkpKSB7XG4gICAgICAgIGV4cGVjdGVkS2V5cy5wdXNoKCdUeXBlJywgJ0R1cGxpY2F0ZXNBbGxvd2VkJywgJ0l0ZW1UeXBlJywgJ1R5cGUnKTtcbiAgICAgICAgZXhwZWN0KHByb3BlcnR5Lkl0ZW1UeXBlKS50b0JlVHJ1dGh5KCk7XG4gICAgICAgIGNvbnN0IGZxbiA9IGAke3R5cGVOYW1lLnNwbGl0KCcuJylbMF19LiR7cHJvcGVydHkuSXRlbVR5cGV9YDtcbiAgICAgICAgY29uc3QgcmVzb2x2ZWRUeXBlID0gc3BlY2lmaWNhdGlvbi5Qcm9wZXJ0eVR5cGVzICYmIHNwZWNpZmljYXRpb24uUHJvcGVydHlUeXBlc1tmcW5dO1xuICAgICAgICBleHBlY3QocmVzb2x2ZWRUeXBlKS50b0JlVHJ1dGh5KCk7XG4gICAgICAgIGV4cGVjdChwcm9wZXJ0eS5EdXBsaWNhdGVzQWxsb3dlZCkudG9CZUZhbHN5KCk7XG5cbiAgICAgIH0gZWxzZSBpZiAoc2NoZW1hLmlzTWFwT2ZMaXN0c09mUHJpbWl0aXZlc1Byb3BlcnR5KHByb3BlcnR5KSkge1xuICAgICAgICBleHBlY3RlZEtleXMucHVzaCgnVHlwZScsICdEdXBsaWNhdGVzQWxsb3dlZCcsICdJdGVtVHlwZScsICdQcmltaXRpdmVJdGVtSXRlbVR5cGUnLCAnVHlwZScpO1xuICAgICAgICBleHBlY3Qoc2NoZW1hLmlzUHJpbWl0aXZlVHlwZShwcm9wZXJ0eS5QcmltaXRpdmVJdGVtSXRlbVR5cGUpKS50b0JlVHJ1dGh5KCk7XG4gICAgICAgIGV4cGVjdChwcm9wZXJ0eS5EdXBsaWNhdGVzQWxsb3dlZCkudG9CZUZhbHN5KCk7XG5cbiAgICAgIH0gZWxzZSBpZiAoc2NoZW1hLmlzQ29tcGxleFByb3BlcnR5KHByb3BlcnR5KSkge1xuICAgICAgICBleHBlY3RlZEtleXMucHVzaCgnVHlwZScpO1xuICAgICAgICBleHBlY3QocHJvcGVydHkuVHlwZSkudG9CZVRydXRoeSgpO1xuICAgICAgICBjb25zdCBmcW4gPSBgJHt0eXBlTmFtZS5zcGxpdCgnLicpWzBdfS4ke3Byb3BlcnR5LlR5cGV9YDtcbiAgICAgICAgZXhwZWN0KE9iamVjdC5rZXlzKHNwZWNpZmljYXRpb24uUHJvcGVydHlUeXBlcykpLnRvQ29udGFpbihmcW4pO1xuXG4gICAgICB9IGVsc2UgaWYgKHNjaGVtYS5pc1VuaW9uUHJvcGVydHkocHJvcGVydHkpKSB7XG4gICAgICAgIGV4cGVjdGVkS2V5cy5wdXNoKCdQcmltaXRpdmVUeXBlcycsICdQcmltaXRpdmVJdGVtVHlwZXMnLCAnSXRlbVR5cGVzJywgJ1R5cGVzJywgJ0luY2x1c2l2ZVByaW1pdGl2ZUl0ZW1UeXBlcycsICdJbmNsdXNpdmVJdGVtVHlwZXMnLCAnSW5jbHVzaXZlSXRlbVBhdHRlcm4nKTtcbiAgICAgICAgaWYgKHByb3BlcnR5LlByaW1pdGl2ZVR5cGVzKSB7XG4gICAgICAgICAgZm9yIChjb25zdCB0eXBlIG9mIHByb3BlcnR5LlByaW1pdGl2ZVR5cGVzKSB7XG4gICAgICAgICAgICBleHBlY3Qoc2NoZW1hLmlzUHJpbWl0aXZlVHlwZSh0eXBlKSkudG9CZVRydXRoeSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAocHJvcGVydHkuSXRlbVR5cGVzKSB7XG4gICAgICAgICAgZm9yIChjb25zdCB0eXBlIG9mIHByb3BlcnR5Lkl0ZW1UeXBlcykge1xuICAgICAgICAgICAgY29uc3QgZnFuID0gYCR7dHlwZU5hbWUuc3BsaXQoJy4nKVswXX0uJHt0eXBlfWA7XG4gICAgICAgICAgICBjb25zdCByZXNvbHZlZFR5cGUgPSBzcGVjaWZpY2F0aW9uLlByb3BlcnR5VHlwZXMgJiYgc3BlY2lmaWNhdGlvbi5Qcm9wZXJ0eVR5cGVzW2Zxbl07XG4gICAgICAgICAgICBleHBlY3QocmVzb2x2ZWRUeXBlKS50b0JlVHJ1dGh5KCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChwcm9wZXJ0eS5UeXBlcykge1xuICAgICAgICAgIGZvciAoY29uc3QgdHlwZSBvZiBwcm9wZXJ0eS5UeXBlcykge1xuICAgICAgICAgICAgY29uc3QgZnFuID0gYCR7dHlwZU5hbWUuc3BsaXQoJy4nKVswXX0uJHt0eXBlfWA7XG4gICAgICAgICAgICBjb25zdCByZXNvbHZlZFR5cGUgPSBzcGVjaWZpY2F0aW9uLlByb3BlcnR5VHlwZXMgJiYgc3BlY2lmaWNhdGlvbi5Qcm9wZXJ0eVR5cGVzW2Zxbl07XG4gICAgICAgICAgICBleHBlY3QocmVzb2x2ZWRUeXBlKS50b0JlVHJ1dGh5KCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1jb25zb2xlXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoYCR7dHlwZU5hbWV9LlByb3BlcnRpZXMuJHtuYW1lfSBkb2VzIG5vdCBkZWNsYXJlIGEgdHlwZS4gYCArXG4gICAgICAgICAgYFByb3BlcnR5IGRlZmluaXRpb24gaXM6ICR7SlNPTi5zdHJpbmdpZnkocHJvcGVydHksIHVuZGVmaW5lZCwgMil9YCk7XG4gICAgICAgIGV4cGVjdChmYWxzZSkudG9CZVRydXRoeSgpO1xuICAgICAgfVxuXG4gICAgICBleHBlY3Qod2l0aG91dChPYmplY3Qua2V5cyhwcm9wZXJ0eSksIGV4cGVjdGVkS2V5cykpLnRvRXF1YWwoW10pO1xuICAgIH0pO1xuICB9XG59XG5cbmZ1bmN0aW9uIHZhbGlkYXRlQXR0cmlidXRlcyhcbiAgdHlwZU5hbWU6IHN0cmluZyxcbiAgYXR0cmlidXRlczogeyBbbmFtZTogc3RyaW5nXTogc2NoZW1hLkF0dHJpYnV0ZSB9LFxuICBzcGVjaWZpY2F0aW9uOiBzY2hlbWEuU3BlY2lmaWNhdGlvbikge1xuICBmb3IgKGNvbnN0IG5hbWUgb2YgT2JqZWN0LmtleXMoYXR0cmlidXRlcykpIHtcbiAgICB0ZXN0KGBBdHRyaWJ1dGUgJHtuYW1lfWAsICgpID0+IHtcbiAgICAgIGNvbnN0IGF0dHJpYnV0ZSA9IGF0dHJpYnV0ZXNbbmFtZV07XG4gICAgICBleHBlY3QoKCdUeXBlJyBpbiBhdHRyaWJ1dGUpKS5ub3QudG9FcXVhbCgoJ1ByaW1pdGl2ZVR5cGUnIGluIGF0dHJpYnV0ZSkpO1xuICAgICAgaWYgKHNjaGVtYS5pc1ByaW1pdGl2ZUF0dHJpYnV0ZShhdHRyaWJ1dGUpKSB7XG4gICAgICAgIGV4cGVjdChzY2hlbWEuaXNMaXN0QXR0cmlidXRlKGF0dHJpYnV0ZSkpLnRvQmVGYWxzeSgpO1xuICAgICAgICBleHBlY3Qoc2NoZW1hLmlzUHJpbWl0aXZlVHlwZShhdHRyaWJ1dGUuUHJpbWl0aXZlVHlwZSkpLnRvQmVUcnV0aHkoKTtcbiAgICAgICAgZXhwZWN0KCgnUHJpbWl0aXZlSXRlbVR5cGUnIGluIGF0dHJpYnV0ZSkpLnRvQmVGYWxzeSgpO1xuICAgICAgICBleHBlY3QoKCdJdGVtVHlwZScgaW4gYXR0cmlidXRlKSkudG9CZUZhbHN5KCk7XG4gICAgICB9IGVsc2UgaWYgKHNjaGVtYS5pc1ByaW1pdGl2ZUxpc3RBdHRyaWJ1dGUoYXR0cmlidXRlKSkge1xuICAgICAgICBleHBlY3Qoc2NoZW1hLmlzQ29tcGxleExpc3RBdHRyaWJ1dGUoYXR0cmlidXRlKSkudG9CZUZhbHN5KCk7XG4gICAgICAgIGV4cGVjdChzY2hlbWEuaXNQcmltaXRpdmVUeXBlKGF0dHJpYnV0ZS5QcmltaXRpdmVJdGVtVHlwZSkpLnRvQmVUcnV0aHkoKTtcbiAgICAgICAgZXhwZWN0KCgnSXRlbVR5cGUnIGluIGF0dHJpYnV0ZSkpLnRvQmVGYWxzeSgpO1xuICAgICAgfSBlbHNlIGlmIChzY2hlbWEuaXNDb21wbGV4TGlzdEF0dHJpYnV0ZShhdHRyaWJ1dGUpKSB7XG4gICAgICAgIGV4cGVjdChhdHRyaWJ1dGUuSXRlbVR5cGUpLnRvQmVUcnV0aHkoKTtcbiAgICAgICAgaWYgKGF0dHJpYnV0ZS5JdGVtVHlwZSAhPT0gJ1RhZycpIHtcbiAgICAgICAgICBjb25zdCBmcW4gPSBgJHt0eXBlTmFtZS5zcGxpdCgnLicpWzBdfS4ke2F0dHJpYnV0ZS5JdGVtVHlwZX1gO1xuICAgICAgICAgIGNvbnN0IHJlc29sdmVkVHlwZSA9IHNwZWNpZmljYXRpb24uUHJvcGVydHlUeXBlcyAmJiBzcGVjaWZpY2F0aW9uLlByb3BlcnR5VHlwZXNbZnFuXTtcbiAgICAgICAgICBleHBlY3QocmVzb2x2ZWRUeXBlKS50b0JlVHJ1dGh5KCk7XG4gICAgICAgIH1cbiAgICAgICAgZXhwZWN0KCgnUHJpbWl0aXZlSXRlbVR5cGUnIGluIGF0dHJpYnV0ZSkpLnRvQmVGYWxzeSgpO1xuICAgICAgfSBlbHNlIGlmIChzY2hlbWEuaXNQcmltaXRpdmVNYXBBdHRyaWJ1dGUoYXR0cmlidXRlKSkge1xuICAgICAgICBleHBlY3Qoc2NoZW1hLmlzUHJpbWl0aXZlVHlwZShhdHRyaWJ1dGUuUHJpbWl0aXZlSXRlbVR5cGUpKS50b0JlVHJ1dGh5KCk7XG4gICAgICAgIGV4cGVjdCgoJ0l0ZW1UeXBlJyBpbiBhdHRyaWJ1dGUpKS50b0JlRmFsc3koKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgTm8gdmFsaWQgYXR0cmlidXRlIHR5cGUgaW4gJHtKU09OLnN0cmluZ2lmeShhdHRyaWJ1dGUpfWApO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG59XG5cbi8qKlxuICogUmVtb3ZlIGVsZW1lbnRzIGZyb20gYSBzZXRcbiAqL1xuZnVuY3Rpb24gd2l0aG91dDxUPih4czogVFtdLCAuLi5zZXRzOiBUW11bXSkge1xuICBjb25zdCByZXQgPSBuZXcgU2V0KHhzKTtcblxuICBmb3IgKGNvbnN0IHNldCBvZiBzZXRzKSB7XG4gICAgZm9yIChjb25zdCBlbGVtZW50IG9mIHNldCkge1xuICAgICAgaWYgKHJldC5oYXMoZWxlbWVudCkpIHtcbiAgICAgICAgcmV0LmRlbGV0ZShlbGVtZW50KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICByZXR1cm4gQXJyYXkuZnJvbShyZXQpO1xufVxuIl19