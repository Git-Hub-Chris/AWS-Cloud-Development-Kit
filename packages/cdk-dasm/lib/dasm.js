"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.dasmTypeScript = void 0;
const codemaker_1 = require("codemaker");
const fs = require("fs");
const os = require("os");
const path = require("path");
const util_1 = require("util");
const mkdtemp = util_1.promisify(fs.mkdtemp);
const readFile = util_1.promisify(fs.readFile);
async function dasmTypeScript(template, options = {}) {
    const definitions = new Array();
    for (const [id, resource] of Object.entries(template.Resources || {})) {
        const type = resource.Type;
        const props = resource.Properties || {};
        definitions.push({
            id,
            ...toCfnClassName(type),
            props: capitalizeKeys(props)
        });
    }
    const code = new codemaker_1.CodeMaker();
    const outFile = 'out.ts';
    code.openFile(outFile);
    const timestamp = options.timestamp !== undefined ? options.timestamp : true;
    const suffix = timestamp ? `at ${new Date().toISOString()}` : '';
    code.line(`// generated by cdk-dasm ${suffix}`);
    code.line();
    //
    // imports
    //
    code.line(`import { Stack, StackProps, Fn } from '@aws-cdk/core';`);
    code.line(`import { Construct } from 'constructs';`);
    for (const ns of getUniqueNamespaces(definitions)) {
        const importName = `@aws-cdk/aws-${ns}`;
        code.line(`import ${ns} = require('${importName}');`);
    }
    code.line();
    //
    // stack
    //
    code.openBlock(`export class MyStack extends Stack`);
    code.openBlock(`constructor(scope: Construct, id: string, props: StackProps = {})`);
    code.line(`super(scope, id, props);`);
    for (const def of definitions) {
        // no props
        if (Object.keys(def.props).length === 0) {
            code.line(`new ${def.className}(this, '${def.id}');`);
            continue;
        }
        code.indent(`new ${def.className}(this, '${def.id}', {`);
        for (const [key, value] of Object.entries(def.props)) {
            const json = JSON.stringify(value, undefined, 2);
            const [first, ...rest] = json.split('\n');
            if (rest.length === 0) {
                code.line(`${key}: ${first},`); // single line
            }
            else {
                code.line(`${key}: ${first}`);
                rest.forEach((r, i) => {
                    code.line(r + ((i === rest.length - 1) ? ',' : ''));
                });
            }
        }
        code.unindent('});');
    }
    code.closeBlock();
    code.closeBlock(' // MyStack');
    code.closeFile(outFile);
    const workdir = await mkdtemp(path.join(os.tmpdir(), 'cdk-dasm-typescript'));
    await code.save(workdir);
    return (await readFile(path.join(workdir, outFile))).toString();
}
exports.dasmTypeScript = dasmTypeScript;
function capitalizeKeys(x) {
    if (typeof (x) === 'function') {
        throw new Error(`function?`);
    }
    if (Array.isArray(x)) {
        return x.map(i => capitalizeKeys(i));
    }
    if (typeof (x) === 'object') {
        const ret = {};
        for (const [key, value] of Object.entries(x)) {
            let newKey;
            if (key === 'Ref' || key.startsWith('Fn::')) {
                newKey = key;
            }
            else {
                newKey = codemaker_1.toCamelCase(key);
            }
            ret[newKey] = capitalizeKeys(value);
        }
        return ret;
    }
    // primitive
    return x;
}
function toCfnClassName(resourceType) {
    const [, namespace, type] = resourceType.split('::');
    const className = `${namespace.toLocaleLowerCase()}.Cfn${type}`;
    return { namespace: namespace.toLocaleLowerCase(), className };
}
function getUniqueNamespaces(definitions) {
    return [...new Set(definitions.map(definition => definition.namespace))];
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGFzbS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImRhc20udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEseUNBQW1EO0FBQ25ELHlCQUF5QjtBQUN6Qix5QkFBeUI7QUFDekIsNkJBQTZCO0FBQzdCLCtCQUFpQztBQUVqQyxNQUFNLE9BQU8sR0FBRyxnQkFBUyxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUN0QyxNQUFNLFFBQVEsR0FBRyxnQkFBUyxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQztBQWtCakMsS0FBSyxVQUFVLGNBQWMsQ0FBQyxRQUFrQixFQUFFLFVBQStCLEVBQUU7SUFDeEYsTUFBTSxXQUFXLEdBQUcsSUFBSSxLQUFLLEVBQXVCLENBQUM7SUFFckQsS0FBSyxNQUFNLENBQUUsRUFBRSxFQUFFLFFBQVEsQ0FBRSxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLFNBQVMsSUFBSSxFQUFFLENBQUMsRUFBRTtRQUN2RSxNQUFNLElBQUksR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDO1FBQzNCLE1BQU0sS0FBSyxHQUFHLFFBQVEsQ0FBQyxVQUFVLElBQUksRUFBRSxDQUFDO1FBRXhDLFdBQVcsQ0FBQyxJQUFJLENBQUM7WUFDZixFQUFFO1lBQ0YsR0FBRyxjQUFjLENBQUMsSUFBSSxDQUFDO1lBQ3ZCLEtBQUssRUFBRSxjQUFjLENBQUMsS0FBSyxDQUFDO1NBQzdCLENBQUMsQ0FBQztLQUNKO0lBRUQsTUFBTSxJQUFJLEdBQUcsSUFBSSxxQkFBUyxFQUFFLENBQUM7SUFFN0IsTUFBTSxPQUFPLEdBQUcsUUFBUSxDQUFDO0lBRXpCLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7SUFFdkIsTUFBTSxTQUFTLEdBQUcsT0FBTyxDQUFDLFNBQVMsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztJQUM3RSxN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LENBQUM7S0FDWjtJQUVELFlBQVk7SUFDWixPQUFPLENBQUMsQ0FBQztBQUNYLENBQUM7QUFFRCxTQUFTLGNBQWMsQ0FBQyxZQUFvQjtJQUMxQyxNQUFNLENBQUUsQUFBRCxFQUFHLFNBQVMsRUFBRSxJQUFJLENBQUUsR0FBRyxZQUFZLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3ZELE1BQU0sU0FBUyxHQUFHLEdBQUcsU0FBUyxDQUFDLGlCQUFpQixFQUFFLE9BQU8sSUFBSSxFQUFFLENBQUM7SUFDaEUsT0FBTyxFQUFFLFNBQVMsRUFBRSxTQUFTLENBQUMsaUJBQWlCLEVBQUUsRUFBRSxTQUFTLEVBQUUsQ0FBQztBQUNqRSxDQUFDO0FBRUQsU0FBUyxtQkFBbUIsQ0FBQyxXQUF1QztJQUNsRSxPQUFPLENBQUMsR0FBSSxJQUFJLEdBQUcsQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUM1RSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29kZU1ha2VyLCB0b0NhbWVsQ2FzZSB9IGZyb20gJ2NvZGVtYWtlcic7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQgKiBhcyBvcyBmcm9tICdvcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgcHJvbWlzaWZ5IH0gZnJvbSAndXRpbCc7XG5cbmNvbnN0IG1rZHRlbXAgPSBwcm9taXNpZnkoZnMubWtkdGVtcCk7XG5jb25zdCByZWFkRmlsZSA9IHByb21pc2lmeShmcy5yZWFkRmlsZSk7XG5cbmludGVyZmFjZSBDb25zdHJ1Y3REZWZpbml0aW9uIHtcbiAgbmFtZXNwYWNlOiBzdHJpbmc7XG4gIGNsYXNzTmFtZTogc3RyaW5nO1xuICBpZDogc3RyaW5nO1xuICBwcm9wczogeyBba2V5OiBzdHJpbmddOiBhbnkgfTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBEaXNhc3NlbWJsZXJPcHRpb25zIHtcbiAgLyoqXG4gICAqIEluY2x1ZGUgYSB0aW1lc3RhbXAgaW4gdGhlIGdlbmVyYXRlZCBvdXRwdXQuXG4gICAqXG4gICAqIEBkZWZhdWx0IHRydWVcbiAgICovXG4gIHJlYWRvbmx5IHRpbWVzdGFtcD86IGJvb2xlYW47XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBkYXNtVHlwZVNjcmlwdCh0ZW1wbGF0ZTogVGVtcGxhdGUsIG9wdGlvbnM6IERpc2Fzc2VtYmxlck9wdGlvbnMgPSB7fSkge1xuICBjb25zdCBkZWZpbml0aW9ucyA9IG5ldyBBcnJheTxDb25zdHJ1Y3REZWZpbml0aW9uPigpO1xuXG4gIGZvciAoY29uc3QgWyBpZCwgcmVzb3VyY2UgXSBvZiBPYmplY3QuZW50cmllcyh0ZW1wbGF0ZS5SZXNvdXJjZXMgfHwge30pKSB7XG4gICAgY29uc3QgdHlwZSA9IHJlc291cmNlLlR5cGU7XG4gICAgY29uc3QgcHJvcHMgPSByZXNvdXJjZS5Qcm9wZXJ0aWVzIHx8IHt9O1xuXG4gICAgZGVmaW5pdGlvbnMucHVzaCh7XG4gICAgICBpZCxcbiAgICAgIC4uLnRvQ2ZuQ2xhc3NOYW1lKHR5cGUpLFxuICAgICAgcHJvcHM6IGNhcGl0YWxpemVLZXlzKHByb3BzKVxuICAgIH0pO1xuICB9XG5cbiAgY29uc3QgY29kZSA9IG5ldyBDb2RlTWFrZXIoKTtcblxuICBjb25zdCBvdXRGaWxlID0gJ291dC50cyc7XG5cbiAgY29kZS5vcGVuRmlsZShvdXRGaWxlKTtcblxuICBjb25zdCB0aW1lc3RhbXAgPSBvcHRpb25zLnRpbWVzdGFtcCAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy50aW1lc3RhbXAgOiB0cnVlO1xuICBjb25zdCBzdWZmaXggPSB0aW1lc3RhbXAgPyAgYGF0ICR7bmV3IERhdGUoKS50b0lTT1N0cmluZygpfWAgOiAnJztcblxuICBjb2RlLmxpbmUoYC8vIGdlbmVyYXRlZCBieSBjZGstZGFzbSAke3N1ZmZpeH1gKTtcbiAgY29kZS5saW5lKCk7XG5cbiAgLy9cbiAgLy8gaW1wb3J0c1xuICAvL1xuXG4gIGNvZGUubGluZShgaW1wb3J0IHsgU3RhY2ssIFN0YWNrUHJvcHMsIEZuIH0gZnJvbSAnQGF3cy1jZGsvY29yZSc7YCk7XG4gIGNvZGUubGluZShgaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7YCk7XG5cbiAgZm9yIChjb25zdCBucyBvZiBnZXRVbmlxdWVOYW1lc3BhY2VzKGRlZmluaXRpb25zKSkge1xuICAgIGNvbnN0IGltcG9ydE5hbWUgPSBgQGF3cy1jZGsvYXdzLSR7bnN9YDtcbiAgICBjb2RlLmxpbmUoYGltcG9ydCAke25zfSA9IHJlcXVpcmUoJyR7aW1wb3J0TmFtZX0nKTtgKTtcbiAgfVxuXG4gIGNvZGUubGluZSgpO1xuXG4gIC8vXG4gIC8vIHN0YWNrXG4gIC8vXG5cbiAgY29kZS5vcGVuQmxvY2soYGV4cG9ydCBjbGFzcyBNeVN0YWNrIGV4dGVuZHMgU3RhY2tgKTtcbiAgY29kZS5vcGVuQmxvY2soYGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBTdGFja1Byb3BzID0ge30pYCk7XG4gIGNvZGUubGluZShgc3VwZXIoc2NvcGUsIGlkLCBwcm9wcyk7YCk7XG5cbiAgZm9yIChjb25zdCBkZWYgb2YgZGVmaW5pdGlvbnMpIHtcblxuICAgIC8vIG5vIHByb3BzXG4gICAgaWYgKE9iamVjdC5rZXlzKGRlZi5wcm9wcykubGVuZ3RoID09PSAwKSB7XG4gICAgICBjb2RlLmxpbmUoYG5ldyAke2RlZi5jbGFzc05hbWV9KHRoaXMsICcke2RlZi5pZH0nKTtgKTtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cblxuICAgIGNvZGUuaW5kZW50KGBuZXcgJHtkZWYuY2xhc3NOYW1lfSh0aGlzLCAnJHtkZWYuaWR9Jywge2ApO1xuXG4gICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMoZGVmLnByb3BzKSkge1xuICAgICAgY29uc3QganNvbiA9IEpTT04uc3RyaW5naWZ5KHZhbHVlLCB1bmRlZmluZWQsIDIpO1xuICAgICAgY29uc3QgWyBmaXJzdCwgLi4ucmVzdCBdID0ganNvbi5zcGxpdCgnXFxuJyk7XG5cbiAgICAgIGlmIChyZXN0Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgICBjb2RlLmxpbmUoYCR7a2V5fTogJHtmaXJzdH0sYCk7IC8vIHNpbmdsZSBsaW5lXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb2RlLmxpbmUoYCR7a2V5fTogJHtmaXJzdH1gKTtcbiAgICAgICAgcmVzdC5mb3JFYWNoKChyLCBpKSA9PiB7XG4gICAgICAgICAgY29kZS5saW5lKHIgKyAoKGkgPT09IHJlc3QubGVuZ3RoIC0gMSkgPyAnLCcgOiAnJykpO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb2RlLnVuaW5kZW50KCd9KTsnKTtcbiAgfVxuXG4gIGNvZGUuY2xvc2VCbG9jaygpO1xuXG4gIGNvZGUuY2xvc2VCbG9jaygnIC8vIE15U3RhY2snKTtcblxuICBjb2RlLmNsb3NlRmlsZShvdXRGaWxlKTtcblxuICBjb25zdCB3b3JrZGlyID0gYXdhaXQgbWtkdGVtcChwYXRoLmpvaW4ob3MudG1wZGlyKCksICdjZGstZGFzbS10eXBlc2NyaXB0JykpO1xuICBhd2FpdCBjb2RlLnNhdmUod29ya2Rpcik7XG5cbiAgcmV0dXJuIChhd2FpdCByZWFkRmlsZShwYXRoLmpvaW4od29ya2Rpciwgb3V0RmlsZSkpKS50b1N0cmluZygpO1xufVxuXG5mdW5jdGlvbiBjYXBpdGFsaXplS2V5cyh4OiBhbnkpOiBhbnkge1xuICBpZiAodHlwZW9mKHgpID09PSAnZnVuY3Rpb24nKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBmdW5jdGlvbj9gKTtcbiAgfVxuXG4gIGlmIChBcnJheS5pc0FycmF5KHgpKSB7XG4gICAgcmV0dXJuIHgubWFwKGkgPT4gY2FwaXRhbGl6ZUtleXMoaSkpO1xuICB9XG5cbiAgaWYgKHR5cGVvZih4KSA9PT0gJ29iamVjdCcpIHtcbiAgICBjb25zdCByZXQ6IHsgW2tleTogc3RyaW5nXTogYW55IH0gPSB7fTtcbiAgICBmb3IgKGNvbnN0IFsga2V5LCB2YWx1ZSBdIG9mIE9iamVjdC5lbnRyaWVzKHgpKSB7XG4gICAgICBsZXQgbmV3S2V5O1xuICAgICAgaWYgKGtleSA9PT0gJ1JlZicgfHwga2V5LnN0YXJ0c1dpdGgoJ0ZuOjonKSkge1xuICAgICAgICBuZXdLZXkgPSBrZXk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBuZXdLZXkgPSB0b0NhbWVsQ2FzZShrZXkpO1xuICAgICAgfVxuXG4gICAgICByZXRbbmV3S2V5XSA9IGNhcGl0YWxpemVLZXlzKHZhbHVlKTtcbiAgICB9XG4gICAgcmV0dXJuIHJldDtcbiAgfVxuXG4gIC8vIHByaW1pdGl2ZVxuICByZXR1cm4geDtcbn1cblxuZnVuY3Rpb24gdG9DZm5DbGFzc05hbWUocmVzb3VyY2VUeXBlOiBzdHJpbmcpIHtcbiAgY29uc3QgWyAsIG5hbWVzcGFjZSwgdHlwZSBdID0gcmVzb3VyY2VUeXBlLnNwbGl0KCc6OicpO1xuICBjb25zdCBjbGFzc05hbWUgPSBgJHtuYW1lc3BhY2UudG9Mb2NhbGVMb3dlckNhc2UoKX0uQ2ZuJHt0eXBlfWA7XG4gIHJldHVybiB7IG5hbWVzcGFjZTogbmFtZXNwYWNlLnRvTG9jYWxlTG93ZXJDYXNlKCksIGNsYXNzTmFtZSB9O1xufVxuXG5mdW5jdGlvbiBnZXRVbmlxdWVOYW1lc3BhY2VzKGRlZmluaXRpb25zOiBBcnJheTxDb25zdHJ1Y3REZWZpbml0aW9uPik6IFN0cmluZ1tdIHtcbiAgcmV0dXJuIFsuLi4gbmV3IFNldChkZWZpbml0aW9ucy5tYXAoZGVmaW5pdGlvbiA9PiBkZWZpbml0aW9uLm5hbWVzcGFjZSkpXTtcbn1cblxuaW50ZXJmYWNlIFRlbXBsYXRlIHtcbiAgUmVzb3VyY2VzOiB7IFtpZDogc3RyaW5nXTogUmVzb3VyY2UgfTtcbn1cblxuaW50ZXJmYWNlIFJlc291cmNlIHtcbiAgVHlwZTogc3RyaW5nO1xuICBQcm9wZXJ0aWVzPzogeyBbcHJvcDogc3RyaW5nXTogYW55IH1cbn1cbiJdfQ==