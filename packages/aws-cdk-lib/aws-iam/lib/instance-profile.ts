import { Construct } from 'constructs';
import { CfnInstanceProfile } from './iam.generated';
import { IRole } from './role';
import { Resource, Lazy } from '../../core';

/**
 * Represents an IAM Instance Profile
 */
export interface IInstanceProfile {
  /**
   * The Instance Profile's name.
   * @attribute
   */
  readonly instanceProfileName: string;

  /**
   * The Instance Profile's ARN.
   * @attribute
   */
  readonly instanceProfileArn: string;

  /**
   * Adds a role to this Instance Profile.
   */
  addRole(role: IRole): void;
}

/**
 * Properties of an Instance Profile
 */
export interface InstanceProfileProps {
  /**
   * The name of the role to associate with the instance profile. Only one role can
   * be assigned to an EC2 instance at a time, and all applications on the instance
   * share the same role and permissions.
   */
  readonly roles: IRole[];

  /**
   * The name of the instance profile to create.
   *
   * @default - generated by CloudFormation
   */
  readonly instanceProfileName?: string;

  /**
   * The path to the instance profile. Minimum path length is 1 character and maximum
   * is 512 characters.
   *
   * @default - '/'
   */
  readonly path?: string;
}

/**
 * IAM Instance Profile
 */
export class InstanceProfile extends Resource implements IInstanceProfile {
  public readonly instanceProfileName: string;
  public readonly instanceProfileArn: string;
  private readonly roles: IRole[];

  constructor(scope: Construct, id: string, props: InstanceProfileProps) {
    super(scope, id, { physicalName: props.instanceProfileName });

    this.roles = [...props.roles];

    const instanceProfile = new CfnInstanceProfile(this, 'Resource', {
      roles: Lazy.list({ produce: () => this.roles.map(role => role.roleName) }),
      instanceProfileName: props.instanceProfileName,
      path: props.path,
    });

    this.instanceProfileName = this.getResourceNameAttribute(instanceProfile.ref);
    this.instanceProfileArn = this.getResourceArnAttribute(instanceProfile.attrArn, {
      region: '',
      service: 'iam',
      resource: 'instance-profile',
      resourceName: `${props.path ? props.path.substring(props.path.charAt(0) === '/' ? 1 : 0) : ''}${this.physicalName}`,
    });
  }

  public addRole(role: IRole) {
    this.roles.push(role);
  }
}
