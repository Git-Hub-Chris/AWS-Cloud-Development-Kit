import { Construct } from 'constructs';
import { CfnInstanceProfile } from './iam.generated';
import { IRole } from './role';
import { Resource, Lazy, Arn, Stack } from '../../core';

/**
 * Represents an IAM Instance Profile
 */
export interface IInstanceProfile {
  /**
   * The InstanceProfile's name.
   * @attribute
   */
  readonly instanceProfileName: string;

  /**
   * The InstanceProfile's ARN.
   * @attribute
   */
  readonly instanceProfileArn: string;

  /**
   * Adds a role to this InstanceProfile.
   */
  addRole(role: IRole): void;
}

/**
 * Properties of an Instance Profile
 */
export interface InstanceProfileProps {
  /**
   * The name of the role to associate with the InstanceProfile. Only one role can
   * be assigned to an EC2 instance at a time, and all applications on the instance
   * share the same role and permissions.
   */
  readonly roles: IRole[];

  /**
   * The name of the InstanceProfile to create.
   *
   * @default - generated by CloudFormation
   */
  readonly instanceProfileName?: string;

  /**
   * The path to the InstanceProfile. Minimum path length is 1 character and maximum
   * is 512 characters.
   *
   * @default - '/'
   */
  readonly path?: string;
}

export interface InstanceProfileAttributes {
  /**
   * The ARN of the InstanceProfile.
   *
   * Format: arn:<partition>:iam::<account-id>:instance-profile/<instance-profile-name-with-path>
   */
  readonly instanceProfileArn: string;
}

/**
 * IAM Instance Profile
 */
export class InstanceProfile extends Resource implements IInstanceProfile {
  /**
   * Import an existing InstanceProfile from an InstanceProfile name.
   *
   * @param scope construct scope
   * @param id construct id
   * @param instanceProfileName the name of the existing InstanceProfile to import
   */
  public static fromInstanceProfleName(scope: Construct, id: string, instanceProfileName: string): IInstanceProfile {
    const instanceProfileArn = Stack.of(scope).formatArn({
      service: 'iam',
      region: '',
      resource: 'instance-profile',
      resourceName: instanceProfileName,
    });
    return InstanceProfile.fromInstanceProfileAttributes(scope, id, { instanceProfileArn });
  }

  /**
   * Import an existing InstanceProfile from an InstanceProfile ARN.
   *
   * If the ARN comes from a Token, the InstanceProfile cannot have a path; if so, any attempt
   * to reference its instanceProfileName will fail.
   *
   * @param scope construct scope
   * @param id construct id
   * @param instanceProfileArn the ARN of the exiting InstanceProfile to import
   */
  public static fromInstanceProfileArn(scope: Construct, id: string, instanceProfileArn: string): IInstanceProfile {
    return InstanceProfile.fromInstanceProfileAttributes(scope, id, { instanceProfileArn });
  }

  /**
   * Import an existing InstanceProfile from given InstanceProfile attributes.
   *
   * If the ARN comes from a Token, the InstanceProfile cannot have a path; if so, any attempt
   * to reference its instanceProfileName will fail.
   *
   * @param scope construct scope
   * @param id construct id
   * @param attrs the attributes of the InstanceProfile to import
   */
  public static fromInstanceProfileAttributes(scope: Construct, id: string, attrs: InstanceProfileAttributes): IInstanceProfile {
    class Import extends Resource implements IInstanceProfile {
      public readonly instanceProfileName: string = Arn.extractResourceName(attrs.instanceProfileArn, 'instance-profile').split('/').pop()!;
      public readonly instanceProfileArn: string = attrs.instanceProfileArn;

      public addRole(_role: IRole) {
        throw new Error('Cannot add role to imported Instance Profile');
      }
    }

    return new Import(scope, id);
  }

  /**
   * Returns the name of this InstanceProfile.
   */
  public readonly instanceProfileName: string;

  /**
   * Returns the ARN of this InstanceProfile.
   */
  public readonly instanceProfileArn: string;

  private readonly roles: IRole[];

  constructor(scope: Construct, id: string, props: InstanceProfileProps) {
    super(scope, id, { physicalName: props.instanceProfileName });

    this.roles = [...props.roles];

    const instanceProfile = new CfnInstanceProfile(this, 'Resource', {
      roles: Lazy.list({ produce: () => this.roles.map(role => role.roleName) }),
      instanceProfileName: props.instanceProfileName,
      path: props.path,
    });

    this.instanceProfileName = this.getResourceNameAttribute(instanceProfile.ref);
    this.instanceProfileArn = this.getResourceArnAttribute(instanceProfile.attrArn, {
      region: '',
      service: 'iam',
      resource: 'instance-profile',
      resourceName: `${props.path ? props.path.substring(props.path.charAt(0) === '/' ? 1 : 0) : ''}${this.physicalName}`,
    });
  }

  public addRole(role: IRole) {
    this.roles.push(role);
  }
}
