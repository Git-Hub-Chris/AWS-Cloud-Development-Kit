import { shell } from '../lib/os';
import { hasOnlyAutogeneratedTests, unitTestFiles } from '../lib/package-info';

try {
    const testFiles = unitTestFiles();
    if (testFiles.length > 0) {
        const testCommand: string[] = [];

        // We always run the tests, but include an 'nyc' run (for coverage)
        // if and only if the package is not completely autogenerated.
        //
        // The nyc configuration file is in the root (.nycrc). Coverage tresholds
        // can be overridden in the per-package package.json if necessary.
        if (!hasOnlyAutogeneratedTests()) {
            testCommand.push('nyc');
        }
        testCommand.push('nodeunit');
        testCommand.push(...testFiles);

        shell(testCommand);
    }

    // Always run integration test assertions
    shell(['cdk-integ-assert']);
} catch (e) {
    // tslint:disable-next-line:no-console
    console.error(e.toString());
    process.exit(1);
}