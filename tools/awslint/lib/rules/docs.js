"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const linter_1 = require("../linter");
const core_types_1 = require("./core-types");
exports.docsLinter = new linter_1.Linter(assembly => {
    return [
        ...flatMap(assembly.classes, classType => [
            { assembly, kind: 'type', documentable: classType, errorKey: classType.fqn },
            ...classType.ownProperties.map(property => ({ assembly, kind: 'class-property', containingType: classType, documentable: property, errorKey: `${classType.fqn}.${property.name}` })),
            ...classType.ownMethods.map(method => ({ assembly, kind: 'method', containingType: classType, documentable: method, errorKey: `${classType.fqn}.${method.name}` })),
        ]),
        ...flatMap(assembly.interfaces, interfaceType => [
            { assembly, kind: 'type', documentable: interfaceType, errorKey: interfaceType.fqn },
            // tslint:disable-next-line:max-line-length
            ...interfaceType.ownProperties.map(property => ({ assembly, kind: 'interface-property', containingType: interfaceType, documentable: property, errorKey: `${interfaceType.fqn}.${property.name}` })),
            ...interfaceType.ownMethods.map(method => ({ assembly, kind: 'method', containingType: interfaceType, documentable: method, errorKey: `${interfaceType.fqn}.${method.name}` })),
        ]),
        ...flatMap(assembly.enums, enumType => [
            { assembly, kind: 'type', documentable: enumType, errorKey: enumType.fqn },
            ...enumType.members.map(member => ({ assembly, kind: 'enum-member', containingType: enumType, documentable: member, errorKey: `${enumType.fqn}.${member.name}` }))
        ]),
    ];
});
exports.docsLinter.add({
    code: 'docs-public-apis',
    message: 'Public API element must have a docstring',
    eval: e => {
        if (!isPublic(e.ctx)) {
            return;
        }
        // this rule does not apply to L1 constructs
        if (isCfnType(e.ctx)) {
            return;
        }
        if (!e.ctx.documentable.docs.summary) {
            e.assert(e.ctx.documentable.docs.summary, e.ctx.errorKey);
        }
    }
});
exports.docsLinter.add({
    code: 'props-default-doc',
    message: 'Optional property must have @default documentation',
    eval: e => {
        if (e.ctx.kind !== 'interface-property') {
            return;
        }
        if (!e.ctx.containingType.isDataType()) {
            return;
        }
        // this rule does not apply to L1 constructs
        if (core_types_1.CoreTypes.isCfnType(e.ctx.containingType)) {
            return;
        }
        const property = e.ctx.documentable;
        e.assert(!property.optional || property.docs.docs.default !== undefined, e.ctx.errorKey);
    }
});
exports.docsLinter.add({
    code: 'props-no-undefined-default',
    message: `'@default undefined' is not helpful. Users will know the VALUE is literally 'undefined' if they don't specify it, but what is the BEHAVIOR if they do so?`,
    eval: e => {
        if (e.ctx.kind !== 'interface-property') {
            return;
        }
        if (!e.ctx.containingType.isDataType()) {
            return;
        }
        const property = e.ctx.documentable;
        e.assert(property.docs.docs.default !== 'undefined', e.ctx.errorKey);
    }
});
function isPublic(ctx) {
    switch (ctx.kind) {
        case "class-property":
        case "interface-property":
        case "method":
            return !ctx.documentable.protected;
        case "enum-member":
        case "type":
            return true;
    }
}
function isCfnType(ctx) {
    switch (ctx.kind) {
        case "class-property":
        case "interface-property":
        case "method":
        case "enum-member":
            return core_types_1.CoreTypes.isCfnType(ctx.containingType);
        case "type":
            return core_types_1.CoreTypes.isCfnType(ctx.documentable);
    }
}
function flatMap(array, callbackfn) {
    return Array.prototype.concat(...array.map(callbackfn));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9jcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImRvY3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFDQSxzQ0FBbUM7QUFDbkMsNkNBQXlDO0FBWTVCLFFBQUEsVUFBVSxHQUFHLElBQUksZUFBTSxDQUFvQixRQUFRLENBQUMsRUFBRTtJQUNqRSxPQUFPO1FBQ0wsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLE9BQU8sRUFBRSxTQUFTLENBQUMsRUFBRSxDQUFDO1lBQ3hDLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFLFNBQVMsRUFBRSxRQUFRLEVBQUUsU0FBUyxDQUFDLEdBQUcsRUFBRTtZQUM1RSxHQUFHLFNBQVMsQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsZ0JBQWdCLEVBQUUsY0FBYyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxHQUFHLFNBQVMsQ0FBQyxHQUFHLElBQUksUUFBUSxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztZQUNwTCxHQUFHLFNBQVMsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLGNBQWMsRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsR0FBRyxTQUFTLENBQUMsR0FBRyxJQUFJLE1BQU0sQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7U0FDcEssQ0FBQztRQUNGLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxVQUFVLEVBQUUsYUFBYSxDQUFDLEVBQUUsQ0FBQztZQUMvQyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLFlBQVksRUFBRSxhQUFhLEVBQUUsUUFBUSxFQUFFLGFBQWEsQ0FBQyxHQUFHLEVBQUU7WUFDcEYsMkNBQTJDO1lBQzNDLEdBQUcsYUFBYSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxvQkFBb0IsRUFBRSxjQUFjLEVBQUUsYUFBYSxFQUFFLFlBQVksRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLEdBQUcsYUFBYSxDQUFDLEdBQUcsSUFBSSxRQUFRLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQ3BNLEdBQUcsYUFBYSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsY0FBYyxFQUFFLGFBQWEsRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxHQUFHLGFBQWEsQ0FBQyxHQUFHLElBQUksTUFBTSxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztTQUNoTCxDQUFDO1FBQ0YsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxRQUFRLENBQUMsRUFBRSxDQUFDO1lBQ3JDLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsUUFBUSxDQUFDLEdBQUcsRUFBRTtZQUMxRSxHQUFHLFFBQVEsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsYUFBYSxFQUFFLGNBQWMsRUFBRSxRQUFRLEVBQUUsWUFBWSxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsR0FBRyxRQUFRLENBQUMsR0FBRyxJQUFJLE1BQU0sQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7U0FDbkssQ0FBQztLQUNvQixDQUFDO0FBQzNCLENBQUMsQ0FBQyxDQUFDO0FBRUgsa0JBQVUsQ0FBQyxHQUFHLENBQUM7SUFDYixJQUFJLEVBQUUsa0JBQWtCO0lBQ3hCLE9BQU8sRUFBRSwwQ0FBMEM7SUFDbkQsSUFBSSxFQUFFLENBQUMsQ0FBQyxFQUFFO1FBQ1IsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFBRSxPQUFPO1NBQUU7UUFDakMsNENBQTRDO1FBQzVDLElBQUksU0FBUyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUFFLE9BQU87U0FBRTtRQUVqQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUNwQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztTQUMzRDtJQUNILENBQUM7Q0FDRixDQUFDLENBQUM7QUFFSCxrQkFBVSxDQUFDLEdBQUcsQ0FBQztJQUNiLElBQUksRUFBRSxtQkFBbUI7SUFDekIsT0FBTyxFQUFFLG9EQUFvRDtJQUM3RCxJQUFJLEVBQUUsQ0FBQyxDQUFDLEVBQUU7UUFDUixJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxLQUFLLG9CQUFvQixFQUFFO1lBQUUsT0FBTztTQUFFO1FBQ3BELElBQUksQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxVQUFVLEVBQUUsRUFBRTtZQUFFLE9BQU87U0FBRTtRQUNuRCw0Q0FBNEM7UUFDNUMsSUFBSSxzQkFBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxFQUFFO1lBQUUsT0FBTztTQUFFO1FBRTFELE1BQU0sUUFBUSxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDO1FBQ3BDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxRQUFRLENBQUMsUUFBUSxJQUFJLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sS0FBSyxTQUFTLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUMzRixDQUFDO0NBQ0YsQ0FBQyxDQUFDO0FBRUgsa0JBQVUsQ0FBQyxHQUFHLENBQUM7SUFDYixJQUFJLEVBQUUsNEJBQTRCO0lBQ2xDLE9BQU8sRUFBRSwySkFBMko7SUFDcEssSUFBSSxFQUFFLENBQUMsQ0FBQyxFQUFFO1FBQ1IsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksS0FBSyxvQkFBb0IsRUFBRTtZQUFFLE9BQU87U0FBRTtRQUNwRCxJQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsVUFBVSxFQUFFLEVBQUU7WUFBRSxPQUFPO1NBQUU7UUFFbkQsTUFBTSxRQUFRLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUM7UUFDcEMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEtBQUssV0FBVyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDdkUsQ0FBQztDQUNGLENBQUMsQ0FBQztBQUVILFNBQVMsUUFBUSxDQUFDLEdBQXNCO0lBQ3RDLFFBQVEsR0FBRyxDQUFDLElBQUksRUFBRTtRQUNoQixLQUFLLGdCQUFnQixDQUFDO1FBQ3RCLEtBQUssb0JBQW9CLENBQUM7UUFDMUIsS0FBSyxRQUFRO1lBQ1gsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDO1FBRXJDLEtBQUssYUFBYSxDQUFDO1FBQ25CLEtBQUssTUFBTTtZQUNULE9BQU8sSUFBSSxDQUFDO0tBQ2Y7QUFDSCxDQUFDO0FBRUQsU0FBUyxTQUFTLENBQUMsR0FBc0I7SUFDdkMsUUFBUSxHQUFHLENBQUMsSUFBSSxFQUFFO1FBQ2hCLEtBQUssZ0JBQWdCLENBQUM7UUFDdEIsS0FBSyxvQkFBb0IsQ0FBQztRQUMxQixLQUFLLFFBQVEsQ0FBQztRQUNkLEtBQUssYUFBYTtZQUNoQixPQUFPLHNCQUFTLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUVqRCxLQUFLLE1BQU07WUFDVCxPQUFPLHNCQUFTLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQztLQUNoRDtBQUNILENBQUM7QUFFRCxTQUFTLE9BQU8sQ0FBTyxLQUFVLEVBQUUsVUFBd0Q7SUFDekYsT0FBTyxLQUFLLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztBQUMxRCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgcmVmbGVjdCBmcm9tICdqc2lpLXJlZmxlY3QnO1xuaW1wb3J0IHsgTGludGVyIH0gZnJvbSAnLi4vbGludGVyJztcbmltcG9ydCB7IENvcmVUeXBlcyB9IGZyb20gJy4vY29yZS10eXBlcyc7XG5cbnR5cGUgRG9jc0xpbnRlckNvbnRleHQgPSB7XG4gIHJlYWRvbmx5IGFzc2VtYmx5OiByZWZsZWN0LkFzc2VtYmx5O1xuICByZWFkb25seSBlcnJvcktleTogc3RyaW5nO1xufSAmICh7IHJlYWRvbmx5IGtpbmQ6ICd0eXBlJzsgZG9jdW1lbnRhYmxlOiByZWZsZWN0LlR5cGUgfVxuICB8IHsgcmVhZG9ubHkga2luZDogJ2ludGVyZmFjZS1wcm9wZXJ0eSc7IGNvbnRhaW5pbmdUeXBlOiByZWZsZWN0LkludGVyZmFjZVR5cGU7IGRvY3VtZW50YWJsZTogcmVmbGVjdC5Qcm9wZXJ0eSB9XG4gIHwgeyByZWFkb25seSBraW5kOiAnY2xhc3MtcHJvcGVydHknOyBjb250YWluaW5nVHlwZTogcmVmbGVjdC5DbGFzc1R5cGU7IGRvY3VtZW50YWJsZTogcmVmbGVjdC5Qcm9wZXJ0eSB9XG4gIHwgeyByZWFkb25seSBraW5kOiAnbWV0aG9kJzsgY29udGFpbmluZ1R5cGU6IHJlZmxlY3QuUmVmZXJlbmNlVHlwZTsgZG9jdW1lbnRhYmxlOiByZWZsZWN0Lk1ldGhvZCB9XG4gIHwgeyByZWFkb25seSBraW5kOiAnZW51bS1tZW1iZXInOyBjb250YWluaW5nVHlwZTogcmVmbGVjdC5FbnVtVHlwZTsgZG9jdW1lbnRhYmxlOiByZWZsZWN0LkVudW1NZW1iZXIgfVxuKTtcblxuZXhwb3J0IGNvbnN0IGRvY3NMaW50ZXIgPSBuZXcgTGludGVyPERvY3NMaW50ZXJDb250ZXh0Pihhc3NlbWJseSA9PiB7XG4gIHJldHVybiBbXG4gICAgLi4uZmxhdE1hcChhc3NlbWJseS5jbGFzc2VzLCBjbGFzc1R5cGUgPT4gW1xuICAgICAgeyBhc3NlbWJseSwga2luZDogJ3R5cGUnLCBkb2N1bWVudGFibGU6IGNsYXNzVHlwZSwgZXJyb3JLZXk6IGNsYXNzVHlwZS5mcW4gfSxcbiAgICAgIC4uLmNsYXNzVHlwZS5vd25Qcm9wZXJ0aWVzLm1hcChwcm9wZXJ0eSA9PiAoeyBhc3NlbWJseSwga2luZDogJ2NsYXNzLXByb3BlcnR5JywgY29udGFpbmluZ1R5cGU6IGNsYXNzVHlwZSwgZG9jdW1lbnRhYmxlOiBwcm9wZXJ0eSwgZXJyb3JLZXk6IGAke2NsYXNzVHlwZS5mcW59LiR7cHJvcGVydHkubmFtZX1gIH0pKSxcbiAgICAgIC4uLmNsYXNzVHlwZS5vd25NZXRob2RzLm1hcChtZXRob2QgPT4gKHsgYXNzZW1ibHksIGtpbmQ6ICdtZXRob2QnLCBjb250YWluaW5nVHlwZTogY2xhc3NUeXBlLCBkb2N1bWVudGFibGU6IG1ldGhvZCwgZXJyb3JLZXk6IGAke2NsYXNzVHlwZS5mcW59LiR7bWV0aG9kLm5hbWV9YCB9KSksXG4gICAgXSksXG4gICAgLi4uZmxhdE1hcChhc3NlbWJseS5pbnRlcmZhY2VzLCBpbnRlcmZhY2VUeXBlID0+IFtcbiAgICAgIHsgYXNzZW1ibHksIGtpbmQ6ICd0eXBlJywgZG9jdW1lbnRhYmxlOiBpbnRlcmZhY2VUeXBlLCBlcnJvcktleTogaW50ZXJmYWNlVHlwZS5mcW4gfSxcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcbiAgICAgIC4uLmludGVyZmFjZVR5cGUub3duUHJvcGVydGllcy5tYXAocHJvcGVydHkgPT4gKHsgYXNzZW1ibHksIGtpbmQ6ICdpbnRlcmZhY2UtcHJvcGVydHknLCBjb250YWluaW5nVHlwZTogaW50ZXJmYWNlVHlwZSwgZG9jdW1lbnRhYmxlOiBwcm9wZXJ0eSwgZXJyb3JLZXk6IGAke2ludGVyZmFjZVR5cGUuZnFufS4ke3Byb3BlcnR5Lm5hbWV9YCB9KSksXG4gICAgICAuLi5pbnRlcmZhY2VUeXBlLm93bk1ldGhvZHMubWFwKG1ldGhvZCA9PiAoeyBhc3NlbWJseSwga2luZDogJ21ldGhvZCcsIGNvbnRhaW5pbmdUeXBlOiBpbnRlcmZhY2VUeXBlLCBkb2N1bWVudGFibGU6IG1ldGhvZCwgZXJyb3JLZXk6IGAke2ludGVyZmFjZVR5cGUuZnFufS4ke21ldGhvZC5uYW1lfWAgfSkpLFxuICAgIF0pLFxuICAgIC4uLmZsYXRNYXAoYXNzZW1ibHkuZW51bXMsIGVudW1UeXBlID0+IFtcbiAgICAgIHsgYXNzZW1ibHksIGtpbmQ6ICd0eXBlJywgZG9jdW1lbnRhYmxlOiBlbnVtVHlwZSwgZXJyb3JLZXk6IGVudW1UeXBlLmZxbiB9LFxuICAgICAgLi4uZW51bVR5cGUubWVtYmVycy5tYXAobWVtYmVyID0+ICh7IGFzc2VtYmx5LCBraW5kOiAnZW51bS1tZW1iZXInLCBjb250YWluaW5nVHlwZTogZW51bVR5cGUsIGRvY3VtZW50YWJsZTogbWVtYmVyLCBlcnJvcktleTogYCR7ZW51bVR5cGUuZnFufS4ke21lbWJlci5uYW1lfWAgfSkpXG4gICAgXSksXG4gIF0gYXMgRG9jc0xpbnRlckNvbnRleHRbXTtcbn0pO1xuXG5kb2NzTGludGVyLmFkZCh7XG4gIGNvZGU6ICdkb2NzLXB1YmxpYy1hcGlzJyxcbiAgbWVzc2FnZTogJ1B1YmxpYyBBUEkgZWxlbWVudCBtdXN0IGhhdmUgYSBkb2NzdHJpbmcnLFxuICBldmFsOiBlID0+IHtcbiAgICBpZiAoIWlzUHVibGljKGUuY3R4KSkgeyByZXR1cm47IH1cbiAgICAvLyB0aGlzIHJ1bGUgZG9lcyBub3QgYXBwbHkgdG8gTDEgY29uc3RydWN0c1xuICAgIGlmIChpc0NmblR5cGUoZS5jdHgpKSB7IHJldHVybjsgfVxuXG4gICAgaWYgKCFlLmN0eC5kb2N1bWVudGFibGUuZG9jcy5zdW1tYXJ5KSB7XG4gICAgICBlLmFzc2VydChlLmN0eC5kb2N1bWVudGFibGUuZG9jcy5zdW1tYXJ5LCBlLmN0eC5lcnJvcktleSk7XG4gICAgfVxuICB9XG59KTtcblxuZG9jc0xpbnRlci5hZGQoe1xuICBjb2RlOiAncHJvcHMtZGVmYXVsdC1kb2MnLFxuICBtZXNzYWdlOiAnT3B0aW9uYWwgcHJvcGVydHkgbXVzdCBoYXZlIEBkZWZhdWx0IGRvY3VtZW50YXRpb24nLFxuICBldmFsOiBlID0+IHtcbiAgICBpZiAoZS5jdHgua2luZCAhPT0gJ2ludGVyZmFjZS1wcm9wZXJ0eScpIHsgcmV0dXJuOyB9XG4gICAgaWYgKCFlLmN0eC5jb250YWluaW5nVHlwZS5pc0RhdGFUeXBlKCkpIHsgcmV0dXJuOyB9XG4gICAgLy8gdGhpcyBydWxlIGRvZXMgbm90IGFwcGx5IHRvIEwxIGNvbnN0cnVjdHNcbiAgICBpZiAoQ29yZVR5cGVzLmlzQ2ZuVHlwZShlLmN0eC5jb250YWluaW5nVHlwZSkpIHsgcmV0dXJuOyB9XG5cbiAgICBjb25zdCBwcm9wZXJ0eSA9IGUuY3R4LmRvY3VtZW50YWJsZTtcbiAgICBlLmFzc2VydCghcHJvcGVydHkub3B0aW9uYWwgfHwgcHJvcGVydHkuZG9jcy5kb2NzLmRlZmF1bHQgIT09IHVuZGVmaW5lZCwgZS5jdHguZXJyb3JLZXkpO1xuICB9XG59KTtcblxuZG9jc0xpbnRlci5hZGQoe1xuICBjb2RlOiAncHJvcHMtbm8tdW5kZWZpbmVkLWRlZmF1bHQnLFxuICBtZXNzYWdlOiBgJ0BkZWZhdWx0IHVuZGVmaW5lZCcgaXMgbm90IGhlbHBmdWwuIFVzZXJzIHdpbGwga25vdyB0aGUgVkFMVUUgaXMgbGl0ZXJhbGx5ICd1bmRlZmluZWQnIGlmIHRoZXkgZG9uJ3Qgc3BlY2lmeSBpdCwgYnV0IHdoYXQgaXMgdGhlIEJFSEFWSU9SIGlmIHRoZXkgZG8gc28/YCxcbiAgZXZhbDogZSA9PiB7XG4gICAgaWYgKGUuY3R4LmtpbmQgIT09ICdpbnRlcmZhY2UtcHJvcGVydHknKSB7IHJldHVybjsgfVxuICAgIGlmICghZS5jdHguY29udGFpbmluZ1R5cGUuaXNEYXRhVHlwZSgpKSB7IHJldHVybjsgfVxuXG4gICAgY29uc3QgcHJvcGVydHkgPSBlLmN0eC5kb2N1bWVudGFibGU7XG4gICAgZS5hc3NlcnQocHJvcGVydHkuZG9jcy5kb2NzLmRlZmF1bHQgIT09ICd1bmRlZmluZWQnLCBlLmN0eC5lcnJvcktleSk7XG4gIH1cbn0pO1xuXG5mdW5jdGlvbiBpc1B1YmxpYyhjdHg6IERvY3NMaW50ZXJDb250ZXh0KSB7XG4gIHN3aXRjaCAoY3R4LmtpbmQpIHtcbiAgICBjYXNlIFwiY2xhc3MtcHJvcGVydHlcIjpcbiAgICBjYXNlIFwiaW50ZXJmYWNlLXByb3BlcnR5XCI6XG4gICAgY2FzZSBcIm1ldGhvZFwiOlxuICAgICAgcmV0dXJuICFjdHguZG9jdW1lbnRhYmxlLnByb3RlY3RlZDtcblxuICAgIGNhc2UgXCJlbnVtLW1lbWJlclwiOlxuICAgIGNhc2UgXCJ0eXBlXCI6XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgfVxufVxuXG5mdW5jdGlvbiBpc0NmblR5cGUoY3R4OiBEb2NzTGludGVyQ29udGV4dCkge1xuICBzd2l0Y2ggKGN0eC5raW5kKSB7XG4gICAgY2FzZSBcImNsYXNzLXByb3BlcnR5XCI6XG4gICAgY2FzZSBcImludGVyZmFjZS1wcm9wZXJ0eVwiOlxuICAgIGNhc2UgXCJtZXRob2RcIjpcbiAgICBjYXNlIFwiZW51bS1tZW1iZXJcIjpcbiAgICAgIHJldHVybiBDb3JlVHlwZXMuaXNDZm5UeXBlKGN0eC5jb250YWluaW5nVHlwZSk7XG5cbiAgICBjYXNlIFwidHlwZVwiOlxuICAgICAgcmV0dXJuIENvcmVUeXBlcy5pc0NmblR5cGUoY3R4LmRvY3VtZW50YWJsZSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gZmxhdE1hcDxULCBVPihhcnJheTogVFtdLCBjYWxsYmFja2ZuOiAodmFsdWU6IFQsIGluZGV4OiBudW1iZXIsIGFycmF5OiBUW10pID0+IFVbXSk6IFVbXSB7XG4gIHJldHVybiBBcnJheS5wcm90b3R5cGUuY29uY2F0KC4uLmFycmF5Lm1hcChjYWxsYmFja2ZuKSk7XG59XG4iXX0=